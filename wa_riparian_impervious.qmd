---
title: "Holding the line or losing ground? Impervious cover in the riparian corridor"
date: "`r Sys.Date()`"
format:
  docx: 
    reference-doc: /Users/auerbdaa/O/code/quarto_template.docx

  html:
    embed-resources: true
    theme: yeti 
    code-fold: true
    toc: true
    toc-location: left
    grid:
      sidebar-width: 180px
      body-width: 1100px
      margin-width: 20px
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  warning = FALSE, message = FALSE, fig.width = 7, fig.height = 9)

library("tidyverse", quietly = T)
library("sf")
library("patchwork")
library("gt")
theme_set(theme_minimal()) 

dir_data_common <- "~/T/DFW-Team WDFW Watershed Synthesis - data_common"
epsg <- 2927 #WA state standard; NAD83(HARN)/ft
ha <- 0.404686

sf_wrias <- sf::read_sf(file.path(dir_data_common, "WR_WAT_WRIA.gdb/")) |>
  mutate(
    wria = factor(WRIA_NR),
    wria_nr_nm = paste0(str_pad(WRIA_NR,width = 2, pad = "0",),"_",WRIA_NM) |> factor()) |>
  select(WRIA_NR, WRIA_NM, wria, wria_nr_nm, acres = WRIA_AREA_ACR_QT) |> arrange(wria) |> 
  sf::st_transform(sf::st_crs(epsg))

sf_cnty <- sf::read_sf(file.path(dir_data_common, "WA_County_Boundaries/WA_County_Boundaries.shp")) |> 
  select(cnty = JURISDIC_2) |> 
  sf::st_transform(sf::st_crs(epsg))


#load(".RData")
```

# Authors

**Please let me know individually if you'd prefer to be listed in Acknowledgements**

Dan Auerbach 
Ken Pierce 
Ken Muir 
Keith Folkerts 
Robin Hale 
Kara Whittaker 
Simone Des Roches 
Reed Ojala-Barbour 
George Wilhere
Danielle Lazarus 
John Withey 
Braeden Van Deynze 
Maddie Nolan


# Abstract

Land use regulations may protect the ecosystem services provided by riparian areas from threats such as encroaching impervious cover that degrades habitat and alters watershed hydrology. Cumulative, empirical, landscape scale assessments are needed to evaluate whether the policy goals of this regulation are being met. We examined recent trends in impervious cover within riparian corridors in Washington State, USA, comparing estimates from a high resolution change detection dataset based on aerial imagery interpretation with the changes in classified satellite imagery from the National Land Cover Dataset.

*results summary*
*interpretation/message*
for most of the new imperv, it was less that regulation was ineffective where it occurred than that where it occurred - the extent of regulated area  was insufficient
*promising opportunities for ongoing evaluation*



# Introduction

Waters and uplands meet and mingle in what we call 'riparian'. This ecological edge hosts dynamic physical and biological exchanges, and these land-water interactions provide numerous services valued by people: maintenance of water quality through pollutant removal and shading, formation of critical in-channel habitat features and wildlife corridors, and attenuation of high flows. However, human activities have substantially degraded riparian structure and function in many locations, and various laws aiming to preserve these services have been designed and enacted to protect and rehabilitate riparian areas.

One major, ongoing threat to riparian ecological integrity is the spread of impervious surfaces. In addition to the direct loss of terrestrial habitat, replacing native vegetation with concrete or other built elements prevents infiltration and alters watershed flow paths, impairing water quality and channel forms. Limiting this damage while meeting expectations for new construction is a core challenge of land use regulation, and status assessments are critical to determine if the motivating policy goals are being met. In particular, cumulative assessment at the landscape scale is important to guide adaptive management, but poses technical challenges and may be outside of the direct responsibility of any single regulatory entity.

Indeed, despite the well-understood importance of riparian areas and the attention devoted to their study, considerable uncertainty still surrounds basic measures at the landscape scale. Despite some qualitative consensus that riparian ecosystems in the western United States have experienced "substantial" or "dramatic" changes following European colonization, quantitative estimates of current conditions and change remain elusive, potentially hindering effective communication around policy objectives. This analysis addresses the need to quantify change in riparian imperviousness at larger regional scales, using Washington state as a focal example. 

Past research has indicated likely trends without providing a clear characterization of statewide riparian regulatory outcomes. Jones et al. (2010) considered late 20th century land cover change (1973-2003) at a relatively coarse spatial resolution (60m) within a 180m buffer of NHD watercourses in several thousand sample blocks across the continental United States. They described a nationwide monotonic increase in the average riparian "urban %" over the assessed duration, and their results showed the Puget lowlands region had the nationally largest decrease in "natural land cover" during the "mid 80s - early 90s" period. A dramatic expansion of "urban", impervious cover was also described by Powell et al. (2008) within Washington's Snohomish River watershed. Though not constrained to riparian areas, they estimated a 255% increase from 3285 ha in 1972 to 11,652 ha in 2006, based on an analysis combining manual orthophoto review with Landsat imagery. This study indicated that rapid impervious expansion during the 1980s slowed during the 1990s before returning to a faster rate after 2000. The authors noted the potential for changes in land use regulations to have influenced this trajectory but avoided any direct attribution, stating the need to study alternative contributing factors. Bartz et al. (2015) focused on annual changes within 100m or 200m buffers around distinct salmon habitat types throughout additional Puget Sound watersheds. Using a LandTrendr analysis of 30m imagery spanning 1986 to 2008, they estimated that impervious cover in "mainstem" zones increased roughly 3% on average (172ha, 425ac) from 5820ha in 1986, and that "tributary" zones increased roughly 5.5% (118ha, 294ac) from 2,153ha. They also reported shifts to a slower rate of increase in these and the other nearshore, estuary, and floodplain habitat areas examined, though the timing and persistence of inflections varied considerably among habitat types and subbasins. While clear that a legacy of degradation continues to affect Puget Sound salmon habitats, these authors concluded that more recent land cover change may indicate slowing in further impairment.

These studies illustrate factors contributing uncertainty to cumulative assessments of riparian impervious cover change. Differences in hydrography (i.e., the location and resolution of flowlines and waterbodies) combine with alternative lateral buffer dimensions (e.g., from 10m to 200m) to produce variation in the specific zones being evaluated, sometimes even within the spatial scale of a county (10s of kilometers) as well as between separate studies. Beyond hydrographic variation and riparian buffer formulation, landscape scale estimates have also typically relied on categorical classifications of continuous spectral values in satellite imagery, usually at a pixel resolution corresponding to a 30m ground distance. The accuracy of estimates based on these methods is likely to increase where land cover is relatively homogeneous and change areas are large relative to pixel resolution, but substantial cover variation can occur within a 30x30m pixel area, complicating both the assignment of a single class at a given time and the determination of change between images at different times. However, rather than large blocks of change from a continuous baseline, most ongoing impervious cover additions in the western U.S. are likely to occur within heterogeneous mosaics of multiple land cover types and may often involve extents smaller than 0.09ha (0.22 acres, a single 900m2 pixel). 

An evaluation of impervious cover that addresses these considerations is possible in Washington because of high resolution change detection (HRCD) processing of aerial imagery at a 1m scale (Pierce 2015). The HRCD approach combines automated delineation of change polygons with extensive manual review and verification against before-after image pairs to generate a detailed dataset of land cover alteration. We used these data in conjunction with a statewide polygon tessellation of riparian corridors grounded in current policy guidelines, and we compare the resulting estimates with those derived from independent public land cover data in a fixed-width corridor on a different hydrography. We describe these estimated increases in imperviousness relative to the distribution of salmon within river networks, an important cultural and legal driver in the region, as well as relative to concurrent changes in human population and housing, before discussing policy implications and opportunities for improved ongoing assessment.

# Methods 

## Riparian management in Washington

Washington State, in the Pacific northwestern United States, is home to several distinct geologic domains and hydroclimates, giving rise to ecoregions that vary from rainforests to semi-arid shrubsteppe. This produces variation in land uses, with different combinations of forestry, agriculture, and urbanization affecting riparian land cover in different portions of the state. Riparian administrative responsibility is also distributed among multiple, often overlapping entities, with no single authority controlling management decisions or the statewide jurisdictional extent of 'riparian management zones' (RMZ). Within the context of U.S. treaties with sovereign tribes, federal and state statutes interact with local codes to create a complex regulatory regime with ample variation in exactly what constitutes "riparian" for the purposes of land use planning and permitting.

However, as the agency mandated "to preserve, protect and perpetuate fish, wildlife and ecosystems", the Washington Department of Fish and Wildlife (WDFW) has a responsibility to consult on rules and projects affecting habitat for harvested and non-harvested species statewide. In addition to participating in multi-stakeholder forums that shape forestry and agricultural regulations, WDFW defines "riparian areas (comprised of riparian ecosystems, active floodplains, and riverine wetlands)" as a "Priority Habitat" (Rentz et al. 2020) that warrants provisions in the comprehensive plans and critical area ordinances stipulated by Washington's Growth Management Act (GMA, RCW 36.70A). Accordingly, the agency has issued guidance on an RMZ standard grounded in available evidence of ecosystem functions, following an extensive review and synthesis of scientific studies that updated and extended earlier guidelines (Quinn et al. 2020, Knutson and Naef 1997).

The [200-year Site Potential Tree Height standard (SPTH~200~)](https://wdfw.wa.gov/publications/02564) proposes that the mature height of characteristic native trees at a location can be used to determine a lateral distance from water that will protect "full ecosystem function". Though not compulsory, adoption of this minimum standard of protection increases the likelihood that regulated Fish and Wildlife Habitat Conservation Areas (FWHCA) will foster ecosystem health and contribute to recovery of threatened and listed species, including Chinook salmon (*Oncorhynchus tshawytscha*). Recognizing the inherent natural variation in riverscapes (Fausch et al. 2002) and Washington's physiographic heterogeneity, the SPTH~200~ concept avoids a single fixed dimension while still offering a generalized approach to consistent RMZ delineation based on "best available science". This provides an alternative to the simplistic and less-protective values that have been implemented by many cities and counties since passage of the GMA in 1990. Though commonly 50 or 100 feet based on categorical stream types defined by flow permanence and fish use, the specific sets of buffer rules have differed substantially among planning authorities (Folkerts et al. 2020), sometimes between adjacent local governments along the same watercourse.

To facilitate application of the SPTH~200~ standard, WDFW developed a geospatial web application enabling rapid evaluation of riparian conditions and supporting data-informed planning decisions. The foundation of this Riparian Data Engine (RDE, https://ripariandata.wdfw.wa.gov/, [(WDFW 2024)](https://wdfw.medium.com/a-new-way-of-looking-at-washingtons-waterways-ad05d872c4ce)) is a statewide polygon tessellation of RMZs generated from public hydrography (NHD) and soils (SSURGO) data. Users are able to interactively examine various attributes measuring land cover, water quality (via 303d/305b listings), and salmon distribution (via the Statewide Integrated Fish Distribution dataset; [SWIFD](https://geo.wa.gov/datasets/wdfw::statewide-washington-integrated-fish-distribution/about)) calculated for each network reach unit. For example, a user can filter for locations within a Water Resource Inventory Area (WRIA) or a county with a higher or lower tree canopy cover and salmon presence or absence, thereby screening for candidate locations to emphasize for protection or rehabilitation. The complete set of "reach tables" was compiled from this public web application, providing attribute values for more than 1 million individual reach units of the SPTH~200~ tesselation. The per-reach rows in this dataset include a combination of riparian management zone (RMZ, both banks where double-banked), "extent of observed water" (EOW), and "floodplain" (primarily based on FEMA mapping) geometry. Within the riparian corridor composed by these areas, land cover change was calculated from intersection with HRCD polygons (see next section), and values were tabulated statewide and within individual county boundaries, recognizing that county geographic extents contain multiple tribal, federal, state, and local authorities and do not represent the exclusive jurisdiction of county governments.

```{r build_rde_cnty_library, eval=FALSE}
walk(
  URLencode(sort(sf_cnty$cnty))
  ,
  ~httr2::request(paste0(
    'https://api-ripariandata.wdfw.wa.gov/counties/',.x,'/reaches/csv'
  )) |>
    httr2::req_headers(`x-api-key` = key) |>
    #httr2::req_dry_run()
    httr2::req_perform() |>
    httr2::resp_body_raw() |>
    readr::read_csv() |>
    readr::write_csv(
      file = file.path(dir_data_common, paste0("rde/counties/rde_cnty_",.x, ".csv"))
    )
)

```

```{r build_rch_tbl_cnty, eval=FALSE}
#then build combined object: 1,091,144x 40
#NOT deduplicating PID shared across counties
#length(unique(rch_tbl_cnty$pid)) == 1084186 (46 more than wrias?)
#would either need to remove entirely or split+assign by proportion
#preferable to include and count twice in per-county stratification
#and/but unstratified statewide sum-over-counties needs distinct()

rch_tbl_cnty <- map_df(
  list.files(file.path(dir_data_common, "rde/counties"), pattern = ".csv", full.names = T)
  ,
  ~readr::read_csv(.x) |>
    mutate(
      pid = as.character(PermanentIdentifier), PermanentIdentifier = NULL,
      cnty = basename(.x) |> str_remove("rde_cnty_") |> str_remove(".csv") |> 
        str_replace_all("%20", " ")
      )
  ) |>
  rename(wria = WaterResourceInventoryAreaID) |>
  janitor::clean_names() |>
  rename_with(~str_replace(.,"acres","ac")) |>
  rename_with(~str_replace(.,"human_forestry_","forestry_")) |>
  rename_with(~str_replace(.,"human_nonforestry_","nonfstry_")) |>
  rename_with(~str_replace(.,"decrease","dec")) |>
  rename_with(~str_replace(.,"increase","inc")) |>
  rename_with(~str_replace(.,"impervious","impv")) |>
  rename_with(~str_replace(.,"semipervious","semi")) |>
  select(pid, cnty, wria, everything(), -reach_id)

glimpse(rch_tbl_cnty)

#saveRDS(rch_tbl_cnty, "~/T/DFW-Team WDFW Watershed Synthesis - data_common/rde/cnty_rch_tbl.rds")

```

```{r rde_cnty}
#for any statewide sum need: distinct(pid, .keep_all = T)
#no way in this table structure, without a 'zone' attribute', to differentiate RMZ-EOW-Floodplain
rde_cnty <- readRDS("~/T/DFW-Team WDFW Watershed Synthesis - data_common/rde/cnty_rch_tbl.rds") |> 
  mutate(
    wria = factor(wria),
    tree_pct = all_tree_cover_ac / all_land_cover_ac,
    veg_pct = all_vegetated_ac / all_land_cover_ac
    ,
    swifd_any = !is.na(swifd_salmon_distribution),
    swifd_n = 1 + str_count(swifd_salmon_distribution,","),
    swifd_n_fct = case_when(
      is.na(swifd_n) ~ "none",
      swifd_n < 3 ~ "1-2 species",
      swifd_n >= 3 ~ "3 or more species"
    ),
    swifd_chin = case_when(
      str_detect(swifd_salmon_distribution, "Chin") ~ "salmon_with_chin",
      str_detect(swifd_salmon_distribution, "Chin", negate = T) ~ "salmon_not_chin",
      is.na(swifd_salmon_distribution) ~ "not_salmon"
    )
  ) 

```


## High Resolution Change Detection 

Land cover changes were measured following the basic methodology outlined in Pierce (2015), in which automated processing of sequential aerial imagery generated candidate polygons that were then manually reviewed for accuracy and categorical attribution. This process consists of three main phases: 1) object-based change detection (OBCD) to created polygons of similar pixels, 2) estimation of a probability of change for each of these units, and 3) a manual review and attribute assessment. 

High resolution orthoimagery produced by the National Agriculture Inventory Program (NAIP) has been collected at two to three year intervals beginning in 2006 (Maxwell et al. 2017). Mosaics of georectified tiles of these multispectral, aerial data formed the starting point for processing. This study is limited to the 2011 to 2013, 2013 to 2015, and 2015 to 2017 time windows due to their statewide coverage. Imagery for these periods was at 0.914-m (3 ft) resolution. 

Object-based segmentation of these images via Trimble eCognition software (versions 8.8 - 9.5.1) generated geodatabases of irregularly sized and shaped polygons determined by per-pixel spectral properties. Segmentation rule sets were constructed to distinguish potential changes down to the scale of about 1/50 hectare (0.05 acres, 242 pixels). These candidate polygons were assigned a probability of change estimated from random forest models fit to a training set of 5000 stratified samples and analyst-scored units combined with an additional 500 confirmed change units from a directed search.

The short intervals between NAIP images tend to skew the estimated change probability distribution towards zero or "no change", but a relatively low change probability of 25% was used to stratify between “change-likely” and “change-unlikely” groups, reducing omission errors from "unlikely" polygons that contained real change. At least 1% of "unlikely" polygons were randomly sampled for further review.

Analysts used custom software to examine this "unlikely" sample and the set of all "likely" polygons (1-4% or roughly 1,000 - 40,000, depending on the location and time period). Visual comparison between image pairs confirmed changes, allowed assignment of a likely change agent, and addressed imperfections in the homogeneity of pixels within a change segment through assignment of categorical quartile values for the proportions of total change, lost tree canopy, new impervious surface, and new semi-pervious surface (e.g., new gravel roads). Assignment of the percent change categories introduced uncertainty due to accuracy (i.e., selection of 25% vs 50%) and imprecision (i.e., the true value falling within a 25% range). Finer divisions would tend to reduce the latter while increasing the former, but the inspection of millions of candidate change polygons has confirmed that this approach is a logistically feasible way to generate a high quality dataset that captures many small changes at large regional scales.  

## StreamCat-processed NLCD

As a complement and contrast to the RDE-HRCD dataset, the [`StreamCatTools`](https://github.com/USEPA/StreamCatTools) (Weber 2025) R package was used to access the [StreamCat dataset](https://www.epa.gov/national-aquatic-resource-surveys/streamcat-dataset) (Hill et al. 2016). This delivers consistently geoprocessed attribute values for each reach unit of the original medium resolution NHDPlus. Derived from a 30m DEM and sometimes termed "1:100K", this hydrography captures most substantial watercourses and is the precursor to subsequent higher-resolution, continent-wide elevation derived hydrographic datasets that include many smaller channel units (i.e., NHDPlusHR from 10m DEM and 3DHP from LiDAR). For each reach 'comid', StreamCat provides attribute values from many other data sources processed within the local contributing catchment ('`cat`') as well as a 100m riparian buffer ('`rp100`') on "stream lines and on-network NLCD water pixels". 

StreamCat includes values calculated from 8 cycles of the National Land Cover Dataset (NLCD; 2001, 2004, 2006, 2008, 2011, 2013, 2016, and 2019), which are based on random forest classification of satellite and other imagery sources [(Wickham et al. 2023)](https://www.tandfonline.com/doi/full/10.1080/15481603.2023.2181143). The StreamCat NLCD values represent the percentages of each of 16 land cover classes within each of the *cat* and *catrp100* areas of interest  (AOI), such that approximate areas per-class were back-calculated against the per-comid area. The StreamCat process and NLCD datasets have undergone thorough QAQC and been extensively reviewed since their initial development, resulting in their widespread use in various scientific studies. Though unsuited to investigating site specific processes, these data are a standardized, consistent means to investigate large-scale cumulative patterns.

```{r objects_sf}
  
# ##flowlines with WRIA added deduplicated via 'largest=T'
# sf_flw <- sf::read_sf(file.path(dir_data_common, "NHDPlus17/NHDSnapshot/Hydrography/NHDFlowline.shp")) |>
#   sf::st_transform(crs = sf::st_crs(epsg)) |>
#   sf::st_zm() |>
#   select(COMID, FCODE, FTYPE, LENGTHKM) |>
#   rename_with(tolower) |>  
#   st_join(sf_cnty, left = F, largest = T) |> #inner join
#   st_join(sf_wrias |> select(wria, wria_nr_nm), left = F, largest = T) |> #inner join
#   mutate(comid = as.character(comid))
# saveRDS(sf_flw, file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_flw.rds"))
sf_flw <- readRDS(file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_flw.rds"))

# # ##catchment polys with WRIA added deduplicated via 'largest=T'
# sf_cat <- sf::read_sf(file.path(dir_data_common, "NHDPlus17/NHDPlusCatchment/Catchment.shp")) |>
#   sf::st_transform(crs = sf::st_crs(epsg)) |>
#   select(comid = FEATUREID, areasqkm = AreaSqKM) |>
#   st_join(sf_cnty, left = F, largest = T) |> #inner join
#   st_join(sf_wrias |> select(wria, wria_nr_nm), left = F, largest = T) |>
#   mutate(comid = as.character(comid))
# saveRDS(sf_cat, file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_cat.rds"))
sf_cat <- readRDS(file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_cat.rds"))

# # ~608 comids along county borders are assigned different (appropriately, due to geometry+'largest')
# #not splitting geometries (and attributes) so simpler is better
# #visual inspection indicates flowlines should have precedence for associating to StreamCat/NLCD
# mm <- inner_join(
#   sf_cat |> as_tibble() |> select(comid, cnty_cat=cnty),
#   sf_flw |> as_tibble() |> select(comid, cnty_flw=cnty),
#   by = "comid"
#   ) |> 
#   filter(cnty_cat!=cnty_flw)
# x <- sf_cat |> semi_join(mm, by = "comid")
# y <- sf_flw |> semi_join(mm, by = "comid")
# mapview::mapview(list(cat = x, flw = y, cnty = sf_cnty))

# distinct(as_tibble(sf_flw), comid) #66116
# distinct(as_tibble(sf_cat), comid) #57306
# #flowlines with no cat are most pipelines & canalditch (~3K), a third of coastline
# #but also many scattered streamriver and artificalpath statewide but large concentrations in yakima region
# #cat with no flowlines are edge cases, a pothole depressional area SE of Okanagon plus a few other scattered Eastside

```

```{r objects_streamcat_nlcd}
## recall riparian buffers are 100m, per https://www.epa.gov/national-aquatic-resource-surveys/streamcat-dataset-readme 
 
# #pull all 4 AOI, including abs areasqkm
# sc_wa_nlcd <- map(
#   set_names(c(2001, 2004, 2006, 2008, 2011, 2013, 2016, 2019))
#   ,
#   ~StreamCatTools::sc_nlcd(
#     state = "WA", year = .x,
#     aoi = 'cat,catrp100,ws,wsrp100',
#     showAreaSqKm = T
#   ) |>
#     rename_with(tolower) |> as_tibble() |>
#     mutate(comid = as.character(comid), nlcd_year = .x)
# )
# saveRDS(sc_wa_nlcd, file.path(dir_data_common, "streamcat", "sc_wa_nlcd.rds"))

# #removing 7 massive cross-border COMIDs mostly in BC; 6 are >1000km2, last is >350km2
# sf_cat |> arrange(desc(areasqkm)) |> filter(areasqkm>1000) |> ggplot() + geom_sf() + geom_sf_text(aes(label = comid))
# sf_cat |> filter(between(areasqkm,100,1000)) |> ggplot() + geom_sf(aes(fill=areasqkm)) + geom_sf_text(aes(label = comid))
# filter(sf_cat, comid =="23031682")->x; mapview::mapview(x)
comids_drop_BC <- filter(as_tibble(sf_cat), areasqkm>1000) |> distinct(comid) |> bind_rows(tibble(comid = "23031682"))

#starting object with cat and catrp100 (no Ws)
#inner_join against sf_cat to add WRIA 
#then second inner_join against sf_flw to add County and get common set across all 3
#dropping remaining comids with NA rp100
#converting pcts to 0-1
#appending 'ac[res]' cols as AOI-specific product of pct and areasqkm
sc_nlcd <- readRDS(file.path(dir_data_common, "streamcat", "sc_wa_nlcd.rds")) |> 
  map(
    ~.x |> 
      rename_with(
        ~str_remove(.,paste(c(2001, 2004, 2006, 2008, 2011, 2013, 2016, 2019),collapse = "|")) |> 
          str_remove("pct")
        ) |> 
      select(comid, nlcd_year, 
             catareasqkm, catareasqkmrp100,
             ends_with("cat"), ends_with("catrp100"))
      ) |> 
  list_rbind() |> 
  anti_join(comids_drop_BC, by = "comid") |> 
  inner_join(as_tibble(sf_cat) |> select(comid, wria, wria_nr_nm), by = "comid") |> 
  inner_join(as_tibble(sf_flw) |> distinct(comid, cnty), by = "comid") |> 
  drop_na(urbmdcatrp100) |> #single lu class captures all 231 comids NA for rp100 vals
  mutate(
    across(c(ends_with("cat"), ends_with("catrp100")), ~./100)
    ,
    # urb_cat = urbhicat + urbmdcat,
    # urb_catrp100 = urbhicatrp100 + urbmdcatrp100
    ,
    across(ends_with("cat"), list(ac = ~.* catareasqkm * 247.11)),
    across(ends_with("catrp100"), list(ac = ~.* catareasqkmrp100 * 247.11))
    ) 

sc_nlcd <- sc_nlcd |> 
  select(
    wria, wria_nr_nm, cnty,
    comid, nlcd_year, 
    catareasqkm, catareasqkmrp100,
    all_of(sort(grep("cat$", colnames(sc_nlcd), value = T))),
    all_of(sort(grep("catrp100$", colnames(sc_nlcd), value = T))),
    all_of(sort(grep("cat_ac$", colnames(sc_nlcd), value = T))),
    all_of(sort(grep("catrp100_ac$", colnames(sc_nlcd), value = T))),
)

#bring both sf to same 56879
sf_flw <- sf_flw |> inner_join(distinct(sc_nlcd, comid), by = "comid") 
sf_cat <- sf_cat |> inner_join(distinct(sc_nlcd, comid), by = "comid")

pal_nlcd <- set_names(
  c("brown","darkgreen","yellow","lightgreen","yellowgreen",
    "yellow","seagreen","white","green","blue",
    "tan","grey10","grey60","grey30","grey80","seagreen")
  ,
  str_remove(sort(grep("cat$", colnames(sc_nlcd), value = T)), "cat") 
)    

```

## Lazarus dataset?

Alternative spth200 + NLCD

## OFM population and housing data

Annual county-level population and housing unit totals were accessed from the Washington Office of Financial Management (OFM) Data and Research [April 1 Postcensal Estimates](https://ofm.wa.gov/washington-data-research/population-demographics/population-estimates/historical-estimates-april-1-population-and-housing-state-counties-and-cities).

```{r ofm_pop}
#non-numeric special symbol flag cols starting after 1970
#flag==1 is the total of unincorporated (2) and incorp (3), incorp the sum of munis (4)
ofm_pop <- suppressMessages(readxl::read_excel(
  file.path(dir_data_common, "census", "ofm_april1_postcensal_estimates_pop_1960-present.xlsx"),
  sheet = 2, skip = 2, na = "."
) |> 
  drop_na(Filter) |>
  janitor::clean_names() |> #glimpse() 
  select(filter, county, jurisdiction, contains("population")) |> 
  pivot_longer(contains("population"), values_to = "est_pop") |> 
  mutate(
    year = str_remove(name, "_") |> str_sub(2, 5), 
    name = NULL,
    across(c(year, est_pop), as.numeric)
  ))

```

```{r ofm_housing}
ofm_housing <- readxl::read_excel(
  file.path(dir_data_common, "census", "ofm_april1_postcensal_estimates_housing_1980_1990-present.xlsx"),
  sheet = 2, skip = 2, na = "."
) |> 
  drop_na(Filter) |>  #filter(Filter!=".") |> 
  janitor::clean_names() |> #glimpse() 
  # select(filter, county, jurisdiction, contains("total_housing")) |> 
  # pivot_longer(contains("total_housing"), values_to = "total_housing") |> 
  # mutate(
  #   year = str_sub(name, 2, 5), name = NULL,
  #   across(c(year, total_housing), as.numeric)
  #   )
  select(-line) |> 
  pivot_longer(contains("units"), values_to = "units") |> 
  mutate(
    year = str_sub(name, 2, 5), 
    across(c(year, units), as.numeric),
    name = case_when(
      str_detect(name, "total") ~ "total",
      str_detect(name, "one_unit") ~ "single",
      str_detect(name, "two_or_more") ~ "multi",
      str_detect(name, "special") ~ "other"
    )
  )

```



# Results

```{r wa_imp_statewide_summary}
# #if Lazarus ~580-720ac/y for 2001:2019
# expand_grid(ac = c(11:13)*1000, y = 18:19) |> mutate(ac_y = ac/y)

wa_imp <- rde_cnty |> 
  distinct(pid, .keep_all = T) |> 
  summarise(
    across(
      c(reach_ac, 
        rmz_ac, eow_ac, flood_ac, 
        nonfstry_impv_inc_ac, nonfstry_semi_inc_ac
        ),
      ~sum(., na.rm = T)
    )
    , .by = swifd_chin
  ) |> 
  bind_rows(
    rde_cnty |> 
      distinct(pid, .keep_all = T) |> 
      summarise(across(c(reach_ac, rmz_ac, eow_ac, flood_ac, nonfstry_impv_inc_ac, nonfstry_semi_inc_ac), ~sum(., na.rm = T))) |> 
      mutate(swifd_chin = "total")
  ) |> 
  rename_with(~str_remove(., "nonfstry_")) |> 
  mutate(
    reach_ha = ha*reach_ac,
    impv_inc_ha = ha*impv_inc_ac,
    impv_reach_pct = impv_inc_ac / reach_ac,
    semi_inc_ha = ha*semi_inc_ac,
    semi_reach_pct = semi_inc_ac / reach_ac,
    #per KP, HRCD 2011:2017 NAIP is summer to summer
    impv_ha_y = ha*(impv_inc_ac / 6),
    impv_ac_y = impv_inc_ac / 6,
    semi_ha_y = ha*(semi_inc_ac / 6),
    semi_ac_y = semi_inc_ac / 6 
  )
```

```{r rde_cnty_sum}
rde_cnty_sum <- rde_cnty |> 
  summarise(
    across(
      c(reach_ac, 
        riparian_ac, rmz_ac, eow_ac, flood_ac, 
        nonfstry_impv_inc_ac, 
        nonfstry_semi_inc_ac,
        nonfstry_tree_dec_ac
        ),
      ~sum(., na.rm = T)
    )
    , .by = cnty
  ) |> 
  mutate(
    across(
      starts_with("nonf"),
      list(
        #per_100ac = ~100*(./reach_ac)
        pct_rch = ~(./reach_ac)
      )
    )
  ) |> 
  left_join(
    rde_cnty |> 
      summarise(
        across(
          c(reach_ac, 
            #riparian_ac, rmz_ac, eow_ac, flood_ac, 
            nonfstry_impv_inc_ac,
            nonfstry_semi_inc_ac,
            nonfstry_tree_dec_ac
          ),
          ~sum(., na.rm = T)
        ),
        .by = c(cnty, swifd_chin)
      ) |> 
      pivot_wider(names_from = swifd_chin, values_from = ends_with("_ac"))
    , 
    by = "cnty"
  ) |> 
  left_join(
    ofm_pop |> 
      filter(filter == "1", year %in% c(2011, 2017)) |> 
      select(cnty = county, year, est_pop) |> 
      #arrange(cnty, year) |> summarise(across(est_pop, list(d = ~.[2] - .[1])), .by = cnty)
      pivot_wider(names_from = year, names_glue =  "{year}_{.value}", values_from = est_pop) |> 
      mutate(d_est_pop = `2017_est_pop`- `2011_est_pop`)
    ,
    by = "cnty"
  ) |> 
  left_join(
    ofm_housing |> 
      filter(filter == "1", year %in% c(2011, 2017)) |> 
      select(cnty = county, year, name, units) |> 
      #pivot_wider(names_from = name, values_from = units) |> 
      #arrange(cnty, year) |> summarise(across(total:other, list(d = ~.[2] - .[1])), .by = cnty)
      pivot_wider(names_from = year, values_from = units) |> 
      mutate(d = `2017`- `2011`) |> 
      pivot_wider(names_from = name, values_from = where(is.numeric))
    ,
    by = "cnty"
  ) |> 
  rename_with(~str_remove(., "nonfstry_"))


sf_cnty_rde <- sf_cnty |> 
  mutate(cnty_ac = st_area(geometry) |> units::set_units("acres") |> as.numeric()) |> 
  left_join(rde_cnty_sum, by = "cnty")

```

```{r sc_nlcd_year_sum}
sc_nlcd_year_sum <- sc_nlcd |> 
  summarise(
    across(
      contains("urb") & ends_with("ac"),
      list(sum = ~sum(.))
    )
    , .by = c(nlcd_year)
  ) |> 
  pivot_longer(cols = -nlcd_year, values_to = "ac") |> 
  mutate(
    aoi = if_else(str_detect(name, "rp100"), "rp100", "cat"),
    nlcd_class = str_remove(name, "cat") |> str_remove("rp100") |> str_remove("_ac_sum"),
    name = NULL,
    ha = ha*ac
    )
```

```{r figcorridors_sumner}

sf_aoi <- st_as_sf(st_as_sfc(
  st_bbox(
    #c(xmin = 1064273, xmax = 1064273+60000, ymin = 800000, ymax = 800000+90000), #Poulsbo to Pt Orchard
    c(xmin = 1200000, xmax = 1200000+15000, ymin = 679000, ymax = 679000+30000), #Sumner
    crs = st_crs(epsg))
  ))
st_area(sf_aoi) |> units::set_units("acres") 
#mapview::mapview(sf_aoi)

sf_aoi_flw <- sf_flw[sf_aoi,] |> st_crop(sf_aoi)
sf_aoi_flw_rp100 <- st_buffer(sf_aoi_flw, dist = 328) |> 
  left_join(
    sc_nlcd |> 
    select(comid, nlcd_year, starts_with("urb"), ends_with("rp100_ac")) |> filter(nlcd_year==2016),
    by = "comid")
sf_aoi_cat <- sf_cat[sf_aoi,] |> st_crop(sf_aoi) |> 
  left_join(
    sc_nlcd |> 
    select(comid, nlcd_year, starts_with("urb"), ends_with("rp100_ac")) |> filter(nlcd_year==2016),
    by = "comid")

gdb <- file.path(dir_data_common, "HRCD.gdb") #also NAD83(HARN)
sf::st_layers(gdb)
sf_hrcd <- sf::st_read(gdb, layer = "HRCD_ChangeLocations") |> #~4gb
  filter(StartYr >= 2011, EndYr <= 2017, WRIANr == 10) 
sf_aoi_hrcd <- sf_hrcd[sf_aoi,] |> 
  filter(CngOrigin != "Natural", ImpIncPct > 0)


# w = stringr::str_pad(x, width = 2, pad = "0")
# sf::st_read(
#   "~/T/DFW-Team WDFW Watershed Synthesis - data_common/SPTH_Tessellation.gdb",
#   layer = paste0("wria",w,"_SPTH_Tessellation")
# ) |> 
#   sf::st_zm() |>
#   dplyr::group_by(pid = permanent_identifier, zone = Zone) |>
#   dplyr::summarise(area = sum(Shape_Area), .groups = "drop") |> 
#   sf::st_write(  
#     dsn = paste0("wdfw_rde_spth200_tess_wria_",w,".gpkg"), 
#     layer = paste0("wria",w)
#   )
sf_rde <- st_read("wdfw_rde_spth200_tess_wria_10.gpkg")
sf_aoi_rde <- sf_rde[sf_aoi,]


# mapview::mapview(sf_aoi_cat, col.regions = NA) +
#   #mapview::mapview(sf_aoi_flw) +
# mapview::mapview(sf_aoi_flw_rp100, zcol = "urbhicatrp100_ac",
#                  col.regions = rev(wacolors::wacolors$volcano)) +
# mapview::mapview(sf_aoi_rde, zcol = "zone") +
# mapview::mapview(sf_aoi_hrcd, zcol = "ImpIncAc",
#                  col.regions = rev(wacolors::wacolors$forest_fire))

#pretty close, pending floodplain geometry inquiry
ggplot() +
  geom_sf(data = sf_aoi_cat, fill = NA) +
  geom_sf(data = sf_aoi_flw_rp100, aes(fill = urbhicatrp100_ac), color = NA, show.legend = F) +
  geom_sf(data = sf_aoi_rde |> st_crop(sf_aoi) |> filter(zone == "RMZ"), color = "green", fill = NA) +
  geom_sf(data = sf_aoi_rde |> st_crop(sf_aoi) |> filter(zone == "EOW"), color = "blue", fill = NA) +
  # geom_sf(data = sf_aoi_rde |> st_crop(sf_aoi), aes(color = zone), fill = NA) + 
  # scale_color_manual(name = "RDE zone", values = c("lightblue","green")) +
  geom_sf(data = sf_aoi_hrcd, fill = "grey40", color = "grey40") +
  wacolors::scale_fill_wa_c("volcano", reverse = T) +
  ggspatial::annotation_scale()

```

```{r tab_conceptual}
# sc_nlcd_year_sum |>
#   select(-ac) |> 
#   filter(aoi == "rp100") |>
#   nest(.by = nlcd_class) |> 
#   mutate(
#     ha_yr = map(data, ~lm(ha ~ nlcd_year, data = .) |> broom::tidy())
#   ) |> 
#   unnest(ha_yr) |> 
#   filter(term == "nlcd_year") |> 
#   select(nlcd_class, estimate) |> 
#   mutate(est = paste0(nlcd_class,": ", round(estimate, 1))) |> 
#   pull(est)


tibble(
  Characteristic = c(
    "Hydrography","RMZ buffer dimension", "Land cover resolution","Years",
    "Assessed riparian corridor (ha)",
    "Estimated annual impervious increase"),
  `RDE-HRCD` = c(
    "NHD (2022)", "SPTH~200~, varied (approx. 30-75m), +floodplains", "1m", "2011-2017", 
    round(wa_imp$reach_ha[4]) |> scales::number(big.mark = ",")
    , 
    paste0("impv: ",round(wa_imp$impv_ha_y[4]), ", semi:", round(wa_imp$semi_ha_y[4]))
    ),
  `StreamCat-NLCD` = c(
    "NHDPlus v2.1 1:100K", "100m, fixed", "30m", "2001-2019", 
    scales::number(100*round(sum(filter(sc_nlcd, nlcd_year==2011)$catareasqkmrp100)), big.mark = ",")
    ,
    sc_nlcd_year_sum |>
      select(-ac) |> 
      filter(aoi == "rp100", nlcd_year %in% c(2011, 2016)) |>
      pivot_wider(names_from = nlcd_year, values_from = ha) |> 
      mutate(nlcd_class = factor(nlcd_class, levels = c("urbhi","urbmd","urblo","urbop"))) |> 
      arrange(nlcd_class) |> 
      mutate(
        ha_yr = paste0(nlcd_class, ": ",round((`2016`-`2011`)/5,1))
      ) |> 
      pull(ha_yr) |> paste(collapse = ", ") )
) |> 
  gt::gt()
```


```{r fig_rankcimp_fldpct}
#need to better acknowledge that a small percentage of high-proportion-floodplain reaches account for a large percentage of impervious increase; top 10, or 0.134%, are 372ac or 15.9% total increase (tenth of a percent of all reaches are sixteen percent of impinc area); 99 of 7437 or 1.3% of reaches are 1000ac of 2300 total, etc.
rde_cnty |> 
  distinct(pid, .keep_all = T) |> 
  arrange(desc(nonfstry_impv_inc_ac)) |> 
  select(1:10, nonfstry_impv_inc_ac, nonfstry_semi_inc_ac) |> #1,084,186
  filter(nonfstry_impv_inc_ac > 0) |> #7437 of 1,084,186 have non-zero imp inc
  mutate(
    cimp = cumsum(nonfstry_impv_inc_ac),
    rank = dense_rank(cimp), 
    cimp_pct = cimp / sum(nonfstry_impv_inc_ac),
    n_pct = seq_along(cimp) / 7437,
    fld_pct = flood_ac / reach_ac,
    eow_pct = eow_ac / reach_ac,
    rmz_pct = rmz_ac / reach_ac
  ) |> 
  filter(cimp <= 1000) |> 
  # #print(n = 100)
  # ggplot() + geom_col(aes(seq_along(cimp), cimp))
  pivot_longer(cols = fld_pct:rmz_pct) |> 
  ggplot() + geom_col(aes(rank, cimp*value, fill = name), position = position_stack())

# rde_cnty |> 
#   distinct(pid, .keep_all = T) |> 
#   filter(nonfstry_impv_inc_ac > 0) |> 
#   ggplot() + stat_ecdf(aes(nonfstry_impv_inc_ac))

```

Results are presented for the full "riparian corridor" composed of the RMZ, EOW, and floodplain polygons associated with each reach unit. As noted previously, values presented relative to the stratification by county geographic boundaries reflect various combinations of federal, tribal, state, and municipal regulatory regimes, and are not due to the actions of a single management authority.

Statewide, the assessed reaches totaled `r round(wa_imp$reach_ha[4])` hectares, with `r round(wa_imp$rmz_ac[4]/wa_imp$reach_ac[4],3)`% consisting of RMZ (supp. fig 1). Variation in the NHD, soils and floodplain data underlying the polygon tessellation contributed to differences in the overall and proportional extent of the assessed riparian corridor throughout the state, both between and within county boundaries, but total reach area was an average of approximately 22% (median 17.3%, IQR 11.9% - 28.4%) of full county area (@fig-multi_map A, supp. fig 2). The largest areas of reaches associated with the distribution of Chinook salmon were in central and northern Puget Sound, with population and housing values also highest in the vicinity of Seattle, the state's largest urban area (@fig-multi_map B-D).

```{r}
#| label: fig-multi_map

#as_tibble(sf_cnty_rde) |> mutate(pct = reach_ac/cnty_ac) |> pull(pct) |> summary()

list(
  #range(rde_cnty_sum$reach_ac)
  reach_ac = sf_cnty_rde |>  
    ggplot() + geom_sf(aes(fill = ha*reach_ac), show.legend = T) + 
    #wacolors::scale_fill_wa_c("sea", reverse = T, na.value = "pink") +
    #wacolors::scale_fill_wa_c("sea", reverse = T, limits = c(25000, 500000), oob = scales::squish, na.value = "pink") +
    #wacolors::scale_fill_wa_b("sea", reverse = T, na.value = "pink") +
    scale_fill_gradient(name = "hectares", labels = scales::label_comma(), low = "#BEE7DF", high = "#212540", na.value = "pink") +
    labs(subtitle = "Total assessed riparian corridor\nRMZ+EOW+floodplain")
  ,
  # reach_ac_cnty_ac = sf_cnty_rde |> 
  #   ggplot() + geom_sf(aes(fill = reach_ac/cnty_ac), show.legend = F) + 
  #   #scale_fill_gradient(low = alpha("purple", 0.2), high = "purple", na.value = "pink") +
  #   scale_fill_gradient(low = "#BEE7DF", high = "#212540", na.value = "pink") +
  #   labs(subtitle = "Riparian corridor area / county area")
  # ,
   
  swifd_chin = sf_cnty_rde |>  
    ggplot() + geom_sf(aes(fill = ha*reach_ac_salmon_with_chin), show.legend = T) + 
    scale_fill_gradient(name = "hectares", low = alpha("salmon", 0.2), high = "salmon") +
    labs(subtitle = "Riparian + SWIFD Chinook")
  ,
  # swifd_chin_cnty = sf_cnty_rde |>  
  #   ggplot() + geom_sf(aes(fill = reach_ac_salmon_with_chin/cnty_ac), show.legend = F) + 
  #   scale_fill_gradient(low = alpha("salmon", 0.2), high = "salmon", na.value = "pink") +
  #   labs(subtitle = "Chinook / county area")
  # ,
  
  est_pop = sf_cnty_rde |>  
    ggplot() + geom_sf(aes(fill = `2011_est_pop`), show.legend = T) + 
    scale_fill_gradient(low = alpha("orange", 0.2), high = "orange", na.value = "pink") +
    labs(fill = NULL, subtitle = "2011 estimated population")
  ,
  # est_pop_cnty = sf_cnty_rde |>  
  #   ggplot() + geom_sf(aes(fill = `2011_est_pop`/cnty_ac), show.legend = F) + 
  #   scale_fill_gradient(low = alpha("orange", 0.2), high = "orange", na.value = "pink") +
  #   labs(subtitle = "Est. pop. / county area")
  # ,
  
  housing = sf_cnty_rde |>  
    ggplot() + geom_sf(aes(fill = `2011_total`), show.legend = T) + 
    scale_fill_gradient(low = alpha("purple", 0.2), high = "purple", na.value = "pink") +
    labs(fill = NULL, subtitle = "2011 total housing units")
  # ,
  # housing_cnty = sf_cnty_rde |>  
  #   ggplot() + geom_sf(aes(fill = `2011_total`/cnty_ac), show.legend = F) + 
  #   scale_fill_gradient(low = alpha("purple", 0.2), high = "purple", na.value = "pink") +
  #   labs(subtitle = "Housing / county area")
) |> 
  wrap_plots(ncol = 2) +
  plot_annotation(tag_levels = "A")

```

During the 2011-2017 period in these HRCD data, an estimated `r round(wa_imp$impv_inc_ha[4])` hectares of new impervious cover were added to the riparian corridor (table 1; `r round(wa_imp$impv_inc_ac[4])` acres), corresponding to an annual increase of `r round(wa_imp$ha_y[4])` ha/year (`r round(wa_imp$ac_y[4])` acres/year). 

The additional area of impervious cover in non-salmon reaches was similar to that of reaches associated with Chinook distribution, but this new impervious area was an order of magnitude higher percentage of the assessed riparian corridor in Chinook-associated reaches (0.1% vs 0.01%, @tab-statewide, @fig-statewide_swifd).

```{r}
#| label: tab-statewide

wa_imp |> 
  gt(caption = "2011-17 HRCD Impervious Increase within RDE Extent") |> 
#  cols_hide(ends_with("_ac")) |> 
  # gt::grand_summary_rows(
  #   columns = c(ends_with("_ac"), ends_with("_y")), 
  #   fns = list("total") ~ sum(.),
  #   fmt = ~fmt_number(., decimals = 0)) |> 
  fmt_number(decimals = 0) |> 
  fmt_percent(columns = "impv_reach_pct")
  
```

```{r}
#| label: fig-statewide_swifd

rde_cnty_swifd <- rde_cnty |> 
  distinct(pid, .keep_all = T) |> 
  summarise(
    across(
      c(reach_ac, riparian_ac, rmz_ac, eow_ac, flood_ac, nonfstry_impv_inc_ac, nonfstry_tree_dec_ac),
      ~sum(., na.rm = T)
    ),
    #.by = swifd_any
    .by = swifd_chin
  ) |> 
  mutate(
    across(
      starts_with("nonf"),
      list(
        #per_100ac = ~100*(./reach_ac)
        pct_rch = ~(./reach_ac)
      )
    )
  )

pal_swifd_chin <- c("not_salmon" = "tan", "salmon_not_chin" = alpha("salmon", 0.5), "salmon_with_chin" = "salmon")

# {
#   rde_cnty_swifd |> 
#     ggplot() +
#     geom_col(aes(
#       swifd_chin,
#       nonfstry_impv_inc_ac,
#       fill = swifd_chin),
#       show.legend = F) + 
#     scale_fill_manual(values = pal_swifd_chin) +
#     labs(x = "SWIFD status") 
# }/{
  rde_cnty_swifd |> 
    ggplot(aes(swifd_chin, nonfstry_impv_inc_ac_pct_rch)) +
    geom_col(aes(fill = swifd_chin), show.legend = F) + 
    geom_text(
      aes(label = paste('total ha.:', round(ha*nonfstry_impv_inc_ac)))
      ,nudge_y = -0.0001
    ) +
    scale_fill_manual(values = pal_swifd_chin) +
    scale_y_continuous(labels = scales::label_percent()) +
    labs(x = "SWIFD status", y = "Impervious increase proportion of riparian corridor") 
#}

```

Most individual change areas intersecting the riparian corridor were small, with nearly 95% less than 0.4ha (1ac) and a median increase of `r round(ha*median(filter(distinct(rde_cnty, pid, .keep_all=T), nonfstry_impv_inc_ac > 0)$nonfstry_impv_inc_ac),4)` ha, considerably less than the 900m^2 area of a single 30m pixel. This pattern was broadly consistent across portions of the state with more and less total increase (@fig-impv_inc_per_rch_boxes). 

```{r statewide_size_distrib, echo=FALSE, eval=FALSE}
rde_cnty |> 
  distinct(pid, .keep_all = T) |> 
  filter(nonfstry_impv_inc_ac > 0) |> #7541
  summarise(
    across(
      nonfstry_impv_inc_ac,
      list(
        q25 = ~quantile(., p = 0.25),
        q50 = ~median(.),
        q75 = ~quantile(., p = 0.75),
        pctless1ac = ~sum(.<1)/length(.)
        )
    )
  ) |> 
  pivot_longer(everything())

```

```{r}
#| label: fig-impv_inc_per_rch_boxes

# rde_cnty |> 
#   filter(nonfstry_impv_inc_ac > 0) |> 
#   ggplot(aes(
#     nonfstry_impv_inc_ac,
#     fct_reorder(cnty, nonfstry_impv_inc_ac)
#     )) +
#   geom_jitter(height = 0.2, alpha = 0.5, size = 0.4) +
#   #geom_boxplot(varwidth = T, outliers = F, fill = NA) + 
#   #wacolors::scale_fill_wa_c("volcano", reverse = T, na.value = "pink", aesthetics = c("fill","color")) +
#   labs(y = NULL, x = "acres")

{
rde_cnty |> 
  filter(nonfstry_impv_inc_ac > 0) |> #7541
  ggplot(aes(ha*nonfstry_impv_inc_ac)) +
  #geom_vline(xintercept = 0.09, linetype = 3) +
  stat_ecdf() +
  geom_jitter(aes(y = -0.1), height = 0.05, alpha = 0.2, size = 0.1) +
  labs(y = NULL, x = "hectares", subtitle = "Cumulative distribution of per-reach impervious cover increases")
}+{
rde_cnty |> 
  filter(nonfstry_impv_inc_ac > 0) |> #7541
  # filter(nonfstry_impv_inc_ac < 20) |> #7531
  filter(nonfstry_impv_inc_ac <= 1) |>  #7148
  ggplot(aes(
    ha*nonfstry_impv_inc_ac,
    fct_reorder(cnty, nonfstry_impv_inc_ac, sum)
    )) +
  geom_vline(xintercept = 0.09, linetype = 3) + #900m2
  geom_jitter(height = 0.2, alpha = 0.2, size = 0.2) +
  geom_boxplot(varwidth = T, outliers = F, color = "blue", linewidth = 0.3, fill = NA) + 
  labs(y = NULL, x = "hectares",
       subtitle = "Per-reach impervious cover increases up to 0.4 ha (1 acre)")
} + 
  plot_layout(heights = c(1/4,3/4)) + 
  plot_annotation( tag_levels = "A")
```

Qualitatively similar statewide estimates of riparian impervious change result from the high and medium urban NLCD cover classes (>80% and 50-80% impervious respectively) within the StreamCat 100m buffer on NHDPlus watercourses. Differencing the 2011 and 2016 imagery years yields an increase of `r 30157-28642`ha (@tab-sc_statewide) for the combination of these classes, and a simple OLS linear regression on NLCD year indicates an average annual increase of approximately 338ha/year for the sum of both classes during the full 2001-2019 period (@fig-sc_nlcd_statewide_urb_year; approx. 73ha/yr for high, 265ha/yr medium). The low and open urban NLCD classes are designated as representing 50-20% and <20% impervious respectively, and the associated total area therefore includes considerable non-impervious surface. Including these classes did not alter the basic pattern of overall increase since 2001 and during the focal HRCD years, despite the modest decline in the NLCD urban open class. 

```{r}
#| label: tab-sc_statewide

# sc_nlcd_year_sum |> 
#   mutate(across(c(ha, ac), round)) |> 
#   pivot_wider(names_from = aoi, values_from = c(ha, ac)) |> 
#   gt(groupname_col = "nlcd_year") |>
#   summary_rows(columns = starts_with("ha"), fns = list(total = ~sum(.)),
#                fmt = ~fmt_number(., decimals = 0)) |> 
#   fmt_number(columns = c(starts_with("ha"), starts_with("ac")), decimals = 0)

sc_nlcd_year_sum |> 
  mutate(across(c(ha, ac), round)) |> 
  filter(aoi == "rp100") |> select(-ac) |> 
  pivot_wider(names_from = nlcd_class, values_from = c(ha)) |> 
  mutate(
    hi_md = urbhi + urbmd,
    hi_md_lo = urbhi + urbmd + urblo
    ) |>
  select(nlcd_year, High = urbhi, Medium = urbmd, Low = urblo, Open = urbop, `H+M` = hi_md, `H+M+L` = hi_md_lo) |> 
  gt(rowname_col = "nlcd_year", caption = "Est. hectares NLCD urban cover in StreamCat 100m riparian buffer") |>
  fmt_number(columns = !contains("nlcd"), decimals = 0) |> 
  tab_style(style = cell_fill(), locations = cells_body(columns = "H+M")) |> 
  tab_style(style = cell_text(weight = 'bold'), locations = cells_body(columns = "H+M", rows = nlcd_year %in% c(2011, 2016)))

# lm(
#   ha ~ nlcd_year,
#   data = sc_nlcd_year_sum |>
#     filter(aoi == "rp100", 
#            #str_detect(nlcd_class,"hi|md")
#            # str_detect(nlcd_class,"hi")
#            str_detect(nlcd_class,"md")
#            ) |>
#     summarise(across(ha, sum), .by = nlcd_year)
#   ) |>
#   broom::tidy()
#mid range 0.9*73 + 0.65*265 ~= 238/y is still > 160/y
#but low end: 0.8*73 + 0.5*265 ~191 is awfully close

```

```{r}
#| label: fig-sc_nlcd_statewide_urb_year

sc_nlcd_year_sum |> 
  filter(aoi == "rp100") |> select(-ac) |> 
  mutate(nlcd_class = factor(nlcd_class, levels = c("urbhi","urbmd","urblo","urbop"))) |> 
  ggplot(aes(nlcd_year, ha, group = nlcd_class, fill = nlcd_class)) +
  geom_col(show.legend = F) +
  # ggpmisc::stat_poly_line(se = F, show.legend = F) +
  # #ggpmisc::stat_poly_eq(ggpmisc::use_label(c("adj.R2", "p"))) +
  # ggpmisc::stat_fit_tidy(
  #       method = "lm",
  #       label.x = "left", label.y = "top", vjust = -0.7,
  #       method.args = list(formula = y ~ x),
  #       mapping = aes(
  #         label = sprintf(
  #           "est. slope = %.0f/yr", #"Slope = %.3g\np-value = %.3g",
  #           after_stat(x_estimate)#, after_stat(x_p.value)
  #           )
  #         ) #, color = "blue"
  #     ) +
  scale_fill_manual(values = pal_nlcd) +
  scale_y_continuous(labels = scales::label_comma()) +
  coord_cartesian(clip = "off") +
  facet_wrap(~nlcd_class, scales = "free", 
             labeller = as_labeller(c('urbhi' = "A: High", 'urbmd' = 'B: Med.', 'urblo' = 'C: Low', 'urbop' = 'D: Open'))) +
  theme(strip.text = element_text(hjust = 0.1))
  
```

When aggregated by county boundaries, the largest impervious increases were concentrated in more heavily urbanized portions of the state, congruent with expectations based on the geographic distributions of population and housing. Summed change areas were greatest in proximity to the large and rapidly growing metropolitan areas of Seattle, Tacoma, and Vancouver in western Washington (King, Pierce, Clark) and Spokane and the Tri-Cities in the east (@fig-impv_inc_ha_map).

```{r}
#| label: fig-impv_inc_ha_map
 
#can add Oly and Yakima, Pasco/Richland etc. with str_detect(name)
sf_wa_city <- maps::us.cities |> 
      filter(country.etc == "WA", pop > 150000) |> 
      mutate(name = str_remove(name, " WA")) |> 
      sf::st_as_sf(coords = c("long", "lat"), crs = 4326) |> 
      sf::st_transform(epsg)

sf_cnty_rde |>
  ggplot() + geom_sf(aes(fill = ha*impv_inc_ac), color = "white", show.legend = T) +
  geom_sf(data = sf_wa_city, color = "brown", show.legend = F) +
  geom_sf_text(data = sf_wa_city, aes(label = name), color = "brown", hjust = 1.1, show.legend = F) +
  scale_fill_gradient(name = "ha", low = "grey90", high = "grey10") +
  labs(
    x = NULL, y = NULL,
    title = "Riparian impervious cover increase 2011-2017", 
    subtitle = "Sum of HRCD estimates, RMZ+EOW+floodplain") +
  theme(legend.position = "bottom",
        legend.key.height = unit(0.05, "npc"),
        legend.key.width = unit(0.15, "npc")
        )

```

Normalizing impervious increase by the total riparian corridor (i.e., summed reach area within county boundary) highlighted differences in the relative density of change (@fig-impv_inc_ac_pct_reach). King county's boundaries contained the largest aggregate increase, but those within Pierce and Clark county extents both formed a larger proportion of the assessed area. Conversely, though total increases were smaller within the Kitsap, Island, and Benton boundaries, these changes made up higher proportions of the riparian corridor.

```{r}
#| label: fig-impv_inc_ac_pct_reach

{
rde_cnty_sum |> 
  ggplot(aes(ha*reach_ac, ha*impv_inc_ac)) +
  geom_point(size = 0.3, show.legend = F) + 
  geom_text(aes(label = cnty), size = 3, check_overlap = T,
            hjust = -0.1, vjust = 0,
            show.legend = F) + 
    scale_x_continuous(labels = scales::label_comma()) +
  labs(
    x = "Summed riparian corridor (ha)", 
    y = "Summed impervious increase (ha)",
    title = "Impervious increases aggregated to county boundaries") 
}/{
  rde_cnty_sum |> 
  #ggplot(aes( (ha*impv_inc_ac)/(ha*reach_ac), cnty)) +
  ggplot(aes( impv_inc_ac_pct_rch, fct_reorder(cnty, impv_inc_ac_pct_rch))) +
  geom_point(aes(size = ha*impv_inc_ac), show.legend = F) + 
    scale_size_area(max_size = 4) +
    scale_x_continuous(labels = scales::label_percent()) +
  labs(
    x = "Percentage of assessed riparian corridor",
    y = NULL) 
} +
  plot_annotation(tag_levels = "A")

```

Population increases during 2011-2017 were positively correlated with the normalized impervious increase in the riparian corridor, but considerable variation was evident among county-boundary aggregates. For example, the King and Clark areas had population gains greater than that within the Pierce boundary, but smaller proportional impervious increases. Conversely, the Kitsap extent had the fourth largest normalized impervious increase despite less population growth than many other areas (@fig-impv_inc_pop_change). A comparable pattern was evident for changes in housing units, with substantial variation around a generally positive correlation (@fig-impv_inc_housing_change). The King and Island county extents were notable for the, respectively, large and small housing gains relative to proportional riparian corridor impervious additions. 

```{r}
#| label: fig-impv_inc_pop_change

# rde_cnty_sum |>
#   ggplot(aes(impv_inc_ac_pct_rch, log10(d_est_pop))) +
#   geom_point(aes(size = `2011_est_pop`, color = `2011_est_pop`)) +
#   geom_text(aes(label = cnty), hjust = 1.1, size = 3, check_overlap = T) +
#   scale_size_area(max_size = 4, guide = "none") +
#   scale_color_gradient(name = "2011 est. pop. x1000", low = alpha("orange", 0.6), high = "brown", labels = scales::label_number(scale = 1/1000)) +
#   scale_y_continuous(name = "log10 population change 2011-2017", labels = scales::label_log(digits = 1)) +
#   scale_x_continuous(name = "Percentage of assessed riparian corridor", labels = scales::label_percent()) +
#   theme(
#     legend.position = "bottom", legend.key.width = unit(0.1, "npc")
#   )

rde_cnty_sum |> 
  #ggplot(aes(d_est_pop/`2011_est_pop`, impv_inc_ac_pct_rch)) +
  # scale_x_continuous(name = "population change 2011-2017", labels = scales::label_percent()) +
  # scale_y_continuous(name = "Percentage of assessed riparian corridor", labels = scales::label_percent())
  ggplot(aes(impv_inc_ac_pct_rch, d_est_pop/`2011_est_pop`)) +
  geom_point(aes(size = `2011_est_pop`, color = `2011_est_pop`)) +
  geom_text(aes(label = cnty), hjust = -0.1, size = 3, check_overlap = T) +
  scale_size_area(max_size = 4, guide = "none") +
  scale_color_gradient(
    name = "2011 est. pop. x1000",
    low = alpha("orange", 0.6), high = "brown", labels = scales::label_number(scale = 1/1000)) +
  scale_y_continuous(name = "Population change 2011-2017", labels = scales::label_percent()) +
  scale_x_continuous(name = "Percentage of assessed riparian corridor", labels = scales::label_percent()) +
  coord_cartesian(xlim = c(-0.0001, 0.002), ylim = c(-0.01, .13), expand = F) +
  theme(
    legend.position = "bottom", legend.key.width = unit(0.1, "npc")
  )
  
```

```{r}
#| label: fig-impv_inc_housing_change

rde_cnty_sum |>
  # select(cnty, impv_inc_ac_pct_rch, d_total, d_single, d_multi) |> 
  # pivot_longer(starts_with("d_")) |> 
  # ggplot(aes(impv_inc_ac_pct_rch, value, color = name)) +
  # facet_wrap(~name, ncol = 1, scales = "free")
  ggplot(aes(impv_inc_ac_pct_rch, d_total)) +
  geom_point(color = "purple", size = 0.8) + # aes(size = `2011_total`)
  geom_text(aes(label = cnty), hjust = 1.1, size = 3, check_overlap = T) +
  scale_x_continuous(name = "Percentage of assessed riparian corridor", labels = scales::label_percent()) +
  scale_y_continuous(name = "Change in total housing units", labels = scales::label_comma()) 

```

# Discussion

 - clarify that HRCD offers retrospective look at what happened within riparian corridor that was not necessarily regulated as critical area Fish and Wildlife Habitat Conservation Areas FWHCA

We analyzed high resolution land cover change data within an ecologically-grounded riparian corridor to quantify the magnitude of new impervious area in Washington state. A statewide estimate of `r round(wa_imp$impv_inc_ha[4])`ha (`r round(wa_imp$impv_inc_ac[4])` acres) during 2011 to 2017 represented `r round(100*wa_imp$impv_reach_pct[4], 3)`% of the total assessed extent. This estimate might be viewed as both a small portion of the entire riparian corridor and a large new addition to a sensitive portion of watersheds already subject to extensive alteration.

Riparian buffer dimensions that define the jurisdictional extent of management regimes far from uniform, with a range of legally stipulated values in state regulations and local critical area ordinances (Folkerts et al. 2020). This legal variation is in addition to the heterogeneity in realized on-the-ground conditions within any particular management domain (Swartz et al 2024). The 200-year Site Potential Tree Height standard in WDFW guidance has policy influence as a formulation of best available science, but it does not necessarily determine the footprint of protected areas. 

The full riparian corridor examined in this analysis does not represent any specific authority, and it is broader than many current management zones. These results may therefore over-estimate new impervious cover relative to the highly varied mosaic of currently binding buffer distances. Regardless of legal circumstances, however, the assessed corridor has hydrologic and ecological significance to in-channel conditions, and the RDE RMZ tessellation is based on hydrography (NHD) that is missing extensive lengths of the smaller, sometimes intermittent or ephemeral channels that contribute significantly to water quantity and quality (Brinkerhoff et al 2024). These factors increase the likelihood that this analysis under-estimates the overall functional impacts to aquatic ecosystems. 

In addition to the uncertainty in hydrography and site index values on which SPTH~200~ dimensions are based, some residual error persists in the high resolution change polygons despite their manual review. These sources combine to prevent a straightforward estimate of the full uncertainty in the presented values. However, convergence of the independent RDE-HRCD and StreamCat-NLCD approaches presented here, as well as the estimates developed by Lazarus (2023), lends confidence to an estimate in the hundreds of hectares a year. Even imposing an arbitrary 25% reduction still produces values on this order of magnitude. This raises questions about whether regulation and permitting subject to a project-specific "no net loss" standard can have achieved the preservation of function at a cumulative scale. If hundreds of acres of impervious cover are not being removed each year, what actions have offset those that are being added?

Moreover, the addition of upland imperviousness outside of this or any other assessed corridor from 10m to 100m has some effect on riparian and in-channel conditions (e.g., a 30m "buffer" is unlikely to have the same function within a primarily forested catchment as it does as a distinct strip adjacent to converted land). Beyond site-specific slopes and soils, the surrounding watershed context for data collection and analysis has inevitably shaped our understanding of the functional dimensions that underlie buffer formulations. The applicability of distance-decay curves likely warrants review as increasing upland imperviousness continues to alter flow paths away from saturation-excess and towards infiltration-excess dynamics. While an SPTH standard allows for some flexibility to avoid prescribing a single critical area dimension, the basic concept may be invalidated where upland surface alteration has rendered even some simple multiple of SPTH (2x or 5x etc.) insufficient to perform all desired functions.

This comparison indicates only general patterns in the configuration of land cover conversion, with various anthropogenic changes such as roads, warehouses, and other commercial spaces combined with those due to residential construction. Moreover, the summarization of changes within county boundary extents did not generate replicates suited to statistical contrast without additional longitudinal observations; as noted, these "counties" included multiple authorities, had varying hydrographic error, and are affected by distinct socio-ecological histories. Nonetheless, the variation among them in the relationships between area-normalized impervious increases, population, and housing suggests the potential for growth to come at different costs in terms of riparian condition and function (@fig-impv_inc_pop_change). Lambert et al. (2025), offered a related empirical demonstration of the alternative outcomes for habitat from policies shaping land use, showing that similar housing gains in western Washington census block groups were accompanied by substantially different amounts of tree canopy loss. Further study is needed to better disentangle the complex set of interacting factors that likely contributed to the range in riparian impervious increases accompanying similar population changes.


## Next steps

Lazarus (2023) considered a statewide extent, using the National Land Cover Dataset (NLCD) and Cropland Data Layer (CDL) to examine the relative prevalence of vegetation and impervious cover classes within alternative riparian buffer configurations on lands stratified by public and private ownership. This analysis sought to address a holistic set of shifts among multiple land uses across Washington's varied ecoregions, but an increase in impervious-type classes was broadly apparent, estimated to total more than 4,500 ha (>11,000 acres) in the SPTH~200~ buffer between 2001 and 2019 (see table 16, as the combination of all 4 NLCD 'developed' classes).  


  - The premise that social, political, and economic values inform any answer to "how wide should a riparian buffer be" led to separation of the technical review and policy recommendations ([Wilhere and Quinn 2018](https://digitalrepository.unm.edu/nrj/vol58/iss2/13/), Chapman et al. 2020). 
  - Among other legal and economic shifts, this period follows the initial passage of the GMA in 1990 and the federal endangered species listings of several salmon populations during the 1990s, and it offers a perspective on the outcomes of recent practices with relevance to ongoing land use policy debates.


  - fluviosclerosis
  
  - more on SWIFD/Chinook?

  - 3DHP RMZs from geomorphically informed SPTH~200~ 
  
  - Stormwater, 6PPDQ (coho)

  - [task force recs](https://ofm.wa.gov/sites/default/files/public/publications/RiparianTaskforcePreliminaryRecommendationsMay2024.pdf)

  - Add county level population change numbers? fit: urb_ac_rp100 ~ year + pop + housing
  - capture that per-person increases decreasing even as abs continues to increase? or just use bookend pop numbers [now seeing this was done in Powell et al (fig 6, continuously) and Bartz et al (text, bookends)]
 

see sc_ripcorr_nlcd for initial lit notes

Hepinstall-Cymerman, J., S. Coe, and L.R. Hutyra. 2013. Urban growth patterns and growth management boundaries in the central Puget Sound, Washington, 1986–2007. Urban Ecosystems 16:109–129.

Kennedy, R.E., Z. Yang, J. Braaten, C. Copass, N. Antonova, C. Jordan, and P. Nelson. 2015. Attribution of disturbance change agent from Landsat time-series in support of habitat monitoring in the Puget Sound region, USA. Remote Sensing of Environment 166:271-285.

[UW MS thesis]
Nayak (2023) focused on the Cedar River-Lake Washington watershed, reporting a measurable increase in impervious surface area within 54 identified riparian zones, noting that 21st-century growth is more nuanced due to zoning policies, yet significant enough to influence water quality and hydrology.

Nayak, S., 2023. Impact of Riparian Landscape Patterns on Water Quality in an Urbanizing River Basin: A Case of Cedar River-Lake Washington Watershed. Master's thesis. University of Washington. Available at: https://digital.lib.washington.edu/researchworks/bitstream/handle/1773/49961/Nayak_washington_0250O_23832.pdf?sequence=1 [Accessed 4 August 2025].


Maxwell, A.E., Strager, M.P., Warner, T.A., Ramezan, C.A., Morgan, A.N. and Pauley, C.E., 2019. Large-area, high spatial resolution land cover mapping using random forests, GEOBIA, and NAIP orthophotography: Findings and recommendations. Remote Sensing, 11(12), p.1409.
https://www.mdpi.com/2072-4292/11/12/1409

Zhang, H., Gorelick, S.M. and Zimba, P.V., 2020. Extracting impervious surface from aerial imagery using semi-automatic sampling and spectral stability. Remote Sensing, 12(3), p.506.
https://www.mdpi.com/2072-4292/12/3/506

Subedi, M.R., Portillo-Quintero, C., Kahl, S.S., McIntyre, N.E., Cox, R.D. and Perry, G., 2023. Leveraging NAIP imagery for accurate large-area land use/land cover mapping: A case study in central Texas. Photogrammetric Engineering & Remote Sensing, 89(9), pp.547-560.
https://www.ingentaconnect.com/contentone/asprs/pers/2023/00000089/00000009/art00007?crawler=true&mimetype=application/pdf


# Conclusion

Washington is a leader in careful land and water use management, striving to encourage vibrant human communities without compromising the natural systems that make them possible. Yet at a statewide scale, high resolution data indicate that hundreds of acres are still being converted to impervious surface each year within sensitive riparian corridors. Attention to this ongoing change will be critical to continued progress towards salmon recovery and other valued aspects of ecological integrity.

# Acknowledgements

# Citations

Chapman, M., Satterfield, T., & Chan, K. M. A. 2020. How value conflicts infected the science
of riparian restoration for endangered salmon habitat in America’s Pacific Northwest:
Lessons for the application of conservation science to policy. Biological Conservation,
244, 108508. https://doi.org/10.1016/j.biocon.2020.108508

Fausch, K.D., Torgersen, C.E., Baxter, C.V. and Li, H.W., 2002. Landscapes to riverscapes: bridging the gap between research and conservation of stream fishes: a continuous view of the river is needed to understand how processes interacting among scales set the context for stream fishes and their habitat. BioScience, 52(6), pp.483-498.

Hill, Ryan A., Marc H. Weber, Scott G. Leibowitz, Anthony R. Olsen, and Darren J. Thornbrugh, 2016. The Stream-Catchment (StreamCat) Dataset: A Database of Watershed Metrics for the Conterminous United States. Journal of the American Water Resources Association (JAWRA) 52:120-128. DOI: 10.1111/1752-1688.12372.

Knutson, K. L., and Naef, V. L. 1997. Management recommendations for Washington’s priority
habitats: Riparian (p. 181pp.). Washington Department of Fish and Wildlife. https://wdfw.wa.gov/sites/default/files/publications/00029/wdfw00029.pdf

Lazarus, D., 2023. Current Status of Riparian Buffers in Washington State: Public and Private Land Cover Within Riparian Management Zones Based on Best Practice Guidelines (MES thesis, Evergreen State College).

Maxwell, A. E., T. A. Warner, B. C. Vanderbilt, and C. A. Ramezan. 2017. Land cover classification and feature extraction from National Agriculture Imagery Program (NAIP) Orthoimagery: a review. Photogrammetric Engineering & Remote Sensing 83:737–747.

Pierce Jr, K.B., 2015. Accuracy optimization for high resolution object-based change detection: An example mapping regional urbanization with 1-m aerial imagery. Remote Sensing, 7(10), pp.12654-12679.

Quinn, T., G.F. Wilhere, and K.L. Krueger, technical editors. 2020. Riparian Ecosystems, Volume 1: Science Synthesis
and Management Implications. Habitat Program, Washington Department of Fish and Wildlife, Olympia. https://wdfw.wa.gov/publications/01987

Rentz, R., A. Windrope, K. Folkerts, and J. Azerrad. 2020. Riparian Ecosystems, Volume 2: Management Recommendations.
Habitat Program, Washington Department of Fish and Wildlife, Olympia. https://wdfw.wa.gov/publications/01988

WDFW. 2024. A new way of looking at Washington’s waterways. Medium. https://wdfw.medium.com/a-new-way-of-looking-at-washingtons-waterways-ad05d872c4ce 

Weber M (2025). _StreamCatTools: Tools to Work with the StreamCat API Within R and Access the Full Suite of StreamCat and LakeCat Metrics_. R package version 0.6.0, commit d8a8cce142e7cb9e3666a2660a8315a1766e5981, <https://github.com/USEPA/StreamCatTools>.

Wilhere G and Quinn T. 2018. How Wide is Wide Enough?: Science, Values, and Law in Riparian Habitat Conservation, 58 Nat. Resources J.279, https://digitalrepository.unm.edu/nrj/vol58/iss2/13/

# Supplementary info

```{r gg_rde_cnty_zones_stacked_cols}
#showing the relative/proportional composition of 'zones'
rde_cnty_sum |>
  mutate(cnty = factor(cnty) |> fct_reorder(reach_ac)) |>
  select(cnty, rmz_ac, eow_ac, flood_ac) |>
  pivot_longer(-cnty) |>
  #filter(name == "eow_ac") |> #Grant Co really does have numerous large lakes and reservoirs
  ggplot() + geom_col(aes(value, cnty, fill = name)) +
  scale_x_continuous(labels = scales::label_comma()) +
  scale_fill_manual(name = "RDE zone", values = c("lightblue","darkgreen","green")) +
  labs(x = NULL, y = NULL)

```

```{r gg_rde_cnty_sum_reach_pct_cnty}
{
sf_cnty_rde |> 
  mutate(pct = reach_ac/cnty_ac) |> 
  ggplot() + 
  geom_sf(aes(fill = pct)) +
  scale_fill_gradient(name = "reach / cnty", low = grey(0.8), high = grey(0.2))
}/{
as_tibble(sf_cnty_rde) |> 
  mutate(pct = reach_ac/cnty_ac) |> 
  ggplot() + 
  geom_col(aes(pct, fct_reorder(cnty, pct, identity), fill = pct)) +
    scale_fill_gradient(name = "reach / cnty", low = grey(0.8), high = grey(0.2)) +
  scale_x_continuous("Proportion of county area", labels = scales::label_percent()) +
  labs(y = NULL)
} +
  plot_annotation("Assessed reach area as proportion of county boundary extent")
```

```{r gg_rde_cnty_housing_stacked_cols}
rde_cnty_sum |>
  mutate(cnty = factor(cnty) |> fct_reorder(`2011_total`)) |>
  select(cnty, `2011_single`, `2011_multi`, `2011_other`) |>
  pivot_longer(-cnty) |>
  ggplot() + geom_col(aes(value, cnty, fill = name)) +
  scale_x_continuous(labels = scales::label_comma()) +
  scale_fill_manual(name = "Housing", values = c("brown","yellow","tan")) +
  labs(x = NULL, y = NULL, title = "2011 housing composition")
```

```{r gg_impv_vs_pop}
#really potentially misleading?
rde_cnty_sum |> 
  mutate(
    pct_impv = impv_inc_ac / sum(impv_inc_ac),
    pct_pop = d_est_pop / sum(d_est_pop)
  ) |> 
  ggplot(aes(pct_pop, pct_impv)) +
  geom_abline() +
  geom_point() +
  geom_text(aes(label = cnty)) +
  labs(title = "Statewide proportion impv vs pop")
```

```{r gg_impv_vs_tree_dec}

rde_cnty_sum |> #glimpse()
  #ggplot(aes(tree_dec_ac_pct_rch, impv_inc_ac_pct_rch)) +
  ggplot(aes(impv_inc_ac_pct_rch, tree_dec_ac_pct_rch)) +
  geom_point() +
  geom_text(aes(label = cnty))

# rde_cnty |> 
#   drop_na(nonfstry_impv_inc_ac) |> 
#   distinct(pid, .keep_all = T) |>
#   filter(nonfstry_tree_dec_ac + nonfstry_impv_inc_ac > 0) |> 
#   filter(nonfstry_tree_dec_ac + nonfstry_impv_inc_ac < 2) |> 
#   ggplot(aes(nonfstry_tree_dec_ac, nonfstry_impv_inc_ac)) +
#   geom_abline(linetype = 3) +
#   #geom_point(size = 0.1, alpha = 0.3)
#   #geom_hex()
#   geom_bin2d()

```

```{r gg_rde_cnty_per_reach_imp_inc_pct_reach_ac}
#could also show as pct = nonfstry_impv_inc_ac / reach_ac
rde_cnty |> 
  filter(nonfstry_impv_inc_ac > 0) |> #7541
  ggplot(aes(
    nonfstry_impv_inc_ac / reach_ac,
    fct_reorder(cnty, nonfstry_impv_inc_ac, sum)
    )) +
  geom_jitter(height = 0.2, alpha = 0.5, size = 0.4) +
  geom_boxplot(varwidth = T, outliers = F, color = "orange", fill = NA) + 
  scale_x_continuous(labels = scales::label_percent()) +
  labs(y = NULL, x = NULL,
       title = "Per-reach impervious cover increases as percentage of reach area",
       subtitle = "Reach acres = RMZ plus EOW and floodplain where present"
       )
```

```{r proportional_scatters, echo=F, eval=FALSE}
# #housing unit density relative to proportion riparian? 
# #need to think about this - maybe better as 11_17 arrows showing change in density, maybe also against 11_17 impv_inc
# as_tibble(sf_cnty_rde) |> 
#   mutate(cnty_ac = st_area(geometry) |> units::set_units("acres") |> as.numeric()) |> 
#   select(cnty, cnty_ac, reach_ac, `2011_total`, `2011_single`, `2011_multi`, `2011_other`) |>
#   pivot_longer(-c(cnty, cnty_ac, reach_ac)) |>
#   mutate(
#     reach_cnty_ac = reach_ac/cnty_ac,
#     hu_cnty_ac = value/cnty_ac, #density relative to overall boundaries
#     hu_reach_ac = value/reach_ac, #density relative to riparian corr
#     cnty = factor(cnty) |> fct_reorder(hu_cnty_ac)
#     ) |>
#   filter(name == "2011_total") |> 
#   ggplot() +
#   geom_point(aes(reach_cnty_ac, hu_cnty_ac), size = 0.4) +
#   geom_text(aes(reach_cnty_ac, hu_cnty_ac, label = cnty), size = 3) +
#   facet_wrap(~name, scales = "free")
# 

```

```{r gg_nonfstry_impv_inc_ac_per_100ac_vs_abs, echo=F, eval=F}
{
rde_cnty_sum |> 
  ggplot(aes(impv_inc_ac, impv_inc_ac_per_100ac)) +
  geom_point(size = 0.3, show.legend = F) + 
  geom_text(aes(label = cnty), size = 3, check_overlap = F,
            #nudge_x = 3, 
            hjust = 0, vjust = 1.2,
            #position = position_dodge(width = 0.01),
            show.legend = F) + 
  #geom_smooth(method = "lm") +
      coord_cartesian(xlim = c(100, 650), ylim = c(0.02, 0.18), expand = F) +
  labs(
    x = "Total acres", y = "Acres imp. inc. per 100ac",
    title = "Impervious increases by county,\narea normalized vs absolute area") 
}/{
rde_cnty_sum |> 
  ggplot(aes(impv_inc_ac, impv_inc_ac_per_100ac)) +
  geom_point(size = 0.3, show.legend = F) + 
  geom_text(aes(label = cnty), size = 3, check_overlap = T,
            nudge_x = 0.5, hjust = 0,
            show.legend = F) + 
  #geom_smooth(method = "lm") +
  coord_cartesian(xlim = c(0,75), ylim = c(0, 0.08)) +
  labs(
    x = "Total acres", y = "Acres imp. inc. per 100ac",
    subtitle = "Counties with <75ac total increase") 
}
```

::: {.content-hidden when-format="html" when-format="docx"}

:::
