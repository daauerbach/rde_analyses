---
title: "High resolution, landscape scale assessment of riparian impervious cover change"
date: "`r Sys.Date()`"
format:
  docx: 
    reference-doc: /Users/auerbdaa/O/code/quarto_template.docx

  html:
    embed-resources: true
    theme: yeti 
    code-fold: true
    toc: true
    toc-location: left
    grid:
      sidebar-width: 180px
      body-width: 1100px
      margin-width: 20px
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  warning = FALSE, message = FALSE, fig.width = 7, fig.height = 9)

library("tidyverse", quietly = T)
library("sf")
library("patchwork")
library("gt")
theme_set(theme_minimal()) 

dir_data_common <- "~/T/DFW-Team WDFW Watershed Synthesis - data_common"
epsg <- 2927 #WA state standard; NAD83(HARN)/ft
ha <- 0.404686

sf_wrias <- sf::read_sf(file.path(dir_data_common, "WR_WAT_WRIA.gdb/")) |>
  mutate(
    wria = factor(WRIA_NR),
    wria_nr_nm = paste0(str_pad(WRIA_NR,width = 2, pad = "0",),"_",WRIA_NM) |> factor()) |>
  select(WRIA_NR, WRIA_NM, wria, wria_nr_nm, acres = WRIA_AREA_ACR_QT) |> arrange(wria) |> 
  sf::st_transform(sf::st_crs(epsg))

sf_cnty <- sf::read_sf(file.path(dir_data_common, "WA_County_Boundaries/WA_County_Boundaries.shp")) |> 
  select(cnty = JURISDIC_2) |> 
  sf::st_transform(sf::st_crs(epsg))

sf_wa_city <- maps::us.cities |> 
  filter(country.etc == "WA", str_detect(name, "Seattle WA|Tacoma|Olympia|Vancouver|Yakima|Spokane")) |> 
  mutate(name = str_remove(name, " WA")) |> 
  sf::st_as_sf(coords = c("long", "lat"), crs = 4326) |> 
  sf::st_transform(epsg)

```

# Authors

Daniel A Auerbach (dan.auerbach@dfw.wa.gov; ORCID: 0000-0002-3655-5206; corresponding author)

Kenneth B Pierce, Ken Muir, Keith Folkerts, Robin Hale, Kara A Whittaker, Simone Des Roches (ORCID 0000-0002-5360-8197)

Habitat Program, Washington Department of Fish and Wildlife, Olympia, Washington, United States of America

Danielle Lazarus, John Withey 

Graduate Program on the Environment, Evergreen State College, Olympia, Washington, United States of America

# Keywords

Riparian, Land Cover, Impervious surface, Cumulative Assessment

# Statements and Declarations

The authors have no relevant financial or competing interests to disclose. Funding for generation of High Resolution Change Detection and Riparian Data Engine was provided by the Washington State operating budget for fiscal years 2022-2024.

# Abstract

Riparian ecosystems provide numerous services but face various threats to their integrity. Construction of impervious surfaces alters watershed hydrology and can degrade riparian ecological functions, and environmental assessments of whole river networks are needed to characterize these risks at landscape scales. To perform such an assessment we examined recent changes in impervious land cover within riparian areas in Washington State, USA. We generated statewide estimates based on a 1m high resolution change detection (HRCD) dataset for 2011-2017, derived from aerial imagery and intersected with a variable width riparian buffer based on current management guidance. We compared these against estimates based on 30m resolution classified satellite imagery within a fixed buffer on a coarser stream network. We also estimated the 2021 standing impervious area within the variable width buffer extent of the western portion of the state using an independent 1m land cover layer. The high resolution datasets better captured the location and size distribution of individual changes, with changes consisting of a few larger areas and many that were smaller than a single 30x30m pixel. In aggregate, both change estimates indicated statewide increases of impervious surfaces in riparian areas on the order of hundreds of hectares per year during the early and middle 2010s. 

[new result]

Much of the observed change likely occurred outside of the jurisdictional extent of riparian land use regulation at the time, confirming that habitat impairment from new impervious surface remains a major threat and underscoring the importance of aligning regulated buffer widths with the dimensions needed to protect riparian ecosystem functions.

# Introduction

Waters and uplands meet and mingle at the riparian ecological edge. The physical and biological exchanges in these dynamic land-water interactions provide numerous services valued by people: maintenance of water quality through pollutant removal and shading, formation of in-channel habitat and wildlife corridors, and flood attenuation (Quinn et al. 2020). Yet human activities have degraded riparian structure and function in many locations (Nilsson and Berggren 2000), leading to the development of laws and policies to protect and rehabilitate these critical areas (González et al. 2017, Graziano et al. 2022).

The construction of impervious surfaces is one such threat to riparian ecological integrity. In addition to direct loss of terrestrial habitat, replacing native vegetation with concrete and other built elements prevents infiltration and alters watershed flow paths, impairing water quality and channel form (Schueler et al. 2009). Limiting this damage while accommodating multiple land uses is a core regulatory challenge, but decentralized permitting processes make landscape scale status assessments critical to determine progress towards policy goals. Such evaluation poses considerable technical challenges, however, and may fall outside the direct responsibility of any single agency or authority.

In the western United States, considerable uncertainty still surrounds basic measures of change and condition at the landscape scale despite the well-understood importance of riparian areas and the attention devoted to their study. Although riparian ecosystems have experienced substantial ecological shifts following European colonization (Patten 1998, Poff et al. 2011), the lack of quantitative estimates hinders effective communication around policy objectives. For example, the process of defining regional restoration targets and negotiating the associated public expenditures clearly benefits from well-supported estimates of alteration. This analysis quantifies riparian imperviousness at larger regional scales, using Washington State to examine outcomes and remaining challenges from approaches based on readily available public datasets.

Past research has indicated likely trends without clearly characterizing statewide riparian conditions in Washington. Jones et al. (2010) considered late 20th century land cover change (1973-2003) at a relatively coarse spatial resolution (60m) within a 180m buffer of National Hydrography Dataset (NHD) watercourses in several thousand sample blocks across the continental United States. They described a nationwide monotonic increase in the average riparian "urban %" over the assessed duration, and their results showed the Puget lowlands region of Washington had the nationally largest decrease in "natural land cover" during the "mid 80s - early 90s" period. A dramatic expansion of "urban" cover was also described by Powell et al. (2008) within Washington's Snohomish River watershed. Though not constrained to riparian areas, they estimated a 255% increase, from 3,285 ha in 1972 to 11,652 ha in 2006, based on an analysis combining manual orthophoto review with Landsat imagery. This study indicated that rapid impervious expansion during the 1980s slowed during the 1990s before returning to a faster rate after 2000. The authors recognized the potential for changing land use regulations to have contributed to this trajectory in conjunction with other social and economic factors. 

Extending to additional Puget Sound watersheds, Bartz et al. (2015) focused on annual changes within 100m or 200m buffers around distinct habitat features important to salmon. Using a LandTrendr analysis of 30m imagery spanning 1986 to 2008, they estimated that impervious cover in "mainstem" zones increased roughly 3% on average (172ha, 425ac) from 5,820 ha in 1986, and that "tributary" zones increased roughly 5.5% (118ha, 294ac) from 2,153 ha. They also reported shifts to a slower rate of increase in these and other nearshore, estuary, and floodplain habitat buffer areas examined, though the timing of inflections varied considerably. While clear that a legacy of degradation continues to affect Puget Sound salmon habitats, these authors concluded that more recent land cover change may indicate a slower rate of additional impairment.

Throughout Washington State, riparian land cover is affected by the different combinations of forestry, agriculture, and urbanization that occur within varied ecoregions that range from rainforests to semi-arid shrubsteppe. Riparian administrative responsibility is also distributed among several, often overlapping, entities, with no single statewide authority controlling the full suite of management decisions or the jurisdictional extent of riparian management zones (RMZ). Many individual permitting decisions fall to city and county governments, but federal and state statutes and U.S. treaties with sovereign tribes interact with local municipal codes to create a complex regulatory regime with ample variation in exactly what constitutes "riparian" for planning and permitting purposes.

However, as the agency mandated "to preserve, protect and perpetuate fish, wildlife and ecosystems", the Washington Department of Fish and Wildlife (WDFW) has a responsibility to consult on rules and projects affecting habitat for harvested and non-harvested species statewide. In addition to participating in multi-stakeholder forums that shape forestry and agricultural regulations, WDFW defines "riparian areas (comprised of riparian ecosystems, active floodplains, and riverine wetlands)" (Rentz et al. 2020) as a "Priority Habitat". This designation means that under Washington’s Growth Management Act (GMA, RCW 36.70A) and Shoreline Management Act (RCW 90.58) local governments must protect riparian ecosystem functions in their policies, plans, critical area ordinances, and other development regulations. Protection must result in “no net loss” of ecosystem functions and values or shoreline ecological functions, respectively. The agency consequently issued guidance in 2020 describing an RMZ standard grounded in available evidence of ecosystem functions, following an extensive review and synthesis of scientific studies that updated and extended earlier guidelines (Quinn et al. 2020, Knutson and Naef 1997).

This [200-year Site Potential Tree Height standard (SPTH~200yr~)](https://wdfw.wa.gov/publications/02564) proposes that the height of 200-year old characteristic native trees at a location can be used to determine a lateral distance from the channel that will protect "full ecosystem function". Though not compulsory, adoption of this method to define RMZ width increases the likelihood that regulated riparian extents will protect ecosystem functions and contribute to recovery of threatened and listed species, including Chinook salmon (*Oncorhynchus tshawytscha*). The SPTH~200yr~ approach recognizes the inherent natural variation and connectivity of riverscapes (Fausch et al. 2002), offering a generalized but consistent approach to RMZ delineation based on "best available science", while avoiding fixed dimensions based on categorical distinctions of presumed fish occupancy. This provides an alternative to the buffer widths that have been implemented by many cities and counties since passage of the GMA in 1990. These typically afford less protection to smaller, upstream reaches that nonetheless influence downstream fish use. Specific buffer rules have differed substantially among local regulatory authorities (Folkerts et al. 2020), sometimes between adjacent local jurisdictions along the same watercourse, but have commonly required 50 or 100 feet based on categorical stream types defined by flow permanence and fish use. A gradual transition away from these older systems is underway as local governments adopt code revisions during regular update cycles.

Alternative buffer definitions (e.g., from 10m to 200m) affect the evaluated extent in an assessment, but landscape scale estimates have also typically relied on categorical land cover classes derived from continuous spectral values in satellite imagery, often at a 30m pixel resolution. Substantial variation in land cover can occur within a 30x30m pixel area, complicating both the assignment of a single cover class at a given time and the determination of change between images at different times. Moreover, rather than large blocks of change, many contemporary additions of impervious cover in the western U.S. can involve extents smaller than 0.09 ha (0.22 acres, a single 900m^2^ pixel) within mosaics of multiple land cover types. In Washington, high resolution change detection (HRCD) processing of 1m aerial imagery (Pierce 2015) allows the landscape-scale, aggregate evaluation of individual, parcel-scale riparian impervious changes. The HRCD approach combines automated delineation of change polygons with extensive manual review and verification against before-after image pairs to generate a detailed characterization of altered land cover. We examined these data within a spatial dataset of statewide riparian areas generated according to current SPTH~200yr~ management recommendations, and compared the resulting estimates with those derived from an independent dataset of nationally available land cover classes within a fixed-width corridor on a different hydrography (i.e., the spatial datasets representing streams, rivers and other waterbodies). Complementing these change estimates, we also assessed the total impervious cover within the SPTH~200yr~ RMZ spatial extent in the western portion of the state using an independent 1m land cover layer. We describe patterns in these characterizations of imperviousness, including relative to the distribution of culturally and legally important Pacific salmon and according to differences in the land use regulatory domain, before discussing policy implications and opportunities for improving assessment.

# Methods 

```{r build_rde_cnty_library, eval=FALSE}
walk(
  URLencode(sort(sf_cnty$cnty))
  ,
  ~httr2::request(paste0(
    'https://api-ripariandata.wdfw.wa.gov/counties/',.x,'/reaches/csv'
  )) |>
    httr2::req_headers(`x-api-key` = key) |>
    #httr2::req_dry_run()
    httr2::req_perform() |>
    httr2::resp_body_raw() |>
    readr::read_csv() |>
    readr::write_csv(
      file = file.path(dir_data_common, paste0("rde/counties/rde_cnty_",.x, ".csv"))
    )
)

```

```{r build_rch_tbl_cnty, eval=FALSE}
#then build combined object: 1,091,144x 40
#NOT deduplicating PID shared across counties
#length(unique(rch_tbl_cnty$pid)) == 1084186 (46 more than wrias?)
#would either need to remove entirely or split+assign by proportion
#preferable to include and count twice in per-county stratification
#and/but unstratified statewide sum-over-counties needs distinct()

rch_tbl_cnty <- map_df(
  list.files(file.path(dir_data_common, "rde/counties"), pattern = ".csv", full.names = T)
  ,
  ~readr::read_csv(.x) |>
    mutate(
      pid = as.character(PermanentIdentifier), PermanentIdentifier = NULL,
      cnty = basename(.x) |> str_remove("rde_cnty_") |> str_remove(".csv") |> 
        str_replace_all("%20", " ")
      )
  ) |>
  rename(wria = WaterResourceInventoryAreaID) |>
  janitor::clean_names() |>
  rename_with(~str_replace(.,"acres","ac")) |>
  rename_with(~str_replace(.,"human_forestry_","forestry_")) |>
  rename_with(~str_replace(.,"human_nonforestry_","nonfstry_")) |>
  rename_with(~str_replace(.,"decrease","dec")) |>
  rename_with(~str_replace(.,"increase","inc")) |>
  rename_with(~str_replace(.,"impervious","impv")) |>
  rename_with(~str_replace(.,"semipervious","semi")) |>
  select(pid, cnty, wria, everything(), -reach_id)

glimpse(rch_tbl_cnty)

#saveRDS(rch_tbl_cnty, "~/T/DFW-Team WDFW Watershed Synthesis - data_common/rde/cnty_rch_tbl.rds")

```

```{r rde_cnty}
#for any statewide sum need: distinct(pid, .keep_all = T)
#no way in this table structure, without a 'zone' attribute', to differentiate RMZ-EOW-Floodplain
rde_cnty <- readRDS("~/T/DFW-Team WDFW Watershed Synthesis - data_common/rde/cnty_rch_tbl.rds") |> 
  mutate(
    wria = factor(wria),
    tree_pct = all_tree_cover_ac / all_land_cover_ac,
    veg_pct = all_vegetated_ac / all_land_cover_ac
    ,
    swifd_any = !is.na(swifd_salmon_distribution),
    swifd_n = 1 + str_count(swifd_salmon_distribution,","),
    swifd_n_fct = case_when(
      is.na(swifd_n) ~ "none",
      swifd_n < 3 ~ "1-2 species",
      swifd_n >= 3 ~ "3 or more species"
    ),
    swifd_chin = case_when(
      str_detect(swifd_salmon_distribution, "Chin") ~ "salmon_with_chin",
      str_detect(swifd_salmon_distribution, "Chin", negate = T) ~ "salmon_not_chin",
      is.na(swifd_salmon_distribution) ~ "not_salmon"
    )
  ) 

```

```{r streamcat_nlcd}
  
# ##flowlines with WRIA added deduplicated via 'largest=T'
# sf_flw <- sf::read_sf(file.path(dir_data_common, "NHDPlus17/NHDSnapshot/Hydrography/NHDFlowline.shp")) |>
#   sf::st_transform(crs = sf::st_crs(epsg)) |>
#   sf::st_zm() |>
#   select(COMID, FCODE, FTYPE, LENGTHKM) |>
#   rename_with(tolower) |>  
#   st_join(sf_cnty, left = F, largest = T) |> #inner join
#   st_join(sf_wrias |> select(wria, wria_nr_nm), left = F, largest = T) |> #inner join
#   mutate(comid = as.character(comid))
# saveRDS(sf_flw, file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_flw.rds"))
sf_flw <- readRDS(file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_flw.rds"))

# # ##catchment polys with WRIA added deduplicated via 'largest=T'
# sf_cat <- sf::read_sf(file.path(dir_data_common, "NHDPlus17/NHDPlusCatchment/Catchment.shp")) |>
#   sf::st_transform(crs = sf::st_crs(epsg)) |>
#   select(comid = FEATUREID, areasqkm = AreaSqKM) |>
#   st_join(sf_cnty, left = F, largest = T) |> #inner join
#   st_join(sf_wrias |> select(wria, wria_nr_nm), left = F, largest = T) |>
#   mutate(comid = as.character(comid))
# saveRDS(sf_cat, file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_cat.rds"))
sf_cat <- readRDS(file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_cat.rds"))

# # ~608 comids along county borders are assigned different (appropriately, due to geometry+'largest')
# #not splitting geometries (and attributes) so simpler is better
# #visual inspection indicates flowlines should have precedence for associating to StreamCat/NLCD
# mm <- inner_join(
#   sf_cat |> as_tibble() |> select(comid, cnty_cat=cnty),
#   sf_flw |> as_tibble() |> select(comid, cnty_flw=cnty),
#   by = "comid"
#   ) |> 
#   filter(cnty_cat!=cnty_flw)
# x <- sf_cat |> semi_join(mm, by = "comid")
# y <- sf_flw |> semi_join(mm, by = "comid")
# mapview::mapview(list(cat = x, flw = y, cnty = sf_cnty))

# distinct(as_tibble(sf_flw), comid) #66116
# distinct(as_tibble(sf_cat), comid) #57306
# #flowlines with no cat are most pipelines & canalditch (~3K), a third of coastline
# #but also many scattered streamriver and artificalpath statewide but large concentrations in yakima region
# #cat with no flowlines are edge cases, a pothole depressional area SE of Okanagon plus a few other scattered Eastside


## recall riparian buffers are 100m, per https://www.epa.gov/national-aquatic-resource-surveys/streamcat-dataset-readme 
 
# #pull all 4 AOI, including abs areasqkm
# sc_wa_nlcd <- map(
#   set_names(c(2001, 2004, 2006, 2008, 2011, 2013, 2016, 2019))
#   ,
#   ~StreamCatTools::sc_nlcd(
#     state = "WA", year = .x,
#     aoi = 'cat,catrp100,ws,wsrp100',
#     showAreaSqKm = T
#   ) |>
#     rename_with(tolower) |> as_tibble() |>
#     mutate(comid = as.character(comid), nlcd_year = .x)
# )
# saveRDS(sc_wa_nlcd, file.path(dir_data_common, "streamcat", "sc_wa_nlcd.rds"))

# #removing 7 massive cross-border COMIDs mostly in BC; 6 are >1000km2, last is >350km2
# sf_cat |> arrange(desc(areasqkm)) |> filter(areasqkm>1000) |> ggplot() + geom_sf() + geom_sf_text(aes(label = comid))
# sf_cat |> filter(between(areasqkm,100,1000)) |> ggplot() + geom_sf(aes(fill=areasqkm)) + geom_sf_text(aes(label = comid))
# filter(sf_cat, comid =="23031682")->x; mapview::mapview(x)
comids_drop_BC <- filter(as_tibble(sf_cat), areasqkm>1000) |> distinct(comid) |> bind_rows(tibble(comid = "23031682"))

#starting object with cat and catrp100 (no Ws)
#inner_join against sf_cat to add WRIA 
#then second inner_join against sf_flw to add County and get common set across all 3
#dropping remaining comids with NA rp100
#converting pcts to 0-1
#appending 'ac[res]' cols as AOI-specific product of pct and areasqkm
sc_nlcd <- readRDS(file.path(dir_data_common, "streamcat", "sc_wa_nlcd.rds")) |> 
  map(
    ~.x |> 
      rename_with(
        ~str_remove(.,paste(c(2001, 2004, 2006, 2008, 2011, 2013, 2016, 2019),collapse = "|")) |> 
          str_remove("pct")
        ) |> 
      select(comid, nlcd_year, 
             catareasqkm, catareasqkmrp100,
             ends_with("cat"), ends_with("catrp100"))
      ) |> 
  list_rbind() |> 
  anti_join(comids_drop_BC, by = "comid") |> 
  inner_join(as_tibble(sf_cat) |> select(comid, wria, wria_nr_nm), by = "comid") |> 
  inner_join(as_tibble(sf_flw) |> distinct(comid, cnty), by = "comid") |> 
  drop_na(urbmdcatrp100) |> #single lu class captures all 231 comids NA for rp100 vals
  mutate(
    across(c(ends_with("cat"), ends_with("catrp100")), ~./100)
    ,
    # urb_cat = urbhicat + urbmdcat,
    # urb_catrp100 = urbhicatrp100 + urbmdcatrp100
    ,
    across(ends_with("cat"), list(ac = ~.* catareasqkm * 247.11)),
    across(ends_with("catrp100"), list(ac = ~.* catareasqkmrp100 * 247.11))
    ) 

sc_nlcd <- sc_nlcd |> 
  select(
    wria, wria_nr_nm, cnty,
    comid, nlcd_year, 
    catareasqkm, catareasqkmrp100,
    all_of(sort(grep("cat$", colnames(sc_nlcd), value = T))),
    all_of(sort(grep("catrp100$", colnames(sc_nlcd), value = T))),
    all_of(sort(grep("cat_ac$", colnames(sc_nlcd), value = T))),
    all_of(sort(grep("catrp100_ac$", colnames(sc_nlcd), value = T))),
)

#bring both sf to same 56879
sf_flw <- sf_flw |> inner_join(distinct(sc_nlcd, comid), by = "comid") 
sf_cat <- sf_cat |> inner_join(distinct(sc_nlcd, comid), by = "comid")

pal_nlcd <- set_names(
  c("brown","darkgreen","yellow","lightgreen","yellowgreen",
    "yellow","seagreen","white","green","blue",
    "tan","grey10","grey60","grey30","grey80","seagreen")
  ,
  str_remove(sort(grep("cat$", colnames(sc_nlcd), value = T)), "cat") 
)    

```

```{r ofm_pop}
#Annual county-level population and housing unit totals were accessed from the Washington Office of Financial Management (OFM) Data and Research [April 1 Postcensal Estimates](https://ofm.wa.gov/washington-data-research/population-demographics/population-estimates/historical-estimates-april-1-population-and-housing-state-counties-and-cities).

#non-numeric special symbol flag cols starting after 1970
#flag==1 is the total of unincorporated (2) and incorp (3), incorp the sum of munis (4)
ofm_pop <- suppressMessages(readxl::read_excel(
  file.path(dir_data_common, "census", "ofm_april1_postcensal_estimates_pop_1960-present.xlsx"),
  sheet = 2, skip = 2, na = "."
) |> 
  drop_na(Filter) |>
  janitor::clean_names() |> #glimpse() 
  select(filter, county, jurisdiction, contains("population")) |> 
  pivot_longer(contains("population"), values_to = "est_pop") |> 
  mutate(
    year = str_remove(name, "_") |> str_sub(2, 5), 
    name = NULL,
    across(c(year, est_pop), as.numeric)
  ))

ofm_housing <- readxl::read_excel(
  file.path(dir_data_common, "census", "ofm_april1_postcensal_estimates_housing_1980_1990-present.xlsx"),
  sheet = 2, skip = 2, na = "."
) |> 
  drop_na(Filter) |>  #filter(Filter!=".") |> 
  janitor::clean_names() |> #glimpse() 
  # select(filter, county, jurisdiction, contains("total_housing")) |> 
  # pivot_longer(contains("total_housing"), values_to = "total_housing") |> 
  # mutate(
  #   year = str_sub(name, 2, 5), name = NULL,
  #   across(c(year, total_housing), as.numeric)
  #   )
  select(-line) |> 
  pivot_longer(contains("units"), values_to = "units") |> 
  mutate(
    year = str_sub(name, 2, 5), 
    across(c(year, units), as.numeric),
    name = case_when(
      str_detect(name, "total") ~ "total",
      str_detect(name, "one_unit") ~ "single",
      str_detect(name, "two_or_more") ~ "multi",
      str_detect(name, "special") ~ "other"
    )
  )

```

```{r ccap_2021_wrialoop, eval=FALSE}
library(exactextractr)

ccap_imp <- terra::rast("~/T/DFW-Team WDFW Watershed Synthesis - data_common/ccap/wa_2021_ccap_v2_hires_impervious_20250407/wa_2021_ccap_v2_hires_impervious_20250407.tif")

fp <- list.files(pattern = ".gpkg") #PS wrias 1-29 only RMZ and EOW but no attribute of SPTH200 value

rde_ccap <- map(fp, ~NULL) |> set_names(fp) #str_sub(fp,-12,-6)

for (f in fp){
  sf_rde <- st_read(f) |> st_transform(st_crs(ccap_imp))
  ccap_imp_crop <- terra::crop(ccap_imp, sf_rde)
  rde_ccap[[f]] <- exact_extract(ccap_imp_crop, sf_rde, fun = c("sum","count"), append_cols = c("pid","zone"))
}

saveRDS(rde_ccap, "rde_ccap.rds")

rde_ccap_df <- bind_rows(rde_ccap) 

saveRDS(rde_ccap_df, "rde_ccap_df.rds")
```

```{r rde_ccap_df}
#deduplicating reaches duplicated over wria & county
rde_ccap_df <- inner_join(
  rde_cnty |> 
    distinct(pid, .keep_all = T) |> 
    select(pid, wria, cnty, city_uga_names, swifd_chin)
  ,
  readRDS("rde_ccap_df.rds") |>
    mutate(
      tot_ha = count * 0.0001,
      imp_ha = sum * 0.0001 
    ) |> 
    pivot_wider(names_from = zone, values_from = ends_with("_ha")) |> 
    mutate(
      across(where(is.numeric), ~replace_na(., 0)),
      tot_ha = tot_ha_EOW + tot_ha_RMZ,
      imp_ha = imp_ha_EOW + imp_ha_RMZ,
      imp_pct = imp_ha/tot_ha #sum/count
    )
  ,
  by = c("pid")
) |> 
  #exclude a few edge slivers
  filter(as.numeric(wria) < 30, cnty != "Yakima", cnty != "Klickitat")

```

## SPTH~200yr~ Riparian Areas

To facilitate uptake of the SPTH~200yr~ standard, WDFW developed a geospatial web application that enables rapid evaluation of riparian conditions and supports planning. The foundation of this Riparian Data Engine (RDE, https://ripariandata.wdfw.wa.gov/) is a statewide polygon tessellation of RMZs generated from public hydrography (NHD) and soils (SSURGO) data (Folkerts et al. 2025). In generating the RMZ polygons, a default minimum of 100 feet (30.48m) was used in locations without adequate data to establish a site index value. The RDE provides users with various attributes measuring land cover, water quality (stream temperature impairments via 303d/305b listings), and salmon distribution (via the Statewide Integrated Fish Distribution dataset; [SWIFD](https://geo.wa.gov/datasets/wdfw::statewide-washington-integrated-fish-distribution/about)) calculated for each reach. The application offers a data-driven perspective on protection or restoration choices for specific locations within their broader upstream and downstream network context. 

For this analysis, the complete set of more than 1 million individual reach units of the SPTH~200yr~ RMZ tessellation was compiled from the RDE attribute "reach tables". Each per-reach row in this dataset provides information about the combined area of the riparian management zone (RMZ, both banks where double-banked), the "extent of observed water" (EOW), and "floodplain" (primarily based on FEMA mapping). Within this area, land cover change was calculated from the intersection with HRCD polygons (see next section), and values were tabulated statewide and within individual county boundaries. Note that county geographic extents contain multiple tribal, federal, state, and local authorities and do not represent the exclusive jurisdiction of county governments.

## High Resolution Change Detection 

Land cover changes were measured following the methodology outlined in Pierce (2015), in which automated processing of sequential aerial imagery generated candidate polygons that were then manually reviewed for accuracy and categorical attribution. This process consists of three main phases: 1) object-based change detection to create polygons of similar pixels, 2) estimation of a probability of change for each of these units, and 3) a manual review and attribute assessment. 

High resolution imagery produced by the National Agriculture Inventory Program (NAIP) has been collected at two to three year intervals beginning in 2006 (Maxwell et al. 2017). Mosaics of georectified tiles of these multispectral data formed the starting point for processing. This study is limited to the 2011 to 2013, 2013 to 2015, and 2015 to 2017 time windows due to their statewide coverage. Imagery for these periods was at 0.914-m (3 ft) resolution. 

Object-based segmentation of these images via Trimble eCognition software (versions 8.8 - 9.5.1) generated geodatabases of irregularly sized and shaped polygons determined by per-pixel spectral properties. Segmentation rule sets were constructed to distinguish potential changes down to the scale of about 1/50 hectare (0.05 acres, 242 pixels). These candidate polygons were assigned a probability of change estimated from random forest models fit to a training set of 5,000 stratified samples and analyst-scored units combined with an additional 500 confirmed change units from a directed search.

The short intervals between NAIP images tend to skew the estimated change probability distribution towards zero or "no change", but a relatively low change probability of 25% was used to stratify between “change-likely” and “change-unlikely” groups, reducing omission errors from "change-unlikely" polygons that contained real change. At least 1% of "unlikely" polygons were randomly sampled for further review.

Analysts used custom software to examine this "unlikely" sample and the set of all "likely" polygons (1-4% or roughly n = 1,000 - 40,000, depending on the location and time period). Visual comparison between image pairs confirmed changes, allowed assignment of a likely change agent, and addressed imperfections in the homogeneity of pixels within a change segment through assignment of categorical quartile values for the proportions of total change, lost tree canopy, new impervious surface, and new semi-pervious surface (e.g., new gravel roads). Assignment of the percent change categories introduced uncertainty due to accuracy (i.e., selection of 25% vs 50%) and imprecision (i.e., the true value falling within a 25% range). Finer divisions would tend to reduce the latter while increasing the former, but the inspection of millions of candidate change polygons has confirmed that this approach is a logistically feasible way to generate a high quality dataset that captures many small changes at large regional scales.

## C-CAP 1m 2021 Impervious Surface

Complementing these change observations, values from a 1m resolution raster dataset of 2021 impervious cover produced by the Coastal Change Analysis Program (CCAP) of the National Oceanic and Atmospheric Administration (NOAA) Office for Coastal Management were extracted within the RMZ and EOW zones of the RDE riparian polygons (CCAP 2025). These values were then associated to the per-reach attributes provided by the RDE for summarization.

## StreamCat-processed National Land Cover Dataset

As a contrast to the RDE-HRCD dataset, the [`StreamCatTools`](https://github.com/USEPA/StreamCatTools) (Weber 2025) R package was used to access the [StreamCat dataset](https://www.epa.gov/national-aquatic-resource-surveys/streamcat-dataset) (Hill et al. 2016). StreamCat delivers consistently geoprocessed attribute values for each reach unit of the medium resolution NHDPlus. This hydrography captures most substantial watercourses and is the precursor to subsequent higher-resolution, continent-wide elevation-derived hydrographic datasets that include many smaller channel units (i.e., NHDPlusHR associated with 10m digital elevation raster and 3DHP derived from LiDAR). For each reach 'comid', StreamCat provides attribute values calculated from many national datasets processed within the local contributing catchment ('`cat`') as well as a 100m riparian buffer ('`rp100`') on "stream lines and on-network NLCD water pixels". This includes values calculated from 8 cycles of the National Land Cover Dataset (NLCD; 2001, 2004, 2006, 2008, 2011, 2013, 2016, and 2019), which are based on classification of satellite and other imagery sources [(Wickham et al. 2023)](https://www.tandfonline.com/doi/full/10.1080/15481603.2023.2181143). The StreamCat NLCD values represent the percentages of each of 16 land cover classes within each of the *cat* and *catrp100* areas of interest, such that approximate areas per-class were back-calculated against the per-comid area. The StreamCat process and NLCD datasets have undergone thorough QAQC and been extensively reviewed since their initial development, and they are an established, standardized means to investigate large-scale patterns.

# Results

```{r rde_swifd_sum_statewide_summary}
# #if Lazarus ~580-720ac/y for 2001:2019
# expand_grid(ac = c(11:13)*1000, y = 18:19) |> mutate(ac_y = ac/y)

rde_swifd_sum <- rde_cnty |> 
  distinct(pid, .keep_all = T) |> 
  summarise(
    across(
      c(stream_miles, reach_ac, 
        rmz_ac, eow_ac, flood_ac, 
        nonfstry_impv_inc_ac, nonfstry_semi_inc_ac
        ), ~sum(., na.rm = T))
    , .by = swifd_chin
  ) |> 
  bind_rows(
    rde_cnty |> 
      distinct(pid, .keep_all = T) |> 
      summarise(
        across(
          c(stream_miles, reach_ac, 
            rmz_ac, eow_ac, flood_ac, 
            nonfstry_impv_inc_ac, nonfstry_semi_inc_ac
            ), ~sum(., na.rm = T))) |> 
      mutate(swifd_chin = "total")
  ) |> 
  rename_with(~str_remove(., "nonfstry_")) |> 
  mutate(
    stream_km = stream_miles * 1.61,
    reach_ha = ha*reach_ac,
    impv_inc_ha = ha*impv_inc_ac,
    impv_reach_pct = impv_inc_ac / reach_ac,
    semi_inc_ha = ha*semi_inc_ac,
    semi_reach_pct = semi_inc_ac / reach_ac,
    #per KP, HRCD 2011:2017 NAIP is summer to summer
    impv_ha_y = ha*(impv_inc_ac / 6),
    impv_ac_y = impv_inc_ac / 6,
    semi_ha_y = ha*(semi_inc_ac / 6),
    semi_ac_y = semi_inc_ac / 6 
  )
```

```{r sc_nlcd_year_sum}
sc_nlcd_year_sum <- sc_nlcd |> 
  summarise(
    rp100_ha = 100 * sum(catareasqkmrp100),
    across(
      contains("urb") & ends_with("ac"),
      list(sum = ~sum(.))
    )
    , .by = c(nlcd_year)
  ) |> 
  pivot_longer(cols = -c(nlcd_year,rp100_ha), values_to = "ac") |> 
  mutate(
    aoi = if_else(str_detect(name, "rp100"), "rp100", "cat"),
    nlcd_class = str_remove(name, "cat") |> str_remove("rp100") |> str_remove("_ac_sum"),
    name = NULL,
    ha = ha*ac
    ) |> 
  filter(aoi == "rp100") |> #filter(nlcd_year %in% c(2011, 2016))
  select(-ac) |> 
  pivot_wider(names_from = c(nlcd_class), values_from = ha)
```

```{r rde_cnty_sum}
# rde_cnty_sum <- rde_cnty |> 
#   summarise(
#     across(
#       c(reach_ac, 
#         riparian_ac, rmz_ac, eow_ac, flood_ac, 
#         nonfstry_impv_inc_ac, 
#         nonfstry_semi_inc_ac,
#         nonfstry_tree_dec_ac
#         ),
#       ~sum(., na.rm = T)
#     )
#     , .by = cnty
#   ) |> 
#   mutate(
#     across(
#       starts_with("nonf"),
#       list(
#         #per_100ac = ~100*(./reach_ac)
#         pct_rch = ~(./reach_ac)
#       )
#     )
#   ) |> 
#   left_join(
#     rde_cnty |> 
#       summarise(
#         across(
#           c(reach_ac, 
#             #riparian_ac, rmz_ac, eow_ac, flood_ac, 
#             nonfstry_impv_inc_ac,
#             nonfstry_semi_inc_ac,
#             nonfstry_tree_dec_ac
#           ),
#           ~sum(., na.rm = T)
#         ),
#         .by = c(cnty, swifd_chin)
#       ) |> 
#       pivot_wider(names_from = swifd_chin, values_from = ends_with("_ac"))
#     , 
#     by = "cnty"
#   ) |> 
#   left_join(
#     ofm_pop |> 
#       filter(filter == "1", year %in% c(2011, 2017)) |> 
#       select(cnty = county, year, est_pop) |> 
#       #arrange(cnty, year) |> summarise(across(est_pop, list(d = ~.[2] - .[1])), .by = cnty)
#       pivot_wider(names_from = year, names_glue =  "{year}_{.value}", values_from = est_pop) |> 
#       mutate(d_est_pop = `2017_est_pop`- `2011_est_pop`)
#     ,
#     by = "cnty"
#   ) |> 
#   left_join(
#     ofm_housing |> 
#       filter(filter == "1", year %in% c(2011, 2017)) |> 
#       select(cnty = county, year, name, units) |> 
#       #pivot_wider(names_from = name, values_from = units) |> 
#       #arrange(cnty, year) |> summarise(across(total:other, list(d = ~.[2] - .[1])), .by = cnty)
#       pivot_wider(names_from = year, values_from = units) |> 
#       mutate(d = `2017`- `2011`) |> 
#       pivot_wider(names_from = name, values_from = where(is.numeric))
#     ,
#     by = "cnty"
#   ) |> 
#   rename_with(~str_remove(., "nonfstry_"))

rde_cnty_sum <- rde_cnty |> 
  rename_with(~str_remove(., "nonfstry_")) |> 
  mutate(uga = if_else(is.na(city_uga_names), "Non-UGA", "UGA")) |> 
  summarise(
    across(
      c(
        rch = reach_ac, 
        rip = riparian_ac,
        rmz = rmz_ac, 
        eow = eow_ac,
        fld = flood_ac, 
        impv_inc = impv_inc_ac, 
        semi_inc = semi_inc_ac
        ),
      list(ha = ~ha * sum(., na.rm = T))
    )
    , .by = c(cnty, uga, swifd_chin)
  ) |> 
  mutate(impv_semi_inc_ha = impv_inc_ha + semi_inc_ha)

```

```{r rde_impv}
rde_impv <- rde_cnty |> 
  distinct(pid, .keep_all = T) |> 
  arrange(desc(nonfstry_impv_inc_ac)) |> 
  select(1:10, nonfstry_impv_inc_ac, nonfstry_semi_inc_ac) |> #1,084,186
  filter(nonfstry_impv_inc_ac > 0) |> #7437 of 1,084,186 have non-zero imp inc
  rename_with(~str_remove(., "nonfstry_")) |> 
  mutate(
    impv_inc_ha = ha*impv_inc_ac,
    cimp = cumsum(impv_inc_ha),
    rank = dense_rank(cimp), 
    cimp_pct = cimp / sum(cimp),
    n_pct = seq_along(cimp) / length(cimp),
    fld_pct = flood_ac / reach_ac,
    eow_pct = eow_ac / reach_ac,
    rmz_pct = rmz_ac / reach_ac
  )
```

```{r sc_nlcd_year_cnty_sum}
sc_nlcd_year_cnty_sum <- sc_nlcd |> 
  summarise(
    rp100_ha = round(100*sum(catareasqkmrp100)),
    across(
      contains("urb") & ends_with("ac"),
      list(sum = ~sum(.))
    )
    , .by = c(nlcd_year, cnty)
  ) |> 
  pivot_longer(cols = -c(nlcd_year, cnty, rp100_ha), values_to = "ac") |> 
  mutate(
    aoi = if_else(str_detect(name, "rp100"), "rp100", "cat"),
    nlcd_class = str_remove(name, "cat") |> str_remove("rp100") |> str_remove("_ac_sum"),
    name = NULL,
    ha = ha*ac
    ) |> 
  select(-ac) |> filter(aoi == "rp100") |> 
  filter(nlcd_year %in% c(2011, 2016)) |> 
  pivot_wider(names_from = c(nlcd_year, nlcd_class), values_from = ha)

```

```{r sf_cnty_rde_sc}
sf_cnty_rde_sc <- sf_cnty |> 
  mutate(cnty_ha = st_area(geometry) |> units::set_units("hectares") |> as.numeric()) |> 
  left_join(rde_cnty_sum, by = "cnty") |> 
  left_join(sc_nlcd_year_cnty_sum, by = "cnty")

```

## Assessed areas

Reach scale differences between the RDE-HRCD and StreamCat-NLCD datasets (@fig-overlay) produced landscape scale differences in the total extent of the assessed area, with the 3.6mil hectares in the RDE domain encompassing approximately `r round(100*((3636186-2595580)/2595580))`% more than the 2.6mil of the StreamCat *rp100* boundary (@tbl-overall). The medium-resolution NHDPlus underlying StreamCat captures larger streams and rivers but omits some small channels due to the standardized terrain processing of 30m digital elevation data. Consequently, despite the wider 100m buffer in StreamCat, the SPTH~200yr~ widths in the RDE were buffered on the greater length of the more extensive NHD channel network. Variation in assessed area was also apparent when summarizing within county boundaries (@fig-cnty_assess_zones_ratio, A & B), where the StreamCat fixed buffer dimension meant that aggregate area primarily reflected drainage density and overall county size. In contrast, the underlying cartographic heterogeneity in NHD flowlines combined with the ecoregional variation in SPTH~200yr~ values to produce differences in the RDE tessellation extent among (and within) counties that were not necessarily related to watershed topography. These contrasts were evident in the assessed area as proportion of total county area (@fig-cnty_assess_zones_ratio, C), where the RDE tessellation had a larger magnitude of variation. Nonetheless, the RDE assessed area was primarily comprised of the SPTH~200yr~ RMZ portion at the statewide extent (`r round(100*(3066006/3636186))`%) and within individual counties (@fig-cnty_assess_zones_ratio, D).

```{r tbl-overall}
#| label: tbl-overall
#| tbl-cap: "Overall comparison between assessment datasets"

# 
# tibble(
#   Characteristic = c(
#     "Hydrography",
#     "Total stream length (km)",
#     "RMZ buffer dimension",
#     "Land cover resolution",
#     "Change Years",
#     "Total assessed<br>riparian area (ha)",
#     "Estimated<br>cover change"),
# 
#   `RDE-HRCD` = c(
#     "NHD (2022)",
#     round(rde_swifd_sum$stream_km[4]) |> scales::number(big.mark = ","),
#     "SPTH~200yr~ (approx. 30-75m)<br>+floodplains",
#     "1m",
#     "2011-2017",
#     paste0(
#       "Total: ", round(rde_swifd_sum$reach_ha[4]) |> scales::number(big.mark = ","), "<br>",
#       "*RMZ: ", round(ha*rde_swifd_sum$rmz_ac[4]) |> scales::number(big.mark = ","), "*<br>",
#       "*EOW: ", round(ha*rde_swifd_sum$eow_ac[4]) |> scales::number(big.mark = ","), "*<br>",
#       "*Floodplain: ", round(ha*rde_swifd_sum$flood_ac[4]) |> scales::number(big.mark = ","), "*"
#       )
#     ,
#     paste0(
#       paste("Impervious:<br>", round(rde_swifd_sum$impv_inc_ha[4]), "ha, ", round(rde_swifd_sum$impv_ha_y[4]), "ha/y"),
#       "<br>",
#       paste("Semi-pervious:<br>", round(rde_swifd_sum$semi_inc_ha[4]), "ha, ", round(rde_swifd_sum$semi_ha_y[4]), "ha/y")
#       )
#     )
#   ,
#   `StreamCat-NLCD` = c(
#     "NHDPlus v2.1 1:100K",
#     round(sum(sf_flw$lengthkm)) |> scales::number(big.mark = ","), #same COMIDs as sc_nlcd
#     "100m, fixed ('rp100')",
#     "30m",
#     "2011-2016 (data 2001-2019)",
#     scales::number(sc_nlcd_year_sum$rp100_ha[1], big.mark = ",")
#     ,
#     paste(
#     sc_nlcd_year_sum |>
#       filter(aoi == "rp100", nlcd_year %in% c(2011, 2016)) |>
#       select(-aoi, -rp100_ha) |>
#       pivot_longer(-c(nlcd_year), names_to = "nlcd_class", values_to = "ha") |>
#       pivot_wider(names_from = nlcd_year, values_from = ha) |>
#       mutate(
#         nlcd_class = factor(nlcd_class,
#                             levels = c("urbhi","urbmd","urblo","urbop"),
#                             labels = c("High", "Medium", "Low", "Open")),
#         ha = (`2016`-`2011`),
#         ha_yr = ha/5,
#         d = paste0(nlcd_class, ": ", round(ha)," ha, ", round(ha_yr)," ha/y")
#       ) |>
#       arrange(nlcd_class) |>
#       pull(d) |> paste0(collapse = "<br>")
#       )
#     )
#   ,
#   `Lazarus 2023` = c(
#     "Composite based on NHD,<br>with WADNR, VSW, FEMA, CHAMP;<br>excluding sovereign tribal",
#     "---",
#     "SPTH~200yr~<br>+floodplains",
#     "30m",
#     "2001 vs 2019",
#     "3,230,047",
#     "High: 947 ha<br>Medium: 3821 ha<br>Low: 881 ha<br>Open: -886 ha"
#   )
# ) |>
#   gt::gt() |>
#   gt::tab_style(style = cell_text(weight = "bold"), locations = cells_column_labels()) |>
#   gt::fmt_markdown() |> 
#   gt::gtsave(filename = "t1_overall.png")

```

![](t1_overall.png)

```{r fig-overlay}
#| label: fig-overlay
#| fig-cap: "Example location at junction of White and Puyallup Rivers in Sumner, WA (Pierce County) depicting alternative riparian corridors and high resolution change detection (HRCD) areas; SPTH~200yr~ RMZ (light green), EOW (blue), and floodplain (dark green) extents are shown with StreamCatRp100 100m buffer on medium resolution NHDPlus (purple) and individual HRCD impervious increases (grey)"

sf_aoi <- st_as_sf(st_as_sfc(
  st_bbox(
    #c(xmin = 1064273, xmax = 1064273+60000, ymin = 800000, ymax = 800000+90000), #Poulsbo to Pt Orchard
    c(xmin = 1200000, xmax = 1200000+15000, ymin = 679000, ymax = 679000+30000), #Sumner
    crs = st_crs(epsg))
  ))

# # st_bbox(st_transform(sf_aoi, crs = 4326))
# #       xmin       ymin       xmax       ymax 
# # -122.27395   47.18171 -122.21093   47.26484 
# # st_area(sf_aoi) |> units::set_units("acres") 
# #mapview::mapview(sf_aoi)
# 
# sf_aoi_flw <- sf_flw[sf_aoi,] |> st_crop(sf_aoi)
# sf_aoi_flw_rp100 <- st_buffer(sf_aoi_flw, dist = 328) |> 
#   left_join(
#     sc_nlcd |> 
#     select(comid, nlcd_year, starts_with("urb"), ends_with("rp100_ac")) |> filter(nlcd_year==2016),
#     by = "comid")
# sf_aoi_cat <- sf_cat[sf_aoi,] |> st_crop(sf_aoi) |> 
#   left_join(
#     sc_nlcd |> 
#     select(comid, nlcd_year, starts_with("urb"), ends_with("rp100_ac")) |> filter(nlcd_year==2016),
#     by = "comid")
# 
# gdb <- file.path(dir_data_common, "HRCD.gdb") #also NAD83(HARN)
# sf::st_layers(gdb)
# sf_hrcd <- sf::st_read(gdb, layer = "HRCD_ChangeLocations") |> #~4gb
#   filter(StartYr >= 2011, EndYr <= 2017, WRIANr == 10) 
# sf_aoi_hrcd <- sf_hrcd[sf_aoi,] |> 
#   filter(CngOrigin != "Natural", ImpIncPct > 0)

# # # orig RDE geom
# # w = stringr::str_pad(x, width = 2, pad = "0")
# # sf::st_read(
# #   "~/T/DFW-Team WDFW Watershed Synthesis - data_common/SPTH_Tessellation.gdb",
# #   layer = paste0("wria",w,"_SPTH_Tessellation")
# # ) |> 
# #   sf::st_zm() |>
# #   dplyr::group_by(pid = permanent_identifier, zone = Zone) |>
# #   dplyr::summarise(area = sum(Shape_Area), .groups = "drop") |> 
# #   sf::st_write(  
# #     dsn = paste0("wdfw_rde_spth200_tess_wria_",w,".gpkg"), 
# #     layer = paste0("wria",w)
# #   )
# sf_rde <- st_read("wdfw_rde_spth200_tess_wria_10.gpkg")
# sf_aoi_rde <- sf_rde[sf_aoi,]

# # mapview::mapview(sf_aoi_cat, col.regions = NA) +
# # mapview::mapview(sf_aoi_flw) +
# # mapview::mapview(sf_aoi_flw_rp100, zcol = "urbhicatrp100_ac",
# #                  col.regions = rev(wacolors::wacolors$volcano)) +
# # mapview::mapview(sf_aoi_rde, zcol = "zone") +
# # mapview::mapview(sf_aoi_hrcd, zcol = "ImpIncAc",
# #                  col.regions = rev(wacolors::wacolors$forest_fire))

# #RDE geom with floodplains from Colin
# sf_fld <- st_read("wria10.gdb") |> 
#   group_by(PermanentIdentifier, Zone) |> 
#   summarise(.groups = "drop")
# sf_aoi_fld <- sf_fld[sf_aoi,]

# saveRDS(list(
#   fld = sf_aoi_fld,
#   flw_rp100 = sf_aoi_flw_rp100,
#   hrcd = sf_aoi_hrcd
# ), "fig_corridors.rds")

sf_aoi_geo <- readRDS("fig_corridors.rds")

{
  ggplot() + 
    geom_sf(data = sf_cnty, fill = NA) +
    #geom_sf(data = sf_aoi, color = "red", fill = "red") +
    geom_sf(data = st_centroid(sf_aoi), color = "blue", fill = "blue", size = 2) +
    ggspatial::annotation_scale() +
  theme(axis.text = element_blank())
}+{
  ggplot() +
  geom_sf(data = sf_aoi_geo$fld |> st_crop(sf_aoi) |> filter(Zone == "RMZ"), color = "green", fill = "green") +
  geom_sf(data = sf_aoi_geo$fld |> st_crop(sf_aoi) |> filter(Zone == "OMZ"), color = "#69A2E4" , fill = "#69A2E4") +
  geom_sf(data = sf_aoi_geo$fld |> st_crop(sf_aoi) |> filter(Zone == "Flood"), color = "darkgreen" , fill = "darkgreen") +
  geom_sf(data = sf_aoi_geo$flw_rp100 |> st_union() |> st_crop(sf_aoi), fill = NA, color = "purple", linewidth = 0.5, show.legend = F) +
  geom_sf(data = sf_aoi_geo$hrcd, fill = "grey40", color = "grey40", alpha = 0.6) +
  ggspatial::annotation_scale() +
  theme(axis.text = element_blank())
} +
  plot_layout(design = "A\nB") + 
  plot_annotation(tag_levels = "a")

#ggsave("f1_overlay.png", bg = "white", width = 7, height = 12, dpi = 200)
```

```{r fig-assessed}
#| label: fig-assessed
#| fig-cap: "Assessed riparian extent as a) hectares within Riparian Data Engine per-reach polygons; b) hectares in the StreamCat 'rp100' 100m riparian buffer on medium resolution NHDPlus; c) & d) proportion of county boundary area; e) proportion of RDE area within Urban Growth Areas; f) proportion of RDE area associated with Chinook use."

d <- sf_cnty |> 
  mutate(cnty_ha = st_area(geometry) |> units::set_units("hectares") |> as.numeric()) |> 
  left_join(
    rde_cnty_sum |> 
      summarise(across(ends_with("_ha"), sum), .by = cnty), by = "cnty"
  ) |> 
  left_join(
    sc_nlcd |> filter(nlcd_year==2011) |> #all years identical
      summarise(rp100_ha = round(100*sum(catareasqkmrp100)), .by = cnty), by = "cnty"
  ) |> 
  left_join(
    rde_cnty_sum |>
      summarise(across(rch_ha, sum), .by = c(cnty, uga)) |> 
      pivot_wider(names_from = uga, values_from = rch_ha) |> 
      mutate(across(-cnty, ~replace_na(., 0)))
    , by = "cnty"
  ) |> 
  left_join(
    rde_cnty_sum |>
      summarise(across(rch_ha, sum), .by = c(cnty, swifd_chin)) |> 
      pivot_wider(names_from = swifd_chin, values_from = rch_ha) |> 
      mutate(across(-cnty, ~replace_na(., 0)))
    , by = "cnty"
  )
  

list(
  ggplot(d) + 
    geom_sf(aes(fill = rch_ha), show.legend = T) +
    scale_fill_gradient(
      name = "RDE ha", labels = scales::label_comma(),
      low = "#BEE7DF", high = "#212540", na.value = "pink",
      limits = c(0, 300000)) +
    theme(axis.text = element_text(size = 3))
  ,
  ggplot(d) + 
    geom_sf(aes(fill = rp100_ha), show.legend = T) +
    scale_fill_gradient(
      name = "rp100 ha", labels = scales::label_comma(),
      low = "#BEE7DF", high = "#212540", na.value = "pink",
      limits = c(0, 300000)) +
    theme(axis.text = element_text(size = 3))
  ,
  ggplot(d) + 
    geom_sf(aes(fill = rch_ha/cnty_ha), show.legend = T) +
    scale_fill_gradient(
      name = "RDE/county", labels = scales::label_percent(),
      low = "grey90", high = "grey20", na.value = "pink",
      limits = c(0, 1)) +
    theme(axis.text = element_text(size = 3))
  ,
  ggplot(d) + 
    geom_sf(aes(fill = rp100_ha/cnty_ha), show.legend = T) +
    scale_fill_gradient(
      name = "rp100/county", labels = scales::label_percent(),
      low = "grey90", high = "grey20", na.value = "pink",
      limits = c(0, 1)) +
    theme(axis.text = element_text(size = 3))
  ,
  ggplot(d) + 
    geom_sf(aes(fill = UGA/rch_ha), show.legend = T) +
    scale_fill_gradient(
      name = "RDE UGA/total", labels = scales::label_percent(),
      low = alpha("orange",0.01), high = alpha("orange",1), na.value = "pink",
      limits = c(0, 1)) +
    theme(axis.text = element_text(size = 3))
  ,
  ggplot(d) + 
    geom_sf(aes(fill = salmon_with_chin/rch_ha), show.legend = T) +
    scale_fill_gradient(
      name = "RDE Chin/total", labels = scales::label_percent(),
      low = alpha("salmon",0.01), high = alpha("salmon",1), na.value = "pink",
      limits = c(0, 1)) +
    theme(axis.text = element_text(size = 3))
) |>
  wrap_plots(design = "AB\nCD\nEF", guides = "keep") + 
  plot_annotation(tag_levels = "a")

#ggsave("f2_assessed.png", bg = "white", width = 10, height = 12, dpi = 200)
```

## Change in impervious cover

An estimated 947 and 437 hectares of new impervious and semi-pervious cover were added to the assessed extent during the 2011-2017 period of the RDE-HRCD dataset (2,341 and 1,080 acres respectively). Differencing the 2011 and 2016 values in the Streamcat-NLCD dataset, high and medium intensity urban cover (>80% and 50-80% impervious respectively) increased by approximately 365 and 1152 hectares within the rp100 corridor (900 and 2,846 acres). Combining these types per dataset, these changes corresponded to average annual increases of 231 (158+73) and 303 (73+230) ha/year (@tbl-overall). 

The largest increases were concentrated in already urbanized portions of the state. Absolute change was greatest in proximity to the large and rapidly growing metropolitan areas of Seattle, Tacoma, and Vancouver in western Washington (within King, Pierce, and Clark County bounds) and Spokane and the Tri-Cities in eastern Washington (within Spokane, Yakima, and Benton County bounds, @fig-impv_inc_ha_pct_map_cols). However, despite the largest absolute increase within the King County extent, the changes within Pierce and Clark county extents both formed a larger proportion of the assessed area (@fig-impv_inc_ha_pct_map_cols), highlighting differences in the relative density of impervious increase. Similarly, although total increases were smaller within the Kitsap, Island, and Benton county boundaries, these changes made up relatively high proportions of the assessed area.

Reflecting the concentration of human population and existing urbanization in western Washington, the relative density of impervious increases recorded in the RDE-HRCD dataset was considerably higher in reaches associated with Chinook distribution compared to non-salmon reaches. Although the aggregated absolute change was similar (432 vs 445 ha), the total assessed area associated with Chinook was much smaller, with new impervious cover between 2011 and 2017 forming more than a tenth of a percent (@fig-swifd).

The size distribution of individual changes accounting for these landscape scale patterns in the RDE-HRCD dataset was characterized by a few, large impervious increases and many smaller ones. The median intersecting area of the `r nrow(rde_impv) |> scales::number(big.mark = ",")` increased impervious polygons within the RDE assessed area was `r round(median(rde_impv$impv_inc_ha),3)` ha or 240 m^2, considerably less than the 900 square meters of a single 30m pixel. Indeed, `r 100*round(sum(rde_impv$impv_inc_ha < 0.09) / nrow(rde_impv), 3)`% (5,984 of 7,437) changes were smaller than 900m^2^, and `r 100*round(sum(rde_impv$impv_inc_ha < 0.4) / nrow(rde_impv), 3)`% were less than 0.4ha (1 acre). This pattern was broadly consistent across the state. However, despite the preponderance of small changes, a substantial portion of the total change derived from a small set of large changes (@fig-impv_inc_size). For example, the 10 largest per-reach increases contributed `r round(filter(rde_impv, rank == 10)$cimp, 1)` ha of the `r round(max(rde_impv$cimp), 1)` total (i.e., `r 100*round(filter(rde_impv, rank == 10)$cimp / max(rde_impv$cimp), 3)`% of new impervious area came from this 0.134% of reaches). In addition, the floodplain zone composed a greater proportion of the full reach area in many of these largest individual increases (@fig-impv_inc_size). 

```{r fig-impv_inc}
#| label: fig-impv_inc
#| fig-cap: "Increase in riparian impervious cover as a) RDE-HRCD 2011-17 impervious and semi-pervious hectares; b) StreamCat-NLCD high and medium intensity urban hectares; c) and d) proportion of RDE and StreamCat assessed extents"

d <- sf_cnty |> 
  mutate(cnty_ha = st_area(geometry) |> units::set_units("hectares") |> as.numeric()) |> 
  left_join(
    rde_cnty_sum |> 
      summarise(across(ends_with("_ha"), sum), .by = cnty), by = "cnty"
  ) |> 
  left_join(
    sc_nlcd_year_cnty_sum |> 
      mutate(
        hi_ha = `2016_urbhi` - `2011_urbhi`, 
        md_ha = `2016_urbmd` - `2011_urbmd`) |> 
      select(cnty, rp100_ha, hi_ha, md_ha), by = "cnty"
  ) |> 
  left_join(
    rde_cnty_sum |>
      summarise(across(c(impv_semi_inc_ha), sum), .by = c(cnty, uga)) |> 
      pivot_wider(names_from = uga, values_from = impv_semi_inc_ha) |> 
      mutate(across(-cnty, ~replace_na(., 0)))
    , by = "cnty"
  ) |> 
  left_join(
    rde_cnty_sum |>
      summarise(across(c(impv_semi_inc_ha), sum), .by = c(cnty, swifd_chin)) |> 
      pivot_wider(names_from = swifd_chin, values_from = impv_semi_inc_ha) |> 
      mutate(across(-cnty, ~replace_na(., 0)))
    , by = "cnty"
  )


{
  ggplot(d) + #RDE-HRCD imperv+semi 2011-2017
    geom_sf(aes(fill = impv_semi_inc_ha), color = "white", show.legend = T) +
    geom_sf(data = sf_wa_city, color = "brown", show.legend = F) +
    geom_sf_text(data = sf_wa_city, aes(label = name), color = "brown", position = "jitter", hjust = 1.1, size = 3, show.legend = F) +
    scale_fill_gradient(name = "RDE impv+semi ha", low = "grey95", high = "#7E4837", limits = c(0, 350)) + 
    labs(x = NULL, y = NULL) + theme(axis.text = element_blank())
}+{
  ggplot(d) + #SC-NLCD 'high'+'med' 2011-2016"
    geom_sf(aes(fill = hi_ha+md_ha), color = "white", show.legend = T) +
    geom_sf_text(aes(label = cnty), color = "grey20", size = 2.5) +
    #geom_sf(data = sf_wa_city, color = "brown", show.legend = F) +
    #geom_sf_text(data = sf_wa_city, aes(label = name), color = "brown", hjust = 1.1, size = 3, show.legend = F) +
    scale_fill_gradient(name = "rp100 hi+md ha", low = "grey95", high =  "#7E4837", limits = c(0, 350)) +
    labs(x = NULL, y = NULL) + theme(axis.text = element_blank())
}+{
    ggplot(d) + 
    geom_sf(aes(fill = impv_semi_inc_ha / rch_ha), color = "white", show.legend = T) +
    scale_fill_gradient(name = "% RDE extent", low = "grey95", high = "#7E4837", limits = c(0, .01), labels = scales::label_percent()) + 
    labs(x = NULL, y = NULL) + theme(axis.text = element_blank())
}+{
    ggplot(d) + 
    geom_sf(aes(fill = (hi_ha+md_ha) / rp100_ha), color = "white", show.legend = T) +
    scale_fill_gradient(name = "% rp100 extent", low = "grey95", high = "#7E4837", limits = c(0, .01), labels = scales::label_percent()) + 
    labs(x = NULL, y = NULL) + theme(axis.text = element_blank())
}+{
    ggplot(d) + 
    geom_sf(aes(fill = UGA / impv_semi_inc_ha), color = "white", show.legend = T) +
    scale_fill_gradient(name = "RDE UGA/total", low = alpha("orange", 0.1), high = "orange", limits = c(0, 1), labels = scales::label_percent(), na.value = "white") + 
    labs(x = NULL, y = NULL) + theme(axis.text = element_blank())
}+{
    ggplot(d) + 
    geom_sf(aes(fill = salmon_with_chin / impv_semi_inc_ha), color = "white", show.legend = T) +
    scale_fill_gradient(name = "RDE Chin/total", low = alpha("salmon", 0.1), high = "salmon", limits = c(0, 1), labels = scales::label_percent(), na.value = "white") + 
    labs(x = NULL, y = NULL) + theme(axis.text = element_blank())
}+
plot_layout(design = "AB\nCD\nEF") +
plot_annotation(tag_levels = "a")

#ggsave("f3_impv_inc.png", bg = "white", width = 12, height = 11, dpi = 200)
```

```{r fig-swifd}
#| label: fig-swifd
#| fig-cap: "Concentration of impervious increases within salmon distribution as a) and b) hectares of RDE-HRCD estimated change in reaches not included in SWIFD distributions and those with salmon; c) statewide impervious cover increase as proportion of total assessed area"

#as_tibble(sf_cnty_rde) |> mutate(pct = reach_ac/cnty_ac) |> pull(pct) |> summary()

pal_swifd_chin <- c("not_salmon" = "tan", "salmon_not_chin" = alpha("salmon", 0.5), "salmon_with_chin" = "salmon")

# sf_cnty_rde_sc |>  
#     ggplot() + geom_sf(aes(fill = `2017_est_pop`-`2011_est_pop`), show.legend = T) + 
#     scale_fill_gradient(low = "grey95", high = "orange", na.value = "pink", labels = scales::label_comma()) +
#     labs(fill = NULL)  #, subtitle = "2011-17 est. pop. increase"
# sf_cnty_rde_sc |>  
#     ggplot() + geom_sf(aes(fill = ha*impv_inc_ac_salmon_with_chin), show.legend = T) + 
#     scale_fill_gradient(name = "ha", low = "grey95", high = pal_d["RDE-HRCD_impv_ha"])

{
  ggplot(d) + geom_sf(aes(fill = not_salmon), show.legend = T) + 
    scale_fill_gradient(name = "RDE not salmon", low = "grey95", high = pal_swifd_chin[1], na.value = "pink", labels = scales::label_comma()) +
    labs(x = NULL, y = NULL) + theme(axis.text = element_blank())
}+{
  ggplot(d) + geom_sf(aes(fill = salmon_not_chin + salmon_with_chin), show.legend = T) + 
    scale_fill_gradient(name = "RDE salmon", low = "grey95", high = pal_swifd_chin[3], na.value = "pink", labels = scales::label_comma()) +
    labs(x = NULL, y = NULL) + theme(axis.text = element_blank())
}+{
  rde_swifd_sum |> 
    filter(swifd_chin != "total") |> 
    mutate(
      impv_semi_inc_ha = impv_inc_ha + semi_inc_ha,
      pct = impv_semi_inc_ha / reach_ha,
      swifd_any = if_else(str_detect(swifd_chin, "chin"), "salmon", "not salmon")
      ) |> 
    select(swifd_any, swifd_chin, reach_ha, impv_semi_inc_ha, pct) |> 
    mutate( #hot fix
      pct_txt = if_else(swifd_chin=="salmon_not_chin", sum(pct[-1]), pct)
    ) |> 
    ggplot() +
    geom_col(aes(swifd_any, pct, fill = swifd_chin), show.legend = F) +
    geom_text(aes(swifd_any, pct_txt, label = paste0("ha: ", round(impv_semi_inc_ha))),
              nudge_y = -0.0001) +
    scale_fill_manual(values = pal_swifd_chin) +
    scale_y_continuous("Impv.+semi inc. / reach area", labels = scales::label_percent()) +
    scale_x_discrete(name = NULL) #"SWIFD status" guide = guide_axis(n.dodge = 2)
} +
  plot_layout(design = "AC\nBC") +
  plot_annotation(tag_levels = "a")


#ggsave("f4_swifd.png", bg = "white", width = 9, height = 7, dpi = 200)
```

```{r fig-impv_inc_size}
#| label: fig-impv_inc_size
#| fig-cap: "Characterization of per-reach impervious increase from high resolution change detection; a) Size distribution of individual per-reach increases in impervious cover (n = 7,437, not showing 145 greater than 1 hectare); b) Cumulative increase by per-reach rank; c) Magnitude of impervious increase relative to the proportion of the floodplain type in the assessed reach area"

# rde_impv |>
#   ggplot() +
#   #geom_density(aes(impv_inc_ha))
#   stat_ecdf(aes(impv_inc_ha))

{
  rde_impv |>
    #filter(impv_inc_ha > 1) |> nrow() #145
    #filter(impv_inc_ha > 5) |> nrow() #20
    #filter(impv_inc_ha > 10) |> nrow() #7
    filter(impv_inc_ha <= 1) |> 
    ggplot() + 
    geom_histogram(aes(impv_inc_ha), binwidth = 0.01) + #scale_y_log10()
    # ggplot(aes(impv_inc_ha, 0)) +
    # geom_jitter(aes(alpha = impv_inc_ha), height = 0.3, shape = 18, color = pal_d[1], show.legend = F) +
    # geom_boxplot(fill = NA, varwidth = T, outliers = F) +
    geom_vline(xintercept = 0.09, linetype = 2, color ="blue") +
    annotate("text", x = 0.5, y = 350, label = "Not showing 145 per-reach increases >1 ha") +
    annotate("text", x = 0.3, y = 1000, label = "<--- Single 30x30m pixel", color = "blue") +
    labs(y = "Count of per-reach increases", x = "ha")
    #+theme(axis.text.y = element_blank())
}/{
rde_impv |>
  ggplot() +
  geom_hline(aes(yintercept = max(cimp)/2), linetype = 3) +
  geom_text(data = tibble(rank = 500, cimp = 460, txt = "163 largest per-reach increases\nproduced half the total increase"),
            aes(rank, cimp, label = txt), hjust = 0, vjust = 1) + #filter(rde_impv, between(cimp,473,474))
  geom_point(aes(rank, cimp, color = cimp < max(cimp)/2), size = 0.3, show.legend = F) +
  scale_color_manual(values = c("cyan","orange")) +
  labs(x = "Rank, per-reach increase", y = "Cumulative increase (ha)")
}/{
rde_impv |>
  filter(impv_inc_ha > 0.1) |> 
  ggplot(aes(fld_pct, impv_inc_ha)) +
  #geom_bin2d()
  #geom_text(aes(label = rank)) +
  geom_point(shape = 18, alpha = 0.6, color = pal_d[1]) + #aes(color = rank), 
  #scale_color_gradient(low = pal_d[1], high = alpha(pal_d[1], 0.3))
  labs(x = "Reach proportion floodplain", y = "Per-reach impv. increase")
}+
  plot_layout(heights = c(1/3,1/3,1/3)) + 
  plot_annotation( tag_levels = "a")

#ggsave("f5_impv_inc_size.png", bg = "white", width = 9, height = 12, dpi = 200)
```

```{r tbl_uncertainty, eval=FALSE}

tribble(
  ~Type, ~Concern, ~Dataset, ~Effect, ~Solution,
  
  "Hydrography", "Missing small watercourses", "both, primarily StreamCat-NLCD", "estimates low", "LiDAR derived watercourses",
  "Hydrography", "Inconsistent drainage density representation", "both, primarily RDE-HRCD", "hinders comparison of sub-areas within assessed extent", "LiDAR derived watercourses",
  "Hydrography", "Error in watercourse location", "both", "inaccurate channel edge propagates spatial misalignment of RMZs and land cover polygons/cells", "LiDAR derived watercourses",

  "Riparian dimension", "Fixed width", "StreamCat-NLCD", "estimates high at small channels/drainage-areas and low at large channels/DA", "variable buffer width as a function of geomorphic setting (drainage area, reach slope, channel and valley constraints) and ecological controls (soils, stand composition)",
  "Riparian dimension", "Missing data in SPTH~200yr~ RMZ creation", "RDE-HRCD", "estimates low due where default 100ft buffer width applied", "spatial interpolation of soils/site index values",
  "Riparian dimension", "Aggregation of SPTH~200yr~ RMZwith floodplain polygons", "RDE-HRCD", "estimates high where assesed extent could be considered non-riparian", "stricter limit to narrower area",
  "Riparian dimension", "Error in SPTH~200yr~ values", "RDE-HRCD", "estimates low/high due to narrow/wide RMZ resulting from mis-specified site index, tree species, and/or projected growth", "revise assignment of values to simpler ecoregional tiers combining vegetation height with geomorphic setting",
  "Riparian dimension", "Enclusion of 'non-riparian' area", "both", "estimates high due to floodplain or  assessed area narrow/wide RMZ resulting from mis-specified site index, tree species, and/or projected growth", "",
  
  "Land cover", "Imprecision of HRCD change category assignment", "RDE-HRCD", "estimates high where actual change less than 25/50/75/100% upper category limit", "seek additional high resolution land cover data",
  "Land cover", "Inaccuracy of NLCD category assignment", "StreamCat-NLCD", "estimates low/high where actual change greater/less than per-cell category limits", "calculate alternative realizations according to categorical proportions",
  "Land cover", "Intersection misalignment", "RDE-HRCD", "estimates high where change areas within HRCD polygons fall outside of RMZ intersection", "seek additional high resolution land cover data"
) |>
  gt::gt(
    caption = "Sources of uncertainty and likely effect on estimate bias",
    groupname_col = "type", row_group_as_column = T
    ) |>
  gt::tab_style(style = cell_text(weight = "bold"), locations = cells_column_labels()) |>
  gt::tab_style(style = cell_text(weight = "bold"), locations = cells_column_labels()) |>
  gt::fmt_markdown() |> gt::gtsave(filename = "t2_uncertainty.png")

```

```{r tbl_ccap, eval=FALSE}
#COMPARE AGAINST 2019 NLCD (?)

#stratify by UGA within county bounds
#leaving double sum_sum names to denote aggregation first by individual jurisdiction then binary UGA within county
rde_ccap_df_uga_chin <- rde_ccap_df |> 
  #filter(as.numeric(wria) < 20, cnty != "Grays Harbor", cnty != "Lewis") |> 
  summarise(
    across(contains("_ha"), list(sum = ~sum(.))),
    imp_pct_pid_mean = mean(imp_pct),
    #.by = c(cnty, city_uga_names)
    .by = c(cnty, swifd_chin, city_uga_names) #roughly doubles row count
    ) |> 
  mutate(imp_pct_grnd_tot = imp_ha_sum / tot_ha_sum) |> 
  arrange(desc(tot_ha_sum)) |> #print(n=30)
  mutate(uga = if_else(is.na(city_uga_names), "Non-UGA", "UGA"))

rde_ccap_df_uga_sum <- rde_ccap_df_uga_chin |> 
  summarise(
    across(contains("_ha"), list(sum = ~sum(.))),
    .by = c(uga, cnty)
  ) |> 
  mutate(imp_pct = imp_ha_sum_sum / tot_ha_sum_sum) 

rde_ccap_df_chin_sum <- rde_ccap_df_uga_chin |> 
  summarise(
    across(contains("_ha"), list(sum = ~sum(.))),
    .by = c(uga, swifd_chin)
  ) |> 
  mutate(imp_pct = imp_ha_sum_sum / tot_ha_sum_sum) 

# rde_ccap_df_uga_sum |>
#   ggplot(aes(tot_ha_sum_sum, imp_ha_sum_sum, color = uga)) +
#   geom_point() + geom_smooth(method = "lm", se = F) + scale_color_grey() +
#   geom_text(aes(label = cnty), size = 3) +
#   #facet_wrap(~uga, scales = "fixed") +
#   labs(x = "RDE RMZ+EOW assessed ha in county bounds", y = "RDE RMZ+EOW 2021 CCAP imperv. ha in county bounds")
# 
# rde_ccap_df_uga_sum |> 
#   select(cnty, uga, tot_ha_sum_sum, imp_ha_sum_sum, imp_pct) |> 
#   pivot_wider(names_from = uga, values_from = -c(cnty, uga)) |> 
#   ggplot(aes(imp_pct_UGA, `imp_pct_Non-UGA`)) +
#   #geom_point() +
#   geom_text(aes(label = cnty), size = 3)
# 
# rde_ccap_df_uga_sum |> 
#   ggplot(aes(imp_pct, uga)) +
#   geom_boxplot(varwidth = T, outliers = F) + 
#   #geom_jitter(height = 0.3, size = 0.5) +
#   geom_text(aes(label = cnty), position = position_jitter(height = 0.3), size = 3) +
#   scale_x_continuous(labels = scales::label_percent()) +
#   labs(x = "Impervious portion of assessed RDE RMZ+EOW", y = NULL)

#as table
bind_rows(
  rde_ccap_df_uga_sum
  ,
  rde_ccap_df_uga_sum |> 
    summarise(across(contains("_ha"), ~sum(., na.rm = T)), .by = uga) |> 
    mutate(cnty = "Total", imp_pct = imp_ha_sum_sum / tot_ha_sum_sum)
) |>
  select(cnty, uga, tot_ha_sum_sum, imp_ha_sum_sum, imp_pct) |> 
  pivot_wider(names_from = uga, values_from = -c(cnty, uga)) |> 
  mutate(
    tot_pct_UGA = tot_ha_sum_sum_UGA / (tot_ha_sum_sum_UGA + `tot_ha_sum_sum_Non-UGA`)
    ,
    #ratio = `imp_pct_Non-UGA` / imp_pct_UGA
    ratio = imp_pct_UGA / `imp_pct_Non-UGA`
  ) |> 
  arrange(desc(imp_ha_sum_sum_UGA)) |> 
  gt(caption = "Impervious surface from 2021 CCAP 1m within RDE RMZ & EOW\n by combined UGAs within county bounds ") |> 
  cols_label_with(fn = ~str_remove_all(., "tot_ha_sum_sum_|imp_ha_sum_sum_|tot_|imp_pct_")) |> 
  cols_label(cnty = " ", tot_pct_UGA = "%UGA") |> 
  tab_spanner("Assessed", columns = starts_with("tot")) |> 
  tab_spanner("Impervious", columns = c(starts_with("imp_"), "ratio")) |> 
  tab_style(style = cell_text(weight = "bold"), locations = cells_body(rows = cnty == "Total")) |> 
  tab_style(style = cell_fill(alpha = 0.3), locations = cells_body(columns = c(starts_with("imp_"), "ratio"))) |> 
  fmt_number(columns = contains("sum"), decimals = 0) |> 
  fmt_number(columns = "ratio", decimals = 1) |> 
  fmt_percent(columns = contains("pct"), decimals = 1) |> 
  sub_missing() #save has tight borders, clipped and overwrote |> gt::gtsave(filename = "t3_ccap1m_western_wa.png")

```

![](t2_uncertainty.png)
![](t3_ccap1m_western_wa.png)


# Discussion

Assessment of land cover change at the scale of whole watersheds is crucial to understanding the effects of land use policies, and this statewide analysis showed increased impervious cover within ecologically sensitive riparian areas. The results highlight the ongoing threats to aquatic systems from watershed alteration and the need for continued attention to riparian regulations and their implementation where "no net loss of ecological function and services" is a policy goal and statutory requirement (Riparian Taskforce 2024). The hardening of blood vessels harms human health; recovering watershed health requires halting and reversing the analogous progression of "hydrosclerosis" whereby surface hardening hinders the free flux of matter and energy across land-water boundaries.

The RDE-HRCD and Streamcat-NLCD approaches provided different lines of evidence that statewide riparian impervious cover increased annually by hundreds of hectares during the first years of the 2010s. Each dataset has a distinct combination of observation and processing error, and the approximate convergence in the values of aggregate total estimates may be coincidental. However, the greatest dataset differences in stream length and assessed extent were related to smaller, often headwater reaches, and the upper portions of many stream networks in Washington are steeper, forested, and less prone to urban land uses. Larger, lower, mainstem reaches tended to have more hydrographic agreement, reducing differences in assessed extents where human alteration of land cover tends to be more prevalent.

In addition, an independent analysis by Lazarus (2023) also yielded estimates at a comparable order of magnitude (@tbl-overall). Lazarus (2023) extracted land cover from 2001-2019 NLCD within an alternative depiction of SPTH~200yr~ RMZs, based on similar methods to that developed for the RDE, while excluding sovereign tribal lands and using slightly different underlying hydrography. The spatial distribution of total increase was congruent with the findings here, and a total increase of approximately 4,768 ha of the high (947 ha) and medium (3,821 ha) intensity urban cover classes over this period gives an estimate of roughly 251ha/year on average.

This analysis illustrates key methodological choices that affect quantitative watershed-scale assessments of riparian cover condition: defining the spatial boundaries of evaluation and detecting differences within these bounds. The evaluation extent problem involves both the choice of a hydrographic representation and the lateral width of the riparian management zone, and the detection question concerns the scale of change events. 

The resolution of the drainage network on which buffers are constructed exerts a primary influence on estimates of land cover change. What is seen as a stream controls what is understood to be riparian and adjacent to water. The RDE-HRCD and StreamCat-NLCD estimates presented here both derive from hydrographic datasets (NHD and NHDPlus) that omit extensive lengths of the smaller, sometimes intermittent or ephemeral channels that contribute significantly to water quantity and quality (Brinkerhoff et al 2024). Drainage network coarseness increases the likelihood of under-estimating the overall functional impacts on aquatic ecosystems of land use changes. Future assessments will benefit from the greatly improved accuracy and comprehensiveness of flowlines and channels based on hydrography generated from LiDAR elevation data (i.e., the USGS 3DHP initiative; https://www.usgs.gov/3d-hydrography-program). Moreover, the derivation of linear features that are inherently integrated with a high-resolution representation of the surrounding channel migration zone and valley form creates opportunities to refine and enhance vegetation-based RMZ delineation with information on geomorphic constraints.

Along with the issue of determining "where is the water", the question of "how wide" to make buffers has received considerable research and debate, with the relevant factors including a combination of measurable biophysical conditions and sociocultural values subject to dialogue and power relations (Wilhere and Quinn 2018, Chapman et al. 2020). The assessed corridors in this analysis do not represent any specific authority and, in many locations, extend beyond the riparian management zones subject to regulatory protections during the assessed time window. Accordingly, the new impervious cover shown in these results does not necessarily represent inadequate implementation of the operative regulatory regime. However, these results do raise the question of how much of the additional impact would have been avoided, minimized, or mitigated had the extent of regulatory protections corresponded to these assessed areas (i.e., the composite of SPTH~200yr~ and default 100ft RMZs in the RDE dataset and the 100m buffers in the StreamCat dataset). Moreover, with alternative approaches arriving at estimates of hundreds of hectares a year of new impervious cover within riparian and adjacent areas, a relevant question is how per-project "no net loss" determinations can suffice to preserve ecological function at a whole-network scale. If hundreds of hectares of impervious cover are not being removed each year, are the mitigation actions that follow avoidance and minimization of impact adequate to offset the functional consequences of those that continue to be added?

The ecological risks from a narrow RMZ are heightened by the fact that "upland" imperviousness outside of any corridor up to or beyond 100m contributes some additional impact on riparian and in-channel conditions. A 30m buffer is unlikely to have the same functional effect within a primarily forested catchment as it does when adjacent to land converted to industrial, residential, or agricultural uses. The applicability of buffer width- ecological function decay curves likely warrants review as increasing upland imperviousness continues to alter flow paths and the resulting riparian zone effects on water quantity and quality (e.g., more rapid overland flow due to shifts from saturation-excess to infiltration-excess dynamics). 

Regardless, this evidence of new impervious cover underscores the importance of the regulatory dimensions that define RMZs, which are often undefined or inconsistent, with a range of values stipulated in state forestry regulation (WAC 222-30) and various local critical area ordinances (Folkerts et al. 2020). This regulatory variation is compounded by heterogeneity in the realized on-the-ground conditions within any particular management domain (Swartz et al 2024). Within Washington, adoption of the SPTH~200yr~ standard in WDFW guidance is not compulsory, but it defines a science-based, consistent minimum footprint that is more likely to reduce ecological losses. The SPTH~200yr~ standard provides a site-specific RMZ width, which may need to be wider given site-specific upland surface alteration or other watershed attributes have already impaired desired functions.

Beyond definition of the riparian extent, further uncertainty in landscape scale assessment is associated with the data used to determine land cover change. As described earlier, some residual error unavoidably persists in the high resolution change polygons and the land cover classifications despite the extensive validation and quality control efforts in both datasets. In particular, this analysis does not account for cases of partial intersections of RDE reach polygons with HRCD polygons that include less than complete impervious change. Such instances would tend to bias the aggregate estimates higher if the actual new impervious cover within the HRCD polygon occurred outside the area of intersection. However, this was unlikely to have qualitatively affected results due to the prevalence of very small change areas that were fully encompassed or had little potential for within-polygon displacement outside of a partial intersection. 

Such considerations underscore how future assessments are best addressed through the expanded use and further refinement of data at 1m or less resolution. The 30m land cover data was less suited to characterizing reach and site scale patterns, lacking the ability to capture the many areas of new impervious cover smaller than a single pixel. However, a high resolution dataset of 2011 baseline land cover does not exist at the large extent and longer temporal duration of the coarser spatial data, hindering characterization of the observed changes according to the "before" condition of land that became impervious. Future retrospective studies might explore the potential for data assimilation methods to downscale and re-classify older imagery from models trained on later high-resolution sources, while subsequent assessments may better distinguish among types of pre-impervious vegetation by incorporating newly available data that records time periods after that examined here.

This comparison indicates general patterns in recent land cover conversion, with various anthropogenic changes such as roads, warehouses, and other commercial spaces combined with those due to residential construction. Future extensions of high-resolution datasets could also better disentangle impervious increases related to different activities, thereby clarifying how comparable amounts of population and housing growth may impose smaller or larger demands on riparian habitat conditions (Lambert et al. 2025). 

# Conclusion

Washington State laws seek to steward land and water, striving to encourage vibrant human communities without compromising the natural systems that sustain them. Yet, at a statewide scale during the 2010s, high resolution data indicate that hundreds of hectares of new impervious surface were added each year within areas near streams and rivers. Attention to this ongoing change will be critical to continued progress towards salmon recovery and other valued aspects of ecological integrity within the legal framework of Washington's land use.

# Acknowledgements

The authors wish to thank Colin Struthers, Ray Lee, Mike Leech, Kathleen Elmquist and the rest of the team at ESA for their dedication and efforts in building the Riparian Data Engine web application. We also appreciate the work of Mark Weber and others in the ongoing maintenance and development of the StreamCat data and associated tools. Earlier versions of the manuscript were much improved thanks to comments by George Wilhere, Maddie Nolan, Reed Ojala-Barbour, and Braeden Van Deynze.

# Citations

Bartz, K.K., Ford, M.J., Beechie, T.J., Fresh, K.L., Pess, G.R., Kennedy, R.E., Rowse, M.L. and Sheer, M., 2015. Trends in developed land cover adjacent to habitat for threatened salmon in Puget Sound, Washington, USA. PLoS One, 10(4), p.e0124415.

Chapman, M., Satterfield, T., and Chan, K. M. A. 2020. How value conflicts infected the science of riparian restoration for endangered salmon habitat in America’s Pacific Northwest: Lessons for the application of conservation science to policy. Biological Conservation, 244, 108508. https://doi.org/10.1016/j.biocon.2020.108508

Coastal Change Analysis Program (C-CAP) High-Resolution Land Cover. Charleston, SC: NOAA Office for Coastal Management. Accessed December 2025 at  https://coastalimagery.blob.core.windows.net/ccap-landcover/CCAP_bulk_download/High_Resolution_Land_Cover/Phase_1_Initial_Layers/Impervious/index.html

Fausch, K.D., Torgersen, C.E., Baxter, C.V. and Li, H.W., 2002. Landscapes to riverscapes: bridging the gap between research and conservation of stream fishes: a continuous view of the river is needed to understand how processes interacting among scales set the context for stream fishes and their habitat. BioScience, 52(6), pp.483-498.

Folkerts, K., Johnson, T., and Bouchillon, R., 2020. Final Report: Evaluating Critical Area Ordinance Effectiveness: Mapping Critical Areas. https://www.ezview.wa.gov/Portals/_1992/Documents/2021workshops/Webinar%2010%20-%20Final%20Report%20NTA%200368.pdf

Folkerts K, K. Muir, J. Michalak. 2025. PHS Local Government User Guide: 2025 Riparian Management Zones Map. Habitat Program, Washington Department of Fish and Wildlife, Olympia.

González, E., Felipe-Lucia, M.R., Bourgeois, B., Boz, B., Nilsson, C., Palmer, G. and Sher, A.A., 2017. Integrative conservation of riparian zones. Biological conservation, 211, pp.20-29.

Graziano, M.P., Deguire, A.K. and Surasinghe, T.D., 2022. Riparian buffers as a critical landscape feature: insights for riverscape conservation and policy renovations. Diversity, 14(3), p.172.

Hill, Ryan A., Marc H. Weber, Scott G. Leibowitz, Anthony R. Olsen, and Darren J. Thornbrugh, 2016. The Stream-Catchment (StreamCat) Dataset: A Database of Watershed Metrics for the Conterminous United States. Journal of the American Water Resources Association (JAWRA) 52:120-128. DOI: 10.1111/1752-1688.12372.

Jones, K.B., Slonecker, E.T., Nash, M.S., Neale, A.C., Wade, T.G. and Hamann, S., 2010. Riparian habitat changes across the continental United States (1972–2003) and potential implications for sustaining ecosystem services. Landscape Ecology, 25(8), pp.1261-1275.

Knutson, K. L., and Naef, V. L. 1997. Management recommendations for Washington’s priority habitats: Riparian (p. 181pp.). Washington Department of Fish and Wildlife. https://wdfw.wa.gov/sites/default/files/publications/00029/wdfw00029.pdf

Lambert, M.R., Des Roches, S., Auerbach, D.A., Van Deynze, B., Behrens, S., Hale, R. and Pierce, K.B., 2025. Building the neighborhood for the trees: Illuminating win–wins for housing densification and nature. Conservation Science and Practice, 7(7), p.e70085.

Lazarus, D., 2023. Current Status of Riparian Buffers in Washington State: Public and Private Land Cover Within Riparian Management Zones Based on Best Practice Guidelines (MES thesis, Evergreen State College).

Maxwell, A. E., T. A. Warner, B. C. Vanderbilt, and C. A. Ramezan. 2017. Land cover classification and feature extraction from National Agriculture Imagery Program (NAIP) Orthoimagery: a review. Photogrammetric Engineering & Remote Sensing 83:737–747.

Nilsson, C. and Berggren, K., 2000. Alterations of riparian ecosystems caused by river regulation: Dam operations have caused global-scale ecological changes in riparian ecosystems. How to protect river environments and human needs of rivers remains one of the most important questions of our time. BioScience, 50(9), pp.783-792.

Patten, D.T., 1998. Riparian ecosytems of semi-arid North America: Diversity and human impacts. Wetlands, 18(4), pp.498-512.

Pierce Jr, K.B., 2015. Accuracy optimization for high resolution object-based change detection: An example mapping regional urbanization with 1-m aerial imagery. Remote Sensing, 7(10), pp.12654-12679.

Poff, B., Koestner, K.A., Neary, D.G. and Henderson, V., 2011. Threats to riparian ecosystems in Western North America: an analysis of existing literature 1. JAWRA Journal of the American Water Resources Association, 47(6), pp.1241-1254.

Powell, S.L., Cohen, W.B., Yang, Z., Pierce, J.D. and Alberti, M., 2008. Quantification of impervious surface in the Snohomish water resources inventory area of western Washington from 1972–2006. Remote Sensing of Environment, 112(4), pp.1895-1908.

Quinn, T., G.F. Wilhere, and K.L. Krueger, technical editors. 2020. Riparian Ecosystems, Volume 1: Science Synthesis and Management Implications. Habitat Program, Washington Department of Fish and Wildlife, Olympia. https://wdfw.wa.gov/publications/01987

Rentz, R., A. Windrope, K. Folkerts, and J. Azerrad. 2020. Riparian Ecosystems, Volume 2: Management Recommendations. Habitat Program, Washington Department of Fish and Wildlife, Olympia. https://wdfw.wa.gov/publications/01988

Riparian Taskforce. 2024. Final Report and Recommendations. Prepared by Plauché & Carr LLP. https://ofm.wa.gov/sites/default/files/public/publications/Riparian%20Taskforce%20Final%20Report%20and%20Recommendations.pdf

Schueler, T.R., Fraley-McNeal, L. and Cappiella, K., 2009. Is impervious cover still important? Review of recent research. Journal of Hydrologic Engineering, 14(4), pp.309-315.

Swartz, A.G., Coble, A.A., Thaler, E.A. and Warren, D.R., 2024. Quantifying the Variability of “Fixed-Width” Buffers on Harvested Lands in Western Oregon and Washington. Journal of Forestry, 122(5-6), pp.417-430.

WDFW. 2024. A new way of looking at Washington’s waterways. Medium. https://wdfw.medium.com/a-new-way-of-looking-at-washingtons-waterways-ad05d872c4ce 

Weber M (2025). _StreamCatTools: Tools to Work with the StreamCat API Within R and Access the Full Suite of StreamCat and LakeCat Metrics_. R package version 0.6.0, commit d8a8cce142e7cb9e3666a2660a8315a1766e5981, <https://github.com/USEPA/StreamCatTools>.

Wilhere G and Quinn T. 2018. How Wide is Wide Enough?: Science, Values, and Law in Riparian Habitat Conservation, 58 Nat. Resources J.279, https://digitalrepository.unm.edu/nrj/vol58/iss2/13/


::: {.content-hidden when-format="html" when-format="docx"}


# Tables and Figures

# Supplementary info

```{r fig-cnty_assess_zones_ratio}
#| label: fig-cnty_assess_zones_ratio
#| fig-cap: "Assessed riparian extents by county geographic boundaries; a) Total area in Riparian Data Engine statewide polygons based on SPTH~200yr~; b) The StreamCat 'rp100' 100m riparian buffer on medium resolution NHDPlus; c) RDE proportions by county extent of riparian management zones, extent of observed water, and floodplain polygons; d) Per-county ratio of total assessed extent, RDE:rp100."

d <- as_tibble(sf_cnty_rde_sc) |>
  mutate(
    cnty_ha = cnty_ac * ha,
    reach_ha = reach_ac * ha,
    rde_rp100 = reach_ha / rp100_ha,
    across(
      c(rmz_ac, eow_ac, flood_ac), 
      ~(.*ha)/reach_ha
    ),
    cnty = factor(cnty) |> fct_reorder(reach_ha)
  )

list(
  #range(ha*rde_cnty_sum$reach_ac)
  sf_cnty_rde_sc |>
    ggplot() + geom_sf(aes(fill = ha*reach_ac), show.legend = T) +
    scale_fill_gradient(name = "hectares", labels = scales::label_comma(),
                        low = "#BEE7DF", high = "#212540", na.value = "pink",
                        limits = c(0, 300000)) +
    #labs(subtitle = "A. RDE: RMZ+EOW+floodplain") +
    theme(axis.text = element_text(size = 3))
  ,
  sf_cnty_rde_sc |>
    ggplot() + geom_sf(aes(fill = rp100_ha), show.legend = T) +
    scale_fill_gradient(name = "hectares", labels = scales::label_comma(),
                        low = "#BEE7DF", high = "#212540", na.value = "pink",
                        limits = c(0, 300000)) +
    #labs(subtitle = "B. StreamCat: NHDplus rp100") +
    theme(axis.text = element_text(size = 3))
  ,
    d |>
    select(cnty, cnty_ha, rp100 = rp100_ha, RDE = reach_ha) |> arrange(cnty) |> 
    pivot_longer(-c(cnty, cnty_ha)) |>
    ggplot() + 
    geom_col(aes(value/cnty_ha, cnty, fill = name), position = "dodge") +
    scale_x_continuous(labels = scales::label_percent()) +
    scale_fill_manual(name = NULL, values = c("#7E4837", "#483778")) +
    labs(x = "assessed riparian / county extent", y = NULL
         #,subtitle = "C. Assessed area proportion of county extent"
    ) +
    theme(legend.position = "bottom")
,
  d |>
    select(cnty, reach = reach_ha, RMZ = rmz_ac, EOW = eow_ac, Floodplain = flood_ac) |>
    pivot_longer(-c(cnty, reach)) |>
    ggplot() + 
    geom_col(aes(value, cnty, fill = name, group = cnty, width = reach/max(reach))) +
    scale_x_continuous(labels = scales::label_percent()) +
    scale_fill_manual(name = "RDE zone", values = c("#69A2E4","darkgreen","green")) +
    labs(x = NULL, y = NULL 
         # ,subtitle = "D. RDE zone proportions"
    ) +
    theme(legend.position = "bottom")
  # d |>
  #   select(cnty, rp100_ha, reach_ha, rde_rp100) |> arrange(cnty) |> 
  #   ggplot() +
  #   geom_point(aes(rde_rp100, cnty, size = rp100_ha), color = "#483778", fill = "#483778", shape = 21, alpha = 0.8, show.legend = F) +
  #   #geom_point(aes(rde_rp100, cnty, size = reach_ha), color = "#7E4837", fill = "#7E4837", shape = 22, alpha = 0.4, show.legend = F) +
  #   geom_point(aes(rde_rp100, cnty, size = reach_ha), color = "black", fill = "white", shape = 22, alpha = 0.4, show.legend = F) +
  #   geom_vline(xintercept = 1, linetype = 2) +
  #   scale_x_continuous(limits = c(0, 4.5)) +
  #   labs(x = "RDE ha / rp100 ha", y = NULL,
  #        subtitle = "D. Assessed area ratio, RDE:rp100")
  
) |>
  wrap_plots(design = "AB\nCD", guides = "keep") + 
  plot_annotation(tag_levels = "a")

#ggsave("f2_cnty_assess_zones_ratio.png", bg = "white", width = 10, height = 12, dpi = 200)
```

```{r fig-impv_inc_ha_pct_map_cols}
#| label: fig-impv_inc_ha_pct_map_cols
#| fig-cap: "Geographic distribution and magnitude of riparian impervious change; a) RDE-HRCD impervious (darker) and semi-pervious (lighter); b) StreamCat-NLCD high (darker) and medium (lighter) intensity urban; c) Absolute areas (hectares) for county boundaries with largest RDE-HRCD impervious increases; d) impervious and high classes as proportion of assessed extent; e) Impervious and high as proportion of full county extent"


d <- as_tibble(sf_cnty_rde_sc) |> 
  mutate(
    reach_ha = ha * reach_ac,
    cnty_ha = cnty_ac * ha,

    impv_ha = ha * impv_inc_ac,
    semi_ha = ha * semi_inc_ac,

    hi_ha = `2016_urbhi` - `2011_urbhi`, 
    md_ha = `2016_urbmd` - `2011_urbmd`,

    impv_reach_pct = impv_ha / reach_ha,
    hi_rp100_pct = hi_ha / rp100_ha,

    impv_cnty_pct = impv_ha / cnty_ha,
    hi_cnty_pct = hi_ha / cnty_ha
  ) |> 
  select(cnty, ends_with("ha"), ends_with("pct")) |>
  #slice_max(impv_ha, n = 15) |> 
  filter(str_detect(cnty, "Clark|King|Pierce|Benton|Kitsap|Island|Snoho|Spokane|Yakima")) |> 
  pivot_longer(c(ends_with("ha"), ends_with("pct"), -cnty_ha, -reach_ha, -rp100_ha)) |> 
  mutate(
    src = if_else(str_detect(name, "impv|semi|reach"), "RDE-HRCD", "SC-NLCD") |> 
      factor(levels = c("RDE-HRCD", "SC-NLCD"))
    ,
    name = paste0(src, "_", name)
  )

pal_d <- set_names(
  c("#7E4837","#7E4837","#7E4837","#BAAF9F",
    "#483778","#483778","#483778",alpha("#483778",0.3)),
  sort(unique(d$name))
)

{
  sf_cnty_rde_sc |>
      ggplot() + 
      geom_sf(aes(fill = ha*(impv_inc_ac+semi_inc_ac)), color = "white", show.legend = T) +
      geom_sf(data = sf_wa_city, color = "brown", show.legend = F) +
      geom_sf_text(data = sf_wa_city, aes(label = name), color = "brown", hjust = 1.1, size = 3, show.legend = F) +
      scale_fill_gradient(name = "ha", low = "grey95", high = pal_d["RDE-HRCD_impv_ha"]) + #, limits = c(0,300)
      labs(x = NULL, y = NULL
#, subtitle = "A. RDE-HRCD imperv+semi 2011-2017"
) +
      theme(axis.text = element_blank())
  }+{
    sf_cnty_rde_sc |>
      ggplot() + 
      geom_sf(aes(fill = (`2016_urbhi`+`2016_urbmd`) - (`2011_urbhi`+`2011_urbmd`)), color = "white", show.legend = T) +
      geom_sf_text(data = sf_cnty |> semi_join(d, by = "cnty"), aes(label = cnty), color = "grey20", size = 3) +
      geom_sf(data = sf_wa_city, color = "brown", show.legend = F) +
      #geom_sf_text(data = sf_wa_city, aes(label = name), color = "brown", hjust = 1.1, size = 3, show.legend = F) +
      scale_fill_gradient(name = "ha", low = "grey95", high = pal_d["SC-NLCD_hi_ha"]) +
      labs(x = NULL, y = NULL
#, subtitle = "B. SC-NLCD 'high'+'med' 2011-2016"
) +
      theme(axis.text = element_blank())
  }+{
  d |>
    filter(str_detect(name, "_ha")) |> 
    ggplot() +
    geom_col(aes(value, src, fill = name), show.legend = F) +
    scale_y_discrete(limits = rev) +
    scale_fill_manual(values = pal_d) +
    facet_wrap(~cnty, strip.position = "right", ncol = 1) +
    labs(x = "ha", y = NULL
#, subtitle = "C. Abs. area"
) +
    theme(
      axis.text.y = element_text(size = 5),
      strip.text = element_text(size = 6))
 }+{
  d |> 
    filter(str_detect(name, "reach|rp100")) |> 
    ggplot() +
    geom_col(aes(value, src, fill = name), show.legend = F) +
geom_vline(xintercept = 0.0005, linetype = 2) +
    scale_x_continuous(name = "% of assessed extent", labels = scales::label_percent()) +
    scale_y_discrete(limits = rev) +
    scale_fill_manual(values = pal_d) +
    facet_wrap(~cnty, strip.position = "right", ncol = 1) +
    labs(y = NULL
#, subtitle = "D. Proportion assessed"
) +
    theme(
      axis.text.y = element_text(size = 5),
      strip.text = element_text(size = 6))
}+{
  d |> 
    filter(str_detect(name, "cnty_pct")) |> 
    ggplot() +
    geom_col(aes(value, src, fill = name), show.legend = F) +
geom_vline(xintercept = 0.0005, linetype = 2) +
    scale_x_continuous(name = "% of total county extent", labels = scales::label_percent()) +
    scale_y_discrete(limits = rev) +
    scale_fill_manual(values = pal_d) +
    facet_wrap(~cnty, strip.position = "right", ncol = 1) +
    labs(y = NULL
#, "E. Proportion county extent"
) +
    theme(
      axis.text.y = element_text(size = 5),
      strip.text = element_text(size = 6))
} +
#plot_layout(design = "AAABBB\nCCDDEE") +
plot_layout(design = "ACDE\nBCDE") +
plot_annotation(tag_levels = "a")

#ggsave("f3_impv_inc_ha_pct_map_cols.png", bg = "white", width = 16, height = 7, dpi = 200)
```

```{r ccap_1m_testing}
# terra::rast("~/T/DFW-Team WDFW Watershed Synthesis - data_common/ccap/2021_CCAP/2021_CCAP_J1231012tR0_C0.tif") #30m

#https://storymaps.arcgis.com/stories/f22c0fe823974d61b7db4c19f616c250
#from: https://coastalimagery.blob.core.windows.net/ccap-landcover/CCAP_bulk_download/High_Resolution_Land_Cover/Phase_1_Initial_Layers/Impervious/index.html
ccap_imp <- terra::rast("~/T/DFW-Team WDFW Watershed Synthesis - data_common/ccap/wa_2021_ccap_v2_hires_impervious_20250407/wa_2021_ccap_v2_hires_impervious_20250407.tif")

#only RMZ and EOW but no attribute of SPTH200 value
sf_rde_10 <- st_read("wdfw_rde_spth200_tess_wria_10.gpkg") |> #26.5k polys by PID
  st_transform(st_crs(ccap_imp))

#killed after too long: #rde_10_ccap <- terra::extract(ccap_imp, sf_rde_10, fun = table)
#not seeing anything too new: https://r.geocompx.org/raster-vector
#perhaps faster to rasterize RDE/tess?

library(exactextractr)

# exact_extract(ccap_imp, sf_rde_10[1:10,], fun = c("frac"))
# exact_extract(ccap_imp, sf_rde_10[1:10,], fun = c("sum","count")) |> mutate(frac = sum/count)

#considerably smaller
ccap_imp_crop <- terra::crop(ccap_imp, sf_rde_10)
#still slow but tolerable (~2min) and with progress bar at least
system.time(
rde_10_ccap <- exact_extract(ccap_imp_crop, sf_rde_10, fun = c("sum","count"), append_cols = c("pid","zone"))
)

rde_10_ccap |> 
  #semi_join(filter(rde_cnty, wria == "10"), by = "pid") |> 
  semi_join(rde_cnty, by = "pid") |> 
  mutate(
    tot_ha = count * 0.0001,
    imp_ha = sum * 0.0001,
    imp_pct = imp_ha/tot_ha #sum/count
    ) |> 
  summarise(
    across(ends_with("ha"), list(sum = ~sum(.))),
    imp_pct_pid_mean = mean(imp_pct)
    ) |> 
  mutate(imp_pct_grnd_tot = imp_ha_sum / tot_ha_sum)

rde_wria <- rde_cnty |> 
  #allow duplication of spanning reaches: #distinct(pid, .keep_all = T) |> 
  rename_with(~str_remove(., "nonfstry_")) |> 
  summarise(
    across(
      c(stream_miles, reach_ac, riparian_ac,
        rmz_ac, eow_ac, flood_ac, 
        impv_inc_ac, semi_inc_ac
      ), ~sum(., na.rm = T)),
    .by = "wria"
  ) |> 
  mutate(
    stream_km = stream_miles * 1.61,
    reach_ha = ha*reach_ac,
    riparian_ha = ha*riparian_ac,
    impv_inc_ha = ha*impv_inc_ac,
    impv_reach_pct = impv_inc_ac / reach_ac,
    impv_ripar_pct = impv_inc_ac / riparian_ac,
    semi_inc_ha = ha*semi_inc_ac,
    semi_reach_pct = semi_inc_ac / reach_ac
  )

rde_wria |> filter(wria == "10") |> select(contains("_ha"), contains("pct"))

#need/want this? semi_join(rde_cnty, by = "pid")

sf_rde_10_imp <- sf_rde_10 |> 
  left_join(
    rde_10_ccap |> 
      mutate(
        tot_ha = count * 0.0001,
        imp_ha = sum * 0.0001,
        imp_pct = imp_ha/tot_ha #sum/count
      )
    ,
    by = c("pid","zone")
  )

#mapview::mapview(sf_rde_10_imp, zcol = "imp_ha")
#mapview::mapview(sf_rde_10_imp, zcol = "imp_pct")
sf_rde_10_imp |> filter(imp_ha > 0) |> mapview::mapview(zcol = "imp_pct")

#calc imp_pct collapsed over zone
as_tibble(sf_rde_10_imp) |> 
  summarise(across(ends_with("ha"), sum), .by = c(pid)) |> #summary()
  mutate(imp_pct = imp_ha/tot_ha) |> 
  ggplot() + geom_col(aes(imp_pct, fct_reorder(pid, imp_pct, min)))


as_tibble(sf_rde_10_imp) |> 
  select(pid, zone, ends_with("_ha")) |> 
  pivot_wider(names_from = zone, values_from = ends_with("_ha")) |> 
  left_join(
    rde_cnty |> 
      mutate(
        eow_ha = ha*eow_ac,
        rmz_ha = ha*rmz_ac,
        impv_inc_ha = ha*nonfstry_impv_inc_ac,
        semi_inc_ha = ha*nonfstry_semi_inc_ac,
      ) |> 
      select(pid, cnty, wria, ends_with("_ha"))
    ,
    by = "pid"
  ) |> 
  # #44 pids in spatial object that are missing from reach_table object
  # filter(is.na(cnty))
  drop_na(cnty) |> 
  mutate(across(contains("_ha"), ~replace_na(., 0))) |> 
  ggplot() +
  geom_point(aes(impv_inc_ha, imp_ha_EOW+imp_ha_RMZ), alpha = 0.5, size = 0.4)
 
 
bind_rows(
  rde_ccap_df |>
  summarise(
    across(contains("_ha"), list(sum = ~sum(.))),
    imp_pct_pid_mean = mean(imp_pct),
    .by = cnty
    ) |>
  mutate(imp_pct_grnd_tot = imp_ha_sum / tot_ha_sum)
,
rde_ccap_df |>
  summarise(
    across(contains("_ha"), list(sum = ~sum(.))),
    imp_pct_pid_mean = mean(imp_pct)
    ) |>
  mutate(cnty = "Total", imp_pct_grnd_tot = imp_ha_sum / tot_ha_sum)
) |>
  select(County = cnty, `Assessed ha` = tot_ha_sum, `Impervious ha` = imp_ha_sum, `Impv. %` = imp_pct_grnd_tot, `Mean reach impv. %` = imp_pct_pid_mean) |>
  arrange(desc(`Impervious ha`)) |>
  gt(caption = "2021 CCAP 1m impervious surface within RDE RMZ & EOW") |>
  fmt_number(columns = 2:3, decimals = 0) |>
  fmt_percent(columns = 4:5, decimals = 1)

```

```{r nhdp_vs_hrcd, eval=FALSE}
#roughing out NHDplus vs HRCD

#unions to multilinestring by county; st_line_merge cannot combine geometry from separated linestrings to single
sf_flw_cnty <- sf_flw |> group_by(cnty) |> summarise()
#buffer to multipoly, no internal borders per county but minor overlaps and overruns at county borders
sf_flw_cnty_100 <- st_buffer(sf_flw_cnty, dist = 328)
#st_intersection against sf_cnty cleans up edges so map over cnty
#not terribly slow
sf_flw_cnty_100 <- map(
  sf_flw_cnty_100$cnty,
  ~st_intersection(
    filter(sf_flw_cnty_100, cnty == .x),
    filter(sf_cnty, cnty == .x)
    )
  ) |> 
  bind_rows() |> select(-cnty.1)


gdb <- file.path(dir_data_common, "HRCD.gdb") #also NAD83(HARN)
#sf::st_layers(gdb)
sf_hrcd <- sf::st_read(gdb, layer = "HRCD_ChangeLocations") #~4gb
#trim to impervious and semi increases in 11-17
sf_hrcd_11_17 <- sf_hrcd |> 
 filter(
   between(StartYr, 2011, 2015), 
   between(EndYr, 2013, 2017),
   (ImpIncAc > 0 | SemiIncAc > 0),
   CngOrigin == "Anthropogenic"
   )

as_tibble(sf_hrcd_11_17) |> 
  # mutate(across(c(ImpIncPct, SemiIncPct), ~as.character(round(., digits = 2)))) |> 
  # #count(ImpIncPct, SemiIncPct) |> 
  # count(ImpIncPct) |> 
  mutate(p = as.character(round(ImpIncPct + SemiIncPct, digits = 2))) |> count(p) |> 
  arrange(desc(n))

#want this? sf_hrcd_11_17_semionly <- sf_hrcd_11_17 |> filter(ImpIncAc == 0)
#as_tibble(sf_hrcd_11_17) |> count(StartYr, EndYr)
#as_tibble(sf_hrcd_11_17) |> count(CngOrigin, CngAgentNm)

#not super fast but not crazy slow, row expanding by HRCD polys
i <- st_intersection(
  filter(sf_flw_cnty_100, cnty == "Pierce"),
  sf_hrcd_11_17
)

#ImpIncPct_ac SemiIncPct_ac ImpIncPct_ha SemiIncPct_ha
#         95.0          50.9         38.4          20.6
as_tibble(i) |>
  mutate(
    across(
      c(ImpIncPct, SemiIncPct),
      list(
        ac = ~as.numeric(units::set_units(. * st_area(geometry), "acres")),
        ha = ~as.numeric(units::set_units(. * st_area(geometry), "hectares"))
      ))
  ) |> 
  select(contains("Imp"),contains("Semi")) |> 
  summarise(
    across(c(ends_with("_ac"), ends_with("_ha")), sum)
  )


#my simple 100m does not account for waterbody area, polygons of larger rivers lakes etc
#and is ~6K hectares smaller than 54062 rp100
filter(sf_flw_cnty_100, cnty == "Pierce") |> st_area() |> units::set_units("hectares") #48,471
# rde_cnty_sum |> filter(cnty == "Pierce") #not-distinct-pid, includes small area shared across county borders
# rde_impv |> filter(cnty == "Pierce") |> summarise(across(ends_with("inc_ac"), sum)) #excludes border spanning
as_tibble(sf_cnty_rde_sc) |> #built from rde_cnty_sum
  mutate(
    reach_ha = ha * reach_ac,
    cnty_ha = cnty_ac * ha,

    impv_ha = ha * impv_inc_ac,
    semi_ha = ha * semi_inc_ac,

    hi_ha = `2016_urbhi` - `2011_urbhi`, 
    md_ha = `2016_urbmd` - `2011_urbmd`,

    impv_reach_pct = impv_ha / reach_ha,
    hi_rp100_pct = hi_ha / rp100_ha,

    impv_cnty_pct = impv_ha / cnty_ha,
    hi_cnty_pct = hi_ha / cnty_ha
  ) |> 
  select(cnty, ends_with("inc_ac"), ends_with("ha"), ends_with("pct")) |> 
  filter(cnty == "Pierce") 

mapview::mapview(filter(sf_flw_cnty_100, cnty == "Pierce")) +
  mapview::mapview(i, zcol = "ImpIncPct")

#see below but this sf_hrcd_11_17 only has 23 counties
#due to sf_hrcd above only having 25
sf_flw_cnty_100_hrcd <- map(
  sf_flw_cnty_100$cnty,
  ~st_intersection(
    filter(sf_flw_cnty_100, cnty == .x),
    sf_hrcd_11_17
    )
  ) |> 
  bind_rows()

#sf_flw_cnty_100_hrcd |> slice(1:20) |> mapview::mapview() 

as_tibble(sf_flw_cnty_100_hrcd)[1:7641,] |>
  #some strange "not a matrix" error from st_area on this object
  #cannot make sense of why [] or slice(1:7641) fixes but st_area(sf_flw_cnty_100_hrcd[1:7641,]) also works when st_area(sf_flw_cnty_100_hrcd) fails
  mutate(
    int_ha = as.numeric(units::set_units(st_area(geometry), "hectares")),
    across(
      c(ImpIncPct, SemiIncPct),
      list(
        ha = ~. * int_ha
      )
    )
  ) |>
  select(cnty, Acres, int_ha, contains("Imp"),contains("Semi")) |> 
  #summarise(across(c(ends_with("_ha")), sum)) #274 and 208 impv/semi respectively, but for only 23 of 39 counties
  summarise(across(c(ends_with("_ha")), sum) ,.by = cnty) |> 
  left_join(
    as_tibble(sf_cnty_rde_sc) |> #built from rde_cnty_sum
      mutate(
        reach_ha = ha * reach_ac,
        cnty_ha = cnty_ac * ha,
        impv_ha = ha * impv_inc_ac,
        semi_ha = ha * semi_inc_ac,
        hi_ha = `2016_urbhi` - `2011_urbhi`, 
        md_ha = `2016_urbmd` - `2011_urbmd`,
        impv_reach_pct = impv_ha / reach_ha,
        hi_rp100_pct = hi_ha / rp100_ha,
        impv_cnty_pct = impv_ha / cnty_ha,
        hi_cnty_pct = hi_ha / cnty_ha
      ) |> 
      select(cnty, ends_with("ha"))
    , by = "cnty"
  ) |> 
  arrange(desc(ImpIncPct_ha)) |> 
  print(n = Inf)

unique(as_tibble(sf_flw_cnty_100_hrcd)$cnty)
unique(sf_hrcd_11_17$CountyNm) #only 23 of 39
unique(sf_hrcd$CountyNm) #still only 25, so a 
as_tibble(sf_hrcd) |> filter(CountyNm == "Yakima") |> count(StartYr) #missing many E side records

```

```{r gg_rde_cnty_sum_reach_pct_cnty, eval=FALSE}
{
sf_cnty_rde_sc |> 
  mutate(pct = reach_ac/cnty_ac) |> 
  ggplot() + 
  geom_sf(aes(fill = pct)) +
  scale_fill_gradient(name = "reach / cnty", low = grey(0.8), high = grey(0.2))
}/{
as_tibble(sf_cnty_rde_sc) |> 
  mutate(pct = reach_ac/cnty_ac) |> 
  ggplot() + 
  geom_col(aes(pct, fct_reorder(cnty, pct, identity), fill = pct)) +
    scale_fill_gradient(name = "reach / cnty", low = grey(0.8), high = grey(0.2)) +
  scale_x_continuous("Proportion of county area", labels = scales::label_percent()) +
  labs(y = NULL)
} +
  plot_annotation("Assessed reach area as proportion of county boundary extent")
```

```{r gg_impv_vs_tree_dec, eval=FALSE}

rde_cnty_sum |> #glimpse()
  #ggplot(aes(tree_dec_ac_pct_rch, impv_inc_ac_pct_rch)) +
  ggplot(aes(impv_inc_ac_pct_rch, tree_dec_ac_pct_rch)) +
  geom_point() +
  geom_text(aes(label = cnty))

# rde_cnty |> 
#   drop_na(nonfstry_impv_inc_ac) |> 
#   distinct(pid, .keep_all = T) |>
#   filter(nonfstry_tree_dec_ac + nonfstry_impv_inc_ac > 0) |> 
#   filter(nonfstry_tree_dec_ac + nonfstry_impv_inc_ac < 2) |> 
#   ggplot(aes(nonfstry_tree_dec_ac, nonfstry_impv_inc_ac)) +
#   geom_abline(linetype = 3) +
#   #geom_point(size = 0.1, alpha = 0.3)
#   #geom_hex()
#   geom_bin2d()

```

```{r gg_rde_cnty_per_reach_imp_inc_pct_reach_ac, eval=FALSE}
#could also show as pct = nonfstry_impv_inc_ac / reach_ac
rde_cnty |> 
  filter(nonfstry_impv_inc_ac > 0) |> #7541
  ggplot(aes(
    nonfstry_impv_inc_ac / reach_ac,
    fct_reorder(cnty, nonfstry_impv_inc_ac, sum)
    )) +
  geom_jitter(height = 0.2, alpha = 0.5, size = 0.4) +
  geom_boxplot(varwidth = T, outliers = F, color = "orange", fill = NA) + 
  scale_x_continuous(labels = scales::label_percent()) +
  labs(y = NULL, x = NULL,
       title = "Per-reach impervious cover increases as percentage of reach area",
       subtitle = "Reach acres = RMZ plus EOW and floodplain where present"
       )
```

## pop/housing

Population increases during 2011-2017 were positively correlated with the normalized impervious increase in the riparian corridor, but considerable variation was evident among county-boundary aggregates. For example, the King and Clark areas had population gains greater than that within the Pierce boundary, but smaller proportional impervious increases. Conversely, the Kitsap extent had the fourth largest normalized impervious increase despite less population growth than many other areas (@fig-impv_inc_pop_change). A comparable pattern was evident for changes in housing units, with substantial variation around a generally positive correlation (@fig-impv_inc_housing_change). The King and Island county extents were notable for the, respectively, large and small housing gains relative to proportional riparian corridor impervious additions. 

```{r, eval=FALSE}
#| label: fig-impv_inc_pop_change

# rde_cnty_sum |>
#   ggplot(aes(impv_inc_ac_pct_rch, log10(d_est_pop))) +
#   geom_point(aes(size = `2011_est_pop`, color = `2011_est_pop`)) +
#   geom_text(aes(label = cnty), hjust = 1.1, size = 3, check_overlap = T) +
#   scale_size_area(max_size = 4, guide = "none") +
#   scale_color_gradient(name = "2011 est. pop. x1000", low = alpha("orange", 0.6), high = "brown", labels = scales::label_number(scale = 1/1000)) +
#   scale_y_continuous(name = "log10 population change 2011-2017", labels = scales::label_log(digits = 1)) +
#   scale_x_continuous(name = "Percentage of assessed riparian corridor", labels = scales::label_percent()) +
#   theme(
#     legend.position = "bottom", legend.key.width = unit(0.1, "npc")
#   )

rde_cnty_sum |> 
  #ggplot(aes(d_est_pop/`2011_est_pop`, impv_inc_ac_pct_rch)) +
  # scale_x_continuous(name = "population change 2011-2017", labels = scales::label_percent()) +
  # scale_y_continuous(name = "Percentage of assessed riparian corridor", labels = scales::label_percent())
  ggplot(aes(impv_inc_ac_pct_rch, d_est_pop/`2011_est_pop`)) +
  geom_point(aes(size = `2011_est_pop`, color = `2011_est_pop`)) +
  geom_text(aes(label = cnty), hjust = -0.1, size = 3, check_overlap = T) +
  scale_size_area(max_size = 4, guide = "none") +
  scale_color_gradient(
    name = "2011 est. pop. x1000",
    low = alpha("orange", 0.6), high = "brown", labels = scales::label_number(scale = 1/1000)) +
  scale_y_continuous(name = "Population change 2011-2017", labels = scales::label_percent()) +
  scale_x_continuous(name = "Percentage of assessed riparian corridor", labels = scales::label_percent()) +
  coord_cartesian(xlim = c(-0.0001, 0.002), ylim = c(-0.01, .13), expand = F) +
  theme(
    legend.position = "bottom", legend.key.width = unit(0.1, "npc")
  )
  
```

```{r, eval=FALSE}
#| label: fig-impv_inc_housing_change

rde_cnty_sum |>
  # select(cnty, impv_inc_ac_pct_rch, d_total, d_single, d_multi) |> 
  # pivot_longer(starts_with("d_")) |> 
  # ggplot(aes(impv_inc_ac_pct_rch, value, color = name)) +
  # facet_wrap(~name, ncol = 1, scales = "free")
  ggplot(aes(impv_inc_ac_pct_rch, d_total)) +
  geom_point(color = "purple", size = 0.8) + # aes(size = `2011_total`)
  geom_text(aes(label = cnty), hjust = 1.1, size = 3, check_overlap = T) +
  scale_x_continuous(name = "Percentage of assessed riparian corridor", labels = scales::label_percent()) +
  scale_y_continuous(name = "Change in total housing units", labels = scales::label_comma()) 

```

```{r gg_rde_cnty_housing_stacked_cols, eval=FALSE}
rde_cnty_sum |>
  mutate(cnty = factor(cnty) |> fct_reorder(`2011_total`)) |>
  select(cnty, `2011_single`, `2011_multi`, `2011_other`) |>
  pivot_longer(-cnty) |>
  ggplot() + geom_col(aes(value, cnty, fill = name)) +
  scale_x_continuous(labels = scales::label_comma()) +
  scale_fill_manual(name = "Housing", values = c("brown","yellow","tan")) +
  labs(x = NULL, y = NULL, title = "2011 housing composition")
```

```{r gg_impv_vs_pop, eval=FALSE}
#really potentially misleading?
rde_cnty_sum |> 
  mutate(
    pct_impv = impv_inc_ac / sum(impv_inc_ac),
    pct_pop = d_est_pop / sum(d_est_pop)
  ) |> 
  ggplot(aes(pct_pop, pct_impv)) +
  geom_abline() +
  geom_point() +
  geom_text(aes(label = cnty)) +
  labs(title = "Statewide proportion impv vs pop")
```

## other unused lit

Hepinstall-Cymerman, J., S. Coe, and L.R. Hutyra. 2013. Urban growth patterns and growth management boundaries in the central Puget Sound, Washington, 1986–2007. Urban Ecosystems 16:109–129.

[UW MS thesis]
Nayak (2023) focused on the Cedar River-Lake Washington watershed, reporting a measurable increase in impervious surface area within 54 identified riparian zones, noting that 21st-century growth is more nuanced due to zoning policies, yet significant enough to influence water quality and hydrology.

Nayak, S., 2023. Impact of Riparian Landscape Patterns on Water Quality in an Urbanizing River Basin: A Case of Cedar River-Lake Washington Watershed. Master's thesis. University of Washington. Available at: https://digital.lib.washington.edu/researchworks/bitstream/handle/1773/49961/Nayak_washington_0250O_23832.pdf?sequence=1 [Accessed 4 August 2025].

Maxwell, A.E., Strager, M.P., Warner, T.A., Ramezan, C.A., Morgan, A.N. and Pauley, C.E., 2019. Large-area, high spatial resolution land cover mapping using random forests, GEOBIA, and NAIP orthophotography: Findings and recommendations. Remote Sensing, 11(12), p.1409.
https://www.mdpi.com/2072-4292/11/12/1409

Zhang, H., Gorelick, S.M. and Zimba, P.V., 2020. Extracting impervious surface from aerial imagery using semi-automatic sampling and spectral stability. Remote Sensing, 12(3), p.506.
https://www.mdpi.com/2072-4292/12/3/506

Subedi, M.R., Portillo-Quintero, C., Kahl, S.S., McIntyre, N.E., Cox, R.D. and Perry, G., 2023. Leveraging NAIP imagery for accurate large-area land use/land cover mapping: A case study in central Texas. Photogrammetric Engineering & Remote Sensing, 89(9), pp.547-560.
https://www.ingentaconnect.com/contentone/asprs/pers/2023/00000089/00000009/art00007?crawler=true&mimetype=application/pdf

:::
