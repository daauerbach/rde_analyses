---
title: "Assessing Washington's Riparian Land Cover"
author: "dan.auerbach@dfw.wa.gov"
date: "`r Sys.Date()`"
output-file: sc_ripcorr_nlcd.html
format:
  html:
    embed-resources: true
    theme: yeti 
    code-fold: true
    toc: true
    toc-location: left
    grid:
      sidebar-width: 180px
      body-width: 1100px
      margin-width: 20px
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 10)

library("tidyverse", quietly = T)
library("sf")
library("patchwork")
library("gt")
theme_set(theme_minimal()) 

dir_data_common <- "~/T/DFW-Team WDFW Watershed Synthesis - data_common"
epsg <- 2927 #WA state standard; NAD83(HARN)/ft

#load("sc_ripcorr_nlcd.RData")
```

# Introduction

'Riparian' designates where streams and rivers meet and mingle with uplands. As with other ecological edges, this meeting place is host to mutually enriching physical and biological exchanges. These land-water interactions provide numerous services of value to people, leading to laws and policies meant to protect and rehabilitate riparian areas.

In Washington state, within the context of U.S. treaties with sovereign tribes, the Clean Water Act, the Endangered Species Act, and other federal statutes, the 'realized regulatory regime' that affects riparian and shore areas emerges from multiple land use frameworks that include the Shoreline Management Act, the Forest Practices Act, and the Growth Management Act. Administrative responsibility is shared and often overlapping, and no single entity has statewide authority over riparian management or the location and size of 'riparian management zones' (RMZ) delineating the jurisdictional extent of decisions. 

However, the Washington Department of Fish and Wildlife, under its mandate "to preserve, protect and perpetuate fish, wildlife and ecosystems while providing sustainable fish and wildlife recreational and commercial opportunities", has issued guidance on a statewide RMZ formulation that is grounded in available evidence of ecosystem functions. The [Site Potential Tree Height standard (SPTH)](https://wdfw.wa.gov/publications/02564) promulgated in WDFW management recommendations [(Rentz et al. 2020)](https://wdfw.wa.gov/publications/01988) follows from an extensive review and synthesis of scientific studies [(Quinn et al. 2020)](https://wdfw.wa.gov/publications/01987) that updated and extended earlier guidelines [(Knutson and Naef 1997)](https://wdfw.wa.gov/sites/default/files/publications/00029/wdfw00029.pdf). The premise that social, political, and economic values inform any answer to "how wide should an RMZ be" led to separation of the technical review and policy recommendations ([Wilhere and Quinn 2018](https://digitalrepository.unm.edu/nrj/vol58/iss2/13/), Chapman et al. 2020).

Accordingly, the SPTH200 concept in the 2020 WDFW guidance - that the height of mature native trees characteristic of a location determines the RMZ lateral distance from water - is an attempt to accommodate the need for consistency and standardization in implementation while recognizing the inherent natural variation in geomorphic, hydrologic, and ecological conditions. In support of applying the SPTH200 standard more readily, the agency has subsequently developed a geospatial web application that "unites WDFW riparian datasets in Washington State...allow[ing] planners to evaluate the conditions of riparian ecosystems and make data-informed planning decisions". The foundation of this [Riparian Data Engine (RDE)](https://ripariandata.wdfw.wa.gov/) is a statewide polygon tessellation of RMZs generated from public hydrography (NHD) and soils (SSURGO) data. Various land cover, jurisdictional, water quality, and salmon distribution attributes have been calculated for each RMZ unit, enabling users to interactively examine a "reach table" consisting of individual RMZ rows. Filters and map-based exploration support interactive queries and comparison of summarized attribute values. For example, a user can rapidly filter for locations within a Water Resource Inventory Area (WRIA) or a county with a tree canopy cover proportion of interest (i.e., to target protection towards higher cover or rehabilitation towards lower cover). In addition, the RDE provides a means to quickly compare a single reach to the summarized attributes of its upstream and downstream "network neighborhoods". Such information can help to inform a range of conservation management decisions at the site scale [(WDFW 2024)](https://wdfw.medium.com/a-new-way-of-looking-at-washingtons-waterways-ad05d872c4ce).

But despite the well-understood importance of riparian areas and the considerable attention devoted to their study in Washington and the western United States more broadly, considerable uncertainty still surrounds basic measures of riparian condition and change at the landscape scale. Notwithstanding the qualitative consensus that riparian ecosystems have experienced "substantial" or "dramatic" changes, quantitative estimates vary widely, and these differences may hinder effective communication or setting appropriate policy objectives. 

This analysis therefore addresses the need for landscape scale quantification, with a primary focus on "urban" cover as an indicator of imperviousness (much impervious area occurs outside of large cities, but "urban" avoids the unintended connotations of the term "developed"). Impervious cover has statewide relevance in mesic (western) and semi-arid (eastern) regions of the state, and is well-understood to be associated with ecohydrologic degradation. Specifically, we investigated the seemingly simple question "How much impervious surface has Washington state added to riparian areas in the 21st century?"

Past research has indicated likely patterns without providing a clear answer to this inquiry Jones et al. (2010) considered late 20th century land cover change (1973-2003) at relatively coarse spatial resolution (60m) within a 180m buffer of NHD watercourses in several thousand sample blocks across the continental United States. They described a nationwide monotonic increase in the average riparian "urban %" over the assessed duration, and their results showed the Puget lowlands region had the largest decrease in "natural land cover" during the "mid 80s - early 90s" period (relative both to its change in other time periods and to all other regions nationally in that period).

Increased "urban" or impervious cover within Puget Sound was also described by Powell et al. (2008) and Bartz et al. (2015). Throughout the Snohomish basin of central Puget Sound, north of Seattle, an increase of 255%, from 3285 ha in 1972 to 11,652 ha in 2006 was detected from a nuanced analysis combining manual orthophoto review with Landsat imagery spanning 1972 to 2006. Though not focused on riparian areas, this study indicated that a rapid impervious expansion during the 1980s then slowed somewhat throughout the 1990s before returning to a faster rate after 2000. The authors noted the potential for changes in land use regulations to have influenced this trajectory, chiefly the 1990 passage of GMA, but stated a need for more detailed study of additional alternative factors before any direct attribution.

Broadening to more watersheds, Bartz et al. (2015) found similar dynamics in an assessment of annual changes derived from a LandTrendr per-pixel analysis of 30m imagery within 100m or 200m buffers of salmon habitat geographic features. Within these assessed areas, they estimated that, by 2008, impervious cover in mainstem zones increased roughly 172ha (~425ac, 3%) from ~5820ha in 1986, and that tributary zones increased roughly 119ha (294ha, 5.5%) from ~2,153ha. However, they also reported evidence of a "flatter" rate of increase in urban cover across these and the other nearshore, estuary, and floodplain habitat areas examined, with the timing of inflections varying considerably among habitat types and subbasins. These authors were unequivocal that a legacy of degradation continues to affect Puget Sound habitats, but they also concluded that more recent land cover change may indicate slower growth in additional impairment, perhaps associated with a combination of cultural, economic and regulatory factors.

Lazarus (2023) considered a statewide extent, using the National Land Cover Dataset (NLCD) and Cropland Data Layer (CDL) to examine the relative prevalence of vegetation and impervious cover classes within alternative riparian buffer configurations on lands stratified by public and private ownership. This analysis sought to address a holistic set of shifts among multiple land uses across Washington's varied ecoregions, but an increase in impervious-type classes was broadly apparent, estimated to total more than 4,500 ha (>11,000 acres) in the SPTH200 buffer between 2001 and 2019 (see table 16, as the combination of all 4 NLCD 'developed' classes).  

[...]


StreamCat/NLCD...comparing the RDE with a simple, spatially-defined riparian corridor

terms and defs: 
  - rmz vs 'corridor', buffer etc.
  - need to make clear that counties are geographic units that contain multiple jurisdictions NOT the jurisdictional area of county governments


## notes

- RDE/HRCD
  - need to get fully certain that 2011-17 is the time span
  - presentation of county/larger aggregates that mix reaches with/without floodplain (since no 'zone' attrib in API tables)
  - SWIFD stratification?
  
- SC/NLCD
  - rethink whether d_cat_rp100 are valid: if cat is X% giving 10ac and rp100 is Y% giving 10ac, is 0ac d_cat_rp100 always accurate?
  - micro-acreage filter to exclude possible spurious urbhimd noise in forests/river gravels
  - stratify by bfw within county, either 5/25m akin to Bartz or examine distro and pick percentile values
  - what other figs/tables?
    - finish refactoring arrowswarm?
    - bring back/do new other change from-to? (e.g. not all imper inc associated with forest decrease)

- [task force recs](https://ofm.wa.gov/sites/default/files/public/publications/RiparianTaskforcePreliminaryRecommendationsMay2024.pdf)

- Add county level population change numbers? fit: urb_ac_rp100 ~ year + pop + housing
  - capture that per-person increases decreasing even as abs continues to increase? or just use bookend pop numbers [now seeing this was done in Powell et al (fig 6, continuously) and Bartz et al (text, bookends)]
 
- 2021 1m imperv CCAP/Ecopia https://coastalimagery.blob.core.windows.net/ccap-landcover/CCAP_bulk_download/High_Resolution_Land_Cover/Phase_1_Initial_Layers/Impervious/index.html
  - needs processing: SPTH perhaps via Colin's RDE scripts, StreamCat would be question to Mark et al. (opened issue)



- tie in Swartz et al 2024 showing real-world variation in 'fixed width' forest harvest buffers? As related to Folkerts et al 2020 Mapping Critical Areas report?

## lit notes
see sc_ripcorr_nlcd for initial 

Hepinstall-Cymerman, J., S. Coe, and L.R. Hutyra. 2013. Urban growth patterns and growth management boundaries in the central Puget Sound, Washington, 1986–2007. Urban Ecosystems 16:109–129.

Kennedy, R.E., Z. Yang, J. Braaten, C. Copass, N. Antonova, C. Jordan, and P. Nelson. 2015. Attribution of disturbance change agent from Landsat time-series in support of habitat monitoring in the Puget Sound region, USA. Remote Sensing of Environment 166:271-285.


[UW MS thesis]
Nayak (2023) focused on the Cedar River-Lake Washington watershed, reporting a measurable increase in impervious surface area within 54 identified riparian zones, noting that 21st-century growth is more nuanced due to zoning policies, yet significant enough to influence water quality and hydrology.

Nayak, S., 2023. Impact of Riparian Landscape Patterns on Water Quality in an Urbanizing River Basin: A Case of Cedar River-Lake Washington Watershed. Master's thesis. University of Washington. Available at: https://digital.lib.washington.edu/researchworks/bitstream/handle/1773/49961/Nayak_washington_0250O_23832.pdf?sequence=1 [Accessed 4 August 2025].


ScholarGPT via Ken M: 
>Comparative Insight:
20th Century Industrialization Phase: Characterized by aggressive land clearing for agriculture, timber, and heavy industrial operations, leading to direct and large-scale riparian buffer destruction.
21st Century Urbanization: Expansion is less aggressive per unit area but more pervasive, leading to cumulative impacts over broader areas due to residential, infrastructural, and commercial suburban sprawl.
Conclusion:
While the scale and patterns of impervious surface expansion have shifted from concentrated industrial footprints in the 20th century to more distributed urban/suburban expansion in the 21st, the net effect has been a continued loss of riparian function and buffer integrity across Washington State. Despite improved regulatory frameworks, growth management efforts have only partially mitigated these trends.


# Methods 

```{r sf_wrias_cnty}
sf_wrias <- sf::read_sf(file.path(dir_data_common, "WR_WAT_WRIA.gdb/")) |>
  mutate(
    wria = factor(WRIA_NR),
    wria_nr_nm = paste0(str_pad(WRIA_NR,width = 2, pad = "0",),"_",WRIA_NM) |> factor()) |>
  select(WRIA_NR, WRIA_NM, wria, wria_nr_nm, acres = WRIA_AREA_ACR_QT) |> arrange(wria) |> 
  sf::st_transform(sf::st_crs(epsg))

sf_cnty <- sf::read_sf(file.path(dir_data_common, "WA_County_Boundaries/WA_County_Boundaries.shp")) |> 
  select(cnty = JURISDIC_2) |> 
  sf::st_transform(sf::st_crs(epsg))
```

```{r ofm_housing_cnty}
ofm_housing <- readxl::read_excel(
  file.path(dir_data_common, "census", "ofm_april1_postcensal_estimates_housing_1980_1990-present.xlsx"),
  sheet = 2, skip = 2, na = "."
  ) |> 
  drop_na(Filter) |>  #filter(Filter!=".") |> 
  janitor::clean_names() |> 
  select(filter, county, jurisdiction, contains("total_housing")) |> 
  pivot_longer(contains("total_housing"), values_to = "total_housing") |> 
  mutate(
    year = str_sub(name, 2, 5), name = NULL,
    across(c(year, total_housing), as.numeric)
    )

ofm_housing_cnty <- ofm_housing |> 
  filter(filter == "1", year > 1980) |> 
  select(cnty = county, year, total_housing)

# ofm_housing_cnty |> #count(jurisdiction) |> print(n=50)
#   plotly::plot_ly(name = ~cnty) |> plotly::add_lines(x = ~year, y = ~total_housing)
# 
# ofm_housing_cnty |> filter(year == 1990) |> 
#   #arrange(desc(total_housing)) |> print()
#   filter(total_housing > 50000) |> 
#   ggplot(aes(total_housing, fct_reorder(cnty, total_housing, identity))) +
#   geom_col() #+ scale_x_log10(labels = scales::label_log())

```

## Riparian Data Engine

```{r build_rde_wria_library, include=F, eval=FALSE}
# #first DL csv
# walk(
#   #1:30,
#   31:62,
#   
#   ~httr2::request(paste0(
#     'https://api-ripariandata.wdfw.wa.gov/wrias/',.x,'/reaches/csv'
#   )) |> 
#     httr2::req_headers(`x-api-key` = key) |> 
#     #httr2::req_dry_run()
#     httr2::req_perform() |> 
#     httr2::resp_body_raw() |> 
#     readr::read_csv() |> 
#     readr::write_csv(
#       file = file.path(dir_data_common, paste0("rde/wrias/rde_wria_",stringr::str_pad(.x, 2, pad = "0"), ".csv"))
#     )
# )
```

```{r build_rch_tbl_wria, include=F, eval=FALSE}
#then build combined object: 1084192 x 40
#note deduplicating 52 shared across wrias: length(unique(rch_tbl$pid)) == 1084140
rch_tbl <- map_df(
  list.files(file.path(dir_data_common, "rde/wrias"), pattern = ".csv", full.names = T)
  ,
  ~readr::read_csv(.x) |>
    mutate(pid = as.character(PermanentIdentifier), PermanentIdentifier = NULL)
  ) |>
  rename(wria = WaterResourceInventoryAreaID) |>
  janitor::clean_names() |>
  rename_with(~str_replace(.,"acres","ac")) |>
  rename_with(~str_replace(.,"human_forestry_","forestry_")) |>
  rename_with(~str_replace(.,"human_nonforestry_","nonfstry_")) |>
  rename_with(~str_replace(.,"decrease","dec")) |>
  rename_with(~str_replace(.,"increase","inc")) |>
  rename_with(~str_replace(.,"impervious","impv")) |>
  rename_with(~str_replace(.,"semipervious","semi")) |>
  select(pid, everything(), -reach_id) |> 
  distinct(pid, .keep_all = T)

glimpse(rch_tbl)

#saveRDS(rch_tbl, "~/T/DFW-Team WDFW Watershed Synthesis - data_common/rde/wria_rch_tbl.rds")

```

```{r rde_wria, include=F, eval=FALSE}
rde_wria <- readRDS("~/T/DFW-Team WDFW Watershed Synthesis - data_common/rde/wria_rch_tbl.rds") |> 
  mutate(
    wria = factor(wria),
    tree_pct = all_tree_cover_ac / all_land_cover_ac,
    veg_pct = all_vegetated_ac / all_land_cover_ac
    ,
    swifd_any = !is.na(swifd_salmon_distribution),
    swifd_n = 1 + str_count(swifd_salmon_distribution,","),
    swifd_n_fct = case_when(
      is.na(swifd_n) ~ "none",
      swifd_n < 3 ~ "1-2 species",
      swifd_n >= 3 ~ "3 or more species"
    ),
    swifd_chin = case_when(
      str_detect(swifd_salmon_distribution, "Chin") ~ "salmon_with_chin",
      str_detect(swifd_salmon_distribution, "Chin", negate = T) ~ "salmon_not_chin",
      is.na(swifd_salmon_distribution) ~ "not_salmon"
    )
  ) 

```

The complete set of "reach tables" were compiled from the public RDE web application, comprising attribute values for more than 1 million individual units of the SPTH200-based polygon tesselation. The permanent identifiers that index rows in this structure can include a combination of "extent of observed water" (EOW), "floodplain" (primarily based on FEMA mapping), and riparian management zone (RMZ, both banks where double-banked) geometry. 

```{r build_rde_cnty_library, eval=FALSE}
walk(
  URLencode(sort(sf_cnty$cnty))
  ,
  ~httr2::request(paste0(
    'https://api-ripariandata.wdfw.wa.gov/counties/',.x,'/reaches/csv'
  )) |>
    httr2::req_headers(`x-api-key` = key) |>
    #httr2::req_dry_run()
    httr2::req_perform() |>
    httr2::resp_body_raw() |>
    readr::read_csv() |>
    readr::write_csv(
      file = file.path(dir_data_common, paste0("rde/counties/rde_cnty_",.x, ".csv"))
    )
)

```

```{r build_rch_tbl_cnty, eval=FALSE}
#then build combined object: 1,091,144x 40
#NOT deduplicating PID shared across counties
#length(unique(rch_tbl_cnty$pid)) == 1084186 (46 more than wrias?)
#would either need to remove entirely or split+assign by proportion
#preferable to include and count twice in per-county stratification
#and/but unstratified statewide sum-over-counties needs distinct()

rch_tbl_cnty <- map_df(
  list.files(file.path(dir_data_common, "rde/counties"), pattern = ".csv", full.names = T)
  ,
  ~readr::read_csv(.x) |>
    mutate(
      pid = as.character(PermanentIdentifier), PermanentIdentifier = NULL,
      cnty = basename(.x) |> str_remove("rde_cnty_") |> str_remove(".csv") |> 
        str_replace_all("%20", " ")
      )
  ) |>
  rename(wria = WaterResourceInventoryAreaID) |>
  janitor::clean_names() |>
  rename_with(~str_replace(.,"acres","ac")) |>
  rename_with(~str_replace(.,"human_forestry_","forestry_")) |>
  rename_with(~str_replace(.,"human_nonforestry_","nonfstry_")) |>
  rename_with(~str_replace(.,"decrease","dec")) |>
  rename_with(~str_replace(.,"increase","inc")) |>
  rename_with(~str_replace(.,"impervious","impv")) |>
  rename_with(~str_replace(.,"semipervious","semi")) |>
  select(pid, cnty, wria, everything(), -reach_id)

glimpse(rch_tbl_cnty)

#saveRDS(rch_tbl_cnty, "~/T/DFW-Team WDFW Watershed Synthesis - data_common/rde/cnty_rch_tbl.rds")

```

```{r rde_cnty}
#for any statewide sum need: distinct(pid, .keep_all = T)
#no way in this table structure, without a 'zone' attribute', to differentiate RMZ-EOW-Floodplain
rde_cnty <- readRDS("~/T/DFW-Team WDFW Watershed Synthesis - data_common/rde/cnty_rch_tbl.rds") |> 
  mutate(
    wria = factor(wria),
    tree_pct = all_tree_cover_ac / all_land_cover_ac,
    veg_pct = all_vegetated_ac / all_land_cover_ac
    ,
    swifd_any = !is.na(swifd_salmon_distribution),
    swifd_n = 1 + str_count(swifd_salmon_distribution,","),
    swifd_n_fct = case_when(
      is.na(swifd_n) ~ "none",
      swifd_n < 3 ~ "1-2 species",
      swifd_n >= 3 ~ "3 or more species"
    ),
    swifd_chin = case_when(
      str_detect(swifd_salmon_distribution, "Chin") ~ "salmon_with_chin",
      str_detect(swifd_salmon_distribution, "Chin", negate = T) ~ "salmon_not_chin",
      is.na(swifd_salmon_distribution) ~ "not_salmon"
    )
  ) 

```


```{r qaqc_and_hot_take_cnty_impv, include=F, eval=FALSE}

rde_cnty_sum_impv <- rde_cnty |> 
  summarise(
    across(
      #contains("impv"),
      c(reach_ac, nonfstry_impv_inc_ac, nonfstry_tree_dec_ac),
      ~sum(., na.rm = T)
    )
    , .by = cnty
  ) |> 
  mutate(
    across(
      starts_with("nonf"),
      list(
        per_100ac = ~100*(./reach_ac)
      )
    )
  )

rde_cnty_sum_impv <- rde_cnty_sum_impv |> 
  left_join(
    ofm_housing_cnty |> 
      filter(year %in% c(2011, 2017)) |> 
      pivot_wider(names_from = year, values_from = total_housing) |> 
      mutate(d_hous = `2017` - `2011`)
    ,
    by = "cnty"
  )

{
sf_cnty |> 
  left_join(rde_cnty_sum_impv, by = "cnty") |> 
  ggplot() + geom_sf(aes(fill = nonfstry_impv_inc_ac)) + 
    wacolors::scale_fill_wa_c("volcano", reverse = T, na.value = "pink") +
    labs(title = "Riparian impervious cover increase 2011-2017", subtitle = "Sum of HRCD estimates within SPTH200 RMZ+EOW")
}/{
rde_cnty_sum_impv |> 
  ggplot() + 
    geom_col(aes(
      nonfstry_impv_inc_ac,
      fct_reorder(cnty, nonfstry_impv_inc_ac),
      fill = nonfstry_impv_inc_ac)) + 
    wacolors::scale_fill_wa_c("volcano", reverse = T, na.value = "pink") +
    labs(y = NULL, x = "acres")
}+
  plot_layout(guides = "collect")


rde_cnty_sum_impv |> 
  filter(between(d_hous, 500, 5000)) |> 
  ggplot(aes(d_hous, nonfstry_impv_inc_ac)) +
  geom_point(aes(color = nonfstry_impv_inc_ac, 
                 size = nonfstry_impv_inc_ac), show.legend = F) +
  geom_smooth() +
  geom_text(aes(label = cnty), color = "purple", nudge_y = 5, size = 3) +
  scale_size_area() +
  #scale_x_log10(labels = scales::label_log()) + 
  wacolors::scale_color_wa_c("volcano", reverse = T, na.value = "pink") +
  labs(x = "OFM 2017-2011 total housing unit change", y = "est. impervious increase acres")

rde_cnty_sum_impv |> 
  select(County = cnty, nonfstry_impv_inc_ac) |> 
  gt() |> 
  fmt_number("nonfstry_impv_inc_ac", decimals = 2)

#qaqcing Skagit to better understand how much of this change may be in floodplain (a lot)
#if 'floodplain' is left selected from Skagit county page, this has largest imp inc of 21ac
#https://ripariandata.wdfw.wa.gov/reaches/128936102
filter(rde_cnty, pid == "128936102") |> glimpse() #large floodplain appears to have most HRCD polys
#if 'floodplain' deselected from Skagit county page, this has largest imp inc of 6ac
#https://ripariandata.wdfw.wa.gov/reaches/165685545
filter(rde_cnty, pid == "165685545") |> glimpse() #matches


#going to UGA level. unlikely for peer-review mscp other than example/case study
#975 name strings, many with several UGAs
rde_cnty |> 
  count(city_uga_names) |> arrange(desc(n)) |> print(n = 50)

#Sumner looks to have had major new industrial/warehouse footprints on White R bottomlands
#https://earthengine.google.com/timelapse#v=47.22426,-122.22593,11.665,latLng&t=1.75&ps=50&bt=19840101&et=20221231
rde_cnty |> 
  filter(nonfstry_impv_inc_ac > 0) |> 
  summarise(
    across(
      c(reach_ac, nonfstry_impv_inc_ac, nonfstry_tree_dec_ac),
      ~sum(., na.rm = T)
    )
    , .by = c(cnty, city_uga_names)
  ) |> 
  arrange(desc(nonfstry_impv_inc_ac))

#some very large reaches, mostly lakes and Columbia with mostly EOW
rde_cnty |>
  arrange(desc(reach_ac)) |> select(pid, cnty, ends_with("_ac"))
#Lk WA is one 28K ac PID: https://ripariandata.wdfw.wa.gov/reaches/148897889

#fed/state/tribal/muni/private cols cannot be used to limit/exclude jurisdictional extents in counties
#occurrence of some PADUS acreage has little association with impinc
#likely due to potential for spatial co-occurrence in single reach
#possible that some new impervious "on/in" protected area
#but also possible and perhaps more probable that large reaches contain spatially nonintersecting both
#all PADUS cols either NA or numeric per reach, such that is.na(federal_ac) 
rde_cnty |> 
  #drop_na(federal_ac) |> filter(is.na(state_ac) | is.na(tribal_ac) | is.na(municipal_ac) | is.na(private_ngo_ac))
  mutate(has_padus_ac = !is.na(federal_ac)) |> 
  summarise(
    across(
      c(reach_ac, nonfstry_impv_inc_ac, nonfstry_tree_dec_ac),
      ~sum(., na.rm = T)
    )
    , .by = c(has_padus_ac)
  ) |> 
  mutate(
    across(starts_with("nonf"), list(pct = ~./reach_ac))
  )

#little association of imperv to PADUS for reaches with both
#neither clear positive corr suggesting more impinc in larger reaches
#nor clear negative corr signaling less impinc
rde_cnty |> 
  filter(nonfstry_impv_inc_ac > 0) |> #7541
  select(pid, cnty, swifd_any,
         nonfstry_impv_inc_ac,
         federal_ac:tribal_ac
         ) |> 
  pivot_longer(
    federal_ac:tribal_ac, names_to = "auth", values_to = "ac"
  ) |> 
  filter(ac > 0) |> #distinct(pid) #2540 of 7541 with nonzero impinc && nonzero PADUSac
  filter(ac < 1000) |> #exclude some big EOW/floods to see better
  ggplot(aes(ac, nonfstry_impv_inc_ac, color = auth)) +
  geom_point(alpha = 0.3, size = 0.3, show.legend = F) +
  scale_x_log10() +
  scale_y_log10() +
    facet_wrap(~auth, scales = "free")


```


## StreamCat-processed NLCD

The [`StreamCatTools`](https://github.com/USEPA/StreamCatTools) (Weber 2025) R package was used to access the [StreamCat dataset](https://www.epa.gov/national-aquatic-resource-surveys/streamcat-dataset) (Hill et al. 2016), which delivers consistently geoprocessed attribute values for each reach unit of the original medium resolution NHDPlus hydrography. Derived from a 30m DEM and sometimes termed "1:100K", this captures most substantial watercourses and is the precursor to subsequent higher-resolution continent-wide elevation derived hydrographic datasets that include many smaller channel units (i.e., NHDPlusHR from 10m DEM and 3DHP from LiDAR). For each reach 'comid', StreamCat provides attribute values from many raster and rasterized datasets that are processed within the local contributing catchment ('`cat`') as well as a 100m riparian buffer ('`rp100`') on "stream lines and on-network NLCD water pixels". 

*Not yet using Ws/Wsrp100, but add description here if added below*

```{r objects_sf, eval=FALSE}
  
# ##flowlines with WRIA added deduplicated via 'largest=T'
# sf_flw <- sf::read_sf(file.path(dir_data_common, "NHDPlus17/NHDSnapshot/Hydrography/NHDFlowline.shp")) |>
#   sf::st_transform(crs = sf::st_crs(epsg)) |>
#   sf::st_zm() |>
#   select(COMID, FCODE, FTYPE, LENGTHKM) |>
#   rename_with(tolower) |>  
#   st_join(sf_cnty, left = F, largest = T) |> #inner join
#   st_join(sf_wrias |> select(wria, wria_nr_nm), left = F, largest = T) |> #inner join
#   mutate(comid = as.character(comid))
# saveRDS(sf_flw, file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_flw.rds"))
sf_flw <- readRDS(file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_flw.rds"))

# # ##catchment polys with WRIA added deduplicated via 'largest=T'
# sf_cat <- sf::read_sf(file.path(dir_data_common, "NHDPlus17/NHDPlusCatchment/Catchment.shp")) |>
#   sf::st_transform(crs = sf::st_crs(epsg)) |>
#   select(comid = FEATUREID, areasqkm = AreaSqKM) |>
#   st_join(sf_cnty, left = F, largest = T) |> #inner join
#   st_join(sf_wrias |> select(wria, wria_nr_nm), left = F, largest = T) |>
#   mutate(comid = as.character(comid))
# saveRDS(sf_cat, file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_cat.rds"))
sf_cat <- readRDS(file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_cat.rds"))

# # ~608 comids along county borders are assigned different (appropriately, due to geometry+'largest')
# #not splitting geometries (and attributes) so simpler is better
# #visual inspection indicates flowlines should have precedence for associating to StreamCat/NLCD
# mm <- inner_join(
#   sf_cat |> as_tibble() |> select(comid, cnty_cat=cnty),
#   sf_flw |> as_tibble() |> select(comid, cnty_flw=cnty),
#   by = "comid"
#   ) |> 
#   filter(cnty_cat!=cnty_flw)
# x <- sf_cat |> semi_join(mm, by = "comid")
# y <- sf_flw |> semi_join(mm, by = "comid")
# mapview::mapview(list(cat = x, flw = y, cnty = sf_cnty))

# distinct(as_tibble(sf_flw), comid) #66116
# distinct(as_tibble(sf_cat), comid) #57306
# #flowlines with no cat are most pipelines & canalditch (~3K), a third of coastline
# #but also many scattered streamriver and artificalpath statewide but large concentrations in yakima region
# #cat with no flowlines are edge cases, a pothole depressional area SE of Okanagon plus a few other scattered Eastside

```

StreamCat includes values calculated from 8 cycles of the National Land Cover Dataset: 2001, 2004, 2006, 2008, 2011, 2013, 2016, and 2019. The NLCD rasters are based on random forest classification of satellite and other imagery sources [(Wickham et al. 2023)](https://www.tandfonline.com/doi/full/10.1080/15481603.2023.2181143). The StreamCat values represent the percentages of each of 16 land cover classes within each of the *cat* and *catrp100* areas of interest  (AOI), so that the sum across classes is 1 for each AOI (i.e., the *rp100* area is spatially nested, but `rp100` percentages are provided as distinct rather than proportional to the total *cat* area). Approximate acreages were back-calculated simply as:

$$ acres = pct_{nlcd-class} * areasqkm_{cat|catrp100} * 247.11$$

The StreamCat process and NLCD datasets have undergone thorough QAQC and been extensively reviewed since their initial development, resulting in their widespread use in various scientific studies (see Wickham et al 2023 for the most recent NLCD validation study). Nonetheless, as with any remote sensed empirical data, errors persist, and several key caveats are important to note.

  - The underlying hydrographic flowlines and associated catchment polygon mesh have positional error; not all streams, drainage divides, and/or riparian buffer corridors are 'where they should be'.
  - Within any particular NLCD year, substantial ground level variation can occur within the 30m pixel resolution, such that the single cover class assigned to the pixel may poorly describe the actual heterogenity (stated differently, the per-pixel suitability of classification will tend to increase with homogeneity of cover types). 
  - Between different NLCD years, a change in NLCD class may be due to sudden, substantial activity (e.g., a clear cut; fallowing or crop rotation; a new parking lot); to gradual, accumulative shifts of the fine-scale mix of types within-pixel; or potentially to spurious artifacts rather than any actual ground-level change.

Accordingly, these data are a standardized, consistent means to investigate larger-scale, general or cumulative patterns, and are not suited to inferring site specific processes or causes.
 
```{r objects_streamcat_nlcd, eval=FALSE}
## recall riparian buffers are 100m, per https://www.epa.gov/national-aquatic-resource-surveys/streamcat-dataset-readme 
 
# #pull all 4 AOI, including abs areasqkm
# sc_wa_nlcd <- map(
#   set_names(c(2001, 2004, 2006, 2008, 2011, 2013, 2016, 2019))
#   ,
#   ~StreamCatTools::sc_nlcd(
#     state = "WA", year = .x,
#     aoi = 'cat,catrp100,ws,wsrp100',
#     showAreaSqKm = T
#   ) |>
#     rename_with(tolower) |> as_tibble() |>
#     mutate(comid = as.character(comid), nlcd_year = .x)
# )
# saveRDS(sc_wa_nlcd, file.path(dir_data_common, "streamcat", "sc_wa_nlcd.rds"))

# #removing 7 massive cross-border COMIDs mostly in BC; 6 are >1000km2, last is >350km2
# sf_cat |> arrange(desc(areasqkm)) |> filter(areasqkm>1000) |> ggplot() + geom_sf() + geom_sf_text(aes(label = comid))
# sf_cat |> filter(between(areasqkm,100,1000)) |> ggplot() + geom_sf(aes(fill=areasqkm)) + geom_sf_text(aes(label = comid))
# filter(sf_cat, comid =="23031682")->x; mapview::mapview(x)
comids_drop_BC <- filter(as_tibble(sf_cat), areasqkm>1000) |> distinct(comid) |> bind_rows(tibble(comid = "23031682"))

#starting object with cat and catrp100 (no Ws)
#inner_join against sf_cat to add WRIA 
#then second inner_join against sf_flw to add County and get common set across all 3
#dropping remaining comids with NA rp100
#converting pcts to 0-1
#appending 'ac[res]' cols as AOI-specific product of pct and areasqkm
sc_nlcd <- readRDS(file.path(dir_data_common, "streamcat", "sc_wa_nlcd.rds")) |> 
  map(
    ~.x |> 
      rename_with(
        ~str_remove(.,paste(c(2001, 2004, 2006, 2008, 2011, 2013, 2016, 2019),collapse = "|")) |> 
          str_remove("pct")
        ) |> 
      select(comid, nlcd_year, 
             catareasqkm, catareasqkmrp100,
             ends_with("cat"), ends_with("catrp100"))
      ) |> 
  list_rbind() |> 
  anti_join(comids_drop_BC, by = "comid") |> 
  inner_join(as_tibble(sf_cat) |> select(comid, wria, wria_nr_nm), by = "comid") |> 
  inner_join(as_tibble(sf_flw) |> distinct(comid, cnty), by = "comid") |> 
  drop_na(urbmdcatrp100) |> #single lu class captures all 231 comids NA for rp100 vals
  mutate(
    across(c(ends_with("cat"), ends_with("catrp100")), ~./100)
    ,
    # tree_cat = conifcat + decidcat + mxfstcat,
    # tree_catrp100 = conifcatrp100 + decidcatrp100 + mxfstcatrp100,
    urb_cat = urbhicat + urbmdcat,
    urb_catrp100 = urbhicatrp100 + urbmdcatrp100
    ,
    across(ends_with("cat"), list(ac = ~.* catareasqkm * 247.11)),
    across(ends_with("catrp100"), list(ac = ~.* catareasqkmrp100 * 247.11))
    )

#bring both sf to same 56879
sf_flw <- sf_flw |> inner_join(distinct(sc_nlcd, comid), by = "comid") 
sf_cat <- sf_cat |> inner_join(distinct(sc_nlcd, comid), by = "comid")


pal_nlcd <- set_names(
  c("brown","darkgreen","yellow","lightgreen","yellowgreen",
    "yellow","seagreen","white","green","blue",
    "tan","grey10","grey60","grey30","grey80","seagreen")
  ,
  grep("catrp100_ac", names(sc_nlcd), value = T)[1:16] |> 
    str_remove("catrp100_ac") |> sort()
)

#testing focal set
wrias <- as.character(c(1,7,8,10,15, 28,32,37,45,57))

#save.image("sc_ripcorr_nlcd.RData")
```

# Results

*results presented here are based on the area (acreage) associated with the RMZ and EOW [+FLOODPLAIN] "riparian corridor"*
*reiterate/stress counties as geographic not jurisdictional*

distribution of individual increases illustrates "individually small, large in aggregate" and "typically less than 25% of total reach area" 

```{r gg_rde_cnty_per_reach_imp_inc}
# rde_cnty |> 
#   filter(nonfstry_impv_inc_ac > 0) |> 
#   ggplot(aes(
#     nonfstry_impv_inc_ac,
#     fct_reorder(cnty, nonfstry_impv_inc_ac)
#     )) +
#   geom_jitter(height = 0.2, alpha = 0.5, size = 0.4) +
#   #geom_boxplot(varwidth = T, outliers = F, fill = NA) + 
#   #wacolors::scale_fill_wa_c("volcano", reverse = T, na.value = "pink", aesthetics = c("fill","color")) +
#   labs(y = NULL, x = "acres")

rde_cnty |> 
  filter(nonfstry_impv_inc_ac > 0) |> #7541
  filter(nonfstry_impv_inc_ac < 20) |> #7531
  ggplot(aes(
    nonfstry_impv_inc_ac,
    fct_reorder(cnty, nonfstry_impv_inc_ac, sum)
    )) +
  geom_vline(xintercept = 1, linetype = 3) +
  geom_jitter(height = 0.2, alpha = 0.5, size = 0.4) +
  geom_boxplot(varwidth = T, outliers = F, color = "orange", fill = NA) + 
  labs(y = NULL, x = "acres",
       title = "Per-reach impervious cover increases",
       subtitle = "Not showing 10 reaches with increases >20ac")

#could also show as pct = nonfstry_impv_inc_ac / reach_ac
rde_cnty |> 
  filter(nonfstry_impv_inc_ac > 0) |> #7541
  ggplot(aes(
    nonfstry_impv_inc_ac / reach_ac,
    fct_reorder(cnty, nonfstry_impv_inc_ac, sum)
    )) +
  geom_jitter(height = 0.2, alpha = 0.5, size = 0.4) +
  geom_boxplot(varwidth = T, outliers = F, color = "orange", fill = NA) + 
  scale_x_continuous(labels = scales::percent) +
  labs(y = NULL, x = NULL,
       title = "Per-reach impervious cover increases as percentage of reach area",
       subtitle = "Reach acres = RMZ plus EOW and floodplain where present"
       )

```

area normalized by county total reach acres (RMZ+EOW+Flood)
illustrates the variation among counties, which here are geographic rather than jurisdictional units
could do similar distributions as above for per-reach impinc / reach

```{r gg_nonfstry_impv_inc_ac_per_100ac_col}

{{
  sf_cnty |> 
    left_join(rde_cnty_sum_impv, by = "cnty") |> 
    ggplot() + geom_sf(aes(fill = nonfstry_impv_inc_ac), show.legend = F) + 
    wacolors::scale_fill_wa_c("volcano", reverse = T, na.value = "pink") +
    labs(title = "Riparian impervious cover increase 2011-2017", subtitle = "Sum of HRCD estimates, RMZ+EOW+floodplain")
}+{
  sf_cnty |> 
    left_join(rde_cnty_sum_impv, by = "cnty") |> 
    ggplot() + geom_sf(aes(fill = nonfstry_impv_inc_ac_per_100ac), show.legend = F) + 
    wacolors::scale_fill_wa_c("volcano", reverse = T, na.value = "pink") +
    labs(subtitle = "Normalized per 100ac riparian")
}}/{{
  rde_cnty_sum_impv |> 
    ggplot() + 
    geom_col(aes(
      nonfstry_impv_inc_ac,
      fct_reorder(cnty, nonfstry_impv_inc_ac),
      fill = nonfstry_impv_inc_ac), 
      show.legend = F) + 
    wacolors::scale_fill_wa_c("volcano", reverse = T, na.value = "pink") +
    labs(y = NULL, x = "acres")
}+{
  rde_cnty_sum_impv |> 
    ggplot() +
    geom_col(aes(
      nonfstry_impv_inc_ac_per_100ac,
      fct_reorder(cnty, nonfstry_impv_inc_ac_per_100ac),
      fill = nonfstry_impv_inc_ac_per_100ac),
      show.legend = F) + 
    wacolors::scale_fill_wa_c("volcano", reverse = T, na.value = "pink", aesthetics = c("fill","color")) +
    labs(y = NULL, x = "Acres imp. inc. per 100ac") 
}} +
  plot_layout(guides = "collect")


```

area normalized vs abs area
reinforces the implicit relationships in above figure

```{r gg_nonfstry_impv_inc_ac_per_100ac_vs_abs}
{
rde_cnty_sum_impv |> 
  ggplot(aes(nonfstry_impv_inc_ac, nonfstry_impv_inc_ac_per_100ac)) +
  geom_point(size = 0.3, show.legend = F) + 
  geom_text(aes(label = cnty), size = 3, check_overlap = F, show.legend = F) + 
  geom_smooth(method = "lm") +
  wacolors::scale_fill_wa_c("volcano", reverse = T, na.value = "pink", aesthetics = c("fill","color")) +
  labs(
    x = "Total acres", y = "Acres imp. inc. per 100ac",
    title = "Impervious increases by county,\narea normalized vs absolute area") 
}/{
rde_cnty_sum_impv |> 
  ggplot(aes(nonfstry_impv_inc_ac, nonfstry_impv_inc_ac_per_100ac)) +
  geom_point(size = 0.3, show.legend = F) + 
  geom_text(aes(label = cnty), size = 3, check_overlap = F, show.legend = F) + 
  geom_smooth(method = "lm") +
  wacolors::scale_fill_wa_c("volcano", reverse = T, na.value = "pink", aesthetics = c("fill","color")) +
  coord_cartesian(xlim = c(0,75), ylim = c(0, 0.08)) +
  labs(
    x = "Total acres", y = "Acres imp. inc. per 100ac",
    subtitle = "Counties with <75ac total increase") 
}
```

vs housing

```{r gg_nonfstry_impv_inc_ac_per_100ac_vs_housing}
{
rde_cnty_sum_impv |> 
  ggplot(aes(d_hous, nonfstry_impv_inc_ac)) +
  geom_point(size = 0.3, show.legend = F) + 
  geom_text(aes(label = cnty), size =3, color = "purple", nudge_y = 0.005) +
  geom_smooth(method = "lm") +
  wacolors::scale_fill_wa_c("volcano", reverse = T, na.value = "pink", aesthetics = c("fill","color")) +
  #scale_x_log10(labels = scales::label_log()) + 
  labs(
    x = "OFM 2017-2011 total housing unit change", 
    y = "total est. impervious increase",
    title = "Estimated riparian impervious increases vs total housing unit increase by county") 
}/{
rde_cnty_sum_impv |> 
  ggplot(aes(d_hous, nonfstry_impv_inc_ac_per_100ac)) +
  geom_point(size = 0.3, show.legend = F) + 
  geom_text(aes(label = cnty), size =3, color = "purple", nudge_y = 0.005) +
  geom_smooth(method = "lm") +
  wacolors::scale_fill_wa_c("volcano", reverse = T, na.value = "pink", aesthetics = c("fill","color")) +
  #scale_x_log10(labels = scales::label_log()) + 
  labs(
    x = "OFM 2017-2011 total housing unit change", 
    y = "est. impervious increase per 100ac",
    title = "Area normalized riparian impervious increases vs total housing unit increase by county") 
}/{
rde_cnty_sum_impv |> 
  ggplot(aes(d_hous, nonfstry_impv_inc_ac_per_100ac)) +
  geom_point(size = 0.3, show.legend = F) + 
  geom_text(aes(label = cnty), size =3, color = "purple", nudge_y = 0.001) +
  geom_smooth(method = "lm") +
  wacolors::scale_fill_wa_c("volcano", reverse = T, na.value = "pink", aesthetics = c("fill","color")) +
  coord_cartesian(xlim = c(500, 5000), ylim = c(0, 0.08)) +
  labs(
    x = "OFM 2017-2011 total housing unit change", 
    y = "est. impervious increase per 100ac",
    subtitle = "County areas with 500 to 5000 housing unit increases") 
}

  

```



## 2001 Baseline

Cover classes are distributed spatially and proportionally as expected in 2001, with more intense urban cover types concentrated in the western portion of the state, particularly in central Puget Sound, and isolated high urban hotspots corresponding to Spokane, Yakima, and Vancouver. A sum of 'forest' cover types (conifer, deciduous, and mixed) captures the large areas of private, state, tribal, and national forest in the Olympics and Cascades as well as the eastern Blue Mountain and Colville regions.

The conifer, shrub, crop, and grass classes make up the largest total areas, with the two lower intensity urban classes (`urbop` and `urblo`, at <20% impervious and <50% impervious respectively) each more extensive than the sum of the two higher intensity classes (`urbmd` and `urbhi`, at <80% and >80% impervious). The relative proportions of the total areas within each AOI are similar across most classes, but the herbaceous and wooded wetland types (`hbwet` and `wdwet`) are relatively more prevalent in the `rp100` riparian corridor, while the higher intensity urban types are slightly less so.

The total area of the `rp100` extent makes up approximately 14.8% of the total 43.3mil acres included in these data, and almost all WRIAs fall within a range of 10-20% for 'riparian corridor / total local catchment area'.

```{r sc_nlcd_2001}
#single year, all attrib both AOI
sc_nlcd_2001 <- sc_nlcd |> 
  filter(nlcd_year==2001) 
```

```{r ggstatewide_urb_tree}
{ 
  inner_join(
    sf_flw,
    sc_nlcd_2001 |> select(comid, ends_with("catrp100")),
    by = "comid"
  ) |> 
    ggplot() +
    geom_sf(aes(color = urbmdcatrp100+urbhicatrp100)) +
    scale_color_gradient(low = "lightblue", high = "grey20") +
    labs(subtitle = "2001 medium + high intensity urban, rp100", color = "Urb% rp100") + theme_minimal()
}+{
  inner_join(
    sf_cat,
    sc_nlcd_2001 |> select(comid, ends_with("cat")),
    by = "comid"
  ) |> 
    ggplot() +
    geom_sf(aes(fill = conifcat+decidcat+mxfstcat), color = NA) +
    scale_fill_gradient(low = "grey90", high = "darkgreen") +
    labs(subtitle = "2001 conifer+deciduous+mixed forest, cat", color = "Tree% cat") + theme_minimal()
} + plot_layout(ncol = 1)

```

```{r gt_statewide_area_cat_rp100}
sc_nlcd_2001 |> 
  select(comid, contains("_ac"), -contains("urb_")) |> 
  summarise(across(contains("_ac"), sum)) |> 
  pivot_longer(contains("_ac")) |> 
  mutate(
    aoi = if_else(str_detect(name, "rp100"), "rp100", "cat"),
    nlcd_class = str_remove(name, "cat") |> str_remove("rp100") |> str_remove("_ac"),
    name = NULL
    ) |> 
  pivot_wider(names_from = aoi, values_from = value) |>
#recall these acreages are still nested: 
#catareasqkm includes catareasqkmrp100
  mutate(
    d_cat_rp100 = cat - rp100,
    rp100_pct_cat = rp100 / cat, 
    across(c(cat, rp100), list(pct_tot = ~./sum(.)))
    ) |> 
  arrange(nlcd_class) |> 
  gt(caption = "2001 NLCD statewide total areas by LU class and AOI") |> 
  fmt_number(c("cat","rp100","d_cat_rp100"), decimals = 0) |> 
  fmt_percent(contains("pct"), decimals = 1) |> 
  data_color(
    columns = "nlcd_class",
    palette = pal_nlcd
    ) |> 
  grand_summary_rows(columns = c("cat","rp100","d_cat_rp100"),fns = ~sum(.), fmt = ~fmt_number(., decimals = 0)) |> 
  tab_style(style = cell_borders(sides = "right"), locations = cells_body(columns = "rp100_pct_cat"))

```

```{r ggwria_rp100pctcat, fig.height=8}
d <- sf_wrias |> 
  left_join(
    sc_nlcd_2001 |> 
      #summarise(across(contains("areasqkm"), sum)) |> 
      summarise(across(contains("areasqkm"), sum), .by = wria_nr_nm) |> 
      mutate(pct = catareasqkmrp100/catareasqkm) |> 
      arrange(pct),
    by = "wria_nr_nm"
  ) 

{
ggplot(as_tibble(d), aes(pct)) + geom_boxplot(outliers = F) + 
  geom_jitter(aes(y = 0, size = catareasqkmrp100), position = position_jitter(height = 0.3), alpha = 0.5, show.legend = F) +
  scale_x_continuous(labels = scales::percent, limits = c(0, 0.2)) +
    scale_size_area() +
  labs(
    title = "Area of 'rp100' as percentage of total 'cat' area", x = NULL, y = NULL,
    subtitle = "Points scaled to rp100 area") +
    theme(axis.text.y = element_blank())
  }/{
ggplot(d) + geom_sf(aes(fill = pct)) +
  scale_fill_continuous(labels = scales::percent) +
  labs(fill = "(rp100/cat)%")
} + plot_layout(heights = c(1,3)/5)
```

## Patterns since 2001

### Statewide 

Aggregating to statewide totals, higher intensity urban cover has steadily increased within both local catchments and the 100m riparian corridor at similar rates since 2001. Annualizing from a basic OLS fit of $$ acres_{urban} \sim year_{NLCD} $$, suggests that, on average, approximately 179 and 655 acres per year of high and medium intensity urban cover have been added within 100m of WA watercourses. Not all of this increase is necessarily due to losses of natural vegetation cover. However, in conjunction with the 95 acre/year increase in the "low" class, these increases substantially exceed the 264 ac/y decrease in urban "open".

```{r sc_nlcd_2019}
#single year, all attrib both AOI
sc_nlcd_2019 <- sc_nlcd |> 
  filter(nlcd_year==2019) 
```

```{r gt_2019_statewide_area_cat_rp100}
sc_nlcd_2019 |> 
  select(comid, contains("_ac"), -contains("urb_")) |> 
  summarise(across(contains("_ac"), sum)) |> 
  pivot_longer(contains("_ac")) |> 
  mutate(
    aoi = if_else(str_detect(name, "rp100"), "rp100", "cat"),
    nlcd_class = str_remove(name, "cat") |> str_remove("rp100") |> str_remove("_ac"),
    name = NULL
    ) |> 
  pivot_wider(names_from = aoi, values_from = value) |>
#recall these acreages are still nested: 
#catareasqkm includes catareasqkmrp100
  mutate(
    d_cat_rp100 = cat - rp100,
    rp100_pct_cat = rp100 / cat, 
    across(c(cat, rp100), list(pct_tot = ~./sum(.)))
    ) |> 
  arrange(nlcd_class) |> 
  gt(caption = "2019 NLCD statewide total areas by LU class and AOI") |> 
  fmt_number(c("cat","rp100","d_cat_rp100"), decimals = 0) |> 
  fmt_percent(contains("pct"), decimals = 1) |> 
  data_color(
    columns = "nlcd_class",
    palette = pal_nlcd
    ) |> 
  grand_summary_rows(columns = c("cat","rp100","d_cat_rp100"),fns = ~sum(.), fmt = ~fmt_number(., decimals = 0)) |> 
  tab_style(style = cell_borders(sides = "right"), locations = cells_body(columns = "rp100_pct_cat"))

```

```{r ggstatewide_ac_urb_nlcd_year}
sc_nlcd |> 
  summarise(
    across(
      contains("urb") & ends_with("ac"),
      list(sum = ~sum(.))
    )
    , .by = c(nlcd_year)
  ) |> 
  select(-contains("urb_")) |> 
  pivot_longer(cols = -nlcd_year, values_to = "ac") |> 
  mutate(
    aoi = if_else(str_detect(name, "rp100"), "rp100", "cat"),
    nlcd_class = str_remove(name, "cat") |> str_remove("rp100") |> str_remove("_ac_sum"),
    name = NULL
    ) |>
  pivot_wider(names_from = aoi, values_from = ac) |> 
  mutate(d_cat_rp100 = cat - rp100) |> 
  pivot_longer(c(cat, rp100, d_cat_rp100), names_to = "aoi", values_to = "ac") |> 
  filter(aoi != "cat") |> 
##confirming ggpmisc values
  #filter(nlcd_class=="urbhi", aoi =="rp100") -> d; lm(ac~nlcd_year, d) -> d; broom::tidy(d); rm(d)
  split(~nlcd_class) |> 
  map(
    ~.x |> 
      ggplot(aes(nlcd_year, ac, fill = nlcd_class)) +
      geom_col(show.legend = F) +
      #geom_smooth(method = "lm", show.legend = F) +
      ggpmisc::stat_poly_line(color = "blue", se = T, show.legend = F) +
      # ggpmisc::stat_poly_eq(ggpmisc::use_label(c("adj.R2", "p")), color = "orange") +
      ggpmisc::stat_fit_tidy(
        method = "lm",
        label.x = "right", label.y = "top", vjust = -0.7,
        method.args = list(formula = y ~ x),
        mapping = aes(
          label = sprintf(
            "est. slope = %.0f ac/yr", #"Slope = %.3g\np-value = %.3g",
            after_stat(x_estimate)#, after_stat(x_p.value)
            )
          ),
        color = "blue"
      ) +
      coord_cartesian(clip = "off") +
      scale_fill_manual(values = pal_nlcd[grep(unique(.x$nlcd_class), names(pal_nlcd))]) + 
      scale_y_continuous(labels = scales::comma) +
      facet_wrap(~aoi, ncol = 2, strip.position = "top", scales = "free") +
      #facet_wrap(~aoi, ncol = 3, strip.position = "top", scales = "free") +
        labs(y = paste("acres", unique(.x$nlcd_class)), subtitle = unique(.x$nlcd_class)) +
      theme(strip.text = element_text(hjust = 0.1))
  ) |> 
  wrap_plots(ncol = 1, guides = "collect")

```

### By county

Considerable variation among watersheds is evident in the overall magnitude and relative rates of urban cover change outside of and within the riparian corridor.

```{r ggwria_ac_urb_nlcd_year, fig.height=6}
#calc approx acres per-wria, per-aoi, per-urban-class, per-year
#then estimate annual acres change rp100 per annual acre change outside rp100 (d_cat_rp100) 
d <- sc_nlcd |> 
  summarise(
    across(
      contains("urb") & ends_with("ac"),
      list(sum = ~sum(.))
    )
    , .by = c(wria, wria_nr_nm, nlcd_year)
  ) |> 
  select(-contains("urb_")) |> 
  pivot_longer(cols = -c(wria, wria_nr_nm, nlcd_year), values_to = "ac") |> 
  mutate(
    aoi = if_else(str_detect(name, "rp100"), "rp100", "cat"),
    nlcd_class = str_remove(name, "cat") |> str_remove("rp100") |> str_remove("_ac_sum"),
    name = NULL
  ) |> 
  pivot_wider(names_from = aoi, values_from = ac) |> 
  mutate(d_cat_rp100 = cat - rp100) |> 
  pivot_longer(c(cat, rp100, d_cat_rp100), names_to = "aoi", values_to = "ac") |> 
  arrange(wria, aoi, nlcd_class, nlcd_year) |> 
  nest(.by = c(wria, wria_nr_nm, aoi, nlcd_class)) |> 
  mutate(
    lm_ac_y = map(data, ~lm(ac ~ nlcd_year, data = .x)),
    lm_ac_y_est = map_dbl(lm_ac_y, ~broom::tidy(.x) |> filter(term=="nlcd_year") |> pluck("estimate")),
    ac_2001 = map_dbl(data, ~filter(.x, nlcd_year==2001) |> pluck("ac"))
  ) |> 
  select(wria, wria_nr_nm, aoi, nlcd_class, ac_2001, lm_ac_y_est) |> 
  pivot_wider(names_from = aoi, values_from = c(ac_2001, lm_ac_y_est))

# g <- d |> 
#   filter(str_detect(nlcd_class, "hi|md")) |> 
#   ggplot(aes(label = wria_nr_nm)) +
#   # geom_col(aes(lm_ac_y_est_d_cat_rp100, fct_reorder(wria_nr_nm, lm_ac_y_est_d_cat_rp100, min))) +
#   # geom_col(aes(lm_ac_y_est_rp100, fct_reorder(wria_nr_nm, lm_ac_y_est_d_cat_rp100, min)), alpha = 0.5, fill = "red") +
#   geom_point(aes(lm_ac_y_est_d_cat_rp100, lm_ac_y_est_rp100,
#                  color = nlcd_class, size = ac_2001_rp100), 
#              show.legend = F) +
#   scale_color_manual(values = pal_nlcd[grep("urb", names(pal_nlcd))]) +
#   scale_size_area() +
#   facet_wrap(~nlcd_class, ncol = 1, scales = "free") +
#   labs(
#     title = "Estimated annual change in urban cover within vs outside rp100 corridor",
#     subtitle = "Point size scaled to 2001 acres of cover in rp100",
#     x = "Est. ac/year outside rp100",
#     y = "Est. ac/year within rp100"
#   )
# plotly::ggplotly(g)

#the ratio alone is sensitive to small denominators and mostly highlights locations with less cat-wide urb
d <- sf_wrias |> 
  left_join(
    d |> 
      filter(str_detect(nlcd_class, "hi|md")) |> 
      mutate(
        ac_y_rp100_per_d_cat = lm_ac_y_est_rp100 / lm_ac_y_est_d_cat_rp100
        #across(c(lm_ac_y_est_rp100, lm_ac_y_est_d_cat_rp100), list(per = ~. / lm_ac_y_est_d_cat_rp100))
      ) |>  
      arrange(desc(ac_y_rp100_per_d_cat))
    , by = c("wria", "wria_nr_nm")
  ) 

# {
# d |> 
#   ggplot() + 
#   geom_sf(aes(fill = lm_ac_y_est_d_cat_rp100)) +
#   wacolors::scale_fill_wa_c("vantage", midpoint = 100) +
#   facet_wrap(~nlcd_class, ncol = 1) +
#   labs(
#     subtitle = "Outside 100m riparian corridor",
#     fill = "est. ac/y"
#   )
# }

{
  d |> 
  ggplot() + 
  geom_sf(aes(fill = lm_ac_y_est_d_cat_rp100)) +
  wacolors::scale_fill_wa_c("vantage", midpoint = 100) +
  facet_wrap(~nlcd_class, ncol = 1) +
  labs(
    subtitle = "Outside 100m riparian corridor",
    fill = "est. ac/y"
  ) + theme_minimal() + theme(axis.text = element_blank())
}+{
d |> 
  #filter(nlcd_class == "urbhi") |> 
  ggplot() + 
  #geom_sf(aes(fill = ac_y_rp100_per_d_cat)) +
  geom_sf(aes(fill = lm_ac_y_est_rp100)) +
  wacolors::scale_fill_wa_c("vantage", midpoint = 10) +
  facet_wrap(~nlcd_class, ncol = 1) +
  labs(
    subtitle = "Within 100m riparian corridor",
    fill = "est. ac/y"
  ) + theme_minimal() + theme(axis.text = element_blank())
} + 
  plot_layout(nrow = 1) + 
  plot_annotation(title = "Estimated annual urban cover change 2001-2019")
```

Stratification by county organizes some of this spatial variation in NLCD urban cover classes by a relevant jurisdictional unit.

```{r sc_nlcd_ac_y_cnty}
#calc approx acres per-wria, per-aoi, per-urban-class, per-year
#then estimate annual acres change rp100 per annual acre change outside rp100 (d_cat_rp100) 
sc_nlcd_ac_y_cnty <- sc_nlcd |> 
  summarise(
    across(
      contains("urb") & ends_with("ac"),
      list(sum = ~sum(.))
    )
    , .by = c(cnty, nlcd_year)
  ) |> 
  select(-contains("urb_")) |> 
  pivot_longer(cols = -c(cnty, nlcd_year), values_to = "ac") |> 
  mutate(
    aoi = if_else(str_detect(name, "rp100"), "rp100", "cat"),
    nlcd_class = str_remove(name, "cat") |> str_remove("rp100") |> str_remove("_ac_sum"),
    name = NULL
  ) |> 
  pivot_wider(names_from = aoi, values_from = ac) |> 
  mutate(d_cat_rp100 = cat - rp100) |> 
  pivot_longer(c(cat, rp100, d_cat_rp100), names_to = "aoi", values_to = "ac") |> 
  arrange(cnty, aoi, nlcd_class, nlcd_year) 

lm_nlcd_ac_y_cnty <- sc_nlcd_ac_y_cnty |> 
  nest(.by = c(cnty, aoi, nlcd_class)) |> 
  mutate(
    lm_ac_y = map(data, ~lm(ac ~ nlcd_year, data = .x)),
    lm_ac_y_est = map_dbl(lm_ac_y, ~broom::tidy(.x) |> filter(term=="nlcd_year") |> pluck("estimate")),
    ac_2001 = map_dbl(data, ~filter(.x, nlcd_year==2001) |> pluck("ac"))
  ) |> 
  select(cnty, aoi, nlcd_class, ac_2001, lm_ac_y_est) |> 
  pivot_wider(names_from = aoi, values_from = c(ac_2001, lm_ac_y_est))

```

Differences among counties are evident in both the overall magnitude and the relative rates between the riparian corridor values and those for the encompassing local catchment.

The estimated acres of each NLCD urban class within the `rp100` AOI of example counties illustrates how the two higher impervious cover classes (darker bars) are typically present at smaller extents but exhibit proportionally larger changes among NLCD-years (fig column-series).

```{r ggcnty_ac_y_urb_cols}
#split|>map pattern for side by side aoi is visually overwhelming with change in time of multiple nlcd_class
#focus first here on just rp100

sc_nlcd_ac_y_cnty |> 
  filter(
    aoi == "rp100", 
    #str_detect(nlcd_class, "hi|md")
    str_detect(cnty, "akim|okane|hurst|nohom")
  ) |> 
  ggplot(aes(nlcd_year, ac, group = cnty, fill = nlcd_class)) +
  geom_col(show.legend = F) +
  scale_x_continuous(breaks = c(2001, 2004, 2006, 2008, 2011, 2013, 2016, 2019)) + #unique(sc_nlcd_ac_y_cnty$nlcd_year)
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = pal_nlcd[grep("urb", names(pal_nlcd))]) +
  facet_grid(rows = vars(cnty), cols = vars(nlcd_class), scales = "free_y") +
  labs(
    title = "Example counties showing rp100 acreage of NLCD urban classes",
    subtitle = "Note differences in y-axis scale among counties",
    x = NULL, y = "acres"
    ) +
  theme(axis.text = element_text(size = 7))

```

Clicking individual county names in the legend will focus on only those traces.

```{r plotly_ac_y_urb_lines_multi, include=FALSE, eval=FALSE}
lapply(
  sc_nlcd_ac_y_cnty |>
    filter(aoi == "rp100") |>
    split(~nlcd_class)
  ,
  \(x){
    plotly::plot_ly(
      data = x,
      type = 'scatter', mode = 'markers+lines',
      name = ~cnty, x = ~nlcd_year, y = ~ac,
      color = ~nlcd_class, colors = pal_nlcd[grep("urb", names(pal_nlcd))]
      # #generates a single 4 panel with per-panel names and without duplicated labels
      # #but label on/off not shared across panels 
      #showlegend = x$nlcd_class[1] == "urbhi"
    ) |>
      plotly::layout(
        annotations = list(
          x = 2001, y = 1.05*max(x$ac),
          text = x$nlcd_class[1],
          showarrow = FALSE
        )
      )
  }
) #|> plotly::subplot(nrows = 4)
```

```{r plotly_ac_y_urb_lines_hi}
#single nlcd_class
sc_nlcd_ac_y_cnty |>
  filter(aoi == "rp100", nlcd_class == "urbhi") |>
  plotly::plot_ly(
    type = 'scatter', mode = 'markers+lines',
      name = ~cnty, x = ~nlcd_year, y = ~ac,
      color = ~nlcd_class, colors = pal_nlcd[grep("urb", names(pal_nlcd))]
  ) |>
  plotly::layout(
    title = list(text = "Urbhi")
  )

```
```{r plotly_ac_y_urb_lines_md}
sc_nlcd_ac_y_cnty |>
  filter(aoi == "rp100", nlcd_class == "urbmd") |>
  plotly::plot_ly(
    type = 'scatter', mode = 'markers+lines',
      name = ~cnty, x = ~nlcd_year, y = ~ac,
      color = ~nlcd_class, colors = pal_nlcd[grep("urb", names(pal_nlcd))]
  ) |>
  plotly::layout(
    title = list(text = "Urbmd")
  )

```
```{r plotly_ac_y_urb_lines_lo}
#single nlcd_class
sc_nlcd_ac_y_cnty |>
  filter(aoi == "rp100", nlcd_class == "urblo") |>
  plotly::plot_ly(
    type = 'scatter', mode = 'markers+lines',
      name = ~cnty, x = ~nlcd_year, y = ~ac,
      color = ~nlcd_class, colors = pal_nlcd[grep("urb", names(pal_nlcd))]
  ) |>
  plotly::layout(
    title = list(text = "Urblo")
  )

```
```{r plotly_ac_y_urb_lines_op}
#single nlcd_class
sc_nlcd_ac_y_cnty |>
  filter(aoi == "rp100", nlcd_class == "urbop") |>
  plotly::plot_ly(
    type = 'scatter', mode = 'markers+lines',
      name = ~cnty, x = ~nlcd_year, y = ~ac,
      color = ~nlcd_class, colors = pal_nlcd[grep("urb", names(pal_nlcd))]
  ) |>
  plotly::layout(
    title = list(text = "Urbop")
  )

```

Viewed as the linear regression estimate of per-year change, the medium and high classes show consistent increases (i.e., positive slope estimates) across counties, while the low and open classes show variation with some counties decreasing in these classes.
(fig boxplot of rp100 lm-est by nlcd-class)

```{r ggcnty_ac_y_urb_box}
## if not html
# lm_nlcd_ac_y_cnty |> 
#   ggplot(aes(lm_ac_y_est_rp100, nlcd_class, color = nlcd_class)) +
#   geom_vline(xintercept = 0, linewidth = 0.3) +
#   geom_jitter(aes(size = ac_2001_rp100), position = position_jitter(height = 0.2), alpha = 0.5, show.legend = F) +
#   geom_boxplot(outliers = F, show.legend = F) +
#   scale_size_area(max_size = 4) +
#   scale_color_manual(values = pal_nlcd[grep("urb", names(pal_nlcd))]) +
#   labs(
#     title = "Annual changes by county in NLCD urban classes within riparian corridor",
#     subtitle = "Sample distributions of linear estimate of rp100 acres ~ NLCD year",
#     x = "est. acres/year", y = NULL
#   )

lm_nlcd_ac_y_cnty |> 
  mutate(nlcd_class = factor(nlcd_class)) |> 
  plotly::plot_ly(
        color = ~nlcd_class, colors = pal_nlcd[grep("urb", names(pal_nlcd))]
  ) |> 
  plotly::add_trace(
    x = ~lm_ac_y_est_rp100, 
    y = ~nlcd_class, 
    type = "box", hoverinfo = 'name+x', showlegend = F
  ) |> 
  plotly::add_markers(
    x = ~lm_ac_y_est_rp100,
    y = ~nlcd_class, 
    marker = list(size = 6),
    hoverinfo = 'text', text = ~paste(cnty, round(lm_ac_y_est_rp100,3)),
    showlegend = F
  )

```

These shifts within the riparian corridor are informed by the trajectory of urban cover in the area of each local catchment outside of the `rp100` extent. Comparing the medium and high classes this way, the within-corridor increases show clear inflections at roughly 30ac/y and 100ac/y for medium and high respectively, as well as saturation with increasing outside-corridor increases. Notably, the considerable scatter in within-corridor values at a given outside-corridor indicates clear differences between counties in where urban cover increases may have been concentrated.

(fig scatter of rp100 lm-est ~ d_cat_rp100 lm_est)

```{r ggcnty_ac_y_urb_scatter}
g <- lm_nlcd_ac_y_cnty |> 
  filter(str_detect(nlcd_class, "hi|md")) |> 
  ggplot(aes(label = cnty, color = nlcd_class)) +
  geom_point(aes(lm_ac_y_est_d_cat_rp100, lm_ac_y_est_rp100,
                 size = ac_2001_rp100), 
             show.legend = F) +
  geom_smooth(aes(lm_ac_y_est_d_cat_rp100, lm_ac_y_est_rp100)) +
  scale_color_manual(values = pal_nlcd[grep("urb", names(pal_nlcd))]) +
  scale_size_area() +
  facet_wrap(~nlcd_class, ncol = 1, scales = "free") +
  labs(
    title = "Estimated annual change in urban cover within vs outside rp100 corridor",
    subtitle = "Point size scaled to 2001 acres of cover in rp100",
    x = "Est. ac/year outside rp100",
    y = "Est. ac/year within rp100"
  )

plotly::ggplotly(g)
```

As an example, focusing on the `urbhi` class, Thurston (~77ac/y) and Yakima (~72ac/y) counties exhibit similar increases in the area outside `rp100`, but the ~14ac/yr within the riparian corridor of the latter was roughly 7 times the ~2ac/y of the former. Within Yakima county, most of the riparian corridor 'urban high' increase appears to have occurred in the same local catchments that experienced appreciable non-`rp100` increase. In contrast, the Thurston county local catchment with the most urban increase outside of `rp100` had relatively little change within the corridor. However, at the aggregated county scale, the larger total `rp100` increase in Yakima county appears due to the more widespread occurrence of reaches with both larger and smaller increases. It is possible that some of these smaller increases may be related to data artifacts, perhaps related to the more arid conditions.

But...compare Snohom and Spokane, which are reversed E/W-dry/wet and below/above avg for rp100~d_cat_rp100

```{r ggcnty_ac_y_urb_sf_focal_cnty}
d <- sc_nlcd |> 
  filter(
    str_detect(cnty, "hurst|akima")
    ,
    nlcd_year %in% c(2001, 2019)
    ) |> 
  #select(cnty, comid, nlcd_year, urbhicatrp100_ac) |> 
  #pivot_wider(names_from = nlcd_year, values_from = urbhicatrp100_ac) |> 
  #mutate(d = `2019`-`2001`) |> 

  select(cnty, comid, nlcd_year, contains("urbhi") & contains("_ac")) |> 
  mutate(
    #trace cover class percentages can generate negative d_cat_rp100 at single comid scale (e.g., 23105084)
    #so coerce rp100 down to cat value if greater
    urbhicatrp100_ac = if_else(urbhicatrp100_ac > urbhicat_ac, urbhicat_ac, urbhicatrp100_ac),
    urbhi_d_cat_rp100 = urbhicat_ac - urbhicatrp100_ac
    , urbhicat_ac = NULL
    ) |>  
  #filter(urbhi_d_cat_rp100 < 0) |> arrange(desc(abs(urbhi_d_cat_rp100)))
  pivot_wider(names_from = nlcd_year, values_from = contains("urbhi")) |> 
  mutate(
    d_rp100 = urbhicatrp100_ac_2019 - urbhicatrp100_ac_2001,
    d_out = urbhi_d_cat_rp100_2019 - urbhi_d_cat_rp100_2001
    ) |> 
  filter(urbhi_d_cat_rp100_2019 > 0 | urbhicatrp100_ac_2019 > 0) |> 
  arrange(d_out) |> 
  #12 cases of very small negative diffs in d_out for 19-01, all with d_rp100 < 1
  #could coerce to 0 but simpler to exclude
  filter(d_out >= 0)

d_sf_cat <- sf_cat |> 
  select(-cnty) |> 
  inner_join(d, by = "comid")

d_sf_flw <- sf_flw |> 
  select(-cnty) |> 
  inner_join(d, by = "comid")

{
ggplot() +
  geom_sf(data = d_sf_cat, aes(fill = d_out), color = "lightgrey", linewidth = 0.1) +
  geom_sf(data = d_sf_flw, color = "lightblue", linewidth = 0.3) +
  wacolors::scale_fill_wa_c("forest_fire", limits = c(0, max(d$d_out)*1.05), aesthetics = c("fill","color"), reverse = T) +
  ggspatial::annotation_scale() +
    labs(subtitle = "Outside rp100 corridor")
}/{
ggplot() +
  geom_sf(data = d_sf_cat, color = "lightgrey", fill = "white", linewidth = 0.1) +
  geom_sf(data = d_sf_flw, aes(fill = d_rp100, color = d_rp100)) +
  wacolors::scale_fill_wa_c("forest_fire", limits = c(0, max(d$d_rp100)*1.05), aesthetics = c("fill","color"), reverse = T) +
  ggspatial::annotation_scale() +
    labs(subtitle = "Within rp100 corridor")
}+
  plot_layout(ncol = 1) |> 
  plot_annotation(
    title = "Estimated increase in acres NLCD urban high cover class", subtitle = "Thurston and Yakima counties"
  )
```


```{r arrowswarm}
comids_2019_urb <- sc_nlcd |> 
  filter(nlcd_year == 2019, (urbmdcat + urbhicat > 0)) |> 
  distinct(comid)

d <- sc_nlcd |> 
  filter(nlcd_year %in% c(2001, 2019)
         #, comid %in% comid_2019_urb
  ) |> 
  select(comid, nlcd_year, 
         wria, wria_nr_nm,
         cnty,
         contains("urbhi") & contains("_ac"),
         contains("urbmd") & contains("_ac")
  ) |> 
  mutate(
    #trace cover class percentages can generate negative d_cat_rp100 at single comid scale (e.g., 23105084)
    #so coerce rp100 down to cat value if greater
    urbhicatrp100_ac = if_else(urbhicatrp100_ac > urbhicat_ac, urbhicat_ac, urbhicatrp100_ac),
    urbhi_d_cat_rp100 = urbhicat_ac - urbhicatrp100_ac
    , urbhicat_ac = NULL,
    urbmdcatrp100_ac = if_else(urbmdcatrp100_ac > urbmdcat_ac, urbmdcat_ac, urbmdcatrp100_ac),
    urbmd_d_cat_rp100 = urbmdcat_ac - urbmdcatrp100_ac
    , urbmdcat_ac = NULL
    ) |>  
  pivot_longer(contains("cat"), names_to = "nlcd_class_aoi") |> 
  pivot_wider(names_from = nlcd_year, values_from = value) |> 
  #mutate(d = `2019`-`2001`) |> 
  pivot_longer(c(`2001`,`2019`)) |> 
  mutate(
    nlcd_class_aoi = paste0(nlcd_class_aoi,"_",name), name = NULL
  ) |> 
  pivot_wider(names_from = nlcd_class_aoi, values_from = value)

d |> 
    filter(
      #wria %in% wrias
      str_detect(cnty, "akim|okane|hurst|nohom")
      ) |> 
    ggplot() + 
    geom_segment(aes(
      x = urbhi_d_cat_rp100_2001, y = urbhicatrp100_ac_2001,
      xend = urbhi_d_cat_rp100_2019, yend = urbhicatrp100_ac_2019
      #,color = d_cat - d_catrp100
    ),
    arrow = arrow(length = unit(0.05,"npc")),
    show.legend = T) +
    geom_abline(slope = 1, intercept = 0, linetype = 3) +
    wacolors::scale_color_wa_c("lopez", midpoint = 0) +
    # scale_x_continuous(labels = scales::percent) +
    # scale_y_continuous(labels = scales::percent) +
    facet_wrap(~cnty, ncol = 1, strip.position = "right") +
    theme(strip.text = element_text(size = 5), legend.position = "top") +
    labs(
      title = "2001 to 2019 urban cover change",
      subtitle = "StreamCat NLCD urban high",
      x = "local catchment less riparian",
      y = "100m riparian corridor"
    )

```

# Discussion

  Scratch: We approached the question of how much impervious cover has been added to riparian areas in Washington state in the early part of the 21st century using high resolution land cover change data within an ecologically-grounded extent. In agreement with prior studies at smaller scales and coarser resolution, we found the answer to be both "a little", in that individual additions were mostly less than 1ha, and "a lot", in that the cumulative total of many small changes was still appreciable.


  - note that upland impervious extent is highly likely to affect riparian ecohydrology - 100ft means very different things as a narrow strip of evident green vs an hard to distinguish point along a continuous gradient of forest. In addition to site-specific slope and soils factors, encompassing watershed hydrologic condition has inevitably shaped our understanding of the functional dimensions that underlie buffer formulations, but that this context has changed with increasing imperviousness and alteration of flow paths (i.e., away from saturation excess and towards infiltration excess dynamics). While an SPTH standard allows for some flexibility to avoid prescribing a single critical area dimension, the basic concept may be invalidated where upland surface alteration has rendered even some unknown multiple of SPTH (2x or 5x etc.) insufficient to perform all desired functions.

# Conclusion

# Acknowledgements

# Citations

Chapman, M., Satterfield, T., & Chan, K. M. A. 2020. How value conflicts infected the science
of riparian restoration for endangered salmon habitat in America’s Pacific Northwest:
Lessons for the application of conservation science to policy. Biological Conservation,
244, 108508. https://doi.org/10.1016/j.biocon.2020.108508

Hill, Ryan A., Marc H. Weber, Scott G. Leibowitz, Anthony R. Olsen, and Darren J. Thornbrugh, 2016. The Stream-Catchment (StreamCat) Dataset: A Database of Watershed Metrics for the Conterminous United States. Journal of the American Water Resources Association (JAWRA) 52:120-128. DOI: 10.1111/1752-1688.12372.

Knutson, K. L., and Naef, V. L. 1997. Management recommendations for Washington’s priority
habitats: Riparian (p. 181pp.). Washington Department of Fish and Wildlife.

Lazarus, D., 2023. Current Status of Riparian Buffers in Washington State: Public and Private Land Cover Within Riparian Management Zones Based on Best Practice Guidelines (MES thesis, Evergreen State College).

WDFW. 2024. A new way of looking at Washington’s waterways. Medium. https://wdfw.medium.com/a-new-way-of-looking-at-washingtons-waterways-ad05d872c4ce 

Weber M (2025). _StreamCatTools: Tools to Work with the StreamCat API Within R and Access the Full Suite of StreamCat and LakeCat Metrics_. R package version 0.6.0, commit d8a8cce142e7cb9e3666a2660a8315a1766e5981, <https://github.com/USEPA/StreamCatTools>.

Wilhere G and Quinn T. 2018. How Wide is Wide Enough?: Science, Values, and Law in Riparian Habitat Conservation, 58 Nat. Resources J.279, https://digitalrepository.unm.edu/nrj/vol58/iss2/13/

::: {.content-hidden when-format="html"}

```{r sf_ugas}
#??
sf::read_sf(file.path(dir_data_common, "wa_dor_uga.gdb")) 
```

*other/more*
  - (eastern US, comparison against 1m^2 urban cover showed very good agreement overall, somewhat worse for riparian exclusively)
    - https://www.usgs.gov/publications/accuracy-assessment-nlcd-2011-impervious-cover-data-chesapeake-bay-region-usa
  - bring back sc_imperv?
```{r pctimp_back, include=FALSE, eval=F}
"~/T/DFW-Team WDFW Watershed Synthesis - data_common/streamcat/ImperviousSurfacesRipBuf100_WA.csv"
StreamCatTools::sc_get_data(
  comid = "23989097", metric = "pctimp2001",
  # state = "WA", year = .x,
  aoi = 'cat,catrp100,ws,wsrp100',
  showAreaSqKm = T
  ) |>
  rename_with(tolower) |> as_tibble()
sc_nlcd_2001 |> filter(comid =="23989097")

```
  - add in sc_bfw?
```{r sc_wa_bfw, eval=FALSE}
sc_wa_bfw <- StreamCatTools::sc_get_data(
  state = "WA",
  metric = 'bankfullwidth', aoi = 'other'
) |> 
  mutate(comid = as.character(comid))

#append to sf multilinestring of WA flowlines
sf_flw <- sf_flw |> 
  left_join(sc_wa_bfw, by = "comid")

sf_flw |> 
  drop_na(bankfullwidth) |> 
  ggplot() + geom_sf(aes(linewidth = bankfullwidth), color = "blue")

```


```{r qaqc, include=F, eval=FALSE}
#trace cover class percentages can generate negative d_cat_rp100 at single comid scale
x<-filter(sf_flw, comid=="23105084"); y<-filter(sf_cat, comid=="23105084"); mapview::mapview(x)+mapview::mapview(y)
x<-filter(sf_flw, comid=="24422847"); y<-filter(sf_cat, comid=="24422847"); mapview::mapview(x)+mapview::mapview(y)

#wria 12 is basically just the cities between JBLM and Tacoma, small mostly built or already protected
x<-filter(sf_flw, wria=="12"); y<-filter(sf_cat, wria=="12"); mapview::mapview(x)+mapview::mapview(y)

#digging into a high ratio of rp100/d_cat_rp100
#illustrates sensitivity to small d_cat_rp100 as well as potential processing artifacts
g <- sf_cat |> 
  filter(wria=="16") |> 
  left_join(
    sc_nlcd |> 
      filter(wria=="16") |> #to speed up following operations
      select(comid, nlcd_year, contains("rp100_ac") & contains("urbhi")) |> 
      pivot_longer(cols = -c(comid, nlcd_year), values_to = "ac") |> 
      mutate(
        aoi = if_else(str_detect(name, "rp100"), "rp100", "cat"),
        nlcd_class = str_remove(name, "cat") |> str_remove("rp100") |> str_remove("_ac"),
        name = NULL
        , nlcd_year = factor(nlcd_year)
      )
    ,
    by = "comid"
  ) |> 
  ggplot() +
  geom_sf(aes(fill = ac), color = "grey90", linewidth = 0.1) +
  #scale_fill_gradient(low = "white", high = "grey10") +
  wacolors::scale_fill_wa_c("vantage") +
  #facet_wrap(~nlcd_year, nrow = 2) +
  labs(subtitle = "High intensity urban cover in rp100") 

gganimate::animate(
  g + 
    #gganimate::transition_time(nlcd_year) +
    gganimate::transition_states(nlcd_year) +
    gganimate::ease_aes() +
    gganimate::enter_fade() +
    #labs(title = 'year: {frame_time}')
    labs(title = 'year: {closest_state}')
  , nframes = 2*8, fps = 1, 
  renderer = gifski_renderer()
)

x<-filter(sf_flw, wria=="16"); y <- filter(sf_cat, wria=="16"); mapview::mapview(x)+mapview::mapview(y)
sc_nlcd |> 
  # #the large ONF poly "24287056" looks artifactual; hard to see even 1.8ac of 'mostly impervious' cover other than river gravel
  # filter(comid == "24287056") |> 
  # whereas the Brinnon comid going from 2.7 to 4.5 ac mostly imperv within 100m is quite plausible
  filter(comid == "24286928") |> 
  select(nlcd_year, contains("urb") & contains("hi"))

```

```{r starting_refactor_arrowswarm, eval=FALSE}

#steeper/more vertical indicates greater riparian increase than encompassing
#versus flatter for surrounding increases without riparian

#define comids with non-zero urban cover in final NLCD year; could threshold to larger %
#drop second filter condition if not focusing the tree change on only those comids with +urban
#first look showed qualitatively similar and just including many more 'rural' cats
#further below created vector of 'urban in rp100' comids to limit even more

comids_2019_urb <- sc_nlcd |> 
  filter(nlcd_year == 2019, (urbmdcat + urbhicat > 0)) |> 
  distinct(comid)

d <- sc_nlcd |> 
    filter(nlcd_year %in% c(2001, 2019)
           #, comid %in% comid_2019_urb
           ) |> 
    select(comid, nlcd_year, wria, wria_nr_nm,
           starts_with("urb_")) |> 
    pivot_wider(names_from = nlcd_year, values_from = contains("cat")) |>
    mutate(
      d_cat = urb_cat_2019 - urb_cat_2001,
      d_catrp100 = urb_catrp100_2019 - urb_catrp100_2001
      ,
      d_cat_ac = urb_cat_ac_2019 - urb_cat_ac_2001,
      d_catrp100_ac = urb_catrp100_ac_2019 - urb_catrp100_ac_2001
    ) |> 
    filter(wria %in% wrias)

#in pct units
d |> 
    ggplot() + 
    geom_segment(aes(
      x = urb_cat_2001, y = urb_catrp100_2001,
      xend = urb_cat_2019, yend = urb_catrp100_2019,
      color = d_cat - d_catrp100 
    ),
    arrow = arrow(length = unit(0.05,"npc")),
    show.legend = T) +
    geom_abline(slope = 1, intercept = 0, linetype = 3) +
    wacolors::scale_color_wa_c("lopez", midpoint = 0) +
    scale_x_continuous(labels = scales::percent) +
    scale_y_continuous(labels = scales::percent) +
    facet_wrap(~wria_nr_nm, ncol = 1, strip.position = "right") +
    theme(strip.text = element_text(size = 5), legend.position = "top") +
    labs(
      title = "2001 to 2019 urban cover change",
      subtitle = "StreamCat NLCD %urban high+medium",
      x = "whole local catchment",
      y = "100m riparian corridor %urban"
    )

#in acres...order of mag diffs make not very helpful other than for seeing extremes?
d |> 
    ggplot() + 
    geom_segment(aes(
      x = urb_cat_ac_2001, y = urb_catrp100_ac_2001,
      xend = urb_cat_ac_2019, yend = urb_catrp100_ac_2019,
      color = d_cat_ac - d_catrp100_ac 
    ),
    arrow = arrow(length = unit(0.05,"npc")),
    show.legend = T) +
    geom_abline(slope = 1, intercept = 0, linetype = 3) +
    wacolors::scale_color_wa_c("lopez", midpoint = 0) +
    scale_x_continuous(labels = scales::comma) +
    scale_y_continuous(labels = scales::comma) +
    facet_wrap(~wria_nr_nm, ncol = 1, scales = "free", strip.position = "right") +
    theme(strip.text = element_text(size = 5), legend.position = "top") +
    labs(
      title = "2001 to 2019 urban cover change",
      subtitle = "StreamCat NLCD approx acres urban high+medium",
      x = "whole local catchment",
      y = "100m riparian corridor"
    )


## NOT YET REFACTORED FROM HERE DOWN
## "tree"
  sc_nlcd_cat_ac |> 
    filter(nlcd_year %in% c(2001, 2019), comid %in% comid_2019_urb) |> 
    select(comid, nlcd_year, wria, wria_nr_nm,
           starts_with("tree_")) |> 
    pivot_wider(names_from = nlcd_year, values_from = contains("cat")) |>
    mutate(
      d_cat = tree_cat_2019 - tree_cat_2001,
      d_catrp100 = tree_catrp100_2019 - tree_catrp100_2001
      , 
      d_catrp100f = case_when(
        d_catrp100 < 0 & d_cat < 0 ~ "both dec",
        d_catrp100 >= 0 & d_cat >= 0 ~ "both inc",
        d_catrp100 < 0 & d_cat >= 0 ~ "rp100 dec",
        d_catrp100 >= 0 & d_cat < 0 ~ "cat dec"
      )
    ) |>
    filter(wria %in% wrias) |> 
    #filter(d_catrp100f=="rp100 dec") |> summarise(across(contains("ac_"), sum), .by = wria_nr_nm)
    summarise(across(contains("ac_"), sum), .by = c(d_catrp100f, wria_nr_nm)) |> 
    mutate(
      d_cat_ac = tree_cat_ac_2019 - tree_cat_ac_2001,
      d_catrp100_ac = tree_catrp100_ac_2019 - tree_catrp100_ac_2001
    ) |> 
    select(wria_nr_nm, d_catrp100f, contains("cat_"), contains("catrp100_")) |> 
    arrange(wria_nr_nm, d_catrp100f) |> 
    gt(groupname_col = "wria_nr_nm", rowname_col = "d_catrp100f") |> fmt_number(decimals = 0) |> 
    tab_style_body(fn = \(x){x<0}, style = cell_text(color = "red"))
  ggplot() + 
    geom_segment(aes(
      x = tree_cat_2001, y = tree_catrp100_2001,
      xend = tree_cat_2019, yend = tree_catrp100_2019,
      color = d_catrp100
    ),
    arrow = arrow(length = unit(0.05,"npc")),
    show.legend = T) +
    geom_abline(slope = 1, intercept = 0, linetype = 3) +
    wacolors::scale_color_wa_c("stuart", midpoint = 0) +
    scale_x_continuous(labels = scales::percent) +
    scale_y_continuous(labels = scales::percent) +
    facet_wrap(~wria_nr_nm+d_catrp100f, ncol = 4, 
               labeller = label_wrap_gen(multi_line = F),
               strip.position = "right") +
    theme(strip.text = element_text(size = 5), legend.position = "top") +
    labs(
      title = "2001 to 2019 tree cover change",
      subtitle = "StreamCat NLCD %confi+decid+mxfst; comids with urban > 0 in 2019",
      x = "whole local catchment",
      y = "100m riparian corridor %tree"
    )

```

not usable as is, and likely not helpful due to summing over per-comid different +/- change within wria AND even with free scale hard to see smaller wria vs larger wria diffs
```{r perwria_sum_d1901_col_by_nlcd_class, eval=FALSE}
sc_nlcd |> 
  filter(nlcd_year %in% c(2001, 2019)) |> 
  select(wria, wria_nr_nm, nlcd_year, comid, contains("_ac"), -contains("urb_")) |> 
  summarise(across(contains("_ac"), sum), .by = c(nlcd_year, wria, wria_nr_nm)) |> 
  pivot_longer(contains("_ac")) |> 
  mutate(
    aoi = if_else(str_detect(name, "rp100"), "rp100", "cat"),
    nlcd_class = str_remove(name, "cat") |> str_remove("rp100") |> str_remove("_ac"),
    name = NULL
    ) |> 
  pivot_wider(names_from = nlcd_year, values_from = value) |> 
  mutate(
    d1901 = `2019`-`2001`,
    d1901pct = d1901/`2001`
    ) |> 
  ggplot() +
  geom_col(aes(d1901, wria, fill = nlcd_class, alpha = d1901 > 0), show.legend = F) +
  scale_fill_manual(values = pal_nlcd) +
  scale_alpha_manual(values = c(0.3,0.8)) +
  geom_vline(xintercept = 0) +
  facet_wrap(~nlcd_class, nrow = 1, scales = "free")
```


:::
