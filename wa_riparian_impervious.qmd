---
title: "Getting harder every year? Assessing impervious cover change in the riparian corridor"
date: "`r Sys.Date()`"
format:
  docx: 
    reference-doc: /Users/auerbdaa/O/code/quarto_template.docx

  html:
    embed-resources: true
    theme: yeti 
    code-fold: true
    toc: true
    toc-location: left
    grid:
      sidebar-width: 180px
      body-width: 1100px
      margin-width: 20px
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  warning = FALSE, message = FALSE, fig.width = 7, fig.height = 9)

library("tidyverse", quietly = T)
library("sf")
library("patchwork")
library("gt")
theme_set(theme_minimal()) 

dir_data_common <- "~/T/DFW-Team WDFW Watershed Synthesis - data_common"
epsg <- 2927 #WA state standard; NAD83(HARN)/ft
ha <- 0.404686

sf_wrias <- sf::read_sf(file.path(dir_data_common, "WR_WAT_WRIA.gdb/")) |>
  mutate(
    wria = factor(WRIA_NR),
    wria_nr_nm = paste0(str_pad(WRIA_NR,width = 2, pad = "0",),"_",WRIA_NM) |> factor()) |>
  select(WRIA_NR, WRIA_NM, wria, wria_nr_nm, acres = WRIA_AREA_ACR_QT) |> arrange(wria) |> 
  sf::st_transform(sf::st_crs(epsg))

sf_cnty <- sf::read_sf(file.path(dir_data_common, "WA_County_Boundaries/WA_County_Boundaries.shp")) |> 
  select(cnty = JURISDIC_2) |> 
  sf::st_transform(sf::st_crs(epsg))

#can add Oly and Yakima, Pasco/Richland etc. with str_detect(name)
sf_wa_city <- maps::us.cities |> 
      filter(country.etc == "WA", pop > 150000) |> 
      mutate(name = str_remove(name, " WA")) |> 
      sf::st_as_sf(coords = c("long", "lat"), crs = 4326) |> 
      sf::st_transform(epsg)


#load(".RData")
```

# Authors

Dan Auerbach 
Ken Pierce 
Ken Muir 
Keith Folkerts 
Robin Hale 
Kara Whittaker 
Simone Des Roches 
Reed Ojala-Barbour 
George Wilhere
Danielle Lazarus 
John Withey 
Braeden Van Deynze 
Maddie Nolan


# Abstract

Land use regulations may protect riparian ecosystem services from threats such as encroaching impervious cover that degrades habitat and alters watershed hydrology. Empirical cumulative assessments at landscape scales are needed to evaluate whether the policy goals of regulation are being met. We examined recent trends in impervious cover within riparian corridors in Washington State, USA, comparing estimates from a high resolution change detection dataset based on aerial imagery interpretation with those from changes in classified satellite imagery from the National Land Cover Dataset. Aggregated statewide, both approaches indicated that impervious cover within a riparian corridor increased by hundreds of hectares a year during the early and middle 2010s. Despite the convergence in estimated totals, the high resolution dataset offered a clearer characterization of the location and size distribution of new imperviousness. Many changes were small, often less than the size of a single pixel, though a substantial portion of the total change was associated with relatively few larger change areas that occurred outside of the spatial extent of riparian land use protections at the time. These results indicated that regulatory shifts in the 20th century have not eliminitated the risks of habitat impairment from new impervious cover and that the jurisdictional extent of regulated riparian areas warrants continued adaptive management.

# Introduction

Waters and uplands meet and mingle at the riparian ecological edge. The physical and biological exchanges in these dynamic land-water interactions provide numerous services valued by people: maintenance of water quality through pollutant removal and shading, formation of in-channel habitat and wildlife corridors, and attenuation of high flows. Yet human activities have degraded riparian structure and function in many locations, and various laws and policies have been developed to protect and rehabilitate riparian areas.

One major threat to riparian ecological integrity is the spread of impervious surfaces. In addition to the direct loss of terrestrial habitat, replacing native vegetation with concrete or other built elements prevents infiltration and alters watershed flow paths, impairing water quality and channel form. Limiting this damage while meeting expectations for new construction is a core challenge of land use regulation, and status assessments are critical to determine if the motivating policy goals are being met. In particular, cumulative assessment at the landscape scale is important to guide adaptive management, but poses technical challenges and may be outside of the direct responsibility of any single regulatory entity.

Indeed, despite the well-understood importance of riparian areas and the attention devoted to their study, considerable uncertainty still surrounds basic measures of current conditions and changes at the landscape scale. Despite some qualitative consensus that riparian ecosystems in the western United States have experienced "substantial" or "dramatic" shifts following European colonization, quantitative estimates remain elusive, potentially hindering effective communication around policy objectives. This analysis addresses the need to quantify change in riparian imperviousness at larger regional scales, using Washington state as a focal example. 

Past research has indicated likely trends without providing a clear characterization of statewide riparian conditions. Jones et al. (2010) considered late 20th century land cover change (1973-2003) at a relatively coarse spatial resolution (60m) within a 180m buffer of NHD watercourses in several thousand sample blocks across the continental United States. They described a nationwide monotonic increase in the average riparian "urban %" over the assessed duration, and their results showed the Puget lowlands region had the nationally largest decrease in "natural land cover" during the "mid 80s - early 90s" period. A dramatic expansion of "urban", impervious cover was also described by Powell et al. (2008) within Washington's Snohomish River watershed. Though not constrained to riparian areas, they estimated a 255% increase from 3285 ha in 1972 to 11,652 ha in 2006, based on an analysis combining manual orthophoto review with Landsat imagery. This study indicated that rapid impervious expansion during the 1980s slowed during the 1990s before returning to a faster rate after 2000. The authors noted the potential for changes in land use regulations to have influenced this trajectory but avoided any direct attribution, stating the need to study alternative contributing factors. 

Extending to additional Puget Sound watersheds, Bartz et al. (2015) focused on annual changes within 100m or 200m buffers around distinct habitat features important to salmon. Using a LandTrendr analysis of 30m imagery spanning 1986 to 2008, they estimated that impervious cover in "mainstem" zones increased roughly 3% on average (172ha, 425ac) from 5820ha in 1986, and that "tributary" zones increased roughly 5.5% (118ha, 294ac) from 2,153ha. They also reported shifts to a slower rate of increase in these and the other nearshore, estuary, and floodplain habitat areas examined, though the timing and persistence of inflections varied considerably among habitat types and subbasins. While clear that a legacy of degradation continues to affect Puget Sound salmon habitats, these authors concluded that more recent land cover change may indicate slowing in further impairment.

These studies illustrate several factors contributing uncertainty to cumulative assessments of riparian cover and impervious cover change. Differences in hydrography (i.e., the location and resolution of flowlines and waterbodies) combine with alternative lateral buffer dimensions (e.g., from 10m to 200m) to produce variation in the specific zones being evaluated, sometimes even within the spatial scale of a county (10s of kilometers) as well as between separate studies. Beyond hydrographic variation and riparian buffer formulation, landscape scale estimates have also typically relied on categorical classifications of continuous spectral values in satellite imagery, usually at a pixel resolution corresponding to a 30m ground distance. The accuracy of estimates based on these methods is likely to increase where land cover is relatively homogeneous and change areas are large relative to pixel resolution, but substantial cover variation can occur within a 30x30m pixel area, complicating both the assignment of a single class at a given time and the determination of change between images at different times. Moreover, rather than large blocks of change from a continuous baseline, most ongoing impervious cover additions in the western U.S. are likely to occur within heterogeneous mosaics of multiple land cover types and may often involve extents smaller than 0.09ha (0.22 acres, a single 900m^2^ pixel). 

An evaluation of impervious cover that addresses these considerations is possible in Washington because of high resolution change detection (HRCD) processing of aerial imagery at a 1m scale (Pierce 2015). The HRCD approach combines automated delineation of change polygons with extensive manual review and verification against before-after image pairs to generate a detailed dataset of land cover alteration. We used these data in conjunction with a statewide polygon tessellation of riparian corridors grounded in current policy guidelines, and we compare the resulting estimates with those derived from an independent dataset of nationally availalble land cover within a fixed-width corridor on a different hydrography. We describe these estimated increases in imperviousness relative to the distribution of salmon within river networks, an important cultural and legal driver in the region, as well as relative to concurrent changes in human population and housing, before discussing policy implications and opportunities for improved ongoing assessment.

# Methods 

## Riparian management in Washington

Washington State, in the Pacific northwestern United States, is home to several distinct geologic domains and hydroclimates, giving rise to ecoregions that vary from rainforests to semi-arid shrubsteppe. This produces variation in land uses, with different combinations of forestry, agriculture, and urbanization affecting riparian land cover in different portions of the state. Riparian administrative responsibility is also distributed among multiple, often overlapping entities, with no single authority controlling management decisions or the statewide jurisdictional extent of riparian management zones (RMZ). Within the context of U.S. treaties with sovereign tribes, federal and state statutes interact with local codes to create a complex regulatory regime with ample variation in exactly what constitutes "riparian" for the purposes of land use planning and permitting.

However, as the agency mandated "to preserve, protect and perpetuate fish, wildlife and ecosystems", the Washington Department of Fish and Wildlife (WDFW) has a responsibility to consult on rules and projects affecting habitat for harvested and non-harvested species statewide. In addition to participating in multi-stakeholder forums that shape forestry and agricultural regulations, WDFW defines "riparian areas (comprised of riparian ecosystems, active floodplains, and riverine wetlands)" as a "Priority Habitat" (Rentz et al. 2020). This designation warrants provisions in the comprehensive plans and critical area ordinances stipulated by Washington's Growth Management Act (GMA, RCW 36.70A). The agency has consequently issued guidance on an RMZ standard grounded in available evidence of ecosystem functions, following an extensive review and synthesis of scientific studies that updated and extended earlier guidelines (Quinn et al. 2020, Knutson and Naef 1997).

The [200-year Site Potential Tree Height standard (SPTH~200~)](https://wdfw.wa.gov/publications/02564) proposes that the mature height of characteristic native trees at a location can be used to determine a lateral distance from water that will protect "full ecosystem function". Though not compulsory, adoption of this minimum standard of protection increases the likelihood that regulated Fish and Wildlife Habitat Conservation Areas (FWHCA) will foster ecosystem health and contribute to recovery of threatened and listed species, including Chinook salmon (*Oncorhynchus tshawytscha*). Recognizing the inherent natural variation in riverscapes (Fausch et al. 2002) and Washington's physiographic heterogeneity, the SPTH~200~ concept avoids a single fixed dimension while still offering a generalized approach to consistent RMZ delineation based on "best available science". This provides an alternative to the simplistic and less-protective values that have been implemented by many cities and counties since passage of the GMA in 1990. Though commonly 50 or 100 feet based on categorical stream types defined by flow permanence and fish use, the specific sets of buffer rules have differed substantially among planning authorities (Folkerts et al. 2020), sometimes between adjacent local governments along the same watercourse.

To facilitate application of the SPTH~200~ standard, WDFW developed a geospatial web application that supports planning decisions by enabling rapid evaluation of riparian conditions. The foundation of this Riparian Data Engine (RDE, https://ripariandata.wdfw.wa.gov/, [(WDFW 2024)](https://wdfw.medium.com/a-new-way-of-looking-at-washingtons-waterways-ad05d872c4ce) is a statewide polygon tessellation of RMZs generated from public hydrography (NHD) and soils (SSURGO) data. Users are able to interactively examine various attributes measuring land cover, water quality (via 303d/305b listings), and salmon distribution (via the Statewide Integrated Fish Distribution dataset; [SWIFD](https://geo.wa.gov/datasets/wdfw::statewide-washington-integrated-fish-distribution/about)) calculated for each network reach. For example, a user can filter for locations within a Water Resource Inventory Area (WRIA) or a county with a higher or lower tree canopy cover and salmon presence or absence, thereby screening for candidate locations to emphasize for protection or rehabilitation. 

For this analysis, the complete set of "reach tables" was compiled from this public web application, providing attribute values for more than 1 million individual reach units of the SPTH~200~ tesselation. The per-reach rows in this dataset include a combination of riparian management zone (RMZ, both banks where double-banked), "extent of observed water" (EOW), and "floodplain" (primarily based on FEMA mapping) geometry. Within the riparian corridor composed by these areas, land cover change was calculated from the intersection with HRCD polygons (see next section), and values were tabulated statewide and within individual county boundaries, recognizing that county geographic extents contain multiple tribal, federal, state, and local authorities and do not represent the exclusive jurisdiction of county governments.

```{r build_rde_cnty_library, eval=FALSE}
walk(
  URLencode(sort(sf_cnty$cnty))
  ,
  ~httr2::request(paste0(
    'https://api-ripariandata.wdfw.wa.gov/counties/',.x,'/reaches/csv'
  )) |>
    httr2::req_headers(`x-api-key` = key) |>
    #httr2::req_dry_run()
    httr2::req_perform() |>
    httr2::resp_body_raw() |>
    readr::read_csv() |>
    readr::write_csv(
      file = file.path(dir_data_common, paste0("rde/counties/rde_cnty_",.x, ".csv"))
    )
)

```

```{r build_rch_tbl_cnty, eval=FALSE}
#then build combined object: 1,091,144x 40
#NOT deduplicating PID shared across counties
#length(unique(rch_tbl_cnty$pid)) == 1084186 (46 more than wrias?)
#would either need to remove entirely or split+assign by proportion
#preferable to include and count twice in per-county stratification
#and/but unstratified statewide sum-over-counties needs distinct()

rch_tbl_cnty <- map_df(
  list.files(file.path(dir_data_common, "rde/counties"), pattern = ".csv", full.names = T)
  ,
  ~readr::read_csv(.x) |>
    mutate(
      pid = as.character(PermanentIdentifier), PermanentIdentifier = NULL,
      cnty = basename(.x) |> str_remove("rde_cnty_") |> str_remove(".csv") |> 
        str_replace_all("%20", " ")
      )
  ) |>
  rename(wria = WaterResourceInventoryAreaID) |>
  janitor::clean_names() |>
  rename_with(~str_replace(.,"acres","ac")) |>
  rename_with(~str_replace(.,"human_forestry_","forestry_")) |>
  rename_with(~str_replace(.,"human_nonforestry_","nonfstry_")) |>
  rename_with(~str_replace(.,"decrease","dec")) |>
  rename_with(~str_replace(.,"increase","inc")) |>
  rename_with(~str_replace(.,"impervious","impv")) |>
  rename_with(~str_replace(.,"semipervious","semi")) |>
  select(pid, cnty, wria, everything(), -reach_id)

glimpse(rch_tbl_cnty)

#saveRDS(rch_tbl_cnty, "~/T/DFW-Team WDFW Watershed Synthesis - data_common/rde/cnty_rch_tbl.rds")

```

```{r rde_cnty}
#for any statewide sum need: distinct(pid, .keep_all = T)
#no way in this table structure, without a 'zone' attribute', to differentiate RMZ-EOW-Floodplain
rde_cnty <- readRDS("~/T/DFW-Team WDFW Watershed Synthesis - data_common/rde/cnty_rch_tbl.rds") |> 
  mutate(
    wria = factor(wria),
    tree_pct = all_tree_cover_ac / all_land_cover_ac,
    veg_pct = all_vegetated_ac / all_land_cover_ac
    ,
    swifd_any = !is.na(swifd_salmon_distribution),
    swifd_n = 1 + str_count(swifd_salmon_distribution,","),
    swifd_n_fct = case_when(
      is.na(swifd_n) ~ "none",
      swifd_n < 3 ~ "1-2 species",
      swifd_n >= 3 ~ "3 or more species"
    ),
    swifd_chin = case_when(
      str_detect(swifd_salmon_distribution, "Chin") ~ "salmon_with_chin",
      str_detect(swifd_salmon_distribution, "Chin", negate = T) ~ "salmon_not_chin",
      is.na(swifd_salmon_distribution) ~ "not_salmon"
    )
  ) 

```


## High Resolution Change Detection 

Land cover changes were measured following the methodology outlined in Pierce (2015), in which automated processing of sequential aerial imagery generated candidate polygons that were then manually reviewed for accuracy and categorical attribution. This process consists of three main phases: 1) object-based change detection (OBCD) to created polygons of similar pixels, 2) estimation of a probability of change for each of these units, and 3) a manual review and attribute assessment. 

High resolution orthoimagery produced by the National Agriculture Inventory Program (NAIP) has been collected at two to three year intervals beginning in 2006 (Maxwell et al. 2017). Mosaics of georectified tiles of these multispectral, aerial data formed the starting point for processing. This study is limited to the 2011 to 2013, 2013 to 2015, and 2015 to 2017 time windows due to their statewide coverage. Imagery for these periods was at 0.914-m (3 ft) resolution. 

Object-based segmentation of these images via Trimble eCognition software (versions 8.8 - 9.5.1) generated geodatabases of irregularly sized and shaped polygons determined by per-pixel spectral properties. Segmentation rule sets were constructed to distinguish potential changes down to the scale of about 1/50 hectare (0.05 acres, 242 pixels). These candidate polygons were assigned a probability of change estimated from random forest models fit to a training set of 5000 stratified samples and analyst-scored units combined with an additional 500 confirmed change units from a directed search.

The short intervals between NAIP images tend to skew the estimated change probability distribution towards zero or "no change", but a relatively low change probability of 25% was used to stratify between “change-likely” and “change-unlikely” groups, reducing omission errors from "change-unlikely" polygons that contained real change. At least 1% of "unlikely" polygons were randomly sampled for further review.

Analysts used custom software to examine this "unlikely" sample and the set of all "likely" polygons (1-4% or roughly n = 1,000 - 40,000, depending on the location and time period). Visual comparison between image pairs confirmed changes, allowed assignment of a likely change agent, and addressed imperfections in the homogeneity of pixels within a change segment through assignment of categorical quartile values for the proportions of total change, lost tree canopy, new impervious surface, and new semi-pervious surface (e.g., new gravel roads). Assignment of the percent change categories introduced uncertainty due to accuracy (i.e., selection of 25% vs 50%) and imprecision (i.e., the true value falling within a 25% range). Finer divisions would tend to reduce the latter while increasing the former, but the inspection of millions of candidate change polygons has confirmed that this approach is a logistically feasible way to generate a high quality dataset that captures many small changes at large regional scales.  

## StreamCat-processed NLCD

As a complement and contrast to the RDE-HRCD dataset, the [`StreamCatTools`](https://github.com/USEPA/StreamCatTools) (Weber 2025) R package was used to access the [StreamCat dataset](https://www.epa.gov/national-aquatic-resource-surveys/streamcat-dataset) (Hill et al. 2016). This delivers consistently geoprocessed attribute values for each reach unit of the original medium resolution NHDPlus. Derived from a 30m DEM and sometimes termed "1:100K", this hydrography captures most substantial watercourses and is the precursor to subsequent higher-resolution, continent-wide elevation derived hydrographic datasets that include many smaller channel units (i.e., NHDPlusHR from 10m DEM and 3DHP from LiDAR). For each reach 'comid', StreamCat provides attribute values from many other data sources processed within the local contributing catchment ('`cat`') as well as a 100m riparian buffer ('`rp100`') on "stream lines and on-network NLCD water pixels". 

StreamCat includes values calculated from 8 cycles of the National Land Cover Dataset (NLCD; 2001, 2004, 2006, 2008, 2011, 2013, 2016, and 2019), which are based on random forest classification of satellite and other imagery sources [(Wickham et al. 2023)](https://www.tandfonline.com/doi/full/10.1080/15481603.2023.2181143). The StreamCat NLCD values represent the percentages of each of 16 land cover classes within each of the *cat* and *catrp100* areas of interest  (AOI), such that approximate areas per-class were back-calculated against the per-comid area. The StreamCat process and NLCD datasets have undergone thorough QAQC and been extensively reviewed since their initial development, resulting in their widespread use in various scientific studies. Though unsuited to investigating site specific processes, these data are a standardized, consistent means to investigate large-scale cumulative patterns.

```{r objects_sf}
  
# ##flowlines with WRIA added deduplicated via 'largest=T'
# sf_flw <- sf::read_sf(file.path(dir_data_common, "NHDPlus17/NHDSnapshot/Hydrography/NHDFlowline.shp")) |>
#   sf::st_transform(crs = sf::st_crs(epsg)) |>
#   sf::st_zm() |>
#   select(COMID, FCODE, FTYPE, LENGTHKM) |>
#   rename_with(tolower) |>  
#   st_join(sf_cnty, left = F, largest = T) |> #inner join
#   st_join(sf_wrias |> select(wria, wria_nr_nm), left = F, largest = T) |> #inner join
#   mutate(comid = as.character(comid))
# saveRDS(sf_flw, file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_flw.rds"))
sf_flw <- readRDS(file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_flw.rds"))

# # ##catchment polys with WRIA added deduplicated via 'largest=T'
# sf_cat <- sf::read_sf(file.path(dir_data_common, "NHDPlus17/NHDPlusCatchment/Catchment.shp")) |>
#   sf::st_transform(crs = sf::st_crs(epsg)) |>
#   select(comid = FEATUREID, areasqkm = AreaSqKM) |>
#   st_join(sf_cnty, left = F, largest = T) |> #inner join
#   st_join(sf_wrias |> select(wria, wria_nr_nm), left = F, largest = T) |>
#   mutate(comid = as.character(comid))
# saveRDS(sf_cat, file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_cat.rds"))
sf_cat <- readRDS(file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_cat.rds"))

# # ~608 comids along county borders are assigned different (appropriately, due to geometry+'largest')
# #not splitting geometries (and attributes) so simpler is better
# #visual inspection indicates flowlines should have precedence for associating to StreamCat/NLCD
# mm <- inner_join(
#   sf_cat |> as_tibble() |> select(comid, cnty_cat=cnty),
#   sf_flw |> as_tibble() |> select(comid, cnty_flw=cnty),
#   by = "comid"
#   ) |> 
#   filter(cnty_cat!=cnty_flw)
# x <- sf_cat |> semi_join(mm, by = "comid")
# y <- sf_flw |> semi_join(mm, by = "comid")
# mapview::mapview(list(cat = x, flw = y, cnty = sf_cnty))

# distinct(as_tibble(sf_flw), comid) #66116
# distinct(as_tibble(sf_cat), comid) #57306
# #flowlines with no cat are most pipelines & canalditch (~3K), a third of coastline
# #but also many scattered streamriver and artificalpath statewide but large concentrations in yakima region
# #cat with no flowlines are edge cases, a pothole depressional area SE of Okanagon plus a few other scattered Eastside

```

```{r objects_streamcat_nlcd}
## recall riparian buffers are 100m, per https://www.epa.gov/national-aquatic-resource-surveys/streamcat-dataset-readme 
 
# #pull all 4 AOI, including abs areasqkm
# sc_wa_nlcd <- map(
#   set_names(c(2001, 2004, 2006, 2008, 2011, 2013, 2016, 2019))
#   ,
#   ~StreamCatTools::sc_nlcd(
#     state = "WA", year = .x,
#     aoi = 'cat,catrp100,ws,wsrp100',
#     showAreaSqKm = T
#   ) |>
#     rename_with(tolower) |> as_tibble() |>
#     mutate(comid = as.character(comid), nlcd_year = .x)
# )
# saveRDS(sc_wa_nlcd, file.path(dir_data_common, "streamcat", "sc_wa_nlcd.rds"))

# #removing 7 massive cross-border COMIDs mostly in BC; 6 are >1000km2, last is >350km2
# sf_cat |> arrange(desc(areasqkm)) |> filter(areasqkm>1000) |> ggplot() + geom_sf() + geom_sf_text(aes(label = comid))
# sf_cat |> filter(between(areasqkm,100,1000)) |> ggplot() + geom_sf(aes(fill=areasqkm)) + geom_sf_text(aes(label = comid))
# filter(sf_cat, comid =="23031682")->x; mapview::mapview(x)
comids_drop_BC <- filter(as_tibble(sf_cat), areasqkm>1000) |> distinct(comid) |> bind_rows(tibble(comid = "23031682"))

#starting object with cat and catrp100 (no Ws)
#inner_join against sf_cat to add WRIA 
#then second inner_join against sf_flw to add County and get common set across all 3
#dropping remaining comids with NA rp100
#converting pcts to 0-1
#appending 'ac[res]' cols as AOI-specific product of pct and areasqkm
sc_nlcd <- readRDS(file.path(dir_data_common, "streamcat", "sc_wa_nlcd.rds")) |> 
  map(
    ~.x |> 
      rename_with(
        ~str_remove(.,paste(c(2001, 2004, 2006, 2008, 2011, 2013, 2016, 2019),collapse = "|")) |> 
          str_remove("pct")
        ) |> 
      select(comid, nlcd_year, 
             catareasqkm, catareasqkmrp100,
             ends_with("cat"), ends_with("catrp100"))
      ) |> 
  list_rbind() |> 
  anti_join(comids_drop_BC, by = "comid") |> 
  inner_join(as_tibble(sf_cat) |> select(comid, wria, wria_nr_nm), by = "comid") |> 
  inner_join(as_tibble(sf_flw) |> distinct(comid, cnty), by = "comid") |> 
  drop_na(urbmdcatrp100) |> #single lu class captures all 231 comids NA for rp100 vals
  mutate(
    across(c(ends_with("cat"), ends_with("catrp100")), ~./100)
    ,
    # urb_cat = urbhicat + urbmdcat,
    # urb_catrp100 = urbhicatrp100 + urbmdcatrp100
    ,
    across(ends_with("cat"), list(ac = ~.* catareasqkm * 247.11)),
    across(ends_with("catrp100"), list(ac = ~.* catareasqkmrp100 * 247.11))
    ) 

sc_nlcd <- sc_nlcd |> 
  select(
    wria, wria_nr_nm, cnty,
    comid, nlcd_year, 
    catareasqkm, catareasqkmrp100,
    all_of(sort(grep("cat$", colnames(sc_nlcd), value = T))),
    all_of(sort(grep("catrp100$", colnames(sc_nlcd), value = T))),
    all_of(sort(grep("cat_ac$", colnames(sc_nlcd), value = T))),
    all_of(sort(grep("catrp100_ac$", colnames(sc_nlcd), value = T))),
)

#bring both sf to same 56879
sf_flw <- sf_flw |> inner_join(distinct(sc_nlcd, comid), by = "comid") 
sf_cat <- sf_cat |> inner_join(distinct(sc_nlcd, comid), by = "comid")

pal_nlcd <- set_names(
  c("brown","darkgreen","yellow","lightgreen","yellowgreen",
    "yellow","seagreen","white","green","blue",
    "tan","grey10","grey60","grey30","grey80","seagreen")
  ,
  str_remove(sort(grep("cat$", colnames(sc_nlcd), value = T)), "cat") 
)    

```

## Lazarus dataset?

Alternative spth200 + NLCD

## OFM population and housing data

Annual county-level population and housing unit totals were accessed from the Washington Office of Financial Management (OFM) Data and Research [April 1 Postcensal Estimates](https://ofm.wa.gov/washington-data-research/population-demographics/population-estimates/historical-estimates-april-1-population-and-housing-state-counties-and-cities).

```{r ofm_pop}
#non-numeric special symbol flag cols starting after 1970
#flag==1 is the total of unincorporated (2) and incorp (3), incorp the sum of munis (4)
ofm_pop <- suppressMessages(readxl::read_excel(
  file.path(dir_data_common, "census", "ofm_april1_postcensal_estimates_pop_1960-present.xlsx"),
  sheet = 2, skip = 2, na = "."
) |> 
  drop_na(Filter) |>
  janitor::clean_names() |> #glimpse() 
  select(filter, county, jurisdiction, contains("population")) |> 
  pivot_longer(contains("population"), values_to = "est_pop") |> 
  mutate(
    year = str_remove(name, "_") |> str_sub(2, 5), 
    name = NULL,
    across(c(year, est_pop), as.numeric)
  ))

```

```{r ofm_housing}
ofm_housing <- readxl::read_excel(
  file.path(dir_data_common, "census", "ofm_april1_postcensal_estimates_housing_1980_1990-present.xlsx"),
  sheet = 2, skip = 2, na = "."
) |> 
  drop_na(Filter) |>  #filter(Filter!=".") |> 
  janitor::clean_names() |> #glimpse() 
  # select(filter, county, jurisdiction, contains("total_housing")) |> 
  # pivot_longer(contains("total_housing"), values_to = "total_housing") |> 
  # mutate(
  #   year = str_sub(name, 2, 5), name = NULL,
  #   across(c(year, total_housing), as.numeric)
  #   )
  select(-line) |> 
  pivot_longer(contains("units"), values_to = "units") |> 
  mutate(
    year = str_sub(name, 2, 5), 
    across(c(year, units), as.numeric),
    name = case_when(
      str_detect(name, "total") ~ "total",
      str_detect(name, "one_unit") ~ "single",
      str_detect(name, "two_or_more") ~ "multi",
      str_detect(name, "special") ~ "other"
    )
  )

```



# Results

```{r rde_swifd_sum_statewide_summary}
# #if Lazarus ~580-720ac/y for 2001:2019
# expand_grid(ac = c(11:13)*1000, y = 18:19) |> mutate(ac_y = ac/y)

rde_swifd_sum <- rde_cnty |> 
  distinct(pid, .keep_all = T) |> 
  summarise(
    across(
      c(reach_ac, 
        rmz_ac, eow_ac, flood_ac, 
        nonfstry_impv_inc_ac, nonfstry_semi_inc_ac
        ),
      ~sum(., na.rm = T)
    )
    , .by = swifd_chin
  ) |> 
  bind_rows(
    rde_cnty |> 
      distinct(pid, .keep_all = T) |> 
      summarise(across(c(reach_ac, rmz_ac, eow_ac, flood_ac, nonfstry_impv_inc_ac, nonfstry_semi_inc_ac), ~sum(., na.rm = T))) |> 
      mutate(swifd_chin = "total")
  ) |> 
  rename_with(~str_remove(., "nonfstry_")) |> 
  mutate(
    reach_ha = ha*reach_ac,
    impv_inc_ha = ha*impv_inc_ac,
    impv_reach_pct = impv_inc_ac / reach_ac,
    semi_inc_ha = ha*semi_inc_ac,
    semi_reach_pct = semi_inc_ac / reach_ac,
    #per KP, HRCD 2011:2017 NAIP is summer to summer
    impv_ha_y = ha*(impv_inc_ac / 6),
    impv_ac_y = impv_inc_ac / 6,
    semi_ha_y = ha*(semi_inc_ac / 6),
    semi_ac_y = semi_inc_ac / 6 
  )
```

```{r sc_nlcd_year_sum}
sc_nlcd_year_sum <- sc_nlcd |> 
  summarise(
    rp100_ha = 100*sum(catareasqkmrp100),
    across(
      contains("urb") & ends_with("ac"),
      list(sum = ~sum(.))
    )
    , .by = c(nlcd_year)
  ) |> 
  pivot_longer(cols = -c(nlcd_year,rp100_ha), values_to = "ac") |> 
  mutate(
    aoi = if_else(str_detect(name, "rp100"), "rp100", "cat"),
    nlcd_class = str_remove(name, "cat") |> str_remove("rp100") |> str_remove("_ac_sum"),
    name = NULL,
    ha = ha*ac
    ) |> 
  filter(aoi == "rp100") |> #filter(nlcd_year %in% c(2011, 2016))
  select(-ac) |> 
  pivot_wider(names_from = c(nlcd_class), values_from = ha)
```

```{r rde_cnty_sum}
rde_cnty_sum <- rde_cnty |> 
  summarise(
    across(
      c(reach_ac, 
        riparian_ac, rmz_ac, eow_ac, flood_ac, 
        nonfstry_impv_inc_ac, 
        nonfstry_semi_inc_ac,
        nonfstry_tree_dec_ac
        ),
      ~sum(., na.rm = T)
    )
    , .by = cnty
  ) |> 
  mutate(
    across(
      starts_with("nonf"),
      list(
        #per_100ac = ~100*(./reach_ac)
        pct_rch = ~(./reach_ac)
      )
    )
  ) |> 
  left_join(
    rde_cnty |> 
      summarise(
        across(
          c(reach_ac, 
            #riparian_ac, rmz_ac, eow_ac, flood_ac, 
            nonfstry_impv_inc_ac,
            nonfstry_semi_inc_ac,
            nonfstry_tree_dec_ac
          ),
          ~sum(., na.rm = T)
        ),
        .by = c(cnty, swifd_chin)
      ) |> 
      pivot_wider(names_from = swifd_chin, values_from = ends_with("_ac"))
    , 
    by = "cnty"
  ) |> 
  left_join(
    ofm_pop |> 
      filter(filter == "1", year %in% c(2011, 2017)) |> 
      select(cnty = county, year, est_pop) |> 
      #arrange(cnty, year) |> summarise(across(est_pop, list(d = ~.[2] - .[1])), .by = cnty)
      pivot_wider(names_from = year, names_glue =  "{year}_{.value}", values_from = est_pop) |> 
      mutate(d_est_pop = `2017_est_pop`- `2011_est_pop`)
    ,
    by = "cnty"
  ) |> 
  left_join(
    ofm_housing |> 
      filter(filter == "1", year %in% c(2011, 2017)) |> 
      select(cnty = county, year, name, units) |> 
      #pivot_wider(names_from = name, values_from = units) |> 
      #arrange(cnty, year) |> summarise(across(total:other, list(d = ~.[2] - .[1])), .by = cnty)
      pivot_wider(names_from = year, values_from = units) |> 
      mutate(d = `2017`- `2011`) |> 
      pivot_wider(names_from = name, values_from = where(is.numeric))
    ,
    by = "cnty"
  ) |> 
  rename_with(~str_remove(., "nonfstry_"))

```

```{r sc_nlcd_year_cnty_sum}
sc_nlcd_year_cnty_sum <- sc_nlcd |> 
  summarise(
    rp100_ha = round(100*sum(catareasqkmrp100)),
    across(
      contains("urb") & ends_with("ac"),
      list(sum = ~sum(.))
    )
    , .by = c(nlcd_year, cnty)
  ) |> 
  pivot_longer(cols = -c(nlcd_year, cnty, rp100_ha), values_to = "ac") |> 
  mutate(
    aoi = if_else(str_detect(name, "rp100"), "rp100", "cat"),
    nlcd_class = str_remove(name, "cat") |> str_remove("rp100") |> str_remove("_ac_sum"),
    name = NULL,
    ha = ha*ac
    ) |> 
  select(-ac) |> filter(aoi == "rp100") |> 
  filter(nlcd_year %in% c(2011, 2016)) |> 
  pivot_wider(names_from = c(nlcd_year, nlcd_class), values_from = ha)

```

```{r sf_cnty_rde_sc}
sf_cnty_rde_sc <- sf_cnty |> 
  mutate(cnty_ac = st_area(geometry) |> units::set_units("acres") |> as.numeric()) |> 
  left_join(rde_cnty_sum, by = "cnty") |> 
  left_join(sc_nlcd_year_cnty_sum, by = "cnty")

```

## Assessed riparian corridor

The RDE-HRCD and StreamCat-NLCD datasets differ in total extent of the assessed corridor, with the former encompassing a `r round(100*((3636186-2595580)/2595580))`% larger area (@tbl-overall). The pattern of variation in assessed area also differed between datasets when summarized within county boundaries (@fig-cnty_assess). In the medium-resolution NHDPlus, standardized terrain processing from 30m digital elevation data captures larger streams and rivers but omits some small channels. The fixed buffer dimension of the StreamCat 'rp100' corridor meant that corridor area was driven by the length of the channel network and, when aggregated within counties, primarily reflected drainage density and overall county size. In contrast, the ecoregional variation in SPTH~200~ values combined with underlying cartographic heterogeneity in NHD flowlines to create sub-regional differences in assessed extent across the RDE tessellation that were not necessarily related to watershed topography. However, despite this variation in total extent, the RDE assessed corridor was primarily comprised of the SPTH~200~ RMZ portion at the statewide extent (`r round(100*(3066006/3636186))`%) and within individual counties (@fig-rde_cnty_zones_stacked_cols; SI fig 2).


```{r eval=FALSE}
#| label: tbl-overall
#| tbl-cap: "Overall comparison between assessment datasets"

# sc_nlcd_year_sum |>
#   select(-ac) |> 
#   filter(aoi == "rp100") |>
#   nest(.by = nlcd_class) |> 
#   mutate(
#     ha_yr = map(data, ~lm(ha ~ nlcd_year, data = .) |> broom::tidy())
#   ) |> 
#   unnest(ha_yr) |> 
#   filter(term == "nlcd_year") |> 
#   select(nlcd_class, estimate) |> 
#   mutate(est = paste0(nlcd_class,": ", round(estimate, 1))) |> 
#   pull(est)


tibble(
  Characteristic = c(
    "Hydrography","RMZ buffer dimension", "Land cover resolution","Years",
    "Total assessed riparian corridor",
    "Estimated cover change"),
  `RDE-HRCD` = c(
    "NHD (2022)", "SPTH~200~ (approx. 30-75m)<br>+floodplains", "1m", "2011-2017"
    , 
    paste0(
      "Total: ", round(rde_swifd_sum$reach_ha[4]) |> scales::number(big.mark = ","), "<br>",
      "*RMZ: ", round(ha*rde_swifd_sum$rmz_ac[4]) |> scales::number(big.mark = ","), "*<br>",
      "*EOW: ", round(ha*rde_swifd_sum$eow_ac[4]) |> scales::number(big.mark = ","), "*<br>",
      "*Floodplain: ", round(ha*rde_swifd_sum$flood_ac[4]) |> scales::number(big.mark = ","), "*"
      )
    , 
    paste0(
      paste("Impervious:<br>", round(rde_swifd_sum$impv_inc_ha[4]), "ha, ", round(rde_swifd_sum$impv_ha_y[4]), "ha/y"),
      "<br>",
      paste("Semi-pervious:<br>", round(rde_swifd_sum$semi_inc_ha[4]), "ha, ", round(rde_swifd_sum$semi_ha_y[4]), "ha/y")
      )
    ),
  `StreamCat-NLCD` = c(
    "NHDPlus v2.1 1:100K", "100m, fixed ('rp100')", "30m", "2001-2019", 
    scales::number(sc_nlcd_year_sum$rp100_ha[1], big.mark = ",")
    ,
    paste(
      "2011 to 2016 only<br>",
    sc_nlcd_year_sum |>
      filter(aoi == "rp100", nlcd_year %in% c(2011, 2016)) |>
      select(-aoi) |> 
      pivot_longer(-c(nlcd_year), names_to = "nlcd_class", values_to = "ha") |> 
      pivot_wider(names_from = nlcd_year, values_from = ha) |> 
      mutate(
        nlcd_class = factor(nlcd_class, 
                            levels = c("urbhi","urbmd","urblo","urbop"), 
                            labels = c("High", "Medium", "Low", "Open")),
        ha = (`2016`-`2011`),
        ha_yr = ha/5,
        d = paste0(nlcd_class, ": ", round(ha)," ha, ", round(ha_yr)," ha/y")
      ) |> 
      arrange(nlcd_class) |> 
      pull(d) |> paste0(collapse = "<br>")
      )
    )
) |> 
  gt::gt() |> 
  tab_style(style = cell_text(weight = "bold"), locations = cells_column_labels()) |> 
  fmt_markdown()


```

![Table 1: Overall comparison between assessment datasets](t_tbl_overall_placeholder.png)

```{r}
#| label: fig-cnty_assess
#| fig-cap: "Total area of assessed riparian corridor by county geographic boundaries. A) The Riparian Data Engine statewide tessellation based on SPTH~200~ management zones, extent of observed water, and floodplain polygons. B) The StreamCat 100m riparian buffer on medium resolution NHDPlus."

list(
  #range(ha*rde_cnty_sum$reach_ac)
  reach_ha = sf_cnty_rde_sc |>  
    ggplot() + geom_sf(aes(fill = ha*reach_ac), show.legend = T) + 
    scale_fill_gradient(name = "hectares", labels = scales::label_comma(),
                        low = "#BEE7DF", high = "#212540", na.value = "pink",
                        limits = c(0, 300000)) +
    labs(subtitle = "A. RDE: RMZ+EOW+floodplain")
  ,
  rp100_ha = sf_cnty_rde_sc |> 
    ggplot() + geom_sf(aes(fill = rp100_ha), show.legend = T) + 
    scale_fill_gradient(name = "hectares", labels = scales::label_comma(),
                        low = "#BEE7DF", high = "#212540", na.value = "pink", 
                        limits = c(0, 300000)) +
    labs(subtitle = "B. StreamCat: NHDplus rp100")
) |> 
  wrap_plots(design = "A\nB", guides = "collect")

```

```{r figcorridors_sumner, eval=FALSE}

sf_aoi <- st_as_sf(st_as_sfc(
  st_bbox(
    #c(xmin = 1064273, xmax = 1064273+60000, ymin = 800000, ymax = 800000+90000), #Poulsbo to Pt Orchard
    c(xmin = 1200000, xmax = 1200000+15000, ymin = 679000, ymax = 679000+30000), #Sumner
    crs = st_crs(epsg))
  ))

# st_bbox(st_transform(sf_aoi, crs = 4326))
#       xmin       ymin       xmax       ymax 
# -122.27395   47.18171 -122.21093   47.26484 
# st_area(sf_aoi) |> units::set_units("acres") 
#mapview::mapview(sf_aoi)


sf_aoi_flw <- sf_flw[sf_aoi,] |> st_crop(sf_aoi)
sf_aoi_flw_rp100 <- st_buffer(sf_aoi_flw, dist = 328) |> 
  left_join(
    sc_nlcd |> 
    select(comid, nlcd_year, starts_with("urb"), ends_with("rp100_ac")) |> filter(nlcd_year==2016),
    by = "comid")
sf_aoi_cat <- sf_cat[sf_aoi,] |> st_crop(sf_aoi) |> 
  left_join(
    sc_nlcd |> 
    select(comid, nlcd_year, starts_with("urb"), ends_with("rp100_ac")) |> filter(nlcd_year==2016),
    by = "comid")

gdb <- file.path(dir_data_common, "HRCD.gdb") #also NAD83(HARN)
sf::st_layers(gdb)
sf_hrcd <- sf::st_read(gdb, layer = "HRCD_ChangeLocations") |> #~4gb
  filter(StartYr >= 2011, EndYr <= 2017, WRIANr == 10) 
sf_aoi_hrcd <- sf_hrcd[sf_aoi,] |> 
  filter(CngOrigin != "Natural", ImpIncPct > 0)


# w = stringr::str_pad(x, width = 2, pad = "0")
# sf::st_read(
#   "~/T/DFW-Team WDFW Watershed Synthesis - data_common/SPTH_Tessellation.gdb",
#   layer = paste0("wria",w,"_SPTH_Tessellation")
# ) |> 
#   sf::st_zm() |>
#   dplyr::group_by(pid = permanent_identifier, zone = Zone) |>
#   dplyr::summarise(area = sum(Shape_Area), .groups = "drop") |> 
#   sf::st_write(  
#     dsn = paste0("wdfw_rde_spth200_tess_wria_",w,".gpkg"), 
#     layer = paste0("wria",w)
#   )
sf_rde <- st_read("wdfw_rde_spth200_tess_wria_10.gpkg")
sf_aoi_rde <- sf_rde[sf_aoi,]

#floodplains still pending from Colin

# mapview::mapview(sf_aoi_cat, col.regions = NA) +
#   #mapview::mapview(sf_aoi_flw) +
# mapview::mapview(sf_aoi_flw_rp100, zcol = "urbhicatrp100_ac",
#                  col.regions = rev(wacolors::wacolors$volcano)) +
# mapview::mapview(sf_aoi_rde, zcol = "zone") +
# mapview::mapview(sf_aoi_hrcd, zcol = "ImpIncAc",
#                  col.regions = rev(wacolors::wacolors$forest_fire))

#pretty close, pending floodplain geometry inquiry
ggplot() +
  #geom_sf(data = sf_aoi_cat, fill = NA, color = "purple") +
  geom_sf(data = sf_aoi_rde |> st_crop(sf_aoi) |> filter(zone == "RMZ"), color = "green", fill = "green") +
  geom_sf(data = sf_aoi_rde |> st_crop(sf_aoi) |> filter(zone == "EOW"), color = "#69A2E4" , fill = "#69A2E4") +
  geom_sf(data = sf_aoi_flw_rp100, fill = NA, color = "purple", linewidth = 0.5, show.legend = F) +
  # geom_sf(data = sf_aoi_rde |> st_crop(sf_aoi), aes(color = zone), fill = NA) + 
  # scale_color_manual(name = "RDE zone", values = c("lightblue","green")) +
  geom_sf(data = sf_aoi_hrcd, fill = "grey40", color = "grey40") +
  wacolors::scale_fill_wa_c("volcano", reverse = T) +
  ggspatial::annotation_scale() +
  labs(
    #title = "Assessed riparian corridors",
    subtitle = "SPTH200 RMZ (green) & EOW (blue)\nStreamCatRp100 100m buffer on NHDPlusMR (purple)\nHRCD impervious increases (grey)"
  )

ggsave("f_corridor_overlay_sumner_placeholder.png", bg = "white", width = 7, height = 10, dpi = 200)
```

![Placeholder figure illustrating datasets](f_corridor_overlay_sumner_placeholder.png)

```{r}
#| label: fig-rde_cnty_zones_stacked_cols
#| fig-cap: "Relative proportions of riparian corridor elements in the RDE-HRCD dataset"

#showing the relative/proportional composition of 'zones'
rde_cnty_sum |>
  mutate(
cnty = factor(cnty) |> fct_reorder(reach_ac),
across(c(rmz_ac, eow_ac, flood_ac), ~.*ha)
) |>
  select(cnty, RMZ = rmz_ac, EOW = eow_ac, Floodplain = flood_ac) |>
  pivot_longer(-cnty) |>
  #filter(name == "eow_ac") |> #Grant Co really does have numerous large lakes and reservoirs
  ggplot() + geom_col(aes(value, cnty, fill = name)) +
  scale_x_continuous(labels = scales::label_comma()) +
  scale_fill_manual(name = "RDE zone", values = c("#69A2E4","darkgreen","green")) +
  labs(x = "ha", y = NULL) +
theme(legend.position = "bottom")

```

## Change in impervious cover

An estimated 947 (2341) and 437 (1080) hectares (acres) of new impervious and semi-pervious cover were added to the assessed riparian corridor during the 2011-2017 period of the RDE-HRCD dataset. Differencing the 2011 and 2016 values in the Streamcat-NLCD dataset, high and medium intensity urban cover (>80% and 50-80% impervious respectively) increased by approximately 365 (900) and 1152 (2846) hectares (acres) within the rp100 corridor. Combining these types per dataset, this corresponded to average annual increases of 231 (158+73) and 303 (73+230) ha/year (@tab-overall). 

The largest increases were concentrated in previously urbanizing portions of the state. Absolute change was greatest in proximity to the large and rapidly growing metropolitan areas of Seattle, Tacoma, and Vancouver in western Washington (King, Pierce, Clark counties) and Spokane and the Tri-Cities in the east (@fig-impv_inc_ha_map). However, the NLCD-based estimates for the medium (and low) intensity classes were generally greater in the more arid eastern counties.

```{r}
#| label: fig-impv_inc_ha_map
#| fig-cap: "Geographic distribution  and differences between datasets in new impervious cover."

d <- sf_cnty_rde_sc |> 
  as_tibble() |> 
  #select(cnty, impv_inc_ac, semi_inc_ac, `2011_urbhi`,`2011_urbmd`, `2016_urbhi`,`2016_urbmd`) |> 
  mutate(
    impv_ha = ha*(impv_inc_ac),
    semi_ha = ha*(semi_inc_ac),
    hi_ha = `2016_urbhi`-`2011_urbhi`, 
    md_ha = `2016_urbmd`-`2011_urbmd`
  ) |> 
  select(cnty, ends_with("ha"), -rp100_ha) |>
  slice_max(impv_ha, n = 10) |> 
  pivot_longer(-cnty, values_to = "ha") |> 
  mutate(
    src = if_else(str_detect(name, "impv|semi"), "RDE-HRCD", "SC-NLCD") |> 
      factor(levels = c("RDE-HRCD", "SC-NLCD"))
    ,
    name = paste0(src, "_", name)
  )

pal_d <- set_names(
  c("#7E4837","#BAAF9F", "#483778", alpha("#483778",0.3)),
  sort(unique(d$name))
)

{
    sf_cnty_rde_sc |>
      ggplot() + 
      geom_sf(aes(fill = ha*(impv_inc_ac+semi_inc_ac)), color = "white", show.legend = T) +
      geom_sf(data = sf_wa_city, color = "brown", show.legend = F) +
      geom_sf_text(data = sf_wa_city, aes(label = name), color = "brown", hjust = 1.1, size = 3, show.legend = F) +
      scale_fill_gradient(name = "ha", low = "grey95", high = pal_d["RDE-HRCD_impv_ha"]) + #, limits = c(0,300)
      labs(x = NULL, y = NULL, subtitle = "RDE-HRCD imperv+semi 2011-2017") +
      theme(axis.text = element_blank())
  }+{
    sf_cnty_rde_sc |>
      ggplot() + 
      geom_sf(aes(fill = (`2016_urbhi`+`2016_urbmd`) - (`2011_urbhi`+`2011_urbmd`)), color = "white", show.legend = T) +
      geom_sf_text(data = sf_cnty |> semi_join(d, by = "cnty"), aes(label = cnty), color = "grey20", size = 3) +
      geom_sf(data = sf_wa_city, color = "brown", show.legend = F) +
      geom_sf_text(data = sf_wa_city, aes(label = name), color = "brown", hjust = 1.1, size = 3, show.legend = F) +
      scale_fill_gradient(name = "ha", low = "grey95", high = pal_d["SC-NLCD_hi_ha"]) +
      labs(x = NULL, y = NULL, subtitle = "SC-NLCD 'high'+'med' 2011-2016") +
      theme(axis.text = element_blank())
  }+{
  d |> 
    ggplot() +
    geom_col(aes(ha, src, fill = name), show.legend = F) +
    scale_y_discrete(limits = rev) +
    scale_fill_manual(values = pal_d) +
    facet_wrap(~cnty, strip.position = "right", ncol = 1) +
    labs(y = NULL, subtitle = "County boundaries with largest\nHRCD impervious increases") +
    theme(
      axis.text.y = element_text(size = 5),
      strip.text = element_text(size = 6))
} +
plot_layout(design = "AC\nBC") +
plot_annotation(tag_levels = "A")

```

Normalizing by the assessed riparian corridor extent within county boundaries highlighted differences in the relative density of impervious cover change (@fig-impv_inc_pct_reach). Despite the largest absolute aggregate increase within King county boundaries, the changes within Pierce and Clark county extents both formed a larger proportion of the assessed area. Conversely, though total increases were smaller within the Kitsap, Island, and Benton boundaries, these changes made up relatively high proportions of the riparian corridor.

```{r}
#| label: fig-impv_inc_pct_reach
#| fig-cap: "New impervious cover as proportion of county geographic extent for RDE-HRCD (brown triangles) and StreamCat (purple dots) estimates."

#somewhat redundant wrangling (% are equiv whether ac or ha and SC was orig in %)
#but for clarity
d <- full_join(
  rde_cnty_sum |> 
    mutate(
      reach_ha = ha*reach_ac,
      impv_ha = ha*impv_inc_ac,
      impv_reach_pct = impv_ha / reach_ha
    ) |> 
    select(cnty, reach_ha, impv_ha, impv_reach_pct)
  ,
  sc_nlcd_year_cnty_sum |> 
    mutate(
      hi_ha = `2016_urbhi`-`2011_urbhi`, 
      hi_rp100_pct = hi_ha / rp100_ha
    ) |> 
    select(cnty, rp100_ha, hi_ha, hi_rp100_pct)
  ,
  by = "cnty")

# #relatively less interesting contrast?
# d |> 
#   ggplot(aes(impv_reach_pct, hi_rp100_pct)) +
#   geom_point(size = 0.5, show.legend = F) + 
#   geom_text(aes(label = cnty), size = 3, check_overlap = T,
#             hjust = -0.1, vjust = 0,
#             show.legend = F) + 
#   geom_abline(intercept = 0, slope = 1) +
#     scale_x_continuous(labels = scales::label_percent()) +
#     scale_y_continuous(labels = scales::label_percent()) 


# #yet another suboptimal way to show per-county diffs
# #slope 1:1 indicates relatively consistent gain in imperv detection with greater assessed area
# #flatter slopes indicate little diff in imperv detection despite diffs in assessed area
# #but could discuss Island and Spokane? similar assessed areas but reversed detection
# #Island: RDE-HRCD sees much less increase
# #Spokane: RDE-HRCD sees much more...
# d |> 
#   filter(str_detect(cnty, "Isla|Spok"))
#   ggplot() +
#   geom_segment(aes(group = cnty, 
#                    x = reach_ha, xend = rp100_ha,
#                    y = impv_ha, yend = hi_ha),
#                color = "grey") +
#   geom_point(aes(reach_ha, impv_ha), color = "#7E4837", shape = 3, show.legend = F) +
#   geom_text(aes(reach_ha, impv_ha, label = cnty), color = "#7E4837", size = 3, show.legend = F) +
#   geom_point(aes(rp100_ha, hi_ha), color = "#483778", size = 0.9, show.legend = F) +
#   scale_x_continuous("Assessed area", labels = scales::label_comma()) +
#   scale_y_continuous("Increase, impervious or high")


d |> 
  ggplot(aes(y = fct_reorder(cnty, impv_reach_pct))) +
  geom_point(aes(impv_reach_pct, size = impv_ha), color = "#7E4837", fill = "#7E4837", shape = 17, show.legend = F) +
  geom_point(aes(hi_rp100_pct, size = hi_ha), color = "#483778", show.legend = F) +
  scale_x_continuous(labels = scales::label_percent()) +
  scale_size_area(max_size = 4) +
  labs(
    x = "Percentage of assessed riparian corridor",
    y = NULL) 

```

Reflecting the concentration of human population and existing urbanization in western Washington, the relative density of impervious increases recorded in the RDE-HRCD dataset was considerably higher in reaches associated with Chinook distribution compared to non-salmon reaches, due to a similar total change area within a much smaller total assessed area (@fig-swifd).

```{r}
#| label: fig-swifd
#| fig-cap: "A) Change in human population during the time period of RDE-HRCD estimates. B) Magnitude of impervious cover increase within reaches associated with Chinook salmon distribution. C) Statewide impervious cover increase as proportion of total assessed area relative to salmon distribution."

#as_tibble(sf_cnty_rde) |> mutate(pct = reach_ac/cnty_ac) |> pull(pct) |> summary()

pal_swifd_chin <- c("not_salmon" = "tan", "salmon_not_chin" = alpha("salmon", 0.5), "salmon_with_chin" = "salmon")

{
  sf_cnty_rde_sc |>  
    ggplot() + geom_sf(aes(fill = `2017_est_pop`-`2011_est_pop`), show.legend = T) + 
    scale_fill_gradient(low = "grey95", high = "orange", na.value = "pink", labels = scales::label_comma()) +
    labs(fill = NULL, subtitle = "2011-17 est. pop. increase")
}+{
sf_cnty_rde_sc |>  
    ggplot() + geom_sf(aes(fill = ha*impv_inc_ac_salmon_with_chin), show.legend = T) + 
scale_fill_gradient(name = "ha", low = "grey95", high = pal_d["RDE-HRCD_impv_ha"]) +
    labs(subtitle = "Impv. inc. in SWIFD Chinook")
}+{
rde_swifd_sum |> 
  filter(swifd_chin != "total") |> 
  ggplot() +
  geom_col(aes(swifd_chin, impv_reach_pct, fill = swifd_chin), show.legend = F) +
  geom_text(aes(swifd_chin, impv_reach_pct, 
                label = paste0("ha: ", round(impv_inc_ha))),
            nudge_y = -0.0001) +
  scale_fill_manual(values = pal_swifd_chin) +
  scale_y_continuous("Impv. inc. / reach area", labels = scales::label_percent()) +
    scale_x_discrete(name = NULL, guide = guide_axis(n.dodge = 2)) #"SWIFD status"
} +
  plot_layout(design = "AC\nBC") +
  plot_annotation(tag_levels = "A")

  # swifd_chin = sf_cnty_rde_sc |>
  #   ggplot() + geom_sf(aes(fill = ha*reach_ac_salmon_with_chin), show.legend = T) +
  #   scale_fill_gradient(name = "hectares", low = "grey95", high = pal_swifd_chin["salmon_with_chin"], labels = scales::label_comma()) +
  #   labs(subtitle = "RDE reaches with SWIFD Chinook")
  # ,


```

```{r rde_impv}
rde_impv <- rde_cnty |> 
  distinct(pid, .keep_all = T) |> 
  arrange(desc(nonfstry_impv_inc_ac)) |> 
  select(1:10, nonfstry_impv_inc_ac, nonfstry_semi_inc_ac) |> #1,084,186
  filter(nonfstry_impv_inc_ac > 0) |> #7437 of 1,084,186 have non-zero imp inc
  rename_with(~str_remove(., "nonfstry_")) |> 
  mutate(
    impv_inc_ha = ha*impv_inc_ac,
    cimp = cumsum(impv_inc_ha),
    rank = dense_rank(cimp), 
    cimp_pct = cimp / sum(cimp),
    n_pct = seq_along(cimp) / length(cimp),
    fld_pct = flood_ac / reach_ac,
    eow_pct = eow_ac / reach_ac,
    rmz_pct = rmz_ac / reach_ac
  )
```

The size distribution of individual changes accounting for these landscape scale patterns in the RDE-HRCD dataset was characterized by a few, larger impervious increase areas and many smaller ones. 

The median intersecting area of the `r nrow(rde_impv)` new impervious cover polygons within the RDE riparian corridor was `r round(median(rde_impv$impv_inc_ha),3)` ha or 240 m^2, considerably less than the 900 m^2^ area of a single 30m pixel. Indeed, `r 100*round(sum(rde_impv$impv_inc_ha < 0.09) / nrow(rde_impv), 3)`% (5984 of 7437) changes were below this threshold, and `r 100*round(sum(rde_impv$impv_inc_ha < 0.4) / nrow(rde_impv), 3)`% were less than 0.4ha (1 acre). This pattern was broadly consistent across portions of the state with more and less total increase. However, despite the preponderance of small changes, a substantial portion of the total change derived from a small set of large changes (@fig-impv_inc_size). For example, the 10 largest per-reach increases contributed `r round(filter(rde_impv, rank == 10)$cimp, 1)` ha of the `r round(max(rde_impv$cimp), 1)` total (i.e., `r 100*round(filter(rde_impv, rank == 10)$cimp / max(rde_impv$cimp), 3)`% of new impervious area came from this 0.134% of reaches). In addition, the floodplain zone composed a greater proportion of the full reach area in many of these largest individual increases (@fig-impv_inc_size C). 

```{r rde_impv}
#| label: fig-impv_inc_size
#| fig-cap: "A) Size distribution of individual per-reach increases in impervious cover (n = 7437, not showing 145 greater than 1 hectare). B) Cumulative increase by per-reach rank. C) Magnitude of impervious increase relative to the proportion of the floodplain type in the assessed reach area."

# rde_impv |>
#   ggplot() +
#   #geom_density(aes(impv_inc_ha))
#   stat_ecdf(aes(impv_inc_ha))

{
  rde_impv |>
    #filter(impv_inc_ha > 1) |> nrow()
    filter(impv_inc_ha <= 1) |> 
    ggplot(aes(impv_inc_ha, 0)) +
    geom_jitter(aes(alpha = impv_inc_ha), height = 0.3, shape = 18, color = pal_d[1], show.legend = F) +
    geom_boxplot(fill = NA, varwidth = T, outliers = F) +
    geom_vline(xintercept = 0.09, linetype = 2, color ="blue") +
    annotate("text", x = 0.5, y = -0.35, label = "Not showing 145 increases >1 ha") +
    labs(y = "Per-reach increases", x = "ha") +
    theme(axis.text.y = element_blank())
}/{
rde_impv |>
  ggplot() +
  geom_hline(aes(yintercept = max(cimp)/2), linetype = 3) +
  geom_text(data = tibble(rank = 500, cimp = 460, txt = "163 largest per-reach increases\nproduced half the total increase"),
            aes(rank, cimp, label = txt), hjust = 0, vjust = 1) + #filter(rde_impv, between(cimp,473,474))
  geom_point(aes(rank, cimp, color = cimp < max(cimp)/2), size = 0.3, show.legend = F) +
  scale_color_manual(values = c("cyan","orange")) +
  labs(x = "Rank, per-reach increase", y = "Cumulative increase (ha)")
}/{
rde_impv |>
  filter(impv_inc_ha > 0.1) |> 
  ggplot(aes(fld_pct, impv_inc_ha)) +
  #geom_bin2d()
  #geom_text(aes(label = rank)) +
  geom_point(shape = 18, alpha = 0.6, color = pal_d[1]) + #aes(color = rank), 
  #scale_color_gradient(low = pal_d[1], high = alpha(pal_d[1], 0.3))
  labs(x = "Reach proportion floodplain", y = "Per-reach impv. increase")
}+
  plot_layout(heights = c(1/3,1/3,1/3)) + 
  plot_annotation( tag_levels = "A")

```


# Discussion

Cumulative assessments of land cover change are crucial to understanding the effects of land use policies, and this 
statewide analysis showed increased impervious cover within the ecohydrologically sensitive riparian corridors of watersheds. These results highlight the ongoing risk of cover change and the importance of continued attention to regulatory implementation where preservation of ecological function and services is a policy goal (Riparian Taskforce 2024). Just as the hardening of circulatory and connective tissues harms individual health, recovering watershed health where imperviousness has become prevalent will require halting and reversing the analogous progression of "hydrosclerosis".

This analysis illustrates key challenges that complicate assessments: defining the spatial boundaries of evaluation and detecting differences within these bounds. The evaluation extent problem involves both the choice of a hydrographic representation and the width to extend laterally in the definition of riparian management zones. 

The depicted resolution of the drainage network on which buffers are constructed exerts a primary influence on outcomes. What is seen as a "water" controls what is understood to adjoin waters. The RDE-HRCD and StreamCat-NLCD estimates presented here both derive from hydrography (NHD and NHDPlus) that is missing extensive lengths of the smaller, sometimes intermittent or ephemeral channels that contribute significantly to water quantity and quality (Brinkerhoff et al 2024). This increases the likelihood of under-estimating the overall functional impacts on aquatic ecosystems of land use changes. In the United States, the accuracy and comprehensiveness of flowlines and other features at the inner edge of RMZs promises to improve greatly as the USGS 3DHP initiative transitions to hydrography generated from LiDAR elevation data. Moreover, the derivation of linear features that are inherently integrated with a high-resolution representation of the surrounding channel migration zone and valley forms creates opportunities to refine and enhance vegetation-based delineation with information on geomorphic constraints.

Despite considerable research and debate, the question of "how wide" to make buffers has resisted answers other than "it depends", with the relevant factors including a combination of local biophysical conditions (subject to observation and measurement) and sociocultural values subject to dialogue and power relations (Wilhere and Quinn 2018, Chapman et al. 2020). The assessed corridors in this analysis do not represent any specific authority and, in many locations, extend beyond the riparian management zones subject to the strongest protections at the time. Accordingly, the new impervious cover shown in these results does not necessarily represent a widespread failure of the operative regulatory regime during the 2010s. However, these results do raise the question of how much of the additional impact would have been avoided, minimized, or mitigated had the jurisdictional extent corresponded to the assessed corridor. 

Moreover, "upland" imperviousness outside of any corridor up to or beyond 100m contributes some additional impact on riparian and in-channel conditions. A 30m buffer is unlikely to have the same functional effect within a primarily forested catchment as it does when adjacent to land converted to industrial, residential, or agricultural uses. In conjunction with site-specific slopes and soils factors, the surrounding watershed context of empirical studies of riparian function-width relationships has inevitably shaped our understanding of buffer dimensions and configurations. The applicability of width-function decay curves likely warrants review as increasing upland imperviousness continues to alter flow paths away from saturation-excess and towards infiltration-excess dynamics. 

Regardless, this evidence of new impervious cover underscores the importance of the geographic scope of jurisdiction, even as the regulatory dimensions that define RMZs remain inconsistent, with a range of values stipulated in state laws and local critical area ordinances (Folkerts et al. 2020). This legal variation is compounded by heterogeneity in the realized on-the-ground conditions within any particular management domain (Swartz et al 2024). Within Washington, adoption of the 200-year Site Potential Tree Height standard in WDFW guidance is not compulsory, but it defines a science-based, consistent minimum footprint for riparian habitat conservation areas more likely to reduce ecological losses. Nonetheless, while the SPTH~200~ standard avoids prescribing a single critical area dimension, the necessary widths may be greater where upland surface alteration or other valley attributes have already impaired desired functions.

Beyond the definition of the corridor itself, further uncertainty in landscape scale assessment is also associated with the data used to determine changes, in this case, the residual error persisting in the high resolution change polygons and the land cover classifications. Given these uncertainties and the other methodological differences in the underlying datasets, it is perhaps somewhat surprising that the RDE-HRCD and StreamCat-NLCD approaches converge on an estimate of new impervious cover in the hundreds of hectares a year. This value raises questions about whether a project-specific "no net loss" standard can possibly have preserved function at a cumulative scale. If hundreds of acres of impervious cover are not being removed each year, what actions are being taken to offset the functional consequences of those that continue to be added? Moving forward, such questions are likely only adequately addressed through the expanded use and further refinement of high resolution data (i.e., 1m or less). Notwithstanding the similarity in statewide aggregate values, the 30m land cover data was unsuited to characterizing site-scale patterns, lacking the ability to capture the many areas of new impervious cover smaller than a single pixel. However, a high resolution baseline cover dataset does not exist at the large extent and for the longer temporal duration of the coarser spatial data, hindering stratification of changes by the "before" condition of land that became impervious. Future retrospective studies might explore the potential for data assimilation methods to downscale and re-classify older imagery from models trained on later high-resolution sources, while subsequent assessments may better distinguish among types of pre-impervious vegetation by incorporating newly available datasets that record the period after that examined here.

This comparison indicates general patterns in the configuration of land cover conversion, with various anthropogenic changes such as roads, warehouses, and other commercial spaces combined with those due to residential construction. Future extensions of high-resolution datasets could better disentangle impervious increases related to different activities, thereby clarifying how comparable amounts of population and housing growth may impose smaller or larger demands on riparian habitat conditions (Lambert et al. 2025). 


# Conclusion

Washington state is a leader in land and water stewardship, striving to encourage vibrant human communities without compromising the natural systems that make them possible. Yet at a statewide scale during the 2010s, a period following the passage of laws to guide land use towards less damaging practices, high resolution data indicate that hundreds of hectares of new impervious surface were added each year within sensitive riparian corridors. Attention to this ongoing change will be critical to continued progress towards salmon recovery and other valued aspects of ecological integrity.

# Acknowledgements

# Citations

Chapman, M., Satterfield, T., & Chan, K. M. A. 2020. How value conflicts infected the science
of riparian restoration for endangered salmon habitat in America’s Pacific Northwest:
Lessons for the application of conservation science to policy. Biological Conservation,
244, 108508. https://doi.org/10.1016/j.biocon.2020.108508

Fausch, K.D., Torgersen, C.E., Baxter, C.V. and Li, H.W., 2002. Landscapes to riverscapes: bridging the gap between research and conservation of stream fishes: a continuous view of the river is needed to understand how processes interacting among scales set the context for stream fishes and their habitat. BioScience, 52(6), pp.483-498.

Hill, Ryan A., Marc H. Weber, Scott G. Leibowitz, Anthony R. Olsen, and Darren J. Thornbrugh, 2016. The Stream-Catchment (StreamCat) Dataset: A Database of Watershed Metrics for the Conterminous United States. Journal of the American Water Resources Association (JAWRA) 52:120-128. DOI: 10.1111/1752-1688.12372.

Knutson, K. L., and Naef, V. L. 1997. Management recommendations for Washington’s priority
habitats: Riparian (p. 181pp.). Washington Department of Fish and Wildlife. https://wdfw.wa.gov/sites/default/files/publications/00029/wdfw00029.pdf

Lazarus, D., 2023. Current Status of Riparian Buffers in Washington State: Public and Private Land Cover Within Riparian Management Zones Based on Best Practice Guidelines (MES thesis, Evergreen State College).

Maxwell, A. E., T. A. Warner, B. C. Vanderbilt, and C. A. Ramezan. 2017. Land cover classification and feature extraction from National Agriculture Imagery Program (NAIP) Orthoimagery: a review. Photogrammetric Engineering & Remote Sensing 83:737–747.

Pierce Jr, K.B., 2015. Accuracy optimization for high resolution object-based change detection: An example mapping regional urbanization with 1-m aerial imagery. Remote Sensing, 7(10), pp.12654-12679.

Quinn, T., G.F. Wilhere, and K.L. Krueger, technical editors. 2020. Riparian Ecosystems, Volume 1: Science Synthesis
and Management Implications. Habitat Program, Washington Department of Fish and Wildlife, Olympia. https://wdfw.wa.gov/publications/01987

Rentz, R., A. Windrope, K. Folkerts, and J. Azerrad. 2020. Riparian Ecosystems, Volume 2: Management Recommendations.
Habitat Program, Washington Department of Fish and Wildlife, Olympia. https://wdfw.wa.gov/publications/01988

Riparian Taskforce. 2024. Final Report and Recommendations. Prepared by Plauché & Carr LLP.
https://ofm.wa.gov/sites/default/files/public/publications/Riparian%20Taskforce%20Final%20Report%20and%20Recommendations.pdf

WDFW. 2024. A new way of looking at Washington’s waterways. Medium. https://wdfw.medium.com/a-new-way-of-looking-at-washingtons-waterways-ad05d872c4ce 

Weber M (2025). _StreamCatTools: Tools to Work with the StreamCat API Within R and Access the Full Suite of StreamCat and LakeCat Metrics_. R package version 0.6.0, commit d8a8cce142e7cb9e3666a2660a8315a1766e5981, <https://github.com/USEPA/StreamCatTools>.

Wilhere G and Quinn T. 2018. How Wide is Wide Enough?: Science, Values, and Law in Riparian Habitat Conservation, 58 Nat. Resources J.279, https://digitalrepository.unm.edu/nrj/vol58/iss2/13/

# Supplementary info

```{r gg_rde_cnty_sum_reach_pct_cnty}
{
sf_cnty_rde_sc |> 
  mutate(pct = reach_ac/cnty_ac) |> 
  ggplot() + 
  geom_sf(aes(fill = pct)) +
  scale_fill_gradient(name = "reach / cnty", low = grey(0.8), high = grey(0.2))
}/{
as_tibble(sf_cnty_rde_sc) |> 
  mutate(pct = reach_ac/cnty_ac) |> 
  ggplot() + 
  geom_col(aes(pct, fct_reorder(cnty, pct, identity), fill = pct)) +
    scale_fill_gradient(name = "reach / cnty", low = grey(0.8), high = grey(0.2)) +
  scale_x_continuous("Proportion of county area", labels = scales::label_percent()) +
  labs(y = NULL)
} +
  plot_annotation("Assessed reach area as proportion of county boundary extent")
```

```{r gg_impv_vs_tree_dec}

rde_cnty_sum |> #glimpse()
  #ggplot(aes(tree_dec_ac_pct_rch, impv_inc_ac_pct_rch)) +
  ggplot(aes(impv_inc_ac_pct_rch, tree_dec_ac_pct_rch)) +
  geom_point() +
  geom_text(aes(label = cnty))

# rde_cnty |> 
#   drop_na(nonfstry_impv_inc_ac) |> 
#   distinct(pid, .keep_all = T) |>
#   filter(nonfstry_tree_dec_ac + nonfstry_impv_inc_ac > 0) |> 
#   filter(nonfstry_tree_dec_ac + nonfstry_impv_inc_ac < 2) |> 
#   ggplot(aes(nonfstry_tree_dec_ac, nonfstry_impv_inc_ac)) +
#   geom_abline(linetype = 3) +
#   #geom_point(size = 0.1, alpha = 0.3)
#   #geom_hex()
#   geom_bin2d()

```

```{r gg_rde_cnty_per_reach_imp_inc_pct_reach_ac}
#could also show as pct = nonfstry_impv_inc_ac / reach_ac
rde_cnty |> 
  filter(nonfstry_impv_inc_ac > 0) |> #7541
  ggplot(aes(
    nonfstry_impv_inc_ac / reach_ac,
    fct_reorder(cnty, nonfstry_impv_inc_ac, sum)
    )) +
  geom_jitter(height = 0.2, alpha = 0.5, size = 0.4) +
  geom_boxplot(varwidth = T, outliers = F, color = "orange", fill = NA) + 
  scale_x_continuous(labels = scales::label_percent()) +
  labs(y = NULL, x = NULL,
       title = "Per-reach impervious cover increases as percentage of reach area",
       subtitle = "Reach acres = RMZ plus EOW and floodplain where present"
       )
```

## pop/housing

Population increases during 2011-2017 were positively correlated with the normalized impervious increase in the riparian corridor, but considerable variation was evident among county-boundary aggregates. For example, the King and Clark areas had population gains greater than that within the Pierce boundary, but smaller proportional impervious increases. Conversely, the Kitsap extent had the fourth largest normalized impervious increase despite less population growth than many other areas (@fig-impv_inc_pop_change). A comparable pattern was evident for changes in housing units, with substantial variation around a generally positive correlation (@fig-impv_inc_housing_change). The King and Island county extents were notable for the, respectively, large and small housing gains relative to proportional riparian corridor impervious additions. 

```{r}
#| label: fig-impv_inc_pop_change

# rde_cnty_sum |>
#   ggplot(aes(impv_inc_ac_pct_rch, log10(d_est_pop))) +
#   geom_point(aes(size = `2011_est_pop`, color = `2011_est_pop`)) +
#   geom_text(aes(label = cnty), hjust = 1.1, size = 3, check_overlap = T) +
#   scale_size_area(max_size = 4, guide = "none") +
#   scale_color_gradient(name = "2011 est. pop. x1000", low = alpha("orange", 0.6), high = "brown", labels = scales::label_number(scale = 1/1000)) +
#   scale_y_continuous(name = "log10 population change 2011-2017", labels = scales::label_log(digits = 1)) +
#   scale_x_continuous(name = "Percentage of assessed riparian corridor", labels = scales::label_percent()) +
#   theme(
#     legend.position = "bottom", legend.key.width = unit(0.1, "npc")
#   )

rde_cnty_sum |> 
  #ggplot(aes(d_est_pop/`2011_est_pop`, impv_inc_ac_pct_rch)) +
  # scale_x_continuous(name = "population change 2011-2017", labels = scales::label_percent()) +
  # scale_y_continuous(name = "Percentage of assessed riparian corridor", labels = scales::label_percent())
  ggplot(aes(impv_inc_ac_pct_rch, d_est_pop/`2011_est_pop`)) +
  geom_point(aes(size = `2011_est_pop`, color = `2011_est_pop`)) +
  geom_text(aes(label = cnty), hjust = -0.1, size = 3, check_overlap = T) +
  scale_size_area(max_size = 4, guide = "none") +
  scale_color_gradient(
    name = "2011 est. pop. x1000",
    low = alpha("orange", 0.6), high = "brown", labels = scales::label_number(scale = 1/1000)) +
  scale_y_continuous(name = "Population change 2011-2017", labels = scales::label_percent()) +
  scale_x_continuous(name = "Percentage of assessed riparian corridor", labels = scales::label_percent()) +
  coord_cartesian(xlim = c(-0.0001, 0.002), ylim = c(-0.01, .13), expand = F) +
  theme(
    legend.position = "bottom", legend.key.width = unit(0.1, "npc")
  )
  
```

```{r}
#| label: fig-impv_inc_housing_change

rde_cnty_sum |>
  # select(cnty, impv_inc_ac_pct_rch, d_total, d_single, d_multi) |> 
  # pivot_longer(starts_with("d_")) |> 
  # ggplot(aes(impv_inc_ac_pct_rch, value, color = name)) +
  # facet_wrap(~name, ncol = 1, scales = "free")
  ggplot(aes(impv_inc_ac_pct_rch, d_total)) +
  geom_point(color = "purple", size = 0.8) + # aes(size = `2011_total`)
  geom_text(aes(label = cnty), hjust = 1.1, size = 3, check_overlap = T) +
  scale_x_continuous(name = "Percentage of assessed riparian corridor", labels = scales::label_percent()) +
  scale_y_continuous(name = "Change in total housing units", labels = scales::label_comma()) 

```

```{r gg_rde_cnty_housing_stacked_cols}
rde_cnty_sum |>
  mutate(cnty = factor(cnty) |> fct_reorder(`2011_total`)) |>
  select(cnty, `2011_single`, `2011_multi`, `2011_other`) |>
  pivot_longer(-cnty) |>
  ggplot() + geom_col(aes(value, cnty, fill = name)) +
  scale_x_continuous(labels = scales::label_comma()) +
  scale_fill_manual(name = "Housing", values = c("brown","yellow","tan")) +
  labs(x = NULL, y = NULL, title = "2011 housing composition")
```

```{r gg_impv_vs_pop}
#really potentially misleading?
rde_cnty_sum |> 
  mutate(
    pct_impv = impv_inc_ac / sum(impv_inc_ac),
    pct_pop = d_est_pop / sum(d_est_pop)
  ) |> 
  ggplot(aes(pct_pop, pct_impv)) +
  geom_abline() +
  geom_point() +
  geom_text(aes(label = cnty)) +
  labs(title = "Statewide proportion impv vs pop")
```


::: {.content-hidden when-format="html" when-format="docx"}

Summarizing changes within county boundary extents did not generate replicates, and the idiosyncrasies of multiple authorities, varying hydrographic error, and distinct socio-ecological histories warrant longitudinal statistical approaches that are not viable with a single time period.

Lazarus (2023) considered a statewide extent, using the National Land Cover Dataset (NLCD) and Cropland Data Layer (CDL) to examine the relative prevalence of vegetation and impervious cover classes within alternative riparian buffer configurations on lands stratified by public and private ownership. This analysis sought to address a holistic set of shifts among multiple land uses across Washington's varied ecoregions, but an increase in impervious-type classes was broadly apparent, estimated to total more than 4,500 ha (>11,000 acres) in the SPTH~200~ buffer between 2001 and 2019 (see table 16, as the combination of all 4 NLCD 'developed' classes).  


  - Fish and Wildlife Habitat Conservation Areas (FWHCA)
  - more on SWIFD/Chinook?
  - Stormwater, 6PPDQ (coho)
  - Among other legal and economic shifts, this period follows the initial passage of the GMA in 1990 and the federal endangered species listings of several salmon populations during the 1990s, and it offers a perspective on the outcomes of recent practices with relevance to ongoing land use policy debates.


Hepinstall-Cymerman, J., S. Coe, and L.R. Hutyra. 2013. Urban growth patterns and growth management boundaries in the central Puget Sound, Washington, 1986–2007. Urban Ecosystems 16:109–129.

[UW MS thesis]
Nayak (2023) focused on the Cedar River-Lake Washington watershed, reporting a measurable increase in impervious surface area within 54 identified riparian zones, noting that 21st-century growth is more nuanced due to zoning policies, yet significant enough to influence water quality and hydrology.

Nayak, S., 2023. Impact of Riparian Landscape Patterns on Water Quality in an Urbanizing River Basin: A Case of Cedar River-Lake Washington Watershed. Master's thesis. University of Washington. Available at: https://digital.lib.washington.edu/researchworks/bitstream/handle/1773/49961/Nayak_washington_0250O_23832.pdf?sequence=1 [Accessed 4 August 2025].


Maxwell, A.E., Strager, M.P., Warner, T.A., Ramezan, C.A., Morgan, A.N. and Pauley, C.E., 2019. Large-area, high spatial resolution land cover mapping using random forests, GEOBIA, and NAIP orthophotography: Findings and recommendations. Remote Sensing, 11(12), p.1409.
https://www.mdpi.com/2072-4292/11/12/1409

Zhang, H., Gorelick, S.M. and Zimba, P.V., 2020. Extracting impervious surface from aerial imagery using semi-automatic sampling and spectral stability. Remote Sensing, 12(3), p.506.
https://www.mdpi.com/2072-4292/12/3/506

Subedi, M.R., Portillo-Quintero, C., Kahl, S.S., McIntyre, N.E., Cox, R.D. and Perry, G., 2023. Leveraging NAIP imagery for accurate large-area land use/land cover mapping: A case study in central Texas. Photogrammetric Engineering & Remote Sensing, 89(9), pp.547-560.
https://www.ingentaconnect.com/contentone/asprs/pers/2023/00000089/00000009/art00007?crawler=true&mimetype=application/pdf

:::
