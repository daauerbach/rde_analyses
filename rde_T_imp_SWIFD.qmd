---
title: "Riparian Data Engine: stream temperature impairment & salmon distribution"
author: "dan.auerbach@dfw.wa.gov"
date: "`r Sys.Date()`"
format:
  html:
    embed-resources: true
    theme: yeti 
    code-fold: true
    toc: true
    toc-location: left
    grid:
      sidebar-width: 180px
      body-width: 1100px
      margin-width: 20px
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 8)

library("tidyverse", quietly = T)
library("sf")
library("patchwork")
library("gt")
theme_set(theme_minimal()) 

dir_data_common <- "~/T/DFW-Team WDFW Watershed Synthesis - data_common"
epsg <- 2927 #WA state standard; NAD83(HARN)/ft

#sort(unique(rde$t_imp_f))
pal_t_imp_f <- c("1" = "darkgreen", "2" = "orange", "3" = "yellow", "4|5" = "#965127", "NA" = "grey") 
pal_swifd_chin <- c("not_salmon" = NA, "salmon_not_chin" = "tan", "salmon_with_chin" = "salmon")

```

The [Riparian Data Engine (RDE)](https://ripariandata.wdfw.wa.gov/), developed by WDFW with support from ESA, is a geospatial web application that "unites WDFW riparian datasets in Washington State...allow[ing] planners to evaluate the conditions of riparian ecosystems and make data-informed planning decisions".

Following publication of the Volume 1 Science Synthesis [(Quinn et al. 2020)](https://wdfw.wa.gov/publications/01987) and Volume 2 Management Recommendations [(Rentz et al. 2020)](https://wdfw.wa.gov/publications/01988), the agency has developed several technical tools to support implementation (see https://wdfw.wa.gov/species-habitats/ecosystems/riparian).

The RDE enables interactive exploration of various landscape attributes associated with riparian management zone (RMZ) polygons that were consistently generated according to the [Site Potential Tree Height standard](https://wdfw.wa.gov/publications/02564) using publicly available GIS data.

This analysis illustrates an application of these data to a primary motivating question: *How does riparian tree canopy within portions of the riverscape occupied by salmon relate to stream temperature assessments recorded in the [303(d) list](https://ecology.wa.gov/water-shorelines/water-quality/water-improvement/assessment-of-state-waters-303d) under Clean Water Act (CWA) Water Quality Standards (WQS)?*

Interactive users of the RDE can examine a "reach table" consisting of columns of various land cover, jurisdictional, and hydrographic attributes for rows corresponding to individual RMZ units in the polygon tessellation with which attribute values were calculated. Various filters and map-based exploration allow formulation of queries that subset these rows and enable comparison of summarized attribute values. For example, a filter for tree canopy cover greater than 50% can be used to examine the number and location of such RMZs within a Water Resource Inventory Area (WRIA) or a county. In addition, a powerful feature provided by the RDE is the display of a single reach relative to its upstream and downstream network "neighborhoods" and the attributes of those areas. This "local view" is well suited to understanding how conditions in a particular location compare to adjacent portions of the riverscape with hydrologic, geomorphic and ecological connections. Such information can help to inform a range of conservation management decisions at the site scale.

This analysis broadens to a regional scale, quantifying patterns per-WRIA, based on the full set of complete-WRIA reach tables, accessed via an API.

# Data

```{r sf_wrias, include=FALSE, eval=FALSE}
sf_wrias <- sf::read_sf(file.path(dir_data_common, "WR_WAT_WRIA.gdb/")) |>
  mutate(wria = paste0(str_pad(WRIA_NR,width = 2, pad = "0",),"_",WRIA_NM) |> factor()) |>
  select(WRIA_NR, WRIA_NM, wria, acres = WRIA_AREA_ACR_QT) |> arrange(wria) |> 
  sf::st_transform(sf::st_crs(epsg))
```

```{r build_rde_wria_library, include=FALSE, eval=FALSE}
# created 4/23/25 after API first exposed
# see rde_wrias_init.qmd for scraping calls, not yet rerun to check any issues from baseurl changes

# https://api-riparis.esa-prod.sitkatech.com/docs/index.html 
# Reaches for a County: https://api-riparis.esa-prod.sitkatech.com/counties/{countyName}/reaches/csv
# Reaches for a WRIA: https://api-riparis.esa-prod.sitkatech.com/wrias/{wriaID}/reaches/csv
# Reach table contents for a Reach: https://api-riparis.esa-prod.sitkatech.com/reaches/{permanentIdentifier}/ csv

# rch_tbl <- map_df(1:62, ~readr::read_csv(
#   file.path(dir_data_common, paste0("rde/wrias/rde_wria_",stringr::str_pad(.x, 2, pad = "0"), ".csv"))
# ) |> 
#   mutate(pid = as.character(PermanentIdentifier), PermanentIdentifier = NULL)
# ) |> 
#   rename(wria = WaterResourceInventoryAreaID) |> 
#   rename_with(~str_replace(.,"Acres","_ac")) |> 
#   janitor::clean_names() |> 
#   select(pid, everything(), -reach_id)
# 
# saveRDS(rch_tbl, "~/T/DFW-Team WDFW Watershed Synthesis - data_common/rde/wria_rch_tlb.rds")
```

A complete set of reach tables includes values for >1mil rows statewide, indexed by `pid` (permanent identifiers). In this structure, a `pid`-row can include a combination of "extent of observed water" (EOW), "floodplain" (primarily based on FEMA mapping), and riparian management zone (RMZ, both banks where double-banked) geometry. However, the results presented here are based on the area (acreage) associated with the RMZ and EOW "riparian corridor".

```{r rde}
rde <- readRDS("~/T/DFW-Team WDFW Watershed Synthesis - data_common/rde/wria_rch_tlb.rds") |> 
  mutate(
    wria = factor(wria)
    ,
    swifd_any = !is.na(swifd_salmon_distribution),
    swifd_n = 1 + str_count(swifd_salmon_distribution,","),
    swifd_n_fct = case_when(
      is.na(swifd_n) ~ "none",
      swifd_n < 3 ~ "1-2 species",
      swifd_n >= 3 ~ "3 or more species"
    )
    ,
    # #1:meets WQS, 2:some concerns about some uses, 3:insuf data, 4:impair-no-TMDL, 5:TMDL
    ## NOTE - the status "Not Impaired" in this version of the csvs is not accurate
    ## as of 6/6/25 ver 0.0.1 the production reach table is (more accurately) "Not Assessed"
    ## this may have been corrected in prod API but need to check with Ray
    ## here manually overwriting
    t_imp = temperature_impairments |> str_replace("Impaired", "Assessed") |> factor()
    , 
    tree_pct = all_tree_cover_ac / all_land_cover_ac,
    veg_pct = all_vegetated_ac / all_land_cover_ac
  )

# #corresponds to nrow of reach table in ver 0.0.1 with EOW and Floodplain in Zone filter unchecked
# rde |> filter(wria==1, rmz_ac!=0)
# #but is NOT the same as 
# rde |> filter(wria==1, eow_ac==0, flood_ac==0)
# #which are PIDs with _only_ RMZ
# #no way in this table structure, without a 'zone' attribute', to differentiate RMZ-EOW-Floodplain...

```

Individual tessellation units can span different assessed stream temperature status, resulting in some `pid` with multiple categories. The number and extent of these are both small, but those that involve conflicts are excluded ("1, 5"), while combinations that include "category 3" (insufficient data) are re-coded as 3 and those that include impairment are aggregated.

```{r rde_t_imp_f}
rde <- rde |>
  filter(t_imp != "1, 5") |> 
  mutate(
    t_imp_f = case_when(
      t_imp == "1, 5" ~ NA_character_,
      str_detect(t_imp, "3") ~ "3",
      str_detect(t_imp, "4|5") ~ "4|5", #bundles 2-4, 2-5, 4-5, 4A, 4B, 5
      str_detect(t_imp, "Not") ~ "NA",
      .default = t_imp
    )
  )
```

```{r gt_rde_t_imp_f}
rde |>
  summarise(
    pid_n = n(),
    across(c(riparian_ac, rmz_ac, eow_ac), list(sum = ~sum(., na.rm = T))),
    .by = c(t_imp_f, t_imp)
  ) |> 
  mutate(pid_pct = round(pid_n / sum(pid_n), 3)) |> 
  arrange(t_imp_f) |> 
  select(`analysis category` = t_imp_f, `303d category` = t_imp, starts_with("pid"), ends_with("sum")) |> 
  gt() |> 
  fmt_percent(pid_pct, decimals = 1) |> 
  fmt_number(ends_with("sum"), decimals = 0)

```

The Statewide Integrated Fish Distribution (SWIFD) data characterize the documented and presumed presence of several salmonid species. For an initial examination, the `pid` units can be stratified according to whether Chinook are included in the set of species present in SWIFD for the location. As expected, the total areas of riparian and open water extent are greater for reaches designated by SWIFD as Chinook-occupied, despite the smaller total number of these (larger) river network units. 

```{r rde_swifd_chin}
rde <- rde |>
  mutate(
    swifd_chin = case_when(
      str_detect(swifd_salmon_distribution, "Chin") ~ "salmon_with_chin",
      str_detect(swifd_salmon_distribution, "Chin", negate = T) ~ "salmon_not_chin",
      is.na(swifd_salmon_distribution) ~ "not_salmon"
    )
  )
```

```{r gt_rde_swifd_chin}
rde |> 
  summarise(
    pid_n = n(),
    across(c(riparian_ac, rmz_ac, eow_ac), list(sum = ~sum(., na.rm = T))),
    .by = c(swifd_chin)
  ) |> 
  mutate(pid_pct = round(pid_n / sum(pid_n), 3)) |> 
  arrange(swifd_chin) |> 
  select(swifd_chin, starts_with("pid"), ends_with("sum")) |> 
  gt() |> 
  fmt_percent(pid_pct, decimals = 1) |> 
  fmt_number(ends_with("sum"), decimals = 0)
```

Summarizing the acreage and average tree canopy cover within the RMZ corridor within these strata yields values for comparison.

```{r rde_smry}
rde_smry <- rde |> 
  summarise(
    across(c(riparian_ac, rmz_ac), list(sum = ~sum(., na.rm = T))),
    across(
      #add canopy_pattern_metric?
      tree_pct, #ends_with("_pct"),
      list(
        mean = ~mean(., na.rm = T),
        sd = ~sd(., na.rm = T)
        )
      )
    ,
    .by = c(swifd_chin, t_imp_f)
  ) |> 
  mutate(riparian_ac_pct_temp_in_swifd = riparian_ac_sum / sum(riparian_ac_sum), .by = c(swifd_chin)) |> 
  mutate(riparian_ac_pct_swifd_in_temp = riparian_ac_sum / sum(riparian_ac_sum), .by = c(t_imp_f)) |> 
  arrange(swifd_chin, t_imp_f)
```

```{r rde_smry_wria}
rde_smry_wria <- rde |> 
  summarise(
    across(c(riparian_ac, rmz_ac), list(sum = ~sum(., na.rm = T))),
    across(
      #add canopy_pattern_metric?
      tree_pct, #ends_with("_pct"),
      list(
        mean = ~mean(., na.rm = T),
        sd = ~sd(., na.rm = T)
        )
      )
    ,
    .by = c(wria, swifd_chin, t_imp_f)
  ) |> 
  mutate(riparian_ac_pct_temp_in_swifd = riparian_ac_sum / sum(riparian_ac_sum), .by = c(wria, swifd_chin)) |> 
  mutate(riparian_ac_pct_swifd_in_temp = riparian_ac_sum / sum(riparian_ac_sum), .by = c(wria, t_imp_f)) |> 
  arrange(wria, swifd_chin, t_imp_f)
```


# Visualizations

## Statewide 

Ecoregional differences between Eastern and Western Washington riverscapes are apparent in the RDE data, but it may be informative to examine patterns at the statewide scale before distinguishing WRIAs further.

The plot below illustrates the total acreages within 303(d) temperature impairment and SWIFD salmon occupancy categories. Panels in the left column show all categories, including "not assessed" (grey) and "insufficent data" (yellow), on a log10 scale, while the right column focuses on 303(d) categories of interest with an untransformed scale. 

Unassessed area outside of salmon distribution forms a *substantial* majority of the total riparian acreage considered in the RDE dataset. This follows from the tension between the limited resources for water quality assessment and the dendritic structure of river networks in which many individually small tributaries have cumulatively large contributing extents.

Focusing on assessed areas, the total riparian acreage of designated water temperature impairments ("4|5", brown) or concerns ("2", orange) exceeds that of "not impaired" ("1", green) for each of the salmon distribution types. More notably, however, the proportion meeting thermal water quality standards drops from 11.7% in reaches outside of SWIFD to 5% in those to associated with salmon other than Chinook to only 1.7% in reaches within the SWIFD Chinook distribution extent.

```{r gg_abs_area, fig.width=9, fig.height=7}
wrap_table(
  rde_smry |> 
    arrange(swifd_chin, desc(t_imp_f)) |> 
    select(swifd_chin, `303(d)` = t_imp_f, riparian_ac_sum) |> 
    gt(groupname_col = "swifd_chin") |> 
    fmt_number("riparian_ac_sum", decimals = 0) |> 
    tab_style_body(values = "NA", targets = "row", style = cell_fill(pal_t_imp_f["NA"], alpha = 0.5)) |> 
    tab_style_body(values = "4|5", targets = "row", style = cell_fill(pal_t_imp_f["4|5"], alpha = 0.5)) |> 
    tab_style_body(values = "3", targets = "row", style = cell_fill(pal_t_imp_f["3"], alpha = 0.5)) |> 
    tab_style_body(values = "2", targets = "row", style = cell_fill(pal_t_imp_f["2"], alpha = 0.5)) |> 
    tab_style_body(values = "1", targets = "row", style = cell_fill(pal_t_imp_f["1"], alpha = 0.5))
  ,panel = "full"
)+{
rde_smry |> 
  ggplot() +
  geom_col(aes(riparian_ac_sum, t_imp_f, fill = t_imp_f), show.legend = F) +
  scale_x_log10(labels = scales::label_log()) +
  scale_fill_manual(values = pal_t_imp_f) +
  facet_wrap(~swifd_chin, ncol = 1) +
  labs(x = "Total riparian area, log10(acres)", y = "303d category")
}+{
rde_smry |> 
  filter(t_imp_f != "NA", t_imp_f != "3") |> 
  ggplot() +
  geom_col(aes(riparian_ac_sum, t_imp_f, fill = t_imp_f), show.legend = F) +
  scale_x_continuous(labels = scales::label_comma()) +
  scale_fill_manual(values = pal_t_imp_f) +
  facet_wrap(~swifd_chin, ncol = 1) +
  labs(x = "Total riparian area, acres", y = "303d category"
       # , subtitle = "Excluding 'non-assessed' & inadeq. data"
       )
}+
  plot_layout(widths = c(4,5,4))

```

```{r gt_pct_meeting}
rde_smry |> 
  filter(t_imp_f != "NA", t_imp_f != "3") |> 
  mutate(t_imp_f_245 = if_else(t_imp_f != "1","impaired|concern","meeting_standard")) |> 
  summarise(
    riparian_ac_sum = sum(riparian_ac_sum),
    #riparian_ac_pct_temp_in_swifd = sum(riparian_ac_pct_temp_in_swifd),
    .by = c(swifd_chin, t_imp_f_245)
  ) |> 
  pivot_wider(names_from = t_imp_f_245, values_from = riparian_ac_sum) |> 
  mutate(pct_meeting = meeting_standard / (meeting_standard + `impaired|concern`)) |> 
  gt() |> 
  fmt_number(columns = c("meeting_standard","impaired|concern"), decimals = 0) |> 
  fmt_percent(starts_with("pct_meeting"))

```

## WRIAs 1-25 (Western WA)

### Total area by SWIFD & 303d types

```{r gg_pct_meeting_wria, include=F, eval=F}
# rde_smry_wria |> 
#   filter(as.integer(as.character(wria)) < 26, swifd_chin == "salmon_with_chin") |> 
#   ggplot() +
#   geom_col(aes(wria, riparian_ac_pct_temp_in_swifd, fill = t_imp_f)) +
#   scale_fill_manual(name = "303(d)", values = pal_t_imp_f) +
#   theme(
#     legend.position = "top"
#   )

gg_pct_meeting_wria <- function(swifd_cat){
  rde_smry_wria |> 
    filter(
      as.integer(as.character(wria)) < 26,
      swifd_chin == swifd_cat,
      t_imp_f != "NA", t_imp_f != "3"
    ) |> 
    mutate(t_imp_f_245 = if_else(t_imp_f != "1","impaired|concern","meeting_standard")) |> 
    ggplot() +
    geom_col(aes(riparian_ac_pct_temp_in_swifd, t_imp_f_245, fill = t_imp_f)) +
    scale_x_continuous(labels = scales::label_percent()) +
    scale_fill_manual(name = "303(d)", values = pal_t_imp_f) +
    facet_wrap(~wria, ncol = 1, strip.position = "left", scales = "fixed") +
    labs(x = paste("Proportion of total RMZ area, 303(d) assessed, SWIFD=", swifd_cat), y = NULL) +
    theme(
      legend.position = "top"
    )
}

gg_pct_meeting_wria("not_salmon") +
  gg_pct_meeting_wria("salmon_not_chin") +
  gg_pct_meeting_wria("salmon_with_chin")
```

Differentiating by WRIA west of the Cascade crest while remaining focused on reaches with assessed 303(d) status within SWIFD classes (defined by presence of Chinook or other species), the large disparity between those meeting standards (category 1, green) and those with concerns or designated impairment (2, orange and 4|5 brown) is broadly evident. Some of these differences are likely due to biases in the locations assessed (i.e., the 303(d) categories do not come from a random sample design), but the pattern of substantially lower proportions of reaches meeting standards is consistent across the varied physiography and land uses of these WRIAs. Note that percentages sum to 1 within per-WRIA panels of each column, but "not assessed" (not shown) make up large portions of many WRIA-SWIFD types.

```{r gg_col_pct_meeting_all_swifd_chin, fig.width=9, fig.height=10}
rde_smry_wria |> 
  filter(
    as.integer(as.character(wria)) < 26,
    #swifd_chin == "salmon_with_chin",
    t_imp_f != "NA", t_imp_f != "3"
  ) |> 
  mutate(t_imp_f_245 = if_else(t_imp_f != "1","impaired|concern","meeting_standard")) |> 
  ggplot() +
  geom_col(aes(riparian_ac_pct_temp_in_swifd, t_imp_f_245, fill = t_imp_f)) +
  scale_x_continuous(labels = scales::label_percent()) +
  scale_fill_manual(name = "303(d)", values = pal_t_imp_f) +
  facet_grid(rows = vars(wria), cols = vars(swifd_chin), scales = "fixed") +
  labs(x = "Proportion of total RMZ area\n 303(d) assessed reaches per SWIFD class", y = NULL) +
  theme(
    legend.position = "top"
  )
```

### Tree cover proportion by SWIFD & 303d

These data show a more complicated relationship between assessed water temperature category and the per-reach percentage cover of trees in the riparian corridor (RMZ+EOW). In accordance with conventional expectations, the plot below illustrates that impaired or "concern[ing]" conditions (categories 5,4,2) are associated with lower average riparian tree cover in many WRIAs (i.e., orange/brown points to the left of green). However, the average percent tree cover is similar among 303(d) categories in several instances and occasionally greater for meeting standards reaches. For example, the higher temperature categories in WRIA 15 (Kitsap) have lower tree cover in each SWIFD type (brown/orange left of green), whereas the "not salmon" type reverses this pattern in WRIA 8 and the "with Chinook" category 1 reaches have lower average tree cover in WRIA 3 (lower Skagit). Moreover, lower or similar tree cover for category 1 reaches is present in all SWIFD types in WRIA 25. Nonetheless, the generally larger areal extents of impaired categories remain apparent, shown as the scaled size of the points for per-WRIA means. The coarse spatial scale of this analysis and the varied potential causes of elevated stream temperatures make these results unsurprising, but they underscore the need for caution and consideration of local factors when extrapolating from a robust site-scale mechanism (trees create shade) to a landscape-scale diagnosis (lack of trees impairs water temperature) or prescription (increasing riparian tree cover will decrease impairment).

```{r gg_errorh_tree_pct_mean_sd, fig.width=9, fig.height=11}
rde_smry_wria |> 
  filter(
    as.integer(as.character(wria)) < 26,
    t_imp_f != "NA", t_imp_f != "3"
  ) |> 
  mutate(
    lwr = tree_pct_mean - tree_pct_sd,
    lwr = if_else(lwr<0, 0, lwr),
    upr = tree_pct_mean + tree_pct_sd,
    upr = if_else(upr>1, 1, upr)
  ) |> 
  ggplot(aes(y = t_imp_f, color = t_imp_f)) +
  geom_errorbarh(aes(xmin = lwr, xmax = upr, group = wria), show.legend = F) +
  geom_point(aes(tree_pct_mean, size = riparian_ac_sum), show.legend = F) +
  scale_size_area(max_size = 5) +
  scale_x_continuous(labels = scales::label_percent()) +
  coord_cartesian(clip = "off") +
  scale_color_manual(name = "303(d)", values = pal_t_imp_f) +
  facet_grid(rows = vars(wria), cols = vars(swifd_chin), scales = "fixed") +
  labs(x = "Mean per-reach % tree cover (+/- SD)",
       y = "303(d) assessed category") +
  theme(
    panel.grid = element_blank(),
    panel.grid.major.x = element_line(color = "grey80", linewidth = 0.3), 
    panel.grid.major.y = element_line(color = "grey80", linewidth = 0.3), 
    panel.spacing.y = unit(9, "points")
    )
```

### WRIA 15 Example

Closer examination of the per-reach tree cover relative to 303(d) status and salmon distribution within a single focal WRIA reinforces both the general pattern that fewer reaches and less riparian area are meeting temperature standards where salmon, particularly Chinook, are present, and the considerations that reaches with high tree cover can be impaired (brown bars further right) while those with low cover may not be (green bars further left). Indeed, recognition of this spatial complexity was a factor motivating the development of the RDE. 

```{r gg_col_tree_pct_wria15ex, fig.width=9, fig.height=10}
rde |> 
  drop_na(tree_pct) |> 
  filter(
    wria == "15"
    ,
    t_imp_f != "NA",
    t_imp_f != "3"
    ) |> #filter(is.na(tree_pct))
  mutate(
    pid_f = factor(pid) |> fct_reorder(tree_pct)
  ) |> 
  ggplot() +
  geom_col(aes(pid_f, tree_pct, fill = t_imp_f)) +
  scale_x_discrete(name = "Individual reaches (by pid)", labels = NULL) +
  scale_y_continuous(labels = scales::label_percent()) +
  scale_fill_manual(name = "303(d)", values = pal_t_imp_f) +
  facet_wrap(~swifd_chin, ncol = 1, scales = "free_x") +
  theme(legend.position = "top") +
  labs(title = "WRIA 15 Kitsap")

```

```{r gg_scatter_ac_tree_wria15, fig.width=9, fig.height=10}
rde |> 
  drop_na(tree_pct) |> 
  filter(
    wria == "15",
    t_imp_f != "NA",
    t_imp_f != "3"
  ) |> 
  ggplot() +
  geom_point(aes(riparian_ac, tree_pct, color = t_imp_f), size = 0.5) +
  geom_vline(xintercept = 10, linetype = 3, linewidth = 0.5) +
  geom_hline(yintercept = .75, linetype = 3, linewidth = 0.5) +
  scale_y_continuous(labels = scales::label_percent()) +
  scale_color_manual(name = "303(d)", values = pal_t_imp_f) +
  facet_wrap(~swifd_chin + t_imp_f, ncol = 3, labeller = label_wrap_gen(multi_line = F), scales = "fixed") +
  theme_classic() +
  theme(legend.position = "top") +
  labs(title = "WRIA 15 Kitsap")

# rde |> 
#   drop_na(tree_pct) |> 
#   filter(
#     wria == "15",
#     t_imp_f != "NA",
#     t_imp_f != "3"
#   ) |> 
#   ggplot() +
#   geom_bin_2d(aes(riparian_ac, tree_pct, fill = t_imp_f, alpha = after_stat(count))) +
#   scale_y_continuous(labels = scales::label_percent()) +
#   scale_fill_manual(name = "303(d)", values = pal_t_imp_f) +
#   scale_alpha(range = c(0.3,1)) +
#   facet_wrap(~swifd_chin + t_imp_f, ncol = 3, scales = "fixed") +
#   theme(legend.position = "top") +
#   labs(title = "WRIA 15 Kitsap")

```

```{r gt_rapt}
rde |> 
  drop_na(tree_pct) |> 
  filter(
    wria == "15",
    t_imp_f != "NA",
    t_imp_f != "3"
  ) |> 
  mutate(rapt = riparian_ac * tree_pct) |>
  summarise(
    across(c(riparian_ac, rapt), list(sum = ~sum(., na.rm = T))),
   .by = c(wria, swifd_chin, t_imp_f)
  ) |> 
  mutate(
    rapt_sum_pct = rapt_sum / riparian_ac_sum
  ) |> 
  arrange(wria, swifd_chin, t_imp_f) |> 
  gt(groupname_col = "swifd_chin", row_group_as_column = T) |> 
  fmt_number(ends_with("_sum"), decimals = 0) |> 
  fmt_percent(ends_with("_pct"), decimals = 0) |> 
  cols_label(
    t_imp_f = "303(d) category",
    riparian_ac_sum = "\u03A3 Riparian ac.",
    rapt_sum = "\u03A3 (Rip. ac. x tree%)",
    rapt_sum_pct = "tree discounted % of full"
  )

```

## HRCD tree loss *Broken off to separate rde_SWIFD_HRCD*

Reach table does not include "impervious increase", but also does not distinguish change agents and cannot differentiate, for example, "forestry" from "development"

Across WRIAs, within Chinook habitat, the riparian areas of reaches with temperature impairment or concerns had greater anthropogenic tree loss.

```{r gt_allwria_anth_pct}
#across wrias totals tabulations
#too much conflation of change agents and lowland/upland position etc across wrias
#but still worth noting the pct in with_chin 4|5 > 2 > 1
rde |> 
  summarise(
    across(
      c(riparian_ac, anth_chg_ac = anthropogenic_change_origin_ac), #all_land_cover_ac, all_tree_cover_ac,
      list(sum = ~sum(., na.rm = T))
      ),
    #.by = c(swifd_chin)
    .by = c(swifd_chin, t_imp_f)
  ) |> 
  mutate(anth_pct = anth_chg_ac_sum / riparian_ac_sum) |> 
  arrange(swifd_chin, t_imp_f) |> 
  filter(
    #swifd_chin == "salmon_with_chin",
    t_imp_f %in% c("1","2","4|5")
  ) |> 
  gt(groupname_col = "swifd_chin") |> 
  fmt_number(ends_with("sum"), decimals = 0) |> 
  fmt_percent(ends_with("pct"), decimals = 1)
```

```{r gg_parallel_anth_pct, include=FALSE, eval=FALSE}
#the pct for common scale is not especially informative, especially for the 'not_salmon',
#due to combination of 1) small sample of cat1 and 2) relative landscape positioning of forestry and these typically smaller/higher reaches

rde |> 
  summarise(
    across(
      c(riparian_ac, anth_chg_ac = anthropogenic_change_origin_ac), 
      list(sum = ~sum(., na.rm = T))
      ),
    .by = c(wria, swifd_chin, t_imp_f)
  ) |> 
  mutate(anth_pct = anth_chg_ac_sum / riparian_ac_sum) |> 
  arrange(wria, swifd_chin, t_imp_f) |> 
  filter(
    swifd_chin == "salmon_with_chin",
    t_imp_f %in% c("1","2","4|5")
  ) |> 
  ggplot() +
  #geom_boxplot(aes(swifd_chin, anth_pct, color = t_imp_f), varwidth = T) +
  geom_point(aes(t_imp_f, anth_pct, colour = t_imp_f, group = wria)) +
  geom_line(aes(t_imp_f, anth_pct, colour = t_imp_f, group = wria), linewidth = 0.3) +
  scale_color_manual(name = "303(d)", values = pal_t_imp_f)

rde |> 
  filter(
    #swifd_chin == "salmon_with_chin",
    t_imp_f %in% c("1","2","4|5")
    ) |> 
  mutate(t_imp_f_245 = if_else(t_imp_f != "1","impaired|concern","meeting_standard")) |> 
  summarise(
    across(
      c(riparian_ac, anth_chg_ac = anthropogenic_change_origin_ac), 
      list(sum = ~sum(., na.rm = T))
      ),
    .by = c(wria, swifd_chin, t_imp_f_245)
  ) |> 
  mutate(anth_pct = anth_chg_ac_sum / riparian_ac_sum) |> 
  arrange(wria, swifd_chin, t_imp_f_245) |> 
  ggplot(aes(t_imp_f_245, anth_pct, group = wria)) +
  geom_point(aes(colour = t_imp_f_245, size = anth_chg_ac_sum), alpha = 0.6) + 
  geom_line(linewidth = 0.2, alpha = 0.3) +
  scale_color_manual(name = "303(d)", values = c("#965127","darkgreen")) +
  facet_wrap(~swifd_chin, ncol = 1)
```

```{r gg_coencentric_anth_ac, include=FALSE, eval=FALSE}
#this is arguably better than pct while still conveying relative quantities
#but still harder to judge precisely and basically unreadable as a single plot
rde |> 
  filter(
    #swifd_chin == "salmon_with_chin",
    t_imp_f %in% c("1","2","4|5")
    ) |> 
  mutate(t_imp_f_245 = if_else(t_imp_f != "1","impaired|concern","meeting_standard")) |> 
  summarise(
    across(
      c(riparian_ac, all_tree_cover_ac, anth_chg_ac = anthropogenic_change_origin_ac), 
      list(sum = ~sum(., na.rm = T))
      ),
    .by = c(wria, swifd_chin, t_imp_f_245)
  ) |> 
  mutate(anth_pct = anth_chg_ac_sum / riparian_ac_sum) |> 
  arrange(wria, swifd_chin, t_imp_f_245) |> 
  ggplot(aes(swifd_chin, wria)) +
  geom_point(aes(size = riparian_ac_sum), color = "tan", alpha = 0.6) + 
  geom_point(aes(size = all_tree_cover_ac_sum), color = "darkgreen", alpha = 0.6) + 
  geom_point(aes(size = anth_chg_ac_sum), color ="orange", alpha = 0.6) + 
  scale_size_area() +
  facet_wrap(~t_imp_f_245, ncol = 2)
```

```{r gg_bar_anth_ac}
# #tree loss change excluding notsalmon & meeting
# #acres scale still difficult, needs log10 to see anth_chg but that makes harder to judge intuitively
# rde |> 
#   filter(t_imp_f %in% c("1","2","4|5")) |> 
#   mutate(t_imp_f_245 = if_else(t_imp_f != "1","impaired|concern","meeting_standard")) |> 
#   summarise(
#     across(
#       c(riparian_ac, all_tree_cover_ac, anth_chg_ac = anthropogenic_change_origin_ac), 
#       list(sum = ~sum(., na.rm = T))
#       ),
#     .by = c(wria, swifd_chin, t_imp_f_245)
#   ) |> 
#   mutate(anth_pct = anth_chg_ac_sum / riparian_ac_sum) |> 
#   arrange(wria, swifd_chin, t_imp_f_245) |> 
#   filter(
#     as.integer(as.character(wria)) < 26,
#     swifd_chin != "not_salmon",
#     str_detect(t_imp_f_245, "impair")
#     ) |> 
#   ggplot(aes(y = wria)) +
#   geom_col(aes(x = riparian_ac_sum), fill = "tan", alpha = 0.6) + 
#   geom_col(aes(x = all_tree_cover_ac_sum), fill = "darkgreen", alpha = 0.6) + 
#   geom_col(aes(x = anth_chg_ac_sum), fill ="orange", alpha = 0.6) + 
#   scale_x_log10(labels = scales::label_log()) +
#   facet_wrap(~swifd_chin, ncol = 3)

# #tree loss change within salmon AND impaired|concern reaches
# #better/okay for seeing among-wria but
# #conflates landscape pattern with 303d determination extent/footprint
# rde |>
#   filter(
#     swifd_any,
#     t_imp_f %in% c("2","4|5")
#     ) |>
# #  mutate(t_imp_f_245 = if_else(t_imp_f != "1","impaired|concern","meeting_standard")) |>
#   summarise(
#     across(
#       c(riparian_ac, all_tree_cover_ac, anth_chg_ac = anthropogenic_change_origin_ac),
#       list(sum = ~sum(., na.rm = T))
#       ),
#  #   .by = c(wria, t_imp_f_245)
#     .by = c(wria)
#   ) |>
#   mutate(anth_pct = anth_chg_ac_sum / riparian_ac_sum) |>
# #  arrange(wria, t_imp_f_245) |>
#   filter(
#     as.integer(as.character(wria)) < 26
#     # ,
#     # swifd_chin != "not_salmon",
#     # str_detect(t_imp_f_245, "impair")
#     ) |>
#   #arrange(anth_pct) |> print(n=Inf)
#   ggplot(aes(y = wria)) +
#   geom_col(aes(x = riparian_ac_sum), fill = "tan", alpha = 0.6) +
#   geom_col(aes(x = all_tree_cover_ac_sum), fill = "darkgreen", alpha = 0.6) +
#   geom_col(aes(x = anth_chg_ac_sum), fill ="orange", alpha = 0.6)


##tree loss change in W WA salmon reaches, ignoring 303d
rde_anth_wria_swifd_any <- rde |>
  summarise(
    across(
      c(riparian_ac, all_tree_cover_ac, 
        anth_chg_ac = anthropogenic_change_origin_ac),
      list(sum = ~sum(., na.rm = T))
      ),
    .by = c(wria, swifd_any)
  )

# # #back to scale display problem: larger abs losses in notsalmon
# rde_anth_wria_swifd_any |> 
#   filter(as.integer(as.character(wria)) < 26) |>
#   mutate(anth_pct = anth_chg_ac_sum / riparian_ac_sum) |>
#   ggplot(aes(y = wria)) +
#   geom_col(aes(x = riparian_ac_sum), fill = "tan", alpha = 0.6) +
#   geom_col(aes(x = all_tree_cover_ac_sum), fill = "darkgreen", alpha = 0.6) +
#   geom_col(aes(x = anth_chg_ac_sum), fill ="orange", alpha = 0.6) +
#   facet_wrap(~swifd_any) + scale_x_log10()


#this is good for seeing across wrias within each T/F and acres-fill-color cols
#but still hard to see diffs in ratios
rde_anth_wria_swifd_any |> 
  filter(as.integer(as.character(wria)) < 26) |>
  pivot_longer(cols = ends_with("sum")) |> #pull(name) |> unique() |> sort()
  mutate(
    swifd_any = if_else(swifd_any, "salmon","not salmon"),
    name = factor(name, levels = sort(unique(name))[c(3,1,2)])
    ) |> 
  ggplot(aes(y = wria)) +
  geom_col(aes(x = value, fill = name, alpha = swifd_any), position = "dodge") + 
  scale_x_continuous(labels = scales::comma) +
  scale_fill_manual(values = c("tan","darkgreen","orange"), guide = "none") +
  scale_alpha_manual(values = c(0.3, 0.9)) +
  facet_wrap(~name, scales = "free_x") +
  labs(x = "total acres", y = NULL) +
  theme(legend.position = "top")



# rde_anth_wria_swifd_any |> 
#   filter(as.integer(as.character(wria)) < 26) |>
#   mutate(swifd_any = if_else(swifd_any, "salmon","not salmon")) |> 
#   pivot_longer(ends_with("sum")) |> 
#   pivot_wider(names_from = swifd_any, values_from = value) |> 
#   ggplot() + geom_point(aes(`not salmon`, salmon, color = name), show.legend = F) + geom_abline(slope = 1, linetype = 3) + facet_wrap(~name, scales = "free")


rde |> 
  summarise(
    across(c(riparian_ac), list(sum = ~sum(., na.rm = T))),
    across(tree_pct, list(
        mean = ~mean(., na.rm = T),
        sd = ~sd(., na.rm = T)
        ))
    ,.by = c(wria, swifd_any)
  )

#complex figure. not sure if still too much unpacking needed?
#within each WRIA, some set of reaches is designated by SWIFD as having salmonid use; 
#the x-axis shows this 'salmon-extent' as the proportion of the total riparian acreage (0 no salmon to 1 all salmon); 
#similarly, some portion of the total acreage has tree cover, and this total treed area can be distinguished by salmon use
#so, green points show the proportion of the total riparian tree-cover acreage for the salmon-extent (y-axis/vertical position) relative to the overall proportion of riparian area (x-axis/horizontal) of that same extent (i.e., set of reaches);
#green points near the 1:1 line indicate that the salmon-reaches/salmon-extent make up a similar proportion of the area of tree cover as of the full riparian area, suggesting that tree cover is more evenly distributed across salmon and non-salmon portions of the network
#green points above the 1:1 line indicate a greater proportion than the null expectation based solely on riparian acreage, suggesting that tree cover is relatively concentrated within the salmon-extent reaches 
#green points below the 1:1 line indicate a lower proportion of tree area is salmon-extent than the null expectation, suggesting that tree cover is relatively lacking within these reaches
#the total anthropogenic tree loss within the wria riparian area can also be distinguished by salmon/SWIFD
#orange points show how the proportion of this loss within the salmon-extent compares with both tree cover (green points) and the overall proportion of riparian area:
#orange points below green suggest tree losses were distributed outside of salmon-reaches, whereas orange above green suggests tree losses were more associated with the salmon-extent
#both of these relationships can occur above, below, or across the 1:1 line; for example, the area of salmon/SWIFD reaches in WRIA 12 was ~36% of the total riparian area, but these reaches were associated with ~44% of the tree cover (above 1:1), yet ~24% of tree loss area (below 1:1)

rde_anth_wria_swifd_any |> 
  filter(as.integer(as.character(wria)) < 26) |>
  mutate(
    across(ends_with("sum"), list(pct = ~./sum(.))),
    .by = wria
  ) |> 
  #filter(wria %in% c("4","6","8","12")) |> arrange(wria, swifd_any)
  filter(swifd_any) |>
#ggplot(aes(riparian_ac_sum_pct, all_tree_cover_ac_sum_pct)) + geom_point(aes(color = swifd_any)) + 
ggplot() + 
  geom_abline(slope = 1, linetype = 3) +
  # geom_point(aes(riparian_ac_sum_pct, all_tree_cover_ac_sum_pct, size = riparian_ac_sum/10), color = "darkgreen") + 
  # geom_point(aes(riparian_ac_sum_pct, anth_chg_ac_sum_pct, size = anth_chg_ac_sum), color = "orange") + 
  geom_segment(aes(
    riparian_ac_sum_pct, all_tree_cover_ac_sum_pct,
    xend = riparian_ac_sum_pct, yend = anth_chg_ac_sum_pct),
    arrow = arrow(20, length = unit(0.015, "npc"), type = "open"), arrow.fill = "orange",
    linetype = 1, linewidth = 0.3, color = "grey30"
  ) +
  geom_point(aes(riparian_ac_sum_pct, all_tree_cover_ac_sum_pct, size = riparian_ac_sum/10), color = "darkgreen") + 
  geom_point(aes(riparian_ac_sum_pct, anth_chg_ac_sum_pct, size = anth_chg_ac_sum), color = "orange") + 
  geom_text(aes(riparian_ac_sum_pct, anth_chg_ac_sum_pct, label = wria),
            size = 3,
            #position = "jitter"
            nudge_x = 0.005, nudge_y = -0.003
            ) +
  scale_size_area(max_size = 5, guide = "none") +
  labs(
    title = "Proportions of total tree cover and tree loss\nfor reaches with salmon use (SWIFD) in W WA WRIAs",
    subtitle = "Points sized by relative area",
    x = "Salmon/SWIFD proportion of total WRIA riparian acres",
    y = "Prop. of total riparian tree cover acres (green) or tree loss (orange) acres"
  ) +
  annotate("segment", x = 0.05, y = -0.01, xend = 0.5, yend = -0.01, arrow = arrow()) +
  annotate("text", x = 0.15, y = 0, label = "Salmon/SWIFD extent is more of total network/riparian area", hjust = 0) +
  annotate("segment", x = 0.01, y = 0, xend = 0.01, yend = 0.5, arrow = arrow(), color = "darkgreen") +
  annotate("text", x = 0.03, y = 0.43, label = "More of treed riparian area assoc. with salmon/SWIFD", hjust = 0, color = "darkgreen") +
  annotate("segment", x = 0.02, y = 0, xend = 0.02, yend = 0.5, arrow = arrow(), color = "orange") +
  annotate("text", x = 0.03, y = 0.4, label = "More of tree loss area assoc. with salmon/SWIFD ", hjust = 0, color = "orange") +
  coord_cartesian(clip = "off")


#not especially helpful: sf_tess_01_25_rmz_cntrd_pts |> filter(wria == "8") |> ggplot() + geom_sf(aes(color = all_tree_cover_ac)) + facet_wrap(~swifd_any)
#but this is somewhat interesting: sf_tess_01_25_rmz_cntrd_pts |> filter(wria == "4") |> ggplot() + geom_sf(aes(color = all_tree_cover_ac > 0)) + facet_wrap(~swifd_any)

#facet column vs column: tree/riparian and anth/tree by swifd per wria

#strange plot, probably not a keeper
##tree acres per riparian acres, relative to any-SWIFD extent
rde_anth_wria_swifd_any |>
  filter(as.integer(as.character(wria)) < 26) |>
  mutate(
    swifd_any = if_else(swifd_any, "salmon","not salmon"),
    tree_ac_rip_ac = all_tree_cover_ac_sum / riparian_ac_sum
  ) |>
#  select(-ends_with("sum")) |> 
  pivot_wider(names_from = swifd_any, values_from = where(is.numeric)) |> 
  ggplot(aes(`tree_ac_rip_ac_not salmon`, tree_ac_rip_ac_salmon)) +
  # geom_point(aes(size = riparian_ac_sum_salmon, color = tree_ac_rip_ac_salmon),
  #            alpha = 0.7, show.legend = F) +
  geom_point(aes(size = `riparian_ac_sum_not salmon`), color = "yellow",
             alpha = 0.5, show.legend = F) +
  geom_point(aes(size = riparian_ac_sum_salmon), color = "purple",
             alpha = 0.5, show.legend = F) +
  geom_text(aes(label = wria), position = "jitter") +
  geom_abline(slope = 1, linetype = 3, linewidth = 0.5) +
#  wacolors::scale_color_wa_c("gorge", limits = c(0,1), reverse = T) +
  labs(
    x = "Tree acres per riparian acres, outside SWIFD",
    y = "Tree acres per riparian acres, within SWIFD",
    subtitle = "Point size scale to total riparian acres within SWIFD"
  )

#another (earlier) version - visually simpler but also hard to capture/show multiple among strata relationships
#larger 'not salmon' bars indicate reaches outside SWIFD have higher total proportion of tree cover
#this shows bar-diffs clearly but is tricky since very different abs acres between bars (within and among wrias)
rde_anth_wria_swifd_any |>
  filter(as.integer(as.character(wria)) < 26) |>
  mutate(
    swifd_any = if_else(swifd_any, "salmon","not salmon"),
    tree_rip_pct = all_tree_cover_ac_sum / riparian_ac_sum,
    anth_tree_pct = anth_chg_ac_sum / all_tree_cover_ac_sum
  ) |>
  ggplot() +
  geom_col(aes(tree_rip_pct, wria, alpha = swifd_any), fill = "darkgreen", position = "dodge", width = 0.7) +
  scale_alpha_manual(values = c(0.3, 0.9)) +
  labs(x = "total (tree ac / riparian ac)", y = NULL) +
  theme(legend.position = "top")
#same but showing abs acres as bar width
rde_anth_wria_swifd_any |> 
  filter(as.integer(as.character(wria)) < 26) |>
  mutate(
    swifd_any = if_else(swifd_any, "salmon","not salmon"),
    tree_rip_pct = all_tree_cover_ac_sum / riparian_ac_sum,
    anth_tree_pct = anth_chg_ac_sum / all_tree_cover_ac_sum
  ) |> 
  ggplot() + 
  geom_col(aes(tree_rip_pct, swifd_any, alpha = swifd_any, width = riparian_ac_sum), fill = "darkgreen", position = "dodge2") +
  scale_alpha_manual(values = c(0.3, 0.9)) +
  labs(x = "total (tree ac / riparian ac)", y = NULL) +
  facet_wrap(~wria, ncol = 1, strip.position = "left") +
  theme(legend.position = "top", axis.text.y = element_blank())

#as above, showing between-SWIFD diffs but obscuring diffs in abs areas
rde_anth_wria_swifd_any |> 
  filter(as.integer(as.character(wria)) < 26) |>
  mutate(
    swifd_any = if_else(swifd_any, "salmon","not salmon"),
    tree_rip_pct = all_tree_cover_ac_sum / riparian_ac_sum,
    anth_tree_pct = anth_chg_ac_sum / all_tree_cover_ac_sum
  ) |> 
  ggplot() + 
  geom_col(aes(anth_tree_pct, wria, alpha = swifd_any), fill = "orange", position = "dodge") +
  scale_alpha_manual(values = c(0.3, 0.9)) +
  labs(x = "total (tree loss ac / tree ac)", y = NULL) +
  theme(legend.position = "top")
#with acreage-varied widths
rde_anth_wria_swifd_any |> 
  filter(as.integer(as.character(wria)) < 26) |>
  mutate(
    swifd_any = if_else(swifd_any, "salmon","not salmon"),
    tree_rip_pct = all_tree_cover_ac_sum / riparian_ac_sum,
    anth_tree_pct = anth_chg_ac_sum / all_tree_cover_ac_sum
  ) |> 
  ggplot() + 
  geom_col(aes(anth_tree_pct, swifd_any, alpha = swifd_any, width = riparian_ac_sum), fill = "orange", position = "dodge2") +
  scale_alpha_manual(values = c(0.3, 0.9)) +
  labs(x = "total (tree loss ac / tree ac)", y = NULL) +
  facet_wrap(~wria, ncol = 1, strip.position = "left") +
  theme(legend.position = "top", axis.text.y = element_blank())



#tabulating numbers to stare at
rde_anth_wria_swifd_any |> 
  filter(as.integer(as.character(wria)) < 26) |>
  mutate(
    swifd_any = if_else(swifd_any, "salmon","not salmon"),
    tree_rip_pct = all_tree_cover_ac_sum / riparian_ac_sum,
    anth_tree_pct = anth_chg_ac_sum / all_tree_cover_ac_sum
  ) |> 
  mutate(
    across(ends_with("sum"), list(pct = ~./sum(.))),
    .by = wria
  ) |> 
  arrange(wria, swifd_any) |> print(n = Inf)
  

```

```{r}
#parallel coord as better version of x-y arrow segments
#no UGA in this version of reach_table, otherwise would be good strat
#cols answer:
#how much of total RMZ extent is associated with salmon?
#how much of total RMZ tree cover is associated with salmon?
#how much of total RMZ tree loss is associated with salmon?
d <- rde_anth_wria_swifd_any |> 
  filter(as.integer(as.character(wria)) < 26) |>
  mutate(
    across(ends_with("sum"), list(pct = ~./sum(.))),
    .by = wria
  ) |> 
  #filter(wria %in% c("4","6","8","12")) |> arrange(wria, swifd_any)
  filter(swifd_any) |> 
  #select(wria, swifd_any, ends_with("pct")) |> 
  pivot_longer(-c(wria, swifd_any)) |> 
  mutate(
    var = str_sub(name, -3, -1),
    name = str_remove(name, "_sum") |> str_remove("_pct")
    ) |> 
  pivot_wider(names_from = var, values_from = value) |> 
  #pull(name) |> unique() |> sort()
  mutate(name = factor(name, levels = sort(unique(name))[c(3,1,2)]))

{
d |> 
  ggplot(aes(name, pct, group = wria)) +
  geom_line(linewidth = 0.3) +
  geom_point(aes(color = name, size = sum)) + 
  geom_text(aes(label = wria),
            #position = position_dodge(width = 0.5)
            nudge_x = -0.05
            ) +
  scale_color_manual(values = c("tan","darkgreen","orange"), guide = "none") +
  scale_size_area(guide = "none") +
  #facet_wrap(~swifd_any, ncol = 2) +
  labs(x = NULL, y = "Proportion", 
       title = "SWIFD/salmon RMZ area as proportion of WRIA total")
}+{
sf_wrias |> 
  mutate(WRIA_NR = factor(WRIA_NR)) |> 
  left_join(d, by = c("WRIA_NR" = "wria")) |> 
  drop_na(pct) |> 
  #filter(str_detect(name, "anth")) |> 
  ggplot() + geom_sf(aes(fill = name, alpha = pct), color = "grey80", linewidth = 0.1) + 
  scale_fill_manual(values = c("tan","darkgreen","orange"), aesthetics = c("fill","color"), guide = "none") +
  scale_alpha(name = "Prop.", guide = "none") +
  facet_wrap(~name) #+ theme(legend.position = "bottom")
}+
  plot_layout(ncol = 1)

```


# Multi-WRIA multi-attribute filter

```{r ggpairs_solar_elev_etc, include=FALSE, eval=FALSE}
# rde |> 
#   drop_na(tree_pct) |> 
#   filter(
#     #wria == "15",
#     as.integer(as.character(wria)) < 26,
#     t_imp_f != "NA",
#     t_imp_f != "3"
#   ) |> 
#   mutate(rapt = riparian_ac * tree_pct) |>
#  ggplot() +
#   #geom_point(aes(average_elevation, rapt, color = t_imp_f), size = 0.5, show.legend = F) +
# 
# #  geom_point(aes(tree_pct, average_elevation, color = t_imp_f, size = riparian_ac), alpha = 0.5, show.legend = F) +
#   geom_point(aes(average_solar, average_elevation, color = t_imp_f, size = riparian_ac), alpha = 0.5, show.legend = F) +
# 
#   facet_wrap(~swifd_chin + t_imp_f, ncol = 3, labeller = label_wrap_gen(multi_line = F), scales = "fixed", axes = "all") +
#   # facet_wrap(~swifd_chin, ncol = 1, labeller = label_wrap_gen(multi_line = F), scales = "fixed") +
# 
#   scale_color_manual(name = "303(d)", values = pal_t_imp_f) +
#   scale_size_area(max_size = 5) +
#   # geom_vline(xintercept = 10, linetype = 3, linewidth = 0.5) +
#   # geom_hline(yintercept = .75, linetype = 3, linewidth = 0.5) +
#   # scale_y_continuous(labels = scales::label_percent()) +
#   theme_classic() +
#   theme(
#     axis.line = element_line(linewidth = 0.2),
#     strip.background = element_rect(linewidth = 0)
#     )

#canopy pattern has somewhat better separation than tree_pct for 1 vs 245
#very little of 245 >0.5 vs fairly fat tail for 1
#but see below, any separation not terribly meaningful, more likely artifactual
rde |> 
  filter(
    as.integer(as.character(wria)) < 26,
    t_imp_f != "NA",  t_imp_f != "3"
  ) |> 
  select(
    wria, swifd_chin, t_imp_f,
    riparian_ac, rmz_ac, eow_ac,
    starts_with("average"),
    canopy_pattern_metric,
    tree_pct
    ) |> 
  filter(swifd_chin == "salmon_with_chin") |> 
  rename_with(~str_remove(., "average_"), starts_with("average")) |> 
  GGally::ggpairs(
    mapping = aes(color = t_imp_f, fill = t_imp_f, size = rmz_ac, alpha = 0.3),
    columns = 7:12
  ) +
  scale_color_manual(name = "303(d)", values = pal_t_imp_f, aesthetics = c("color","fill")) +
  scale_size_area(max_size = 5) +
  labs(subtitle = "SWIFD: salmon_with_chin")

#but this looks hard to differentiate from sampling/spatial artifact of 303d/305b
rde |> 
  filter(
    as.integer(as.character(wria)) < 26,
    t_imp_f != "NA",  t_imp_f != "3"
    #,swifd_chin == "salmon_with_chin"
  ) |> 
  ggplot() +
  geom_boxplot(aes(canopy_pattern_metric, wria, color = t_imp_f),
               varwidth = T, outlier.size = 0.3) +
  scale_color_manual(name = "303(d)", values = pal_t_imp_f, aesthetics = c("color","fill")) +
  facet_wrap(~swifd_chin, ncol = 3)

```

```{r multi_attrib_quantile_filter_across_wrias, include=FALSE, eval=FALSE}
#begin with W WA
#limit to reaches with Chinook presence per SWIFD
#then limit to 303d temp concern --> "get ahead of a problem"
#   could certainly also do "5"  --> "focus on the worst"
#then focus on 
#stream miles >= 90th 
#tree_pct <= 10th
#larger areas, lower tree cover
rde |>
  filter(
    as.integer(as.character(wria)) < 26,
    swifd_chin == "salmon_with_chin",
    #t_imp_f != "NA",  t_imp_f != "3"
    #t_imp_f %in% c("2","4|5")
    t_imp_f == "2"
  ) |> 
  mutate(
    across(
      c(stream_miles, rmz_ac, canopy_pattern_metric, tree_pct, average_solar),
      list(
        # q90 = ~. >= quantile(na.omit(.), p = 0.9),
        # q10 = ~. <= quantile(na.omit(.), p = 0.1)
        q75 = ~. >= quantile(na.omit(.), p = 0.75),
        q25 = ~. <= quantile(na.omit(.), p = 0.25)
      )
    ),
    .by = c(wria, swifd_chin, t_imp_f)
  ) |> 
  filter(
    #stream_miles_q90 & tree_pct_q10 & average_solar_q10 
    #stream_miles_q75 & tree_pct_q25 & average_solar_q75 
    stream_miles_q75 & canopy_pattern_metric_q25 & tree_pct_q25 & average_solar_q75 
  ) |>
  select(pid, wria, swifd_chin, t_imp_f, stream_name,
         stream_miles, #contains("stream"), 
         rmz_ac, #contains("rmz_ac"), 
         canopy_pattern_metric,
         tree_pct, #contains("tree_pct"), 
         average_solar #contains("solar")
         ) |> 
  arrange(wria, desc(stream_miles), desc(rmz_ac), desc(tree_pct))
  

```

```{r sf_tess, include=FALSE, eval=FALSE}
#tesselation polygons
#per-PID, can/do have EOW and both L and R bank RMZs as well as potentially other small 'parts'
f_gdb <- "~/T/DFW-Team WDFW Watershed Synthesis - data_common/SPTH_Tessellation.gdb/"
l <- st_layers(f_gdb)$name

# #did not break memory...23 and 24 are especially big
# sf_tess_01_25 <- map(
#   l[1:25],
#   \(w){
#       st_read(f_gdb, w) |> st_zm() |> 
#         select(-Shape_Length, -Shape_Area) |> 
#         rename_with(tolower) |> 
#         mutate(
#           wria = factor(str_sub(w,5,6)),
#           ac = st_area(shape) |> units::set_units(acres) |> as.vector()
#         ) |> 
#       select(wria, pid = permanent_identifier, ac, everything())
#   }
# ) |> bind_rows()
# 
# as_tibble(sf_tess_01_25) |> count(zone)

#for plotting only, no spatial operations, make a version of RMZ-only as centroid points
#memory hungry, slow done all-at-once, so redone in map, which is also slow but stable
# sf_tess_01_25_rmz_cntrd_pts <- sf_tess_01_25 |> 
#   filter(zone=="RMZ") |> 
#   group_by(pid) |> summarise() |> #combines parts
#   st_centroid() #then gets center point
sf_tess_01_25_rmz_cntrd_pts <- map(
  l[1:25],
  \(w){
      st_read(f_gdb, w) |> 
      st_zm() |>
      filter(Zone=="RMZ") |> 
      group_by(pid = permanent_identifier) |> summarise() |> #combines parts
      st_centroid() #then gets center point
  }
) |> bind_rows()

#a few duplicate pid split over WRIAs 
as_tibble(sf_tess_01_25_rmz_cntrd_pts) |> count(pid) |> filter(n>1)

sf_tess_01_25_rmz_cntrd_pts <- sf_tess_01_25_rmz_cntrd_pts |> 
  distinct(pid, .keep_all = T) |> 
  inner_join(rde, by = "pid")

saveRDS(sf_tess_01_25_rmz_cntrd_pts, "sf_tess_01_25_rmz_cntrd_pts.rds")

```

"How to get from half a million to a couple dozen places to work"

```{r gg_sf_multi_attrib_quantile_filter_across_wrias}
sf_tess_01_25_rmz_cntrd_pts <- readRDS("sf_tess_01_25_rmz_cntrd_pts.rds")

sf_tess_01_25_rmz_cntrd_pts |> 
  slice_sample(n = 200000) |> 
  ggplot() + geom_sf(size = 0.2, alpha = 0.1)

sf_tess_01_25_rmz_cntrd_pts |> 
  slice_sample(n = 200000) |> 
  ggplot() + geom_sf(aes(color = t_imp_f), size = 0.2, alpha = 0.2) +
  scale_color_manual(values = pal_t_imp_f)

sf_tess_01_25_rmz_cntrd_pts |> 
  filter(t_imp_f != "NA") |> 
  ggplot() + geom_sf(aes(color = t_imp_f), size = 0.2, alpha = 0.2) +
  scale_color_manual(values = pal_t_imp_f)

sf_tess_01_25_rmz_cntrd_pts |> 
  slice_sample(n = 200000) |> 
  ggplot() + geom_sf(aes(color = swifd_chin), size = 0.2, alpha = 0.2) +
  scale_color_manual(values = pal_swifd_chin)

sf_tess_01_25_rmz_cntrd_pts |> 
  filter(
    swifd_chin == "salmon_with_chin"
  ) |> 
  ggplot() + geom_sf(aes(color = swifd_chin), size = 0.2, alpha = 0.2, show.legend = F) +
  scale_color_manual(values = pal_swifd_chin) +
  labs(subtitle = "SWIFD: Chinook")

sf_tess_01_25_rmz_cntrd_pts |> 
  filter(
    swifd_chin == "salmon_with_chin",
    t_imp_f == "2"
  ) |> 
  ggplot() + geom_sf(aes(color = t_imp_f), size = 0.2, alpha = 0.2, show.legend = F) +
  scale_color_manual(values = pal_t_imp_f) +
  labs(subtitle = "SWIFD: Chinook\n303(d) Cat2 'water temp concern'")

d <- sf_tess_01_25_rmz_cntrd_pts |> 
  filter(
    swifd_chin == "salmon_with_chin",
    t_imp_f == "2"
  ) |> 
  mutate(
    across(
      c(stream_miles, rmz_ac, canopy_pattern_metric, tree_pct, average_solar),
      list(
        q75 = ~. >= quantile(na.omit(.), p = 0.75),
        q25 = ~. <= quantile(na.omit(.), p = 0.25)
      )
    ),
    .by = c(wria, swifd_chin, t_imp_f)
  ) 

ggplot() + 
  geom_sf(data = d, color = pal_t_imp_f["2"], size = 0.2, alpha = 0.2, show.legend = F) +
  geom_sf(
    data = d |> 
      filter(stream_miles_q75 & canopy_pattern_metric_q25 & tree_pct_q25 & average_solar_q75) 
    ,
    aes(color = canopy_pattern_metric, size = stream_miles)
    ) +
  wacolors::scale_color_wa_c(palette = "gorge", limits = c(0,1), reverse = T) +
  labs(
    subtitle = "SWIFD: Chinook\n303(d) Cat2 'water temp concern'\nstream_miles > 75th\ntree cover & canopy pattern < 25th\navg solar > 75th"
    )

```


[Siegel et al. 2023](https://journals.plos.org/water/article?id=10.1371/journal.pwat.0000119) estimated daily stream temperature for the medium resolution NHD+ COMID (flowline+local catchment)
Values here are from the [publicly available datasets of results](https://zenodo.org/records/8174951)

```{r st_pred, eval=FALSE}
##single HUC10 prediction file is n-COMIDs by n-days in 1990-2021
##given sf_pts need to know point(s) HUC10 to figure out model prediction file
##then need to know point(s) COMID since values are by COMID-day
##but points/reach may or may not actually be in the dataset which excludes artificial paths etc.
## HUC6 folders of HUC10s: 171100 - PS, 171001 - Coast

#do not know designated uses, and not going to start with running 7day max
#so formulate a simplistic quasi-category based on days over thresholds 16/18/20
#to demo concept, rather than flow_dash approach of getting huc10 & COMID by service,
#instead first summarize across COMIDs within HUC10

#just this is 7.5m rows
stp <- map_df(
  c("1711000801", #"Stilly NF"
    "1711000802", #"Stilly SF"
    "1711000803" #"Stilly Lower"
  ), 
  ~read_csv(paste0("~/T/DFW-Team WDFW Watershed Synthesis - data_common/st_pred/st_pred_171100/st_pred_",.x,".csv")) |>
    select(date = tim.date, COMID, st_pred = prd.stream_temp)
)

#stp |> count(COMID) |> filter(n!=11688) #n-days

stp_over <- stp |> 
  summarise(
    across(
      st_pred,
      list(
        n_16 = ~sum(. > 16, na.rm = T),
        n_18 = ~sum(. > 18, na.rm = T),
        n_20 = ~sum(. > 20, na.rm = T)
      )),
    .by = COMID
  ) |> 
  mutate(
    across(contains("_n_"), list(pct = ~./11688))
  )

stp_over |> 
  select(COMID, ends_with("pct")) |> 
  pivot_longer(ends_with("pct")) |> 
  ggplot() + geom_density(aes(value, color = name)) + facet_wrap(~name, scales = "free")

sf_flw <- readRDS("~/T/DFW-Team WDFW Watershed Synthesis - flow_trees_heat/sf_nhdp_wa_flw.rds") |>
  sf::st_zm() |> 
  inner_join(stp_over, by = "COMID")

mapview::mapview(sf_flw, zcol = "st_pred_n_20")

{
  ggplot() + 
  geom_sf(data = sf_flw, color = "lightblue", linewidth = 0.3) + 
  geom_sf(data = sf_flw |> filter(st_pred_n_16 > 0), aes(color = st_pred_n_16_pct)) + 
  wacolors::scale_color_wa_c("sea_star")
}+{
  ggplot() + 
  geom_sf(data = sf_flw, color = "lightblue", linewidth = 0.3) + 
  geom_sf(data = sf_flw |> filter(st_pred_n_18 > 0), aes(color = st_pred_n_18_pct)) + 
  wacolors::scale_color_wa_c("sea_star")
}+{
  ggplot() + 
  geom_sf(data = sf_flw, color = "lightblue", linewidth = 0.3) + 
  geom_sf(data = sf_flw |> filter(st_pred_n_20 > 0), aes(color = st_pred_n_20_pct)) + 
  wacolors::scale_color_wa_c("sea_star")
}+plot_layout(ncol = 1)




distinct(stp, COMID) |> 
  inner_join(sites, by = "COMID")
  # split(~site_no) |> 
  # map(
  #   ~left_join(
  #     .x |> select(site_no, COMID),
  #     stp,
  #     by = "COMID") |> 
  #     saveRDS(paste0("data/nwfsc_st_pred_",.x$site_no,".rds"))
  # )

```


::: {.content-hidden when-format="html"}

```{r gg_orig_chin_in_t_imp_cat45, eval=FALSE}
rde_st |> 
  filter(as.integer(as.character(wria)) < 26, t_imp_f == "4|5") |> 
  mutate(
    riparian_ac_pct_swifd_in_temp = if_else(
      swifd_chin == "not salmon", 
      -1*riparian_ac_pct_swifd_in_temp, 
      riparian_ac_pct_swifd_in_temp)
    ) |> 
  ggplot() + wacolors::scale_fill_wa_c("gorge", reverse = T, aesthetics = c("fill")) +
  geom_col(aes(x = riparian_ac_pct_swifd_in_temp, 
               y = fct_rev(wria),
               fill = tree_pct_mean, 
               color = swifd_chin
               ),
           position = position_dodge(0.8)
           ) +
  geom_vline(xintercept = 0, linetype = 3, linewidth = 0.5) +
  scale_x_continuous(limits = c(-1, 1)) +
  scale_color_manual(values = pal_swifd_chin) +
  guides(color = guide_legend(
    override.aes = list(fill = c("not salmon" = NA, "salmon_incl_chin" = "salmon", "salmon_not_chin" = "tan"))
    )) +
  labs(x = "<----- no salmon                salmon ----->", y = NULL, 
       title = "Relative proportion of RMZ corridor by SWIFD Chinook presence for 303d impaired stream temp",
       subtitle = "Darker green indicates higher average tree cover")

```

```{r orig, eval=FALSE}
rde_st |>
  filter(as.integer(as.character(wria)) < 26) |>
  mutate(temp_swifd = paste0(temp_imp,"_", if_else(swifd_any,"salmon","none"))) |>
  ggplot() + wacolors::scale_fill_wa_c("gorge", reverse = T, aesthetics = c("fill","color")) +
  geom_point(aes(temp_swifd, wria, color = tree_pct_mean, size = rmz_ac_pct_swifd_in_temp)) +
  scale_size_area(name = "% RMZ ac") +
  labs(x = NULL, #y = NULL,
       title = "Relative proportion of salmon occupied RMZ by temperature impairment status",
       subtitle = "Darker green indicates higher average tree cover")

rde_st |> 
  filter(as.integer(as.character(wria)) < 26) |> 
  mutate(
    temp_swifd = paste0(temp_imp,"_", if_else(swifd_any,"salmon","none"))
    ,
    wria_temp = paste0(wria, "_", temp_imp),
    rmz_ac_pct_swifd_in_temp = if_else(!swifd_any, -1*rmz_ac_pct_swifd_in_temp, rmz_ac_pct_swifd_in_temp)
    ) |> 
  ggplot() + wacolors::scale_fill_wa_c("gorge", reverse = T, aesthetics = c("fill","color")) +
  geom_col(aes(x = rmz_ac_pct_swifd_in_temp, y = wria_temp, fill = tree_pct_mean)) +
  geom_vline(xintercept = 0, linetype = 2, linewidth = 0.5) +
  facet_wrap(~wria, ncol = 1, scales = "free_y") + 
  theme(
    strip.background = element_blank(),
    strip.text = element_blank()
  ) +
  labs(x = "<----- no salmon        |        salmon ----->", y = NULL, 
       title = "Relative proportion of salmon occupied RMZ by temperature impairment status",
       subtitle = "Darker green indicates higher average tree cover")

#need to fuss with factors and facets
rde_st |> 
  filter(as.integer(as.character(wria)) < 26) |> 
  mutate(
    temp_swifd = paste0(temp_imp,"_", if_else(swifd_any,"salmon","none"))
    ,
    wria_temp = paste0(wria, "_", temp_imp),
    rmz_ac_pct_swifd_in_temp = if_else(!swifd_any, -1*rmz_ac_pct_swifd_in_temp, rmz_ac_pct_swifd_in_temp)
    ) |> 
  ggplot() + wacolors::scale_fill_wa_c("gorge", reverse = T, aesthetics = c("fill","color")) +
  geom_col(aes(x = rmz_ac_pct_swifd_in_temp, y = wria_temp, fill = tree_pct_mean)) +
  geom_vline(xintercept = 0, linetype = 2, linewidth = 0.5) +
  facet_wrap(~wria_temp, ncol = 2, drop = T, scales = "free_y") + 
  theme(
    strip.background = element_blank(),
    strip.text = element_blank()
  ) +
  labs(x = "<----- no salmon        |        salmon ----->", y = NULL, 
       title = "Relative proportion of salmon occupied RMZ by temperature impairment status",
       subtitle = "Darker green indicates higher average tree cover")

```

```{r gdb_tesselation_polygons, include=FALSE, eval=FALSE}
#tesselation polygons
#per-PID, can/do have EOW and both L and R bank RMZs as well as potentially other small 'parts'
f_gdb <- "~/T/DFW-Team WDFW Watershed Synthesis - data_common/SPTH_Tessellation.gdb/"
l <- st_layers(f_gdb)$name
```

```{r trying_for_high_level, include=FALSE, eval=FALSE}
#abs acres of temperature impairments
rde |> 
  summarise(
    across(rmz_ac, list(sum = ~sum(., na.rm = T))),
    .by = c(wria, temp_imp)
  ) |> 
  ggplot(aes(rmz_ac_sum, wria, fill = temp_imp)) + 
  geom_col(position = position_dodge(width = 1)) + 
  scale_x_log10() + 
  scale_fill_manual(values = c(cat123 = "grey", cat45 = "darkred")) #scale_fill_grey()

#not very interesting correlation between categories
rde |> 
  summarise(
    across(rmz_ac, list(sum = ~sum(., na.rm = T))),
    .by = c(wria, temp_imp)
  ) |> 
  pivot_wider(names_from = temp_imp, values_from = rmz_ac_sum) |> 
  ggplot(aes(cat123, cat45, size = cat123+cat45)) +
  #geom_abline(intercept = 0, slope = 1, linetype = 3) +
  geom_point() +
  scale_size_area() +
  scale_x_log10(
    labels = scales::label_comma(),
    #labels = scales::label_log()
    ) #  guides(x = guide_axis_logticks())


#temperature, salmon and trees all at once...
#trying to work out best way to show...
rde |> 
  summarise(
    across(rmz_ac, list(sum = ~sum(., na.rm = T))),
    across(ends_with("_pct"), list(mean = ~mean(., na.rm = T), sd = ~sd(., na.rm = T)))
    ,
    .by = c(wria, temp_imp, swifd_n_fct)
  ) |> 
  ggplot() + wacolors::scale_fill_wa_c("gorge", reverse = T, aesthetics = c("fill","color")) +
  # geom_col(aes(wria, rmz_ac_sum, fill = tree_pct_mean)) +
  # facet_wrap(temp_imp ~ swifd_n_fct, scales = "free")
  # geom_col(aes(wria, rmz_ac_sum, group = wria, fill = tree_pct_mean)) +
  # facet_wrap(~temp_imp, scales = "free")
  # geom_point(aes(swifd_n_fct, wria, size = rmz_ac_sum, color = tree_pct_mean)) +
  # facet_wrap(~temp_imp, scales = "free")
  geom_col(aes(rmz_ac_sum, paste(wria, temp_imp), fill = tree_pct_mean)) +
  facet_wrap(~swifd_n_fct, scales = "free")


rde |> 
  summarise(
    across(rmz_ac, list(sum = ~sum(., na.rm = T))),
    across(tree_pct, list(mean = ~mean(., na.rm = T), sd = ~sd(., na.rm = T)))
    ,
    .by = c(wria, temp_imp, swifd_n_fct)
  ) |> 
  ggplot() + wacolors::scale_fill_wa_c("gorge", reverse = T, aesthetics = c("fill","color")) +
  geom_pointrange(
    aes(x = tree_pct_mean, xmin = min(0, tree_pct_mean - tree_pct_sd), xmax = max(1, tree_pct_mean + tree_pct_sd),
        y = temp_imp,
        size = rmz_ac_sum, color = tree_pct_mean
    ), 
    fatten = 1,
    show.legend = F) +
  scale_size_area(max_size = 4) +
  #facet_wrap(~ wria + swifd_n_fct, ncol = 3, labeller = label_wrap_gen(multi_line = F), scales = "fixed")
  facet_grid(rows = vars(wria), cols = vars(swifd_n_fct), labeller = label_wrap_gen(multi_line = F)) +
  scale_x_continuous(labels = scales::label_percent()) +
  theme(axis.text.y = element_text(size = 6)) +
  labs(x = "Mean RMZ tree canopy %", y = NULL)

#below the line indicates lower average tree cover for temp-impaired salmon-bearing RMZs 
rde |> 
  summarise(
    across(rmz_ac, list(sum = ~sum(., na.rm = T))),
    across(tree_pct, list(mean = ~mean(., na.rm = T), sd = ~sd(., na.rm = T)))
    ,
    .by = c(wria, temp_imp, swifd_n_fct)
  ) |> 
  filter(swifd_n_fct != "none") |> 
  pivot_wider(names_from = temp_imp, values_from = where(is.numeric)) |> 
  ggplot(aes(
    tree_pct_mean_cat123, tree_pct_mean_cat45, group = wria
    )) +
  geom_text(aes(label = wria), size = 4, color = "grey40", nudge_x = 0.01, nudge_y = 0.01) +
  geom_point(aes(
                 shape = swifd_n_fct,
                 color = tree_pct_mean_cat123 - tree_pct_mean_cat45
                 )
             , size = 2.5
             #,show.legend = F
             ) +
  geom_abline(intercept = 0, slope = 1, linetype = 3) +
  wacolors::scale_fill_wa_c("stuart", midpoint = 0, aesthetics = c("fill","color")) +
  scale_size_area(max_size = 4) +
  scale_x_continuous(labels = scales::label_percent()) +
  scale_y_continuous(labels = scales::label_percent()) +
  facet_wrap(~swifd_n_fct) +
  guides(
    shape = guide_none(),
    color = guide_colorbar(title = expression("\u0394 tree% cat123-cat45"))
    ) +
  theme(legend.position = "top") +
  labs(title = "Average RMZ tree cover for temperature impaired vs not impaired salmon-bearing reaches",
  subtitle = "WRIAs below line indicate temp impaired reaches tend to have lower tree canopy")

```

:::
