---
title: "Assessing Washington's Riparian Land Cover"
author: "dan.auerbach@dfw.wa.gov"
date: "`r Sys.Date()`"
format:
  html:
    embed-resources: true
    theme: yeti 
    code-fold: true
    toc: true
    toc-location: left
    grid:
      sidebar-width: 180px
      body-width: 1100px
      margin-width: 20px
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 10)

library("tidyverse", quietly = T)
library("sf")
library("patchwork")
library("gt")
theme_set(theme_minimal()) 

dir_data_common <- "~/T/DFW-Team WDFW Watershed Synthesis - data_common"
epsg <- 2927 #WA state standard; NAD83(HARN)/ft
```

# Introduction

The term 'riparian' designates where streams and rivers meet and mingle with uplands. As with other ecological edges, this meeting place is host to many mutually enriching physical and biological exchanges. These hydro-geo-eco interactions are understood to provide numerous 'services' of value to people, leading to laws and policies seeking to protect more intact riparian areas and rehabilitate their degradation.

In Washington state, within the federal statutory context of the Clean Water Act, Endangered Species Act, and various others, the 'realized riparian regulatory regime' emerges from several land use frameworks including the Shoreline Management Act, the Forest Practices Act, and the Growth Management Act.

[...]
https://ofm.wa.gov/sites/default/files/public/publications/RiparianTaskforcePreliminaryRecommendationsMay2024.pdf
[...]

This analysis offers a landscape-scale perspective on conditions and changes within a simple, spatially-defined riparian corridor, using readily-available datasets to examine broad patterns that span numerous jurisdictions as well as substantial hydroclimate and habitat variation. A primary focus is on "urban" cover as an indicator of imperviousness. Impervious cover has statewide relevance in mesic (western) and semi-arid (eastern) regions, and is well-understood to be associated with ecohydrologic degradation.


# Data & methods 

The [`StreamCatTools`](https://github.com/USEPA/StreamCatTools) (Weber 2025) R package was used to access the [StreamCat dataset](https://www.epa.gov/national-aquatic-resource-surveys/streamcat-dataset) (Hill et al. 2016), which delivers consistently geoprocessed attribute values for each reach unit of the original medium resolution NHDPlus hydrography (derived from a 30m DEM and sometimes termed "1:100K"; this is the precursor to subsequent continental elevation derived hydrographic datasets NHDPlusHR from 10m DEM and 3DHP from LiDAR). For each reach 'comid', attribute values from many raster and rasterized datasets are calculated within the local contributing catchment ('`cat`') as well as a 100m riparian buffer ('`rp100`') on "stream lines and on-network NLCD water pixels". *Not yet using Ws/Wsrp100, but add description here if added below*

```{r objects_sf}
sf_wrias <- sf::read_sf(file.path(dir_data_common, "WR_WAT_WRIA.gdb/")) |>
  mutate(
    wria = factor(WRIA_NR),
    wria_nr_nm = paste0(str_pad(WRIA_NR,width = 2, pad = "0",),"_",WRIA_NM) |> factor()) |>
  select(WRIA_NR, WRIA_NM, wria, wria_nr_nm, acres = WRIA_AREA_ACR_QT) |> arrange(wria) |> 
  sf::st_transform(sf::st_crs(epsg))

##flowlines with WRIA added deduplicated via 'largest=T'
# sf_flw <- sf::read_sf(file.path(dir_data_common, "NHDPlus17/NHDSnapshot/Hydrography/NHDFlowline.shp")) |>
#   sf::st_transform(crs = sf::st_crs(epsg)) |>
#   sf::st_zm() |> 
#   select(COMID, FCODE, FTYPE, LENGTHKM) |> 
#   rename_with(tolower) |> 
#   st_join(sf_wrias |> select(wria, wria_nr_nm), left = F, largest = T) |> #inner join
#   mutate(comid = as.character(comid))
# saveRDS(sf_flw, file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_flw.rds"))
sf_flw <- readRDS(file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_flw.rds"))

# ##catchment polys with WRIA added deduplicated via 'largest=T'
# sf_cat <- sf::read_sf(file.path(dir_data_common, "NHDPlus17/NHDPlusCatchment/Catchment.shp")) |>
#   sf::st_transform(crs = sf::st_crs(epsg)) |>
#   select(comid = FEATUREID, areasqkm = AreaSqKM) |> 
#   st_join(sf_wrias |> select(wria, wria_nr_nm), left = F, largest = T) |> 
#   mutate(comid = as.character(comid))
# saveRDS(sf_cat, file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_cat.rds"))
sf_cat <- readRDS(file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_cat.rds"))

# distinct(as_tibble(sf_flw), comid) #66116
# distinct(as_tibble(sf_cat), comid) #57306
# #flowlines with no cat are most pipelines & canalditch (~3K), a third of coastline
# #but also many scattered streamriver and artificalpath statewide but large concentrations in yakima region
# #cat with no flowlines are edge cases, a pothole depressional area SE of Okanagon plus a few other scattered Eastside

```

StreamCat includes values calculated from 8 cycles of the National Land Cover Dataset: 2001, 2004, 2006, 2008, 2011, 2013, 2016, and 2019. The NLCD consists of a raster based on random forest classification of satellite and other imagery sources [(Wickham et al. 2023)](https://www.tandfonline.com/doi/full/10.1080/15481603.2023.2181143) These represent the percentages of each of 16 land cover classes within each of the *cat* and *catrp100* areas of interest  (AOI), so that the sum across classes is 1 for each AOI (i.e., the *rp100* area is spatially nested, but `rp100` percentages are provided as distinct rather than proportional to the total *cat* area). Approximate acreages were back-calculated as

$$ acres = pct_{nlcd-class} * areasqkm_{cat|catrp100} * 247.11$$.

The StreamCat process and NLCD datasets have undergone thorough QAQC and been extensively reviewed since their initial development, resulting in their widespread use in various scientific studies (see Wickham et al 2023 for the most recent NLCD validation study). Nonetheless, as with any remote sensed empirical data, some error unavoidably persists, and several key caveats are important to note.

  - The underlying hydrography flowlines and catchment polygon mesh have positional error; not all streams, drainage divides, and/or riparian buffer corridors are 'where they should be'.
  - Within any particular NLCD year, substantial 'on the ground' real-world land cover variation can occur within the 30m pixel resolution, such that the single assigned land cover class is the dominant spectral signature (i.e., on the per-pixel scale, classification accuracy is more likely to increase with homogeneity of cover types). 
  - Between different NLCD years, a change in NLCD class may be due to sudden, substantial activity (e.g., a clear cut; fallowing or crop rotation; a new parking lot); to gradual, accumulative shifts of the fine-scale mix of types within-pixel; or potentially to spurious imagery artifacts rather than ground-level change.

Accordingly, these data are a standardized, consistent means to investigate larger-scale, general or cumulative patterns. 
 
```{r objects_streamcat_nlcd}
## recall riparian buffers are 100m, per https://www.epa.gov/national-aquatic-resource-surveys/streamcat-dataset-readme 
 
# #pull all 4 AOI, including abs areasqkm
# sc_wa_nlcd <- map(
#   set_names(c(2001, 2004, 2006, 2008, 2011, 2013, 2016, 2019))
#   ,
#   ~StreamCatTools::sc_nlcd(
#     state = "WA", year = .x,
#     aoi = 'cat,catrp100,ws,wsrp100',
#     showAreaSqKm = T
#   ) |>
#     rename_with(tolower) |> as_tibble() |>
#     mutate(comid = as.character(comid), nlcd_year = .x)
# )
# saveRDS(sc_wa_nlcd, file.path(dir_data_common, "streamcat", "sc_wa_nlcd.rds"))

#starting object with cat and catrp100 (no Ws)
#inner_join of sf_cat to add WRIA
#dropping 231 comids with NA rp100
#converting pcts to 0-1
#appending 'ac[res]' cols as AOI-specific product of pct and areasqkm
sc_nlcd <- readRDS(file.path(dir_data_common, "streamcat", "sc_wa_nlcd.rds")) |> 
  map(
    ~.x |> 
      rename_with(
        ~str_remove(.,paste(c(2001, 2004, 2006, 2008, 2011, 2013, 2016, 2019),collapse = "|")) |> 
          str_remove("pct")
        ) |> 
      select(comid, nlcd_year, 
             catareasqkm, catareasqkmrp100,
             ends_with("cat"), ends_with("catrp100"))
      ) |> 
  list_rbind() |> 
  inner_join(as_tibble(sf_cat) |> select(comid, wria, wria_nr_nm), by = "comid") |> 
  drop_na(urbmdcatrp100) |> #single lu class captures all 231 comids NA for rp100 vals
  mutate(
    across(c(ends_with("cat"), ends_with("catrp100")), ~./100)
    ,
    # tree_cat = conifcat + decidcat + mxfstcat,
    # tree_catrp100 = conifcatrp100 + decidcatrp100 + mxfstcatrp100,
    urb_cat = urbhicat + urbmdcat,
    urb_catrp100 = urbhicatrp100 + urbmdcatrp100
    ,
    across(ends_with("cat"), list(ac = ~.* catareasqkm * 247.11)),
    across(ends_with("catrp100"), list(ac = ~.* catareasqkmrp100 * 247.11))
    )

#going fast, just presumes nlcd_class sorted alphabetically
pal_nlcd <- c("brown","darkgreen","yellow","green","yellowgreen",
              "yellow","seagreen","white","green","blue",
              "tan","grey10","grey30","grey60","grey80","seagreen")


```

urbop: <20% impv
urbloL 20-50% impv
urbmd: 50-79% impv
urbhi: >80% impv

*other/more*
  - (eastern US, comparison against 1m^2 urban cover showed very good agreement overall, somewhat worse for riparian exclusively)
    - https://www.usgs.gov/publications/accuracy-assessment-nlcd-2011-impervious-cover-data-chesapeake-bay-region-usa
  - bring back sc_imperv?
```{r pctimp_back, eval=F}
"~/T/DFW-Team WDFW Watershed Synthesis - data_common/streamcat/ImperviousSurfacesRipBuf100_WA.csv"
StreamCatTools::sc_get_data(
  comid = "23989097", metric = "pctimp2001",
  # state = "WA", year = .x,
  aoi = 'cat,catrp100,ws,wsrp100',
  showAreaSqKm = T
  ) |>
  rename_with(tolower) |> as_tibble()
sc_nlcd_2001 |> filter(comid =="23989097")

```


# A 2001 Baseline

```{r sc_nlcd_2001_sf_2001}
sc_nlcd_2001 <- sc_nlcd |> 
  filter(nlcd_year==2001) 

sf_flw_catrp100_2001 <- sf_flw |> 
  inner_join(
    select(sc_nlcd_2001, comid, ends_with("catrp100")),
    by = "comid"
  )
sf_cat_cat_2001 <- sf_cat |> 
  inner_join(
    select(sc_nlcd_2001, comid, ends_with("cat")),
    by = "comid"
  )
```

```{r statewide_area_overall}
sc_nlcd_2001 |> 
  summarise(across(contains("areasqkm"), sum)) |> 
  pivot_longer(contains("areasqkm"), names_to = "aoi", values_to = "sqkm") |> 
  mutate(
    aoi = str_remove(aoi, "areasqkm"),
    ac = sqkm * 247.11) |> 
  gt() |> fmt_number(decimals = 0)
```

```{r statewide_area_cat_rp100}
sc_nlcd_2001 |> 
  select(comid, contains("_ac"), -contains("urb_")) |> 
  summarise(across(contains("_ac"), sum)) |> 
  pivot_longer(contains("_ac")) |> 
  mutate(
    aoi = if_else(str_detect(name, "rp100"), "rp100", "cat"),
    nlcd_class = str_remove(name, "cat") |> str_remove("rp100") |> str_remove("_ac"),
    name = NULL
    ) |> 
  pivot_wider(names_from = aoi, values_from = value) |>
#recall these acreages are still nested: 
#catareasqkm includes catareasqkmrp100
  mutate(
    rp100_pct_cat = rp100 / cat, 
    across(c(cat, rp100), list(pct = ~./sum(.)))
    ) |> 
  arrange(nlcd_class) |> 
  gt() |> 
  fmt_number(c("cat","rp100"), decimals = 0) |> 
  fmt_percent(contains("pct"), decimals = 1) |> 
  data_color(palette = pal_nlcd)

```


```{r ggstatewide_urb_tree}
{ 
ggplot() +
  geom_sf(data = sf_flw_catrp100_2001, aes(color = urbmdcatrp100+urbhicatrp100)) +
  scale_color_gradient(low = "lightblue", high = "grey20") +
  labs(subtitle = "2001") + theme_minimal()
}+{
ggplot() +
  geom_sf(data = sf_cat_cat_2001, aes(fill = conifcat+decidcat+mxfstcat), color = NA) +
  scale_fill_gradient(low = "grey90", high = "darkgreen") +
  labs(subtitle = "2001") + theme_minimal()
} + plot_layout(ncol = 1)

```

```{r}
sc_nlcd_2001

```

-describe 2001: maps, distributions, tables
  - rp100 vs cat
-describe 2001-2019 change
  - urban increases
    - rp100
    - rp100 vs cat
  - other nlcd_class changes: mix of tree loss and other class shifts
    - focus on rp100?

# Citations

Hill, Ryan A., Marc H. Weber, Scott G. Leibowitz, Anthony R. Olsen, and Darren J. Thornbrugh, 2016. The Stream-Catchment (StreamCat) Dataset: A Database of Watershed Metrics for the Conterminous United States. Journal of the American Water Resources Association (JAWRA) 52:120-128. DOI: 10.1111/1752-1688.12372.

Weber M (2025). _StreamCatTools: Tools to Work with the StreamCat API Within R and Access the Full Suite of StreamCat and LakeCat Metrics_. R package version 0.6.0, commit d8a8cce142e7cb9e3666a2660a8315a1766e5981, <https://github.com/USEPA/StreamCatTools>.

:::

```{r streamcat_nlcd_overall_LUclass_EDA}
## overall spatial patterns of streamcat NLCD classes
## parsing to determine whether/how to drop and/or aggregate classes

sc_nlcd_cat <- readRDS(file.path(dir_data_common, "streamcat", "sc_wa_nlcd.rds")) |> 
  map(
    ~.x |> 
      rename_with(~str_remove(.,paste(c(2001, 2004, 2006, 2008, 2011, 2013, 2016, 2019),collapse = "|")) |> 
                    str_remove("pct")) |> 
      select(comid, nlcd_year, catareasqkm, ends_with("cat"))
      ) |> 
  list_rbind() |> 
# distinct(comid, .keep_all = T) |>  #57313
#   anti_join(as_tibble(sf_cat), by ="comid")
  inner_join(
    as_tibble(sf_cat) |> select(comid, wria, wria_nr_nm), by = "comid"
  )

#all classes all years by wria
sc_nlcd_cat_ac_year_wria <- sc_nlcd_cat |> 
  mutate(
    across(ends_with("cat"), ~./100*catareasqkm*247.11)
  ) |> 
  summarise(
    across(ends_with("cat"), sum),
    .by = c(nlcd_year, wria, wria_nr_nm)
  ) |> 
  pivot_longer(-c(nlcd_year,wria,wria_nr_nm), names_to = "nlcd_class", values_to = "ac") |> 
  mutate(nlcd_class = str_remove(nlcd_class, "cat"))

##statewide totals by nlcd_year
# #as statewide pct; think this may be more misleading than helpful
# sc_nlcd_cat_ac_year_wria |> 
#   summarise(ac = sum(ac), .by = c(nlcd_year, nlcd_class)) |> 
#   mutate(pct = ac/sum(ac), .by = nlcd_year) |> 
#   ggplot() + 
#   geom_col(aes(nlcd_year, pct, fill = nlcd_class, color = nlcd_class), show.legend = F) +
#   facet_wrap(~nlcd_class)
#as abs acres
sc_nlcd_cat_ac_year_wria |> 
  summarise(ac = sum(ac), .by = c(nlcd_year, nlcd_class)) |> 
  ggplot() + geom_col(aes(nlcd_year, ac, fill = nlcd_class, color = nlcd_class), show.legend = F) +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~nlcd_class, scales = "free")
#acres, urban only; did not expect to see decline in urbop
#but major potential conflation with other class switches
sc_nlcd_cat_ac_year_wria |> 
  filter(str_detect(nlcd_class, "urb")) |> 
  summarise(ac = sum(ac), .by = c(nlcd_year, nlcd_class)) |> 
  ggplot() + 
  geom_col(aes(nlcd_year, ac, fill = nlcd_class, color = nlcd_class), show.legend = F) +
  scale_color_grey(aesthetics = c("fill","color")) +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~nlcd_class)

#overall changes across nlcd classes and wrias
#could calc running diff() but start with 2019-2001
#this is 'too much' but also useful for narrowing
#statewide drop in urbop mostly wria 62, 49, 41, 43 --> looks mostly switched into urbmd
#multiwria 22-28 increases in wdwet seem likely timber regrowth given accompanying decreases in bl+mxfst+shrb
#decrease in wria4 ow points towards misclass artifact, unless baker and ross lakes have really shrunk a lot
sc_nlcd_cat_ac_year_wria |> 
  filter(nlcd_year %in% c(2001, 2019)) |> 
  pivot_wider(names_from = nlcd_year, values_from = ac) |> 
  mutate(
    d1901 = `2019`-`2001`,
    d1901pct = d1901/`2001`
    ) |> 
  ggplot() +
  geom_col(aes(d1901, wria, fill = nlcd_class, alpha = d1901 > 0), show.legend = F) +
  scale_alpha_manual(values = c(0.3,0.8)) +
  geom_vline(xintercept = 0) +
  facet_wrap(~nlcd_class, nrow = 1, scales = "free")
#another version, harvest and/or fire dominate when the unit is untransformed acres
#commented lines confirm that all urbhi and urbmd changes are increases
sc_nlcd_cat_ac_year_wria |> 
  filter(    
    str_detect(nlcd_class, "ice|ow", negate = T),
    nlcd_year %in% c(2001, 2019)
    ) |> 
  pivot_wider(names_from = nlcd_year, values_from = ac) |> 
  mutate(d1901 = `2019`-`2001`) |>
  select(-c(`2001`,`2019`)) |> 
  arrange(nlcd_class) |> 
  #pivot_wider(names_from = nlcd_class, values_from = d1901) |> 
  ## GGally::ggpairs(columns = 3:16, mapping = aes(size = 0.5, alpha = 0.5))
  #count(urbhi > 0, urbmd > 0)
  ggplot() + geom_point(aes(nlcd_class, wria_nr_nm, size = abs(d1901), color = d1901)) + wacolors::scale_color_wa_c("lopez", midpoint = 0)

#per-wria class changes between 2001 and 2019
#focusing on wria subset
#these 4 westside all have increased conif & decreased shrb
sc_nlcd_cat_ac_year_wria |> 
  filter(    
    str_detect(nlcd_class, "ice", negate = T),
    nlcd_year %in% c(2001, 2019)
    ) |> 
  pivot_wider(names_from = nlcd_year, values_from = ac) |> 
  mutate(d1901 = `2019`-`2001`) |> 
  #filter(wria=="57") |> arrange(d1901) |> 
  filter(wria %in% c("28","37","49","57", 
                     "8","9","10","15")) |> 
  ggplot() +
  geom_col(aes(nlcd_class, d1901, fill = nlcd_class), show.legend = F) +
  facet_wrap(~wria_nr_nm, nrow = 2, scales = "free", strip.position = "right")

#can ignore ice and open water and could combine urbhi+urbmd
#such that prelim cat-vs-rp100 was probably not wildly off for the urban part
#BUT combining 'tree' types looks much less clean/clear, as shrb/bl etc. vary by wria/region
#SO due to contrasting directions of change between classes across wrias, 
#and heterogeneity/conflation of different within-wria locations in wria-total change, 
#rather than initial approach of aggregating classes and summarizing by wria
#appears preferable to spatially-focus on comids with a change of interest
#then examine change in other classes

#orig questions: what's the deficit and how's it changing?
#"how well is washington's land use regulatory regime working to direct loss of natural cover away from a riparian corridor?"



### pct-based viz
#ignoring years, per-wria distrib pct-tree
sc_nlcd_cat_ac |> 
  ggplot() + geom_boxplot(aes(tree_cat, fct_reorder(wria, tree_cat)), varwidth = T)
#ignoring years, contrasting rp100 vs wria-wide
sc_nlcd_cat_ac |> 
  select(comid, nlcd_year, wria, tree_cat, tree_catrp100) |> 
  pivot_longer(cols = contains("tree"), values_to = "pct") |> 
  ggplot() + geom_boxplot(aes(pct, fct_reorder(wria, pct), color = name), varwidth = T)
#ignoring years, per-wria distrib of per-local spatial diff riparian-vs-whole
#positive: %treed in riparian corr greater than local catch as whole
#but these distributions of differences ignore 'starting point' of higher/lower pcts
sc_nlcd_cat_ac |> 
  select(comid, nlcd_year, wria, tree_cat, tree_catrp100) |> 
  mutate(d_tree = tree_catrp100 - tree_cat) |> 
  ggplot() + geom_boxplot(aes(d_tree, fct_reorder(wria, d_tree)), varwidth = T)
#so ordinate diffs by riparian treed
#within each nlcd_year, d_tree>0 indicates locally 'relatively-more-treed-than-overall' riparian for a given level of %treed
#larger d_tree at larger tree_catrp suggests more 'green ribbon'-like conditions with untreed upland
sc_nlcd_cat_ac_dtree <- sc_nlcd_cat_ac |> 
  filter(nlcd_year %in% c(2001, 2019)) |> 
  select(comid, nlcd_year, wria, tree_cat, tree_catrp100) |> 
  mutate(d_tree = tree_catrp100 - tree_cat) 
sc_nlcd_cat_ac_dtree |> 
  ggplot() + geom_point(aes(tree_catrp100, d_tree, color = factor(nlcd_year)), alpha = 0.1, size = 0.2) +
  annotate("segment", x = 0.05, y = -1.05, xend = 0.95, yend = -1.05, arrow = arrow()) +
  annotate("text", x = 0.15, y = -1, label = "higher riparian %tree cover", hjust = 0) +
  annotate("segment", x = -0.05, y = -1.05, xend = -0.05, yend = 1.05, arrow = arrow()) +
  annotate("text", x = -0.01, y = 0.5, label = "greater difference \nriparian vs whole-cat %tree cover", hjust = 0) +
  wacolors::scale_color_wa_d() +
  facet_wrap(~nlcd_year)
#following is difficult to intuit...
#calc'd as temporal diff in spatial diff: (rip19-cat19) - (rip01-cat01)
# best-case? positive d19 is more positive than a negative or positive d01?
sc_nlcd_cat_ac_dtree |> 
  pivot_wider(names_from = nlcd_year, values_from = contains("tree")) |> 
  mutate(`d_tree_2019-2001` = d_tree_2019 - d_tree_2001) |> 
  ggplot() +
  geom_point(aes(d_tree_2019, `d_tree_2019-2001`, size = tree_catrp100_2019, color = wria), alpha = 0.1, show.legend = F) +
  scale_size_area()
#spatial-diff ordinated t2 vs t1
sc_nlcd_cat_ac_dtree |> 
  pivot_wider(names_from = nlcd_year, values_from = contains("tree")) |> 
  ggplot() +
  geom_point(aes(d_tree_2001, d_tree_2019, size = tree_catrp100_2019, color = wria), alpha = 0.2, show.legend = F)
#best of a dubious bunch? calc then ordinate each temporal diff per spatial-extent
sc_nlcd_cat_ac_dtree |> 
  pivot_wider(names_from = nlcd_year, values_from = contains("tree")) |> 
  mutate(
    d_cat_1901 = tree_cat_2019 - tree_cat_2001,
    d_catrp100_1901 = tree_catrp100_2019 - tree_catrp100_2001
  ) |> 
  ggplot() +
  geom_point(aes(d_cat_1901, d_catrp100_1901, size = tree_catrp100_2019, color = wria), alpha = 0.2, show.legend = F) +
    annotate("segment", x = -1, y = -1.05, xend = 1, yend = -1.05, arrow = arrow()) +
  annotate("text", x = 0, y = -.95, label = "greater whole local catchment\n %tree in 2019 vs 2001", hjust = 0) +
  annotate("segment", x = -1.05, y = -1, xend = -1.05, yend = 1, arrow = arrow()) +
  annotate("text", x = -1, y = 0.85, label = "greater riparian %tree cover in 2019 vs 2001", hjust = 0)

#urban flipside, sort of interesting to see in the same 'unit space'?
#but still visually compromised by not having 'starting point' in the picture
#such that +5% between years means very different things from 75% vs 0%
sc_nlcd_cat_ac |> 
  filter(nlcd_year %in% c(2001, 2019)) |> 
  select(comid, nlcd_year, wria, urb_cat, urb_catrp100) |> 
  pivot_wider(names_from = nlcd_year, values_from = contains("urb")) |> 
  mutate(
    d_cat_1901 = urb_cat_2019 - urb_cat_2001,
    d_catrp100_1901 = urb_catrp100_2019 - urb_catrp100_2001
  ) |> 
  ggplot() +
  geom_point(aes(d_cat_1901, d_catrp100_1901, size = urb_catrp100_2019, color = wria), alpha = 0.2, show.legend = F) +
    annotate("segment", x = -1, y = -1.05, xend = 1, yend = -1.05, arrow = arrow()) +
  annotate("text", x = 0, y = -.95, label = "greater whole local catchment\n %urban in 2019 vs 2001", hjust = 0) +
  annotate("segment", x = -1.05, y = -1, xend = -1.05, yend = 1, arrow = arrow()) +
  annotate("text", x = -1, y = 0.85, label = "greater riparian %urban cover in 2019 vs 2001", hjust = 0)

#segments better than points
#steeper/more vertical indicates greater riparian increase than encompassing
#versus flatter for surrounding increases without riparian
wrias <- as.character(c(1,7,8,10,15, 28,32,37,45,57))
#define comids with non-zero urban cover in final NLCD year; could threshold to larger %
#drop second filter condition if not focusing the tree change on only those comids with +urban
#first look showed qualitatively similar and just including many more 'rural' cats
#further below created vector of 'urban in rp100' comids to limit even more
comid_2019_urb <- sc_nlcd_cat_ac |> 
  #ggplot() + stat_ecdf(aes(urbmdcat + urbhicat, color = factor(nlcd_year)))
  #summarise(q = quantile(urbmdcat + urbhicat, p = 0.75), .by = nlcd_year)
  filter(nlcd_year == 2019, (urbmdcat + urbhicat > 0)) |> 
  pull(comid)

{
  sc_nlcd_cat_ac |> 
    filter(nlcd_year %in% c(2001, 2019), comid %in% comid_2019_urb) |> 
    select(comid, nlcd_year, wria, wria_nr_nm,
           starts_with("urb_")) |> 
    pivot_wider(names_from = nlcd_year, values_from = contains("cat")) |>
    mutate(
      d_cat = urb_cat_2019 - urb_cat_2001,
      d_catrp100 = urb_catrp100_2019 - urb_catrp100_2001
    ) |> 
    filter(wria %in% wrias) |> 
    ggplot() + 
    geom_segment(aes(
      x = urb_cat_2001, y = urb_catrp100_2001,
      xend = urb_cat_2019, yend = urb_catrp100_2019,
      color = d_cat - d_catrp100 
    ),
    arrow = arrow(length = unit(0.05,"npc")),
    show.legend = T) +
    geom_abline(slope = 1, intercept = 0, linetype = 3) +
    wacolors::scale_color_wa_c("lopez", midpoint = 0) +
    scale_x_continuous(labels = scales::percent) +
    scale_y_continuous(labels = scales::percent) +
    facet_wrap(~wria_nr_nm, ncol = 1, strip.position = "right") +
    theme(strip.text = element_text(size = 5), legend.position = "top") +
    labs(
      title = "2001 to 2019 urban cover change",
      subtitle = "StreamCat NLCD %urban high+medium",
      x = "whole local catchment",
      y = "100m riparian corridor %urban"
    )
}+{
  sc_nlcd_cat_ac |> 
    filter(nlcd_year %in% c(2001, 2019), comid %in% comid_2019_urb) |> 
    select(comid, nlcd_year, wria, wria_nr_nm,
           starts_with("tree_")) |> 
    pivot_wider(names_from = nlcd_year, values_from = contains("cat")) |>
    mutate(
      d_cat = tree_cat_2019 - tree_cat_2001,
      d_catrp100 = tree_catrp100_2019 - tree_catrp100_2001
      , 
      d_catrp100f = case_when(
        d_catrp100 < 0 & d_cat < 0 ~ "both dec",
        d_catrp100 >= 0 & d_cat >= 0 ~ "both inc",
        d_catrp100 < 0 & d_cat >= 0 ~ "rp100 dec",
        d_catrp100 >= 0 & d_cat < 0 ~ "cat dec"
      )
    ) |>
    filter(wria %in% wrias) |> 
    #filter(d_catrp100f=="rp100 dec") |> summarise(across(contains("ac_"), sum), .by = wria_nr_nm)
    summarise(across(contains("ac_"), sum), .by = c(d_catrp100f, wria_nr_nm)) |> 
    mutate(
      d_cat_ac = tree_cat_ac_2019 - tree_cat_ac_2001,
      d_catrp100_ac = tree_catrp100_ac_2019 - tree_catrp100_ac_2001
    ) |> 
    select(wria_nr_nm, d_catrp100f, contains("cat_"), contains("catrp100_")) |> 
    arrange(wria_nr_nm, d_catrp100f) |> 
    gt(groupname_col = "wria_nr_nm", rowname_col = "d_catrp100f") |> fmt_number(decimals = 0) |> 
    tab_style_body(fn = \(x){x<0}, style = cell_text(color = "red"))
  ggplot() + 
    geom_segment(aes(
      x = tree_cat_2001, y = tree_catrp100_2001,
      xend = tree_cat_2019, yend = tree_catrp100_2019,
      color = d_catrp100
    ),
    arrow = arrow(length = unit(0.05,"npc")),
    show.legend = T) +
    geom_abline(slope = 1, intercept = 0, linetype = 3) +
    wacolors::scale_color_wa_c("stuart", midpoint = 0) +
    scale_x_continuous(labels = scales::percent) +
    scale_y_continuous(labels = scales::percent) +
    facet_wrap(~wria_nr_nm+d_catrp100f, ncol = 4, 
               labeller = label_wrap_gen(multi_line = F),
               strip.position = "right") +
    theme(strip.text = element_text(size = 5), legend.position = "top") +
    labs(
      title = "2001 to 2019 tree cover change",
      subtitle = "StreamCat NLCD %confi+decid+mxfst; comids with urban > 0 in 2019",
      x = "whole local catchment",
      y = "100m riparian corridor %tree"
    )
} + 
  plot_layout(widths = c(1,4)/5,guides = "keep")

#increased riparian urban cover is not exclusively correlated with decreased tree cover
sc_nlcd_cat_ac |> 
  filter(nlcd_year %in% c(2001, 2019), comid %in% comid_2019_urb) |> 
  select(comid, nlcd_year, wria, wria_nr_nm,
         starts_with("urb_") & ends_with("ac"),
         starts_with("tree_") & ends_with("ac")
         ) |> 
  pivot_wider(names_from = nlcd_year, values_from = contains("cat")) |>
  mutate(
    d_cat_ac_urb = urb_cat_ac_2019 - urb_cat_ac_2001,
    d_cat_ac_tree = tree_cat_ac_2019 - tree_cat_ac_2001,

    d_catrp100_ac_urb = urb_catrp100_ac_2019 - urb_catrp100_ac_2001,
    d_catrp100_ac_tree = tree_catrp100_ac_2019 - tree_catrp100_ac_2001
  ) |> 
  filter(wria %in% wrias) |> 
  ggplot() +
  geom_point(aes(d_catrp100_ac_urb, d_catrp100_ac_tree, color = wria), alpha = 0.5, size = 0.5, show.legend = F) +
  geom_smooth(aes(d_catrp100_ac_urb, d_catrp100_ac_tree, color = wria), show.legend = F) +
  geom_hline(yintercept = 0) +
  facet_wrap(~wria, nrow = 2, scales = "free") +
  labs(
    title = "Increased riparian urban cover is not exclusively correlated with decreased tree cover",
    subtitle = "StreamCat NLCD 2019-2001, comids with non-zero urban in 2019")

#what changes where urban increases?
#focus first on locations with nonzero RP100 urban in 2019
comid_2019_urb_rp100 <- sc_nlcd_cat_ac |> 
  filter(nlcd_year == 2019, (urbmdcatrp100 + urbhicatrp100 > 0)) |> 
  pull(comid)


sc_nlcd_cat_ac |> 
  filter(nlcd_year %in% c(2001, 2019), comid %in% comid_2019_urb_rp100) |> 
  select(wria, wria_nr_nm, comid, nlcd_year, contains("rp100") & ends_with("_ac")) |> 
  #filter(nlcd_year==2019) |> summary()
  pivot_longer(-c(wria, wria_nr_nm, comid, nlcd_year), names_to = "nlcd_class") |> 
  pivot_wider(names_from = nlcd_year,
              #names_prefix = "nlcd_", 
              values_from = value) |> 
  mutate(d = `2019` - `2001`) |> #mutate(d = nlcd_2019 - nlcd_2001) |> 
  # pivot_wider(names_from = name, values_from = c(d, `2019`, `2001`)) |> 
  filter(
    str_detect(nlcd_class, "urb_|tree_", negate = T),
    `2001`+`2019` > 0 #drop classes with zero cover both year
    ) |> 
  #ignore classes with no change in comid
  filter(abs(d) > 0) |> 
  filter(wria == "15") |> 
  # #big change comids
  filter(abs(d) < 50) |> 
  # #focal comids with larger urb gains
  # filter(nlcd_class == "urbmdcatrp100_ac", d > 10) |> pull(comid) -> urbmdgain
  ggplot() +
  # # #quasi heatmap
  # # geom_point(aes(fct_reorder(comid, d, min), nlcd_class, color = d)) +
  # # scale_color_gradient2(midpoint = 0) +
  # # scale_size_area(max_size = 4) +
  # #rotated parallel coord
  # geom_point(aes(nlcd_class, d, group = comid, color = nlcd_class), size = 0.6, show.legend = F) +
  # geom_line(aes(nlcd_class, d, group = comid), linewidth = 0.1, alpha = 0.3) +
  # coord_flip() +
  #problem with 'avg' change per class is that it blends different comid-specific shifts?
  geom_vline(xintercept = 0) +
  geom_jitter(aes(d, nlcd_class, color = nlcd_class), size = 0.5, alpha = 0.5, show.legend = F) +
  geom_boxplot(aes(d, nlcd_class, color = nlcd_class), fill = NA, varwidth = T, outliers = F, show.legend = F) +
  scale_color_manual(values = pal_nlcd) +
  facet_wrap(~wria, scales = "free_x") +
  theme(panel.grid = element_blank()) 

#closer look at 2 big rp100 changes, gain conif lose shrb
x <- sf_cat |> filter(comid %in% c("23990429", "24288108"))
y <- sf_flw |> filter(comid %in% c("23990429", "24288108")) |> st_buffer(dist = 300)
mapview(x) + mapview(y) 
#just E of Tahuya SF and E of Union R outlet, rp100 looks more S in cat, E of 'carney lake'
#plainly some regrowth of cut patches between 2001 and 2019 for 24288108
#and for 23990429, appears to be 
#https://earthengine.google.com/timelapse#v=47.46993,-122.80657,11.104,latLng&t=3.53&ps=50&bt=19840101&et=20221231

d <- sc_nlcd_cat_ac |> 
  filter(comid %in% urbmdgain) |> 
  select(wria, wria_nr_nm, comid, nlcd_year, contains("rp100") & ends_with("_ac")) |> 
  pivot_longer(-c(wria, wria_nr_nm, comid, nlcd_year), names_to = "nlcd_class") |> 
  filter(str_detect(nlcd_class, "ice|urb_|tree_", negate = T)) |> 
  arrange(comid, nlcd_year, desc(nlcd_class))
{d |> 
  ggplot(aes(nlcd_year, value, color=nlcd_class, fill=nlcd_class, group = comid)) +
  geom_col() +
  scale_color_manual(values = pal_nlcd, aesthetics = c("color","fill")) +
  facet_wrap(~comid, ncol = 1, scales = "free") + labs(y = "acres")
}+{
  d |> 
  ggplot(aes(nlcd_year, value, color=nlcd_class, fill=nlcd_class, group = nlcd_class)) +
  geom_line(show.legend = F) +
  scale_color_manual(values = pal_nlcd, aesthetics = c("color","fill")) +
  facet_wrap(~comid, ncol = 1, scales = "free") + labs(y = "acres")
} + plot_layout(guides = "keep")

#turns out to be N Bremerton, making the 'densification' plausible
x <- sf_cat |> filter(comid %in% c("23989097"))
y <- sf_flw |> filter(comid %in% c("23989097")) |> st_buffer(dist = 300)
mapview(x) + mapview(y) 

d |> 
  filter(
    nlcd_year %in% c(2001, 2019),
    comid %in% c("23989097")
    ) |> 
  pivot_wider(names_from = nlcd_year, values_from = value) |> 
  mutate(d = `2019` - `2001`) |> 
  arrange(desc(d))

#function to plot all-nlcd_class series, passed comid(s) as arg

```

```{r SUPERSEDED_BUT_WITH_USEFUL_RP100_cat_d_urb_then_tree}
#wrangle saved list by year to single tibble
#strip year from colnames, and condensing categories: 
#focus on urban 'high'+'medium', 4 tree categories 
#recognize that rp100 is nested rather than spatial difference/set complement when contrasted with encompassing catchment NLCD LU
sc_urb_tree <- readRDS(file.path(dir_data_common, "streamcat", "sc_wa_nlcd.rds")) |> 
  map(
    ~.x |> 
      rename_with(~str_remove(.,paste(c(2001, 2004, 2006, 2008, 2011, 2013, 2016, 2019),collapse = "|")) |> 
                    str_remove("pct")) |> 
      select(comid, nlcd_year, contains("areasqkm"),
             contains("urbmd"), contains("urbhi"), 
             contains("wdwet"), contains("mxfst"), contains("decid"), contains("conif")
      ) |> 
      mutate(
        urb_cat = urbmdcat + urbhicat,
        urb_ws = urbmdws + urbhiws,
        tree_cat = wdwetcat + mxfstcat + decidcat + conifcat,
        tree_ws = wdwetws + mxfstws + decidws + conifws
        ,
        urb_catrp100 = urbmdcatrp100 + urbhicatrp100,
        urb_wsrp100 = urbmdwsrp100 + urbhiwsrp100,
        tree_catrp100 = wdwetcatrp100 + mxfstcatrp100 + decidcatrp100 + conifcatrp100,
        tree_wsrp100 = wdwetwsrp100 + mxfstwsrp100 + decidwsrp100 + conifwsrp100
      ) |> 
      select(comid, nlcd_year, 
             contains("areasqkm"), 
             areasqkm_cat = catareasqkm, areasqkm_ws = wsareasqkm,
             areasqkm_catrp100 = catareasqkmrp100, areasqkm_wsrp100 = wsareasqkmrp100,
             ends_with("_cat"), ends_with("_catrp100"),
             ends_with("_ws"), ends_with("_wsrp100"))
  ) |> 
  list_rbind()

#break apart then rejoin to get areas by AOI, duplicated by LC
sc_urb_tree <- left_join(
  sc_urb_tree |> 
    select(comid, nlcd_year, contains("areasqkm")) |> 
    pivot_longer(cols = -c(comid, nlcd_year), values_to = "areasqkm") |> 
    mutate(aoi = str_remove(name, "areasqkm_"), name = NULL)
  ,
  sc_urb_tree |> 
    select(comid, nlcd_year, contains("urb"),contains("tree")) |> 
    pivot_longer(cols = -c(comid, nlcd_year), values_to = "pct") |> 
    separate(name, c("lc", "aoi")) |> 
    mutate(pct = round(pct/100, 4))
  ,
  by = c("comid", "nlcd_year", "aoi")
)

#per-nlcd-year 'spatial diff' of whole-cat-pct vs/minus riparian-pct
#positive indicating higher proportion of riparian 'urban' or treed
#random testing shows 'urban' can be roads...often near water
cat_d <- sc_urb_tree |> 
  mutate(acres = 247.11 * areasqkm * pct) |>
  filter(str_detect(aoi,"cat")) |> 
  pivot_wider(names_from = aoi, values_from = c(areasqkm, pct, acres)) |> 
  arrange(comid, nlcd_year)

#### urban ---------

# cat_d |> 
#   filter(str_detect(lc,"urb")) |> 
#   mutate(
#     # d_pct = pct_cat - pct_catrp100,
#     # d_acres = acres_cat - acres_catrp100
#     prop_rp100 = acres_catrp100 / acres_cat
#   )

#first look statewide, indicating that at least in some coarse sense,
#regulations have been steering 'urban' away from the riparian corridor 
cat_d |> 
  filter(str_detect(lc,"urb")) |> 
  summarise(
    across(starts_with("acres"), ~sum(., na.rm = T)),
    .by = c(lc, nlcd_year)
  ) |> 
  pivot_longer(cols = starts_with("acres"), names_to = "aoi", values_to = "acres") |> 
  mutate(
    aoi = if_else(str_detect(aoi, "rp100"), "Riparian 100m", "Local catchment")
  ) |> 
  ggplot() + 
  geom_col(aes(nlcd_year, acres, fill = aoi)) + 
  scale_fill_grey("Extent") +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Urban land cover, total vs riparian corridor",
    subtitle = "Sum of NLCD urban 'medium' and 'high' classes in StreamCat NHDplus 1:100K"
    )

cat_d_urb_wria <- sf_flw |> 
  as_tibble() |> 
  select(-fcode, -geometry) |> 
  distinct(comid, .keep_all = T) |> #enforce a single wria per comid
  inner_join(filter(cat_d, str_detect(lc,"urb")), by = "comid") |> 
  # #summary()
  # ##comids with NA wria are border edges
  # filter(is.na(wria)) |> distinct(comid) -> no_wria
  # semi_join(sf_flw, no_wria, by = "comid") |> ggplot() + geom_sf(aes(fill = fcode))
  drop_na(wria) |> 
  summarise(
    across(c(lengthkm, starts_with("acres")), ~sum(., na.rm = T)),
    .by = c(lc, nlcd_year, wria, wria_nr_nm)
  )

#geom_col by WRIA, abs area per cat/catrp100
cat_d_urb_wria |> 
  pivot_longer(cols = starts_with("acres"), names_to = "aoi", values_to = "acres") |> 
  mutate(
    aoi = if_else(str_detect(aoi, "rp100"), "Riparian 100m", "Local catchment")
  ) |> 
  ggplot() +
  geom_col(aes(nlcd_year, acres, fill = aoi)) + 
  scale_fill_grey("Extent") +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~wria, scales = "free_y")

#geom_line by WRIA: total urban, riparian corridor urban, and riparian as proportion of total
d <- cat_d_urb_wria |>
  mutate(riparian_proportion_of_total = acres_catrp100 / acres_cat)
d |> arrange(desc(riparian_proportion_of_total))

{
  ggplot(d) +
    geom_line(aes(nlcd_year, acres_cat, group = wria), color = "grey20", linewidth = 0.2) + 
    geom_smooth(aes(nlcd_year, acres_cat), color = "grey20", linewidth = 1.5, linetype = 2) + 
    scale_y_continuous(labels = scales::comma) +
    #facet_wrap(~wria, ncol = 1, strip.position = "right") +
    labs(subtitle = "Total urban extent has increased...")
  }+{
    ggplot() +
      geom_line(data = d, aes(nlcd_year, acres_catrp100, group = wria), color = "grey70", linewidth = 0.3) + 
      geom_smooth(data = d, aes(nlcd_year, acres_catrp100), color = "grey70", linewidth = 1.5, linetype = 2) + 
      geom_text(data = filter(d, nlcd_year == 2019),
                x = 2019.5, aes(y = acres_catrp100, label = wria), color = "grey70", size = 2) + 
      scale_y_continuous(labels = scales::comma) +
      #facet_wrap(~wria, ncol = 1, strip.position = "right") +
      labs(subtitle = "and so has urban cover in a 100m riparian corridor\n around major streams and rivers...")
  }+{
    ggplot() +
      geom_line(data = d, aes(nlcd_year, riparian_proportion_of_total, group = wria), color = "orange") + 
      geom_smooth(data = d, aes(nlcd_year, riparian_proportion_of_total), color = "orange", linewidth = 1.5, linetype = 2) + 
      geom_text(data = filter(d, nlcd_year == 2019),
                x = 2019.5, aes(y = riparian_proportion_of_total, label = wria), color = "orange", size = 2) +
      scale_y_continuous(labels = scales::percent) +
      #facet_wrap(~wria, ncol = 1, strip.position = "right") +
      labs(subtitle = "\nbut mostly at a flat or slower rate")
  } + plot_layout(nrow = 1, guides = "collect")

#geom_sf single wria catchments in time
sf_cat |> 
  filter(wria=="16") |>
  distinct(comid, .keep_all = T) |> #enforce a single wria per comid
  inner_join(
    cat_d |> 
      filter(str_detect(lc,"urb")) 
    , by = "comid") |>
  select(comid, contains("wria"), nlcd_year, contains("cat")) |> 
  pivot_longer(cols = starts_with("acres"), values_to = "ac") |> 
  ggplot() +
  geom_sf(aes(fill = ac), color = NA) +
  scale_fill_gradient(low = "tan",high = "grey30") +
  facet_wrap(~name+nlcd_year, nrow = 2)

#### tree ---------
cat_d |> 
  filter(str_detect(lc,"tree")) |> 
  summarise(
    across(starts_with("acres"), ~sum(., na.rm = T)),
    .by = c(lc, nlcd_year)
  ) |> 
  pivot_longer(cols = starts_with("acres"), names_to = "aoi", values_to = "acres") |> 
  mutate(
    aoi = if_else(str_detect(aoi, "rp100"), "Riparian 100m", "Local catchment")
  ) |> 
  ggplot() + 
  geom_col(aes(nlcd_year, acres, fill = aoi)) + 
  scale_fill_manual(name = "Extent", values = c("palegreen","darkgreen")) +
  scale_y_continuous(labels = scales::comma) +
  #scale_y_log10() +
  labs(
    title = "Tree cover, total vs riparian corridor",
    subtitle = "Sum of NLCD tree/forest classes in StreamCat NHDplus 1:100K"
    )

#statewide boxplot of per-comid pct-tree-riparian by nlcd year
#jitter renders useless
cat_d |> 
  filter(str_detect(lc,"tree")) |> 
  mutate(nlcd_year = factor(nlcd_year)) |> 
  ggplot(aes(nlcd_year, pct_catrp100)) +
  geom_boxplot(color = "darkgreen") +
  geom_jitter(color = "darkgreen", alpha = 0.3, size = 0.2)
#coarse regional stratification is perhaps more interesting
#east-of-cascades relatively consistent decline vs rebound west-side
sf_flw |> 
  as_tibble() |> 
  select(-fcode, -geometry) |> 
  distinct(comid, .keep_all = T) |> #enforce a single wria per comid
  inner_join(filter(cat_d, str_detect(lc,"tree")), by = "comid") |> 
  drop_na(wria) |> 
  mutate(
    nlcd_year = factor(nlcd_year),
    ew = if_else(as.integer(as.character(wria)) > 25, "east", "west")
    ) |> 
  ggplot(aes(nlcd_year, pct_catrp100)) +
  geom_jitter(color = "darkgreen", alpha = 0.2, size = 0.1) +
  geom_boxplot(fill = NA, color = "black") +
  facet_wrap(~ew, nrow = 1)

#going brightening fishing: did any catchments that gained urban cover also increase riparian tree cover?
cat_d |> 
  drop_na(pct_catrp100) |> 
  filter(
    nlcd_year %in% c(2001, 2019)
    ) |>
  select(-contains("areasqkm")) |> 
  pivot_wider(names_from = c(nlcd_year, lc), values_from = contains("cat")) |> 
  mutate(
    d_cat_urb = pct_cat_2019_urb - pct_cat_2001_urb,
    d_catrp100_tree = pct_catrp100_2019_tree - pct_catrp100_2001_tree
  ) |> 
  filter(
    d_cat_urb > 0
  ) |> 
  ggplot(aes(d_cat_urb, d_catrp100_tree)) +
  geom_point(aes(color = d_catrp100_tree > 0), size = 0.1, alpha = 0.3, show.legend = F) +
  scale_color_manual(values = c("grey30","darkgreen")) +
  labs(
    x = "Difference in local catchment %urban cover, 2019-2001",
    y = "Difference in %tree cover of 100m riparian corridor, 2019-2001",
    title = "Some urban land cover increases were concurrent with increased riparian tree cover"
  )

focal <- cat_d |> 
  drop_na(pct_catrp100) |> 
  filter(
    nlcd_year %in% c(2001, 2019)
    ) |>
  select(-contains("areasqkm")) |> 
  pivot_wider(names_from = c(nlcd_year, lc), values_from = contains("cat")) |> 
  mutate(
    d_cat_urb = pct_cat_2019_urb - pct_cat_2001_urb,
    d_catrp100_tree = pct_catrp100_2019_tree - pct_catrp100_2001_tree
  ) |> 
  filter(
    d_cat_urb > 0,
    d_catrp100_tree > 0
    )

#moving fast
ggplot() + 
  geom_sf(
    data = inner_join(sf_cat, focal, by = "comid"),
    aes(fill = d_cat_urb), color = NA
    ) +
  wacolors::scale_fill_wa_c("volcano", reverse = T) +
  geom_sf(
    data = inner_join(sf_flw, focal, by = "comid"),
    aes(color = d_catrp100_tree)
    ) +
  wacolors::scale_color_wa_c("foothills", reverse = T)

```

NOT UPDATED WITH OBJECT NAME/STRUCTURE CHANGES
```{r REDO_ORIG_streamcat_nlcd_EDA}
#add local catchment area and riparian cover pcts to W WA flowlines (duplicated by NLCD year and AOI)
sf_flw_sc_wa_nlcd_rp100_wwa <- sf_flw |> 
  filter(wria %in% factor(1:25)) |> 
  select(-fcode) |> 
  distinct(comid, .keep_all = T) |>  #drop from 17377 to 17342
  inner_join(
    as_tibble(sf_cat) |> select(-geometry)
    , by = "comid"
  ) |> 
  inner_join(sc_wa_nlcd_rp100, by = "comid")


sf_flw_sc_wa_nlcd_rp100_wwa |> 
  as_tibble() |> 
  filter(aoi == "cat", lc == "urbrp100") |> 
  mutate(nlcd_year = factor(nlcd_year)) |> 
  ggplot(aes(nlcd_year, pct, group = comid)) +
  #geom_point(aes(size = lengthkm), alpha = 0.5) + 
  geom_line(linewidth = 0.1) +
  scale_size_area(max_size = 3) +
  guides(color = guide_none()) +
  facet_wrap(~wria + lc, labeller = label_wrap_gen(multi_line = F)) +
  labs(
    title = "Proportion NLCD urban medium+high in NHDplus 100m riparian buffer",
    subtitle = "Local catchment ",
    y = "Pct. local catchment NLCD",
  )


tree_dtot <- sf_flw_sc_wa_nlcd_rp100_wwa |> 
  as_tibble() |> 
  filter(aoi == "cat", lc == "treerp100") |> 
  arrange(nlcd_year) |> 
  mutate(d = c(NA, diff(pct)), .by = comid) |> 
  summarise(
    dtot = sum(d, na.rm = T),
    .by = c(comid, wria, lc, aoi, lengthkm)
  )

#interesting but potentially misleading/misinterpretable
tree_dtot |> 
  filter(abs(dtot)>0) |> 
  ggplot() + 
  #ggridges::geom_ridgeline(aes(lengthkm, wria, height = dtot))
  ggridges::geom_density_ridges(aes(dtot, wria)) +
  geom_vline(xintercept = 0, linetype = 2, linewidth = 0.5)

sf_flw_sc_wa_nlcd_rp100_wwa |> 
  as_tibble() |> 
  filter(aoi == "cat", lc == "treerp100") |> 
  mutate(nlcd_year = factor(nlcd_year)) |> 
  inner_join(
    tree_dtot |> filter(abs(dtot)>0) |> select(comid, dtot) |> mutate(dtot_lgl = dtot > 0)
    , by = "comid"
  ) |> 
  ggplot(aes(nlcd_year, pct, group = comid, color = dtot_lgl)) +
  #geom_point(aes(size = lengthkm), alpha = 0.5) + 
  geom_line(linewidth = 0.2) +
  scale_size_area(max_size = 3) +
  scale_color_manual(values = c("orange","darkgreen")) +
  guides(color = guide_none()) +
  facet_wrap(~wria + lc, labeller = label_wrap_gen(multi_line = F)) +
  labs(
    title = "Proportion NLCD tree/forest in NHDplus 100m riparian buffer",
    subtitle = "Local catchment ",
    y = "Pct. local catchment NLCD",
  )

tree_dtot |> 
  filter(abs(dtot)>0) |> 
  mutate(dtot_lgl = dtot > 0) |> 
  ggplot() +
  geom_point(aes(dtot, lengthkm, color = dtot_lgl), alpha = 0.5) +
  scale_color_manual(values = c("orange","darkgreen")) +
  scale_y_log10() +
  guides(color = guide_none()) +
  facet_wrap(~wria, ncol = 1, scales = "free_y", strip.position = "right")

```

```{r sc_wa_bfw, eval=FALSE}
sc_wa_bfw <- StreamCatTools::sc_get_data(
  state = "WA",
  metric = 'bankfullwidth', aoi = 'other'
) |> 
  mutate(comid = as.character(comid))

#append to sf multilinestring of WA flowlines
sf_flw <- sf_flw |> 
  left_join(sc_wa_bfw, by = "comid")

sf_flw |> 
  drop_na(bankfullwidth) |> 
  ggplot() + geom_sf(aes(linewidth = bankfullwidth), color = "blue")

```

:::
