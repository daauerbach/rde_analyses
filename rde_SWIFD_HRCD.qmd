---
title: "Riparian Data Engine: salmon distribution & tree loss"
author: "dan.auerbach@dfw.wa.gov"
date: "`r Sys.Date()`"
format:
  html:
    embed-resources: true
    theme: yeti 
    code-fold: true
    toc: true
    toc-location: left
    grid:
      sidebar-width: 180px
      body-width: 1100px
      margin-width: 20px
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 10)

library("tidyverse", quietly = T)
library("sf")
library("patchwork")
library("gt")
theme_set(theme_minimal()) 

dir_data_common <- "~/T/DFW-Team WDFW Watershed Synthesis - data_common"
epsg <- 2927 #WA state standard; NAD83(HARN)/ft

#sort(unique(rde$t_imp_f))
pal_t_imp_f <- c("1" = "darkgreen", "2" = "orange", "3" = "yellow", "4|5" = "#965127", "NA" = "grey") 
pal_swifd_chin <- c("not_salmon" = NA, "salmon_not_chin" = "tan", "salmon_with_chin" = "salmon")

sf_wrias <- sf::read_sf(file.path(dir_data_common, "WR_WAT_WRIA.gdb/")) |>
  mutate(
    wria = factor(WRIA_NR),
    wria_nr_nm = paste0(str_pad(WRIA_NR,width = 2, pad = "0",),"_",WRIA_NM) |> factor()) |>
  select(WRIA_NR, WRIA_NM, wria, wria_nr_nm, acres = WRIA_AREA_ACR_QT) |> arrange(wria) |> 
  sf::st_transform(sf::st_crs(epsg))

sf_tess_01_25_rmz_cntrd_pts <- readRDS("sf_tess_01_25_rmz_cntrd_pts.rds")

```

# Background 

The [Riparian Data Engine (RDE)](https://ripariandata.wdfw.wa.gov/), developed by WDFW with support from ESA, is a geospatial web application that "unites WDFW riparian datasets in Washington State...allow[ing] planners to evaluate the conditions of riparian ecosystems and make data-informed planning decisions".

Following publication of the Volume 1 Science Synthesis [(Quinn et al. 2020)](https://wdfw.wa.gov/publications/01987) and Volume 2 Management Recommendations [(Rentz et al. 2020)](https://wdfw.wa.gov/publications/01988), the agency has developed several technical tools to support implementation (see https://wdfw.wa.gov/species-habitats/ecosystems/riparian).

The RDE enables interactive exploration of various landscape attributes associated with riparian management zone (RMZ) polygons that were consistently generated according to the [Site Potential Tree Height standard](https://wdfw.wa.gov/publications/02564) using publicly available GIS data.

Interactive users of the RDE can examine a "reach table" consisting of columns of various land cover, jurisdictional, and hydrographic attributes for rows corresponding to individual RMZ units in the polygon tessellation with which attribute values were calculated. Various filters and map-based exploration allow formulation of queries that subset these rows and enable comparison of summarized attribute values. For example, a filter for tree canopy cover greater than 50% can be used to examine the number and location of such RMZs within a Water Resource Inventory Area (WRIA) or a county. In addition, a powerful feature provided by the RDE is the display of a single reach relative to its upstream and downstream network "neighborhoods" and the attributes of those areas. This "local view" is well suited to understanding how conditions in a particular location compare to adjacent portions of the riverscape with hydrologic, geomorphic and ecological connections. Such information can help to inform a range of conservation management decisions at the site scale.

This analysis broadens to a regional scale, quantifying patterns per-WRIA, based on the full set of complete-WRIA reach tables, accessed via an API.

# Data & Analysis

```{r build_rde_wria_library, include=FALSE, eval=FALSE}
# created 4/23/25 after API first exposed
# see rde_wrias_init.qmd for scraping calls, not yet rerun to check any issues from baseurl changes

# https://api-riparis.esa-prod.sitkatech.com/docs/index.html 
# Reaches for a County: https://api-riparis.esa-prod.sitkatech.com/counties/{countyName}/reaches/csv
# Reaches for a WRIA: https://api-riparis.esa-prod.sitkatech.com/wrias/{wriaID}/reaches/csv
# Reach table contents for a Reach: https://api-riparis.esa-prod.sitkatech.com/reaches/{permanentIdentifier}/ csv

# rch_tbl <- map_df(1:62, ~readr::read_csv(
#   file.path(dir_data_common, paste0("rde/wrias/rde_wria_",stringr::str_pad(.x, 2, pad = "0"), ".csv"))
# ) |> 
#   mutate(pid = as.character(PermanentIdentifier), PermanentIdentifier = NULL)
# ) |> 
#   rename(wria = WaterResourceInventoryAreaID) |> 
#   rename_with(~str_replace(.,"Acres","_ac")) |> 
#   janitor::clean_names() |> 
#   select(pid, everything(), -reach_id)
# 
# saveRDS(rch_tbl, "~/T/DFW-Team WDFW Watershed Synthesis - data_common/rde/wria_rch_tlb.rds")
```

A complete set of reach tables includes values for >1mil rows statewide, indexed by `pid` (permanent identifiers). In this structure, a `pid`-row can include a combination of "extent of observed water" (EOW), "floodplain" (primarily based on FEMA mapping), and riparian management zone (RMZ, both banks where double-banked) geometry. However, the results presented here are based on the area (acreage) associated with the RMZ and EOW "riparian corridor".

```{r rde}
rde <- readRDS("~/T/DFW-Team WDFW Watershed Synthesis - data_common/rde/wria_rch_tlb.rds") |> 
  mutate(
    wria = factor(wria)
    ,
    swifd_any = !is.na(swifd_salmon_distribution),
    swifd_n = 1 + str_count(swifd_salmon_distribution,","),
    swifd_n_fct = case_when(
      is.na(swifd_n) ~ "none",
      swifd_n < 3 ~ "1-2 species",
      swifd_n >= 3 ~ "3 or more species"
    ),
    swifd_chin = case_when(
      str_detect(swifd_salmon_distribution, "Chin") ~ "salmon_with_chin",
      str_detect(swifd_salmon_distribution, "Chin", negate = T) ~ "salmon_not_chin",
      is.na(swifd_salmon_distribution) ~ "not_salmon"
    )
    ,
    # #1:meets WQS, 2:some concerns about some uses, 3:insuf data, 4:impair-no-TMDL, 5:TMDL
    ## NOTE - the status "Not Impaired" in this version of the csvs is not accurate
    ## as of 6/6/25 ver 0.0.1 the production reach table is (more accurately) "Not Assessed"
    ## this may have been corrected in prod API but need to check with Ray
    ## here manually overwriting
    t_imp = temperature_impairments |> str_replace("Impaired", "Assessed") |> factor()
    , 
    tree_pct = all_tree_cover_ac / all_land_cover_ac,
    veg_pct = all_vegetated_ac / all_land_cover_ac
  ) 

# #corresponds to nrow of reach table in ver 0.0.1 with EOW and Floodplain in Zone filter unchecked
# rde |> filter(wria==1, rmz_ac!=0)
# #but is NOT the same as 
# rde |> filter(wria==1, eow_ac==0, flood_ac==0)
# #which are PIDs with _only_ RMZ
# #no way in this table structure, without a 'zone' attribute', to differentiate RMZ-EOW-Floodplain...

```

The Statewide Integrated Fish Distribution [(SWIFD)](https://geo.wa.gov/datasets/wdfw::statewide-washington-integrated-fish-distribution/explore?location=47.239717%2C-120.672158%2C8.61) dataset characterizes the documented and presumed presence of several salmonid species. These data allow stratification of RDE units, indexed by `pid` (permanent identifiers), into the portion within each WRIA directly associated with any salmon occupancy and use, as well as whether Chinook are known or presumed to use the reach.

Across all WRIAs statewide, nearly 90% of the RMZ area included in the RDE has no salmon presence based on SWIFD. Roughly equal areas of RMZs are associated with Chinook versus all other species, but the EOW (extent of observed water) area is considerably larger for Chinook reaches (~43% vs ~15%), following expectations for the species' tendency to favor lower, larger portions of river networks.

```{r gt_rde_swifd_any_swifd_chin_wria_all}
rde |> 
  summarise(
    pid_n = n(),
    across(c(riparian_ac, rmz_ac, eow_ac), list(sum = ~sum(., na.rm = T))),
    .by = c(swifd_any, swifd_chin)
  ) |> 
  mutate(across(-starts_with("swifd"), list(pct = ~round(. / sum(.), 3)))) |> 
  arrange(swifd_any, swifd_chin) |> 
  select(swifd_any, swifd_chin,
         #starts_with("pid"),
         starts_with("ripar"),
         starts_with("rmz"),
         starts_with("eow")
         ) |> 
  gt(caption = md("Total area of reaches with any salmon and Chinook use, per SWIFD  \nall WRIAs statewide")) |> 
  fmt_percent(ends_with("pct"), decimals = 1) |> 
  fmt_number(ends_with("sum"), decimals = 0, use_seps = T) |> 
  tab_style(locations = cells_body(columns = ends_with("sum")), style = cell_borders("left")) |> 
  tab_spanner("Riparian corr.", contains("ripar")) |> 
  tab_spanner("RMZ", contains("rmz")) |> 
  tab_spanner("EOW", contains("eow")) |> 
  cols_label_with(fn = ~str_remove_all(., "riparian_|rmz_|eow_"))
```

The WRIAs west of the Cascade crest (1-25) show an increased portion of the overall riparian corridor and RMZ extent associated with salmon. However, this area still represents less than 25% of the full area encompassed by the SPTH200 tessellation of the RDE, which extends throughout the upper portions of river networks beyond reaches identified in SWIFD. Further, the relative proportion of salmon occupancy varies considerably across this set of watershed divisions.

```{r gt_rde_swifd_any_swifd_chin_wria_1_25}
rde |> 
  filter(as.integer(as.character(wria)) < 26) |>
  summarise(
    pid_n = n(),
    across(c(riparian_ac, rmz_ac, eow_ac), list(sum = ~sum(., na.rm = T))),
    .by = c(swifd_any, swifd_chin)
  ) |> 
  mutate(across(-starts_with("swifd"), list(pct = ~round(. / sum(.), 3)))) |> 
  arrange(swifd_any, swifd_chin) |> 
  select(swifd_any, swifd_chin,
         #starts_with("pid"),
         starts_with("ripar"),
         starts_with("rmz"),
         starts_with("eow")
         ) |> 
  gt(caption = md("Total area of reaches with any salmon and Chinook use, per SWIFD  \nWestern WA WRIAs 1 - 25")) |> 
  fmt_percent(ends_with("pct"), decimals = 1) |> 
  fmt_number(ends_with("sum"), decimals = 0, use_seps = T) |> 
  tab_style(locations = cells_body(columns = ends_with("sum")), style = cell_borders("left")) |> 
  tab_spanner("Riparian corr.", contains("ripar")) |> 
  tab_spanner("RMZ", contains("rmz")) |> 
  tab_spanner("EOW", contains("eow")) |> 
  cols_label_with(fn = ~str_remove_all(., "riparian_|rmz_|eow_"))
```

```{r gg_rde_swifd_any_pts}
sf_tess_01_25_rmz_cntrd_pts |> 
  slice_sample(n = 300000) |> 
  ggplot() + geom_sf(aes(color = swifd_any), size = 0.2, alpha = 0.1, show.legend = F) + 
  geom_sf(data = sf_wrias |> filter(WRIA_NR<26), color = "grey30", fill = NA, linewidth = 0.2) +
  scale_color_manual(values = c("lightblue", "darkblue")) +
  labs(title = "RMZ units with salmon use (SWIFD)",
       subtitle = "Western WA WRIAs 1 - 25, any species")
```

Extensive land cover and land use change has occurred in these Western Washington watersheds, prompting regulatory efforts to limit ongoing tree loss within riparian ecosystems and prevent further riverscape habitat degradation. Accordingly, an important applied conservation question concerns how recent reductions in tree cover are distributed within these riparian networks, particularly relative to the salmon occupied portions.

The high resolution change detection dataset [(HRCD)](https://hrcd-wdfw.hub.arcgis.com/) included within the RDE provides a means to address this question with remote sensed empirical observations of anthropogenic tree loss between 2012-2017.

```{r pending_question_to_hrcd_team, include=FALSE, eval=FALSE}
#difference between blanks and zeros?
#I think blanks correspond to an RMZ poly with no HRCD poly intersection, 
#versus '0' from an RMZ intersection with an HRCD poly that for whatever reason didn't include tree loss area?
#some instances of anth_loss = 0 and nat_loss = 0, so I'm guessing those could be impervious related?
rde |> 
  #filter(as.integer(as.character(wria)) < 26) |>
  filter(wria == "7") |>
  #count(is.na(anthropogenic_change_origin_ac))
  count(anthropogenic_change_origin_ac >= 0)

rde |> 
  filter(wria == "7") |> #42465
  filter(anthropogenic_change_origin_ac == 0) |>  #638
  filter(anthropogenic_change_origin_ac == 0, natural_change_origin_ac == 0) #74

```

Areas of tree loss are apparent at a regional scale, but specific relationships to salmon distribution are more difficult to discern.

```{r gg_rde_swifd_any_pts_tree_loss}
sf_tess_01_25_rmz_cntrd_pts |>
  #filter(swifd_any) |> #as_tibble() |> count(anthropogenic_change_origin_ac > 0)
  slice_sample(n = 250000) |> 
  mutate(
    anth_chg = replace_na(anthropogenic_change_origin_ac, 0)
  ) |> 
  ggplot() + geom_sf(aes(color = anth_chg > 0), size = 0.2, alpha = 0.3, show.legend = F) + 
  scale_color_manual(values = c("#516F25", "orange")) +
  #facet_wrap(~swifd_any)
  labs(title = "RMZ units with any anthropogenic tree loss (HRCD)",
       subtitle = "Western WA WRIAs 1 - 25")
```

**Table to make nicer pending feedback**

Across these WRIAs, the aggregated area of RMZs associated with salmon forms roughly 20% of total riparian corridor area, while the proportion of the total RMZ tree cover area within salmon reaches is slighly lower at roughly 19%. Although the total tree cover area is ~75% of the total RMZ area (~2.9m/3.9m acres), this suggests that, at this scale, riparian tree cover approximately corresponds to a null expectation for salmon distribution, with neither a starkly higher or lower concentration of the overall treed area within salmon occupied RMZs (i.e., the limit case of 100% tree cover in salmon RMZs with the same total tree area would represent ~27% rather than ~19%). Nonetheless, these values also mean that in non-salmon reaches, tree cover acres are ~75% of total acres (2.36m/3.14m) versus ~69% for salmon associated (550K/802K).

In contrast, the proportion of tree loss acres within salmon reaches is less than half of the tree cover area and total area proportions, suggesting that measured decreases *are* concentrated in non-salmon areas to a greater degree than would be expected based only on relative total area. 

```{r gt_rde_swifd_any_hrcd_wria_1_25}
rde |>
  filter(as.integer(as.character(wria)) < 26) |> 
  summarise(
    across(
      c(riparian_ac, 
        tree_cover_ac = all_tree_cover_ac, 
        tree_loss_ac = anthropogenic_change_origin_ac),
      list(sum = ~sum(., na.rm = T))
      )
    , .by = c(swifd_any)
  ) |> 
  mutate(across(ends_with("sum"), list(pct = ~./sum(.)))) |> 
  pivot_longer(-c(swifd_any)) |> 
  mutate(
    var = str_sub(name, -3, -1),
    name = str_remove(name, "_sum") |> str_remove("_pct") |> factor()
    ) |> 
  pivot_wider(names_from = var, values_from = value) |> 
  arrange(name, swifd_any) |> 
  gt(groupname_col = "name", row_group_as_column = T) |> 
  fmt_percent("pct", decimals = 1) |> 
  fmt_number("sum", decimals = 0)

## could work up further/better?
# rde |>
#   filter(as.integer(as.character(wria)) < 26) |> 
#   select(swifd_any, riparian_ac, 
#         tree_cover_ac = all_tree_cover_ac, 
#         tree_loss_ac = anthropogenic_change_origin_ac) |> 
#   mutate(tree_loss_ac = replace_na(tree_loss_ac, 0)) |> 
#   pivot_longer(-c(swifd_any)) |> 
#   ggplot() + 
#   geom_boxplot(aes(name, value, color = swifd_any), varwidth = T) +
#   scale_y_log10()

```

These relationships are better examined with further stratification by WRIA, where several possible patterns emerge.

At this scale, individual WRIAs vary both in terms of the relative proportions of cover and loss, including some that depart from the regional pattern. 

WRIAs 12 and 13 have relatively higher cover than null expectation...

Most WRIAs show the lower proportion of loss versus cover that suggest tree decreases concentrated away from salmon reaches...and Skagit/3 despite lower cover than area has even lower-lower loss...but Cedar-Sam/8, Duwam/9, ELDU/18


```{r rde_anth_wria_swifd_any}
##tree loss change in W WA salmon reaches, ignoring 303d
rde_anth_wria_swifd_any <- rde |>
  summarise(
    across(
      c(riparian_ac, 
        tree_cover_ac = all_tree_cover_ac, 
        tree_loss_ac = anthropogenic_change_origin_ac),
      list(sum = ~sum(., na.rm = T))
      ),
    .by = c(wria, swifd_any)
  ) |> 
  mutate(
    across(ends_with("sum"), list(pct = ~./sum(.))),
    .by = wria
  ) |> 
  pivot_longer(-c(wria, swifd_any)) |> 
  mutate(
    var = str_sub(name, -3, -1),
    name = str_remove(name, "_sum") |> str_remove("_pct") |> factor()
    ) |> 
  pivot_wider(names_from = var, values_from = value) #|> pull(name) |> unique() |> sort()

```

```{r gg_rde_anth_wria_swifd_any_parallel}
{
  rde_anth_wria_swifd_any |>   
    filter(as.integer(as.character(wria)) < 26, swifd_any) |> 
    ggplot(aes(name, pct, group = wria)) +
    geom_line(linewidth = 0.3) +
    geom_point(aes(color = name, size = sum)) + 
    geom_text(aes(label = wria), size = 3,
              #position = position_dodge(width = 0.5)
              nudge_x = -0.05
    ) +
    scale_color_manual(values = c("tan","darkgreen","orange"), guide = "none") +
    scale_size_area(guide = "none") +
    labs(x = NULL, y = "Proportion", 
         title = "SWIFD/salmon RMZ area as proportion of WRIA total",
         subtitle = "Point size scaled to total acres")
}+{
  sf_wrias |> 
    left_join(rde_anth_wria_swifd_any, by = "wria") |> 
    filter(as.integer(as.character(wria)) < 26, swifd_any) |> 
    ggplot() + geom_sf(aes(fill = name, alpha = pct), color = "grey80", linewidth = 0.1) + 
    scale_fill_manual(values = c("tan","darkgreen","orange"), aesthetics = c("fill","color"), guide = "none") +
    scale_alpha(name = "Prop.", guide = "none") +
    facet_wrap(~name) #+ theme(legend.position = "bottom")
}+
  plot_layout(ncol = 1)
```

```{r gt_rde_anth_wria_swifd_any}
# rde_anth_wria_swifd_any |>   
#   filter(as.integer(as.character(wria)) < 26, swifd_any, str_detect(name, "loss")) |> 
#   gt("Acres and proportion of tree loss within salmon reaches") |> 
#   cols_hide(columns = c("swifd_any","name")) |> 
#   fmt_percent("pct", decimals = 1) |> 
#   fmt_number("sum", decimals = 1)

rde_anth_wria_swifd_any |>   
  filter(as.integer(as.character(wria)) < 26, swifd_any) |> 
  pivot_wider(names_from = name, values_from = c(sum, pct)) |> 
  select(wria, contains("rip"), contains("cover"), contains("loss")) |> 
  gt("Acres and proportion of total area, tree cover, and tree loss within salmon reaches") |> 
  fmt_percent(contains("pct"), decimals = 1) |> 
  fmt_number(contains("sum"), decimals = 0) |> 
  tab_style(style = cell_fill("darkgreen", 0.3), locations = cells_body(contains("cover"))) |> 
  tab_style(style = cell_fill("orange", 0.3), locations = cells_body(contains("loss")))


```

Needs work 

```{r gg_tree_loss_points}
# rde_anth_wria_swifd_any |>   
#   filter(as.integer(as.character(wria)) < 26, swifd_any) |> 
#   pivot_wider(names_from = name, values_from = c(sum, pct)) |> 
#   filter(pct_tree_loss_ac > pct_tree_cover_ac)

sf_tess_01_25_rmz_cntrd_pts |> 
  #filter(swifd_any, wria %in% c("4","8","9","10","18")) |> 
  filter(swifd_any, wria %in% c("8","9","10","18",
                                "12","13","14","24")) |> 
  mutate(tree_loss = replace_na(anthropogenic_change_origin_ac, 0)) |> 
  split(~wria, drop = T) |> 
  map(
    ~.x |> 
      ggplot() + 
      geom_sf(aes(color = tree_loss > 0),
              size = 0.2, alpha = 0.3, show.legend = F) + 
      scale_color_manual(values = c("#516F25", "orange")) +
      facet_wrap(~wria)
  ) |> 
  wrap_plots(ncol = 2)
```


::: {.content-hidden when-format="html"}

```{r streamcat_nlcd_get}
##from trap_attr.qmd which also has association of broader streamcat attrib to point location
##imperv only, cat/ws-wide NOT riparian
#read_csv(file.path(dir_data_common,"streamcat/ImperviousSurfaces_WA.csv")) |> 
# select(COMID, WsAreaSqKm, paste0("PctImp",c(2001,2004,2006,2008,2011,2013,2016,2019),"Ws"))

## recall riparian buffers are 100m, per https://www.epa.gov/national-aquatic-resource-surveys/streamcat-dataset-readme 
## older flow_trees_heat.qmd has initial extensive EDA and object creation
## then  flow_trees_apps.qmd has creation of riparian-only 'sc_wa_nlcd/sc_wa_nlcd_rp100.rds' (copied into hpas_ugas_hrcd.qmd)
## also differencing of 2019-2011 composite imperv and tree
## older saved rds has 2011,2013,2016,2019 WsRp100 and CatRp100: sc_wa_nlcd <- readRDS(file.path(dir_data_common, "streamcat", "sc_wa_nlcd_rp100.rds"))

## not up on github anywhere, so repeating a slightly modified version here for reference

# # # list of 8 NLCD for all WA, 57313 rows/comids by (16categories x 2aoi cols)
# # sc_wa_nlcd_rp100 <- map(
# #   set_names(c(2001, 2004, 2006, 2008, 2011, 2013, 2016, 2019))
# #   ,
# #   ~StreamCatTools::sc_nlcd(
# #     state = "WA", year = .x,
# #     aoi = 'catrp100,wsrp100'
# #   ) |>
# #     rename_with(tolower) |> as_tibble() |>
# #     mutate(comid = as.character(comid), nlcd_year = .x)
# # )
# # saveRDS(sc_wa_nlcd_rp100, file.path(dir_data_common, "streamcat", "sc_wa_nlcd_rp100.rds"))
# 
# #pull all 4 AOI, including abs areasqkm
# sc_wa_nlcd <- map(
#   set_names(c(2001, 2004, 2006, 2008, 2011, 2013, 2016, 2019))
#   ,
#   ~StreamCatTools::sc_nlcd(
#     state = "WA", year = .x,
#     aoi = 'cat,catrp100,ws,wsrp100',
#     showAreaSqKm = T
#   ) |>
#     rename_with(tolower) |> as_tibble() |>
#     mutate(comid = as.character(comid), nlcd_year = .x)
# )
# saveRDS(sc_wa_nlcd, file.path(dir_data_common, "streamcat", "sc_wa_nlcd.rds"))

```

```{r streamcat_nlcd_read_wrangle}
sf_flw <- readRDS("~/T/DFW-Team WDFW Watershed Synthesis - flow_trees_heat/sf_nhdp_wa_flw.rds") |>
  sf::st_zm() |> 
  rename_with(tolower) |> 
  mutate(comid = as.character(comid))
#duplicates a few linestrings that cross wrias (from 57229 to 57517)
sf_flw <- sf_flw |> st_join(sf_wrias |> select(wria, wria_nr_nm)) 
#sf_flw |> filter(wria %in% factor(1:25)) |> ggplot() + geom_sf(aes(color = wria_nr_nm))  

#catchment polys
sf_nhdp_wa <- readRDS("~/T/DFW-Team WDFW Watershed Synthesis - flow_trees_heat/sf_nhdp_wa.rds") |> 
  select(comid, areasqkm) |> 
  left_join(as_tibble(sf_flw) |> select(comid, wria, wria_nr_nm), by = "comid")

#wrangle list by year to single tibble
#strip year from colnames, focus on urban 'high'+'medium', 4 tree categories 
#recognize that rp100 is nested rather than spatial difference/set complement when contrasted with encompassing catchment NLCD LU
sc_wa_nlcd <- readRDS(file.path(dir_data_common, "streamcat", "sc_wa_nlcd.rds")) |> 
  map(
    ~.x |> 
      rename_with(~str_remove(.,paste(c(2001, 2004, 2006, 2008, 2011, 2013, 2016, 2019),collapse = "|")) |> 
                    str_remove("pct")) |> 
      select(comid, nlcd_year, contains("areasqkm"),
             contains("urbmd"), contains("urbhi"), 
             contains("wdwet"), contains("mxfst"), contains("decid"), contains("conif")
      ) |> 
      mutate(
        urb_cat = urbmdcat + urbhicat,
        urb_ws = urbmdws + urbhiws,
        tree_cat = wdwetcat + mxfstcat + decidcat + conifcat,
        tree_ws = wdwetws + mxfstws + decidws + conifws
        ,
        urb_catrp100 = urbmdcatrp100 + urbhicatrp100,
        urb_wsrp100 = urbmdwsrp100 + urbhiwsrp100,
        tree_catrp100 = wdwetcatrp100 + mxfstcatrp100 + decidcatrp100 + conifcatrp100,
        tree_wsrp100 = wdwetwsrp100 + mxfstwsrp100 + decidwsrp100 + conifwsrp100
      ) |> 
      select(comid, nlcd_year, 
             contains("areasqkm"), 
             areasqkm_cat = catareasqkm, areasqkm_ws = wsareasqkm,
             areasqkm_catrp100 = catareasqkmrp100, areasqkm_wsrp100 = wsareasqkmrp100,
             ends_with("_cat"), ends_with("_catrp100"),
             ends_with("_ws"), ends_with("_wsrp100"))
  ) |> 
  list_rbind()

#break apart then rejoin to get areas by AOI, duplicated by LC
sc_wa_nlcd <- left_join(
  sc_wa_nlcd |> 
    select(comid, nlcd_year, contains("areasqkm")) |> 
    pivot_longer(cols = -c(comid, nlcd_year), values_to = "areasqkm") |> 
    mutate(aoi = str_remove(name, "areasqkm_"), name = NULL)
  ,
  sc_wa_nlcd |> 
    select(comid, nlcd_year, contains("urb"),contains("tree")) |> 
    pivot_longer(cols = -c(comid, nlcd_year), values_to = "pct") |> 
    separate(name, c("lc", "aoi")) |> 
    mutate(pct = round(pct/100, 4))
  ,
  by = c("comid", "nlcd_year", "aoi")
)

```

```{r cat_d_urb_then_tree}
#per-nlcd-year 'spatial diff' of whole-cat-pct vs/minus riparian-pct
#positive indicating higher proportion of riparian 'urban' or treed
#random testing shows 'urban' can be roads...often near water
cat_d <- sc_wa_nlcd |> 
  mutate(acres = 247.11 * areasqkm * pct) |>
  filter(str_detect(aoi,"cat")) |> 
  pivot_wider(names_from = aoi, values_from = c(areasqkm, pct, acres)) |> 
  arrange(comid, nlcd_year)

#### urban ---------

# cat_d |> 
#   filter(str_detect(lc,"urb")) |> 
#   mutate(
#     # d_pct = pct_cat - pct_catrp100,
#     # d_acres = acres_cat - acres_catrp100
#     prop_rp100 = acres_catrp100 / acres_cat
#   )

#first look statewide, indicating that at least in some coarse sense, regulations have 'urbanization' has been 
cat_d |> 
  filter(str_detect(lc,"urb")) |> 
  summarise(
    across(starts_with("acres"), ~sum(., na.rm = T)),
    .by = c(lc, nlcd_year)
  ) |> 
  pivot_longer(cols = starts_with("acres"), names_to = "aoi", values_to = "acres") |> 
  mutate(
    aoi = if_else(str_detect(aoi, "rp100"), "Riparian 100m", "Local catchment")
  ) |> 
  ggplot() + 
  geom_col(aes(nlcd_year, acres, fill = aoi)) + 
  scale_fill_grey("Extent") +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Urban land cover, total vs riparian corridor",
    subtitle = "Sum of NLCD urban 'medium' and 'high' classes in StreamCat NHDplus 1:100K"
    )

cat_d_urb_wria <- sf_flw |> 
  as_tibble() |> 
  select(-fcode, -geometry) |> 
  distinct(comid, .keep_all = T) |> #enforce a single wria per comid
  inner_join(filter(cat_d, str_detect(lc,"urb")), by = "comid") |> 
  # #summary()
  # ##comids with NA wria are border edges
  # filter(is.na(wria)) |> distinct(comid) -> no_wria
  # semi_join(sf_flw, no_wria, by = "comid") |> ggplot() + geom_sf(aes(fill = fcode))
  drop_na(wria) |> 
  summarise(
    across(c(lengthkm, starts_with("acres")), ~sum(., na.rm = T)),
    .by = c(lc, nlcd_year, wria, wria_nr_nm)
  )

#geom_col by WRIA, abs area per cat/catrp100
cat_d_urb_wria |> 
  pivot_longer(cols = starts_with("acres"), names_to = "aoi", values_to = "acres") |> 
  mutate(
    aoi = if_else(str_detect(aoi, "rp100"), "Riparian 100m", "Local catchment")
  ) |> 
  ggplot() +
  geom_col(aes(nlcd_year, acres, fill = aoi)) + 
  scale_fill_grey("Extent") +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~wria, scales = "free_y")

#geom_line by WRIA: total urban, riparian corridor urban, and riparian as proportion of total
d <- cat_d_urb_wria |>
  mutate(riparian_proportion_of_total = acres_catrp100 / acres_cat)
d |> arrange(desc(riparian_proportion_of_total))

{
  ggplot(d) +
    geom_line(aes(nlcd_year, acres_cat, group = wria), color = "grey20", linewidth = 0.2) + 
    geom_smooth(aes(nlcd_year, acres_cat), color = "grey20", linewidth = 1.5, linetype = 2) + 
    scale_y_continuous(labels = scales::comma) +
    #facet_wrap(~wria, ncol = 1, strip.position = "right") +
    labs(subtitle = "Total urban extent has increased...")
  }+{
    ggplot() +
      geom_line(data = d, aes(nlcd_year, acres_catrp100, group = wria), color = "grey70", linewidth = 0.3) + 
      geom_smooth(data = d, aes(nlcd_year, acres_catrp100), color = "grey70", linewidth = 1.5, linetype = 2) + 
      geom_text(data = filter(d, nlcd_year == 2019),
                x = 2019.5, aes(y = acres_catrp100, label = wria), color = "grey70", size = 2) + 
      scale_y_continuous(labels = scales::comma) +
      #facet_wrap(~wria, ncol = 1, strip.position = "right") +
      labs(subtitle = "and so has urban cover in a 100m riparian corridor\n around major streams and rivers...")
  }+{
    ggplot() +
      geom_line(data = d, aes(nlcd_year, riparian_proportion_of_total, group = wria), color = "orange") + 
      geom_smooth(data = d, aes(nlcd_year, riparian_proportion_of_total), color = "orange", linewidth = 1.5, linetype = 2) + 
      geom_text(data = filter(d, nlcd_year == 2019),
                x = 2019.5, aes(y = riparian_proportion_of_total, label = wria), color = "orange", size = 2) +
      scale_y_continuous(labels = scales::percent) +
      #facet_wrap(~wria, ncol = 1, strip.position = "right") +
      labs(subtitle = "\nbut mostly at a flat or slower rate")
  } + plot_layout(nrow = 1, guides = "collect")

#geom_sf single wria catchments in time
sf_nhdp_wa |> 
  filter(wria=="16") |>
  distinct(comid, .keep_all = T) |> #enforce a single wria per comid
  inner_join(
    cat_d |> 
      filter(str_detect(lc,"urb")) 
    , by = "comid") |>
  select(comid, contains("wria"), nlcd_year, contains("cat")) |> 
  pivot_longer(cols = starts_with("acres"), values_to = "ac") |> 
  ggplot() +
  geom_sf(aes(fill = ac), color = NA) +
  scale_fill_gradient(low = "tan",high = "grey30") +
  facet_wrap(~name+nlcd_year, nrow = 2)

#### tree ---------
cat_d |> 
  filter(str_detect(lc,"tree")) |> 
  summarise(
    across(starts_with("acres"), ~sum(., na.rm = T)),
    .by = c(lc, nlcd_year)
  ) |> 
  pivot_longer(cols = starts_with("acres"), names_to = "aoi", values_to = "acres") |> 
  mutate(
    aoi = if_else(str_detect(aoi, "rp100"), "Riparian 100m", "Local catchment")
  ) |> 
  ggplot() + 
  geom_col(aes(nlcd_year, acres, fill = aoi)) + 
  scale_fill_manual(name = "Extent", values = c("palegreen","darkgreen")) +
  scale_y_continuous(labels = scales::comma) +
  #scale_y_log10() +
  labs(
    title = "Tree cover, total vs riparian corridor",
    subtitle = "Sum of NLCD tree/forest classes in StreamCat NHDplus 1:100K"
    )

cat_d |> 
  filter(str_detect(lc,"tree")) |> 
  mutate(nlcd_year = factor(nlcd_year)) |> 
  ggplot(aes(nlcd_year, pct_catrp100)) +
  geom_boxplot(color = "darkgreen") +
  geom_jitter(color = "darkgreen", alpha = 0.3, size = 0.2)

sf_flw |> 
  as_tibble() |> 
  select(-fcode, -geometry) |> 
  distinct(comid, .keep_all = T) |> #enforce a single wria per comid
  inner_join(filter(cat_d, str_detect(lc,"tree")), by = "comid") |> 
  drop_na(wria) |> 
  mutate(
    nlcd_year = factor(nlcd_year),
    ew = if_else(as.integer(as.character(wria)) > 25, "east", "west")
    ) |> 
  ggplot(aes(nlcd_year, pct_catrp100)) +
  geom_jitter(color = "darkgreen", alpha = 0.2, size = 0.1) +
  geom_boxplot(fill = NA, color = "black") +
  facet_wrap(~ew, nrow = 1)

#going brightening fishing: did any catchments that gained urban cover also increase riparian tree cover?
cat_d |> 
  drop_na(pct_catrp100) |> 
  filter(
    nlcd_year %in% c(2001, 2019)
    ) |>
  select(-contains("areasqkm")) |> 
  pivot_wider(names_from = c(nlcd_year, lc), values_from = contains("cat")) |> 
  mutate(
    d_cat_urb = pct_cat_2019_urb - pct_cat_2001_urb,
    d_catrp100_tree = pct_catrp100_2019_tree - pct_catrp100_2001_tree
  ) |> 
  filter(
    d_cat_urb > 0
  ) |> 
  ggplot(aes(d_cat_urb, d_catrp100_tree)) +
  geom_point(aes(color = d_catrp100_tree > 0), size = 0.1, alpha = 0.3, show.legend = F) +
  scale_color_manual(values = c("grey30","darkgreen")) +
  labs(
    x = "Difference in local catchment %urban cover, 2019-2001",
    y = "Difference in %tree cover of 100m riparian corridor, 2019-2001",
    title = "Some urban land cover increases were concurrent with increased riparian tree cover"
  )

focal <- cat_d |> 
  drop_na(pct_catrp100) |> 
  filter(
    nlcd_year %in% c(2001, 2019)
    ) |>
  select(-contains("areasqkm")) |> 
  pivot_wider(names_from = c(nlcd_year, lc), values_from = contains("cat")) |> 
  mutate(
    d_cat_urb = pct_cat_2019_urb - pct_cat_2001_urb,
    d_catrp100_tree = pct_catrp100_2019_tree - pct_catrp100_2001_tree
  ) |> 
  filter(
    d_cat_urb > 0,
    d_catrp100_tree > 0
    )

#moving fast
ggplot() + 
  geom_sf(
    data = inner_join(sf_nhdp_wa, focal, by = "comid"),
    aes(fill = d_cat_urb), color = NA
    ) +
  wacolors::scale_fill_wa_c("volcano", reverse = T) +
  geom_sf(
    data = inner_join(sf_flw, focal, by = "comid"),
    aes(color = d_catrp100_tree)
    ) +
  wacolors::scale_color_wa_c("foothills", reverse = T)

```


```{r streamcat_nlcd_EDA}
#add local catchment area and riparian cover pcts to W WA flowlines (duplicated by NLCD year and AOI)
sf_flw_sc_wa_nlcd_rp100_wwa <- sf_flw |> 
  filter(wria %in% factor(1:25)) |> 
  select(-fcode) |> 
  distinct(comid, .keep_all = T) |>  #drop from 17377 to 17342
  inner_join(
    as_tibble(sf_nhdp_wa) |> select(-geometry)
    , by = "comid"
  ) |> 
  inner_join(sc_wa_nlcd_rp100, by = "comid")


sf_flw_sc_wa_nlcd_rp100_wwa |> 
  as_tibble() |> 
  filter(aoi == "cat", lc == "urbrp100") |> 
  mutate(nlcd_year = factor(nlcd_year)) |> 
  ggplot(aes(nlcd_year, pct, group = comid)) +
  #geom_point(aes(size = lengthkm), alpha = 0.5) + 
  geom_line(linewidth = 0.1) +
  scale_size_area(max_size = 3) +
  guides(color = guide_none()) +
  facet_wrap(~wria + lc, labeller = label_wrap_gen(multi_line = F)) +
  labs(
    title = "Proportion NLCD urban medium+high in NHDplus 100m riparian buffer",
    subtitle = "Local catchment ",
    y = "Pct. local catchment NLCD",
  )


tree_dtot <- sf_flw_sc_wa_nlcd_rp100_wwa |> 
  as_tibble() |> 
  filter(aoi == "cat", lc == "treerp100") |> 
  arrange(nlcd_year) |> 
  mutate(d = c(NA, diff(pct)), .by = comid) |> 
  summarise(
    dtot = sum(d, na.rm = T),
    .by = c(comid, wria, lc, aoi, lengthkm)
  )

#interesting but potentially misleading/misinterpretable
tree_dtot |> 
  filter(abs(dtot)>0) |> 
  ggplot() + 
  #ggridges::geom_ridgeline(aes(lengthkm, wria, height = dtot))
  ggridges::geom_density_ridges(aes(dtot, wria)) +
  geom_vline(xintercept = 0, linetype = 2, linewidth = 0.5)

sf_flw_sc_wa_nlcd_rp100_wwa |> 
  as_tibble() |> 
  filter(aoi == "cat", lc == "treerp100") |> 
  mutate(nlcd_year = factor(nlcd_year)) |> 
  inner_join(
    tree_dtot |> filter(abs(dtot)>0) |> select(comid, dtot) |> mutate(dtot_lgl = dtot > 0)
    , by = "comid"
  ) |> 
  ggplot(aes(nlcd_year, pct, group = comid, color = dtot_lgl)) +
  #geom_point(aes(size = lengthkm), alpha = 0.5) + 
  geom_line(linewidth = 0.2) +
  scale_size_area(max_size = 3) +
  scale_color_manual(values = c("orange","darkgreen")) +
  guides(color = guide_none()) +
  facet_wrap(~wria + lc, labeller = label_wrap_gen(multi_line = F)) +
  labs(
    title = "Proportion NLCD tree/forest in NHDplus 100m riparian buffer",
    subtitle = "Local catchment ",
    y = "Pct. local catchment NLCD",
  )

tree_dtot |> 
  filter(abs(dtot)>0) |> 
  mutate(dtot_lgl = dtot > 0) |> 
  ggplot() +
  geom_point(aes(dtot, lengthkm, color = dtot_lgl), alpha = 0.5) +
  scale_color_manual(values = c("orange","darkgreen")) +
  scale_y_log10() +
  guides(color = guide_none()) +
  facet_wrap(~wria, ncol = 1, scales = "free_y", strip.position = "right")

```

```{r}
sc_wa_bfw <- StreamCatTools::sc_get_data(
  state = "WA",
  metric = 'bankfullwidth', aoi = 'other'
) |> 
  mutate(comid = as.character(comid))

#append to sf multilinestring of WA flowlines
sf_flw <- sf_flw |> 
  left_join(sc_wa_bfw, by = "comid")

sf_flw |> 
  drop_na(bankfullwidth) |> 
  ggplot() + geom_sf(aes(linewidth = bankfullwidth), color = "blue")

```


:::
