---
title: "Assessing Washington's Riparian Land Cover"
author: "dan.auerbach@dfw.wa.gov"
date: "`r Sys.Date()`"
format:
  html:
    embed-resources: true
    theme: yeti 
    code-fold: true
    toc: true
    toc-location: left
    grid:
      sidebar-width: 180px
      body-width: 1100px
      margin-width: 20px
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 10)

library("tidyverse", quietly = T)
library("sf")
library("patchwork")
library("gt")
theme_set(theme_minimal()) 

# dir_data_common <- "~/T/DFW-Team WDFW Watershed Synthesis - data_common"
# epsg <- 2927 #WA state standard; NAD83(HARN)/ft

load("sc_ripcorr_nlcd.RData")
```

# Introduction

'Riparian' designates where streams and rivers meet and mingle with uplands. As with other ecological edges, this meeting place is host to many mutually enriching physical and biological exchanges. These hydro-geo-eco interactions are understood to provide numerous services of value to people, leading to laws and policies seeking to protect more intact riparian areas and rehabilitate their degradation.

In Washington state, within the federal statutory context of the Clean Water Act, Endangered Species Act, and various others, the 'realized riparian regulatory regime' emerges from several land use frameworks including the Shoreline Management Act, the Forest Practices Act, and the Growth Management Act.

[...]
- V1 and V2 text and refs from earlier scripts
- [task force recs](https://ofm.wa.gov/sites/default/files/public/publications/RiparianTaskforcePreliminaryRecommendationsMay2024.pdf)
[...]

This analysis offers a landscape-scale perspective on conditions and changes within a simple, spatially-defined riparian corridor, using readily-available datasets to examine broad patterns that span numerous jurisdictions as well as substantial hydroclimate and habitat variation. A primary focus is on "urban" cover as an indicator of imperviousness. Impervious cover has statewide relevance in mesic (western) and semi-arid (eastern) regions, and is well-understood to be associated with ecohydrologic degradation.


# Data & methods 

The [`StreamCatTools`](https://github.com/USEPA/StreamCatTools) (Weber 2025) R package was used to access the [StreamCat dataset](https://www.epa.gov/national-aquatic-resource-surveys/streamcat-dataset) (Hill et al. 2016), which delivers consistently geoprocessed attribute values for each reach unit of the original medium resolution NHDPlus hydrography. Derived from a 30m DEM and sometimes termed "1:100K", this captures most substantial watercourses and is the precursor to subsequent higher-resolution continent-wide elevation derived hydrographic datasets that include many smaller channel units (i.e., NHDPlusHR from 10m DEM and 3DHP from LiDAR). For each reach 'comid', StreamCat provides attribute values from many raster and rasterized datasets that are processed within the local contributing catchment ('`cat`') as well as a 100m riparian buffer ('`rp100`') on "stream lines and on-network NLCD water pixels". 

*Not yet using Ws/Wsrp100, but add description here if added below*

```{r objects_sf, eval=FALSE}
sf_wrias <- sf::read_sf(file.path(dir_data_common, "WR_WAT_WRIA.gdb/")) |>
  mutate(
    wria = factor(WRIA_NR),
    wria_nr_nm = paste0(str_pad(WRIA_NR,width = 2, pad = "0",),"_",WRIA_NM) |> factor()) |>
  select(WRIA_NR, WRIA_NM, wria, wria_nr_nm, acres = WRIA_AREA_ACR_QT) |> arrange(wria) |> 
  sf::st_transform(sf::st_crs(epsg))

sf_cnty <- sf::read_sf(file.path(dir_data_common, "WA_County_Boundaries/WA_County_Boundaries.shp")) |> 
  select(cnty = JURISDIC_2) |> 
  sf::st_transform(sf::st_crs(epsg))
  
# ##flowlines with WRIA added deduplicated via 'largest=T'
# sf_flw <- sf::read_sf(file.path(dir_data_common, "NHDPlus17/NHDSnapshot/Hydrography/NHDFlowline.shp")) |>
#   sf::st_transform(crs = sf::st_crs(epsg)) |>
#   sf::st_zm() |>
#   select(COMID, FCODE, FTYPE, LENGTHKM) |>
#   rename_with(tolower) |>  
#   st_join(sf_cnty, left = F, largest = T) |> #inner join
#   st_join(sf_wrias |> select(wria, wria_nr_nm), left = F, largest = T) |> #inner join
#   mutate(comid = as.character(comid))
# saveRDS(sf_flw, file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_flw.rds"))
sf_flw <- readRDS(file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_flw.rds"))

# # ##catchment polys with WRIA added deduplicated via 'largest=T'
# sf_cat <- sf::read_sf(file.path(dir_data_common, "NHDPlus17/NHDPlusCatchment/Catchment.shp")) |>
#   sf::st_transform(crs = sf::st_crs(epsg)) |>
#   select(comid = FEATUREID, areasqkm = AreaSqKM) |>
#   st_join(sf_cnty, left = F, largest = T) |> #inner join
#   st_join(sf_wrias |> select(wria, wria_nr_nm), left = F, largest = T) |>
#   mutate(comid = as.character(comid))
# saveRDS(sf_cat, file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_cat.rds"))
sf_cat <- readRDS(file.path(dir_data_common, "NHDPlus17/sf_nhdp_wa_cat.rds"))

# # ~608 comids along county borders are assigned different (appropriately, due to geometry+'largest')
# #not splitting geometries (and attributes) so simpler is better
# #visual inspection indicates flowlines should have precedence for associating to StreamCat/NLCD
# mm <- inner_join(
#   sf_cat |> as_tibble() |> select(comid, cnty_cat=cnty),
#   sf_flw |> as_tibble() |> select(comid, cnty_flw=cnty),
#   by = "comid"
#   ) |> 
#   filter(cnty_cat!=cnty_flw)
# x <- sf_cat |> semi_join(mm, by = "comid")
# y <- sf_flw |> semi_join(mm, by = "comid")
# mapview::mapview(list(cat = x, flw = y, cnty = sf_cnty))

# distinct(as_tibble(sf_flw), comid) #66116
# distinct(as_tibble(sf_cat), comid) #57306
# #flowlines with no cat are most pipelines & canalditch (~3K), a third of coastline
# #but also many scattered streamriver and artificalpath statewide but large concentrations in yakima region
# #cat with no flowlines are edge cases, a pothole depressional area SE of Okanagon plus a few other scattered Eastside

```

StreamCat includes values calculated from 8 cycles of the National Land Cover Dataset: 2001, 2004, 2006, 2008, 2011, 2013, 2016, and 2019. The NLCD rasters are based on random forest classification of satellite and other imagery sources [(Wickham et al. 2023)](https://www.tandfonline.com/doi/full/10.1080/15481603.2023.2181143). The StreamCat values represent the percentages of each of 16 land cover classes within each of the *cat* and *catrp100* areas of interest  (AOI), so that the sum across classes is 1 for each AOI (i.e., the *rp100* area is spatially nested, but `rp100` percentages are provided as distinct rather than proportional to the total *cat* area). Approximate acreages were back-calculated simply as:

$$ acres = pct_{nlcd-class} * areasqkm_{cat|catrp100} * 247.11$$

The StreamCat process and NLCD datasets have undergone thorough QAQC and been extensively reviewed since their initial development, resulting in their widespread use in various scientific studies (see Wickham et al 2023 for the most recent NLCD validation study). Nonetheless, as with any remote sensed empirical data, errors persist, and several key caveats are important to note.

  - The underlying hydrographic flowlines and associated catchment polygon mesh have positional error; not all streams, drainage divides, and/or riparian buffer corridors are 'where they should be'.
  - Within any particular NLCD year, substantial ground level variation can occur within the 30m pixel resolution, such that the single cover class assigned to the pixel may poorly describe the actual heterogenity (stated differently, the per-pixel suitability of classification will tend to increase with homogeneity of cover types). 
  - Between different NLCD years, a change in NLCD class may be due to sudden, substantial activity (e.g., a clear cut; fallowing or crop rotation; a new parking lot); to gradual, accumulative shifts of the fine-scale mix of types within-pixel; or potentially to spurious artifacts rather than any actual ground-level change.

Accordingly, these data are a standardized, consistent means to investigate larger-scale, general or cumulative patterns, and are not suited to inferring site specific processes or causes.
 
```{r objects_streamcat_nlcd, eval=FALSE}
## recall riparian buffers are 100m, per https://www.epa.gov/national-aquatic-resource-surveys/streamcat-dataset-readme 
 
# #pull all 4 AOI, including abs areasqkm
# sc_wa_nlcd <- map(
#   set_names(c(2001, 2004, 2006, 2008, 2011, 2013, 2016, 2019))
#   ,
#   ~StreamCatTools::sc_nlcd(
#     state = "WA", year = .x,
#     aoi = 'cat,catrp100,ws,wsrp100',
#     showAreaSqKm = T
#   ) |>
#     rename_with(tolower) |> as_tibble() |>
#     mutate(comid = as.character(comid), nlcd_year = .x)
# )
# saveRDS(sc_wa_nlcd, file.path(dir_data_common, "streamcat", "sc_wa_nlcd.rds"))

# #removing 7 massive cross-border COMIDs mostly in BC; 6 are >1000km2, last is >350km2
# sf_cat |> arrange(desc(areasqkm)) |> filter(areasqkm>1000) |> ggplot() + geom_sf() + geom_sf_text(aes(label = comid))
# sf_cat |> filter(between(areasqkm,100,1000)) |> ggplot() + geom_sf(aes(fill=areasqkm)) + geom_sf_text(aes(label = comid))
# filter(sf_cat, comid =="23031682")->x; mapview::mapview(x)
comids_drop_BC <- filter(as_tibble(sf_cat), areasqkm>1000) |> distinct(comid) |> bind_rows(tibble(comid = "23031682"))

#starting object with cat and catrp100 (no Ws)
#inner_join against sf_cat to add WRIA 
#then second inner_join against sf_flw to add County and get common set across all 3
#dropping remaining comids with NA rp100
#converting pcts to 0-1
#appending 'ac[res]' cols as AOI-specific product of pct and areasqkm
sc_nlcd <- readRDS(file.path(dir_data_common, "streamcat", "sc_wa_nlcd.rds")) |> 
  map(
    ~.x |> 
      rename_with(
        ~str_remove(.,paste(c(2001, 2004, 2006, 2008, 2011, 2013, 2016, 2019),collapse = "|")) |> 
          str_remove("pct")
        ) |> 
      select(comid, nlcd_year, 
             catareasqkm, catareasqkmrp100,
             ends_with("cat"), ends_with("catrp100"))
      ) |> 
  list_rbind() |> 
  anti_join(comids_drop_BC, by = "comid") |> 
  inner_join(as_tibble(sf_cat) |> select(comid, wria, wria_nr_nm), by = "comid") |> 
  inner_join(as_tibble(sf_flw) |> distinct(comid, cnty), by = "comid") |> 
  drop_na(urbmdcatrp100) |> #single lu class captures all 231 comids NA for rp100 vals
  mutate(
    across(c(ends_with("cat"), ends_with("catrp100")), ~./100)
    ,
    # tree_cat = conifcat + decidcat + mxfstcat,
    # tree_catrp100 = conifcatrp100 + decidcatrp100 + mxfstcatrp100,
    urb_cat = urbhicat + urbmdcat,
    urb_catrp100 = urbhicatrp100 + urbmdcatrp100
    ,
    across(ends_with("cat"), list(ac = ~.* catareasqkm * 247.11)),
    across(ends_with("catrp100"), list(ac = ~.* catareasqkmrp100 * 247.11))
    )

#bring both sf to same 56879
sf_flw <- sf_flw |> inner_join(distinct(sc_nlcd, comid), by = "comid") 
sf_cat <- sf_cat |> inner_join(distinct(sc_nlcd, comid), by = "comid")


pal_nlcd <- set_names(
  c("brown","darkgreen","yellow","lightgreen","yellowgreen",
    "yellow","seagreen","white","green","blue",
    "tan","grey10","grey60","grey30","grey80","seagreen")
  ,
  grep("catrp100_ac", names(sc_nlcd), value = T)[1:16] |> 
    str_remove("catrp100_ac") |> sort()
)

#testing focal set
wrias <- as.character(c(1,7,8,10,15, 28,32,37,45,57))

#save.image("sc_ripcorr_nlcd.RData")
```

# Results and Discussion 

## 2001 Baseline

Cover classes are distributed spatially and proportionally as expected in 2001, with more intense urban cover types concentrated in the western portion of the state, particularly in central Puget Sound, and isolated high urban hotspots corresponding to Spokane, Yakima, and Vancouver. A sum of 'forest' cover types (conifer, deciduous, and mixed) captures the large areas of private, state, tribal, and national forest in the Olympics and Cascades as well as the eastern Blue Mountain and Colville regions.

The conifer, shrub, crop, and grass classes make up the largest total areas, with the two lower intensity urban classes (`urbop` and `urblo`, at <20% impervious and <50% impervious respectively) each more extensive than the sum of the two higher intensity classes (`urbmd` and `urbhi`, at <80% and >80% impervious). The relative proportions of the total areas within each AOI are similar across most classes, but the herbaceous and wooded wetland types (`hbwet` and `wdwet`) are relatively more prevalent in the `rp100` riparian corridor, while the higher intensity urban types are slightly less so.

The total area of the `rp100` extent makes up approximately 14.8% of the total 43.3mil acres included in these data, and almost all WRIAs fall within a range of 10-20% for 'riparian corridor / total local catchment area'.

```{r sc_nlcd_2001}
#single year, all attrib both AOI
sc_nlcd_2001 <- sc_nlcd |> 
  filter(nlcd_year==2001) 
```

```{r ggstatewide_urb_tree}
{ 
  inner_join(
    sf_flw,
    sc_nlcd_2001 |> select(comid, ends_with("catrp100")),
    by = "comid"
  ) |> 
    ggplot() +
    geom_sf(aes(color = urbmdcatrp100+urbhicatrp100)) +
    scale_color_gradient(low = "lightblue", high = "grey20") +
    labs(subtitle = "2001 medium + high intensity urban, rp100", color = "Urb% rp100") + theme_minimal()
}+{
  inner_join(
    sf_cat,
    sc_nlcd_2001 |> select(comid, ends_with("cat")),
    by = "comid"
  ) |> 
    ggplot() +
    geom_sf(aes(fill = conifcat+decidcat+mxfstcat), color = NA) +
    scale_fill_gradient(low = "grey90", high = "darkgreen") +
    labs(subtitle = "2001 conifer+deciduous+mixed forest, cat", color = "Tree% cat") + theme_minimal()
} + plot_layout(ncol = 1)

```

```{r gt_statewide_area_cat_rp100}
sc_nlcd_2001 |> 
  select(comid, contains("_ac"), -contains("urb_")) |> 
  summarise(across(contains("_ac"), sum)) |> 
  pivot_longer(contains("_ac")) |> 
  mutate(
    aoi = if_else(str_detect(name, "rp100"), "rp100", "cat"),
    nlcd_class = str_remove(name, "cat") |> str_remove("rp100") |> str_remove("_ac"),
    name = NULL
    ) |> 
  pivot_wider(names_from = aoi, values_from = value) |>
#recall these acreages are still nested: 
#catareasqkm includes catareasqkmrp100
  mutate(
    d_cat_rp100 = cat - rp100,
    rp100_pct_cat = rp100 / cat, 
    across(c(cat, rp100), list(pct_tot = ~./sum(.)))
    ) |> 
  arrange(nlcd_class) |> 
  gt(caption = "2001 NLCD statewide total areas by LU class and AOI") |> 
  fmt_number(c("cat","rp100","d_cat_rp100"), decimals = 0) |> 
  fmt_percent(contains("pct"), decimals = 1) |> 
  data_color(
    columns = "nlcd_class",
    palette = pal_nlcd
    ) |> 
  grand_summary_rows(columns = c("cat","rp100","d_cat_rp100"),fns = ~sum(.), fmt = ~fmt_number(., decimals = 0)) |> 
  tab_style(style = cell_borders(sides = "right"), locations = cells_body(columns = "rp100_pct_cat"))

```

```{r ggwria_rp100pctcat, fig.height=8}
d <- sf_wrias |> 
  left_join(
    sc_nlcd_2001 |> 
      #summarise(across(contains("areasqkm"), sum)) |> 
      summarise(across(contains("areasqkm"), sum), .by = wria_nr_nm) |> 
      mutate(pct = catareasqkmrp100/catareasqkm) |> 
      arrange(pct),
    by = "wria_nr_nm"
  ) 

{
ggplot(as_tibble(d), aes(pct)) + geom_boxplot(outliers = F) + 
  geom_jitter(aes(y = 0, size = catareasqkmrp100), position = position_jitter(height = 0.3), alpha = 0.5, show.legend = F) +
  scale_x_continuous(labels = scales::percent, limits = c(0, 0.2)) +
    scale_size_area() +
  labs(
    title = "Area of 'rp100' as percentage of total 'cat' area", x = NULL, y = NULL,
    subtitle = "Points scaled to rp100 area") +
    theme(axis.text.y = element_blank())
  }/{
ggplot(d) + geom_sf(aes(fill = pct)) +
  scale_fill_continuous(labels = scales::percent) +
  labs(fill = "(rp100/cat)%")
} + plot_layout(heights = c(1,3)/5)
```

## Patterns since 2001

### Statewide 

Aggregating to statewide totals, higher intensity urban cover has steadily increased within both local catchments and the 100m riparian corridor at similar rates since 2001. Annualizing from a basic OLS fit of $$ acres_{urban} \sim year_{NLCD} $$, suggests that, on average, approximately 179 and 655 acres per year of high and medium intensity urban cover have been added within 100m of WA watercourses. Not all of this increase is necessarily due to losses of natural vegetation cover. However, in conjunction with the 95 acre/year increase in the "low" class, these increases substantially exceed the 264 ac/y decrease in urban "open".

```{r ggstatewide_ac_urb_nlcd_year}
sc_nlcd |> 
  summarise(
    across(
      contains("urb") & ends_with("ac"),
      list(sum = ~sum(.))
    )
    , .by = c(nlcd_year)
  ) |> 
  select(-contains("urb_")) |> 
  pivot_longer(cols = -nlcd_year, values_to = "ac") |> 
  mutate(
    aoi = if_else(str_detect(name, "rp100"), "rp100", "cat"),
    nlcd_class = str_remove(name, "cat") |> str_remove("rp100") |> str_remove("_ac_sum"),
    name = NULL
    ) |>
  pivot_wider(names_from = aoi, values_from = ac) |> 
  mutate(d_cat_rp100 = cat - rp100) |> 
  pivot_longer(c(cat, rp100, d_cat_rp100), names_to = "aoi", values_to = "ac") |> 
  filter(aoi != "cat") |> 
##confirming ggpmisc values
  #filter(nlcd_class=="urbhi", aoi =="rp100") -> d; lm(ac~nlcd_year, d) -> d; broom::tidy(d); rm(d)
  split(~nlcd_class) |> 
  map(
    ~.x |> 
      ggplot(aes(nlcd_year, ac, fill = nlcd_class)) +
      geom_col(show.legend = F) +
      #geom_smooth(method = "lm", show.legend = F) +
      ggpmisc::stat_poly_line(color = "blue", se = T, show.legend = F) +
      # ggpmisc::stat_poly_eq(ggpmisc::use_label(c("adj.R2", "p")), color = "orange") +
      ggpmisc::stat_fit_tidy(
        method = "lm",
        label.x = "right", label.y = "top", vjust = -0.7,
        method.args = list(formula = y ~ x),
        mapping = aes(
          label = sprintf(
            "est. slope = %.0f ac/yr", #"Slope = %.3g\np-value = %.3g",
            after_stat(x_estimate)#, after_stat(x_p.value)
            )
          ),
        color = "blue"
      ) +
      coord_cartesian(clip = "off") +
      scale_fill_manual(values = pal_nlcd[grep(unique(.x$nlcd_class), names(pal_nlcd))]) + 
      scale_y_continuous(labels = scales::comma) +
      facet_wrap(~aoi, ncol = 2, strip.position = "top", scales = "free") +
      #facet_wrap(~aoi, ncol = 3, strip.position = "top", scales = "free") +
        labs(y = paste("acres", unique(.x$nlcd_class)), subtitle = unique(.x$nlcd_class)) +
      theme(strip.text = element_text(hjust = 0.1))
  ) |> 
  wrap_plots(ncol = 1, guides = "collect")

```

### By county

Considerable variation among watersheds is evident in the overall magnitude and relative rates of urban cover change outside of and within the riparian corridor.

```{r ggwria_ac_urb_nlcd_year, fig.height=6}
#calc approx acres per-wria, per-aoi, per-urban-class, per-year
#then estimate annual acres change rp100 per annual acre change outside rp100 (d_cat_rp100) 
d <- sc_nlcd |> 
  summarise(
    across(
      contains("urb") & ends_with("ac"),
      list(sum = ~sum(.))
    )
    , .by = c(wria, wria_nr_nm, nlcd_year)
  ) |> 
  select(-contains("urb_")) |> 
  pivot_longer(cols = -c(wria, wria_nr_nm, nlcd_year), values_to = "ac") |> 
  mutate(
    aoi = if_else(str_detect(name, "rp100"), "rp100", "cat"),
    nlcd_class = str_remove(name, "cat") |> str_remove("rp100") |> str_remove("_ac_sum"),
    name = NULL
  ) |> 
  pivot_wider(names_from = aoi, values_from = ac) |> 
  mutate(d_cat_rp100 = cat - rp100) |> 
  pivot_longer(c(cat, rp100, d_cat_rp100), names_to = "aoi", values_to = "ac") |> 
  arrange(wria, aoi, nlcd_class, nlcd_year) |> 
  nest(.by = c(wria, wria_nr_nm, aoi, nlcd_class)) |> 
  mutate(
    lm_ac_y = map(data, ~lm(ac ~ nlcd_year, data = .x)),
    lm_ac_y_est = map_dbl(lm_ac_y, ~broom::tidy(.x) |> filter(term=="nlcd_year") |> pluck("estimate")),
    ac_2001 = map_dbl(data, ~filter(.x, nlcd_year==2001) |> pluck("ac"))
  ) |> 
  select(wria, wria_nr_nm, aoi, nlcd_class, ac_2001, lm_ac_y_est) |> 
  pivot_wider(names_from = aoi, values_from = c(ac_2001, lm_ac_y_est))

# g <- d |> 
#   filter(str_detect(nlcd_class, "hi|md")) |> 
#   ggplot(aes(label = wria_nr_nm)) +
#   # geom_col(aes(lm_ac_y_est_d_cat_rp100, fct_reorder(wria_nr_nm, lm_ac_y_est_d_cat_rp100, min))) +
#   # geom_col(aes(lm_ac_y_est_rp100, fct_reorder(wria_nr_nm, lm_ac_y_est_d_cat_rp100, min)), alpha = 0.5, fill = "red") +
#   geom_point(aes(lm_ac_y_est_d_cat_rp100, lm_ac_y_est_rp100,
#                  color = nlcd_class, size = ac_2001_rp100), 
#              show.legend = F) +
#   scale_color_manual(values = pal_nlcd[grep("urb", names(pal_nlcd))]) +
#   scale_size_area() +
#   facet_wrap(~nlcd_class, ncol = 1, scales = "free") +
#   labs(
#     title = "Estimated annual change in urban cover within vs outside rp100 corridor",
#     subtitle = "Point size scaled to 2001 acres of cover in rp100",
#     x = "Est. ac/year outside rp100",
#     y = "Est. ac/year within rp100"
#   )
# plotly::ggplotly(g)

#the ratio alone is sensitive to small denominators and mostly highlights locations with less cat-wide urb
d <- sf_wrias |> 
  left_join(
    d |> 
      filter(str_detect(nlcd_class, "hi|md")) |> 
      mutate(
        ac_y_rp100_per_d_cat = lm_ac_y_est_rp100 / lm_ac_y_est_d_cat_rp100
        #across(c(lm_ac_y_est_rp100, lm_ac_y_est_d_cat_rp100), list(per = ~. / lm_ac_y_est_d_cat_rp100))
      ) |>  
      arrange(desc(ac_y_rp100_per_d_cat))
    , by = c("wria", "wria_nr_nm")
  ) 

# {
# d |> 
#   ggplot() + 
#   geom_sf(aes(fill = lm_ac_y_est_d_cat_rp100)) +
#   wacolors::scale_fill_wa_c("vantage", midpoint = 100) +
#   facet_wrap(~nlcd_class, ncol = 1) +
#   labs(
#     subtitle = "Outside 100m riparian corridor",
#     fill = "est. ac/y"
#   )
# }

{
  d |> 
  ggplot() + 
  geom_sf(aes(fill = lm_ac_y_est_d_cat_rp100)) +
  wacolors::scale_fill_wa_c("vantage", midpoint = 100) +
  facet_wrap(~nlcd_class, ncol = 1) +
  labs(
    subtitle = "Outside 100m riparian corridor",
    fill = "est. ac/y"
  ) + theme_minimal() + theme(axis.text = element_blank())
}+{
d |> 
  #filter(nlcd_class == "urbhi") |> 
  ggplot() + 
  #geom_sf(aes(fill = ac_y_rp100_per_d_cat)) +
  geom_sf(aes(fill = lm_ac_y_est_rp100)) +
  wacolors::scale_fill_wa_c("vantage", midpoint = 10) +
  facet_wrap(~nlcd_class, ncol = 1) +
  labs(
    subtitle = "Within 100m riparian corridor",
    fill = "est. ac/y"
  ) + theme_minimal() + theme(axis.text = element_blank())
} + 
  plot_layout(nrow = 1) + 
  plot_annotation(title = "Estimated annual urban cover change 2001-2019")
```

Stratification by county organizes some of this spatial variation in NLCD urban cover classes by a relevant jurisdictional unit.

```{r sc_nlcd_ac_y_cnty}
#calc approx acres per-wria, per-aoi, per-urban-class, per-year
#then estimate annual acres change rp100 per annual acre change outside rp100 (d_cat_rp100) 
sc_nlcd_ac_y_cnty <- sc_nlcd |> 
  summarise(
    across(
      contains("urb") & ends_with("ac"),
      list(sum = ~sum(.))
    )
    , .by = c(cnty, nlcd_year)
  ) |> 
  select(-contains("urb_")) |> 
  pivot_longer(cols = -c(cnty, nlcd_year), values_to = "ac") |> 
  mutate(
    aoi = if_else(str_detect(name, "rp100"), "rp100", "cat"),
    nlcd_class = str_remove(name, "cat") |> str_remove("rp100") |> str_remove("_ac_sum"),
    name = NULL
  ) |> 
  pivot_wider(names_from = aoi, values_from = ac) |> 
  mutate(d_cat_rp100 = cat - rp100) |> 
  pivot_longer(c(cat, rp100, d_cat_rp100), names_to = "aoi", values_to = "ac") |> 
  arrange(cnty, aoi, nlcd_class, nlcd_year) 

lm_nlcd_ac_y_cnty <- sc_nlcd_ac_y_cnty |> 
  nest(.by = c(cnty, aoi, nlcd_class)) |> 
  mutate(
    lm_ac_y = map(data, ~lm(ac ~ nlcd_year, data = .x)),
    lm_ac_y_est = map_dbl(lm_ac_y, ~broom::tidy(.x) |> filter(term=="nlcd_year") |> pluck("estimate")),
    ac_2001 = map_dbl(data, ~filter(.x, nlcd_year==2001) |> pluck("ac"))
  ) |> 
  select(cnty, aoi, nlcd_class, ac_2001, lm_ac_y_est) |> 
  pivot_wider(names_from = aoi, values_from = c(ac_2001, lm_ac_y_est))

```

Differences among counties are evident in both the overall magnitude and the relative rates between the riparian corridor values and those for the encompassing local catchment.

The estimated acres of each NLCD urban class within the `rp100` AOI of example counties illustrates how the two higher impervious cover classes (darker bars) are typically present at smaller extents but exhibit proportionally larger changes among NLCD-years (fig column-series).

```{r ggcnty_ac_y_urb_cols}
#split|>map pattern for side by side aoi is visually overwhelming with change in time of multiple nlcd_class
#focus first here on just rp100

sc_nlcd_ac_y_cnty |> 
  filter(
    aoi == "rp100", 
    #str_detect(nlcd_class, "hi|md")
    str_detect(cnty, "akim|okane|hurst|nohom")
  ) |> 
  ggplot(aes(nlcd_year, ac, group = cnty, fill = nlcd_class)) +
  geom_col(show.legend = F) +
  scale_x_continuous(breaks = c(2001, 2004, 2006, 2008, 2011, 2013, 2016, 2019)) + #unique(sc_nlcd_ac_y_cnty$nlcd_year)
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = pal_nlcd[grep("urb", names(pal_nlcd))]) +
  facet_grid(rows = vars(cnty), cols = vars(nlcd_class), scales = "free_y") +
  labs(
    title = "Example counties showing rp100 acreage of NLCD urban classes",
    subtitle = "Note differences in y-axis scale among counties",
    x = NULL, y = "acres"
    ) +
  theme(axis.text = element_text(size = 7))

```

Clicking individual county names in the legend will focus on only those traces.

```{r plotly_ac_y_urb_lines_multi, include=FALSE, eval=FALSE}
lapply(
  sc_nlcd_ac_y_cnty |>
    filter(aoi == "rp100") |>
    split(~nlcd_class)
  ,
  \(x){
    plotly::plot_ly(
      data = x,
      type = 'scatter', mode = 'markers+lines',
      name = ~cnty, x = ~nlcd_year, y = ~ac,
      color = ~nlcd_class, colors = pal_nlcd[grep("urb", names(pal_nlcd))]
      # #generates a single 4 panel with per-panel names and without duplicated labels
      # #but label on/off not shared across panels 
      #showlegend = x$nlcd_class[1] == "urbhi"
    ) |>
      plotly::layout(
        annotations = list(
          x = 2001, y = 1.05*max(x$ac),
          text = x$nlcd_class[1],
          showarrow = FALSE
        )
      )
  }
) #|> plotly::subplot(nrows = 4)
```

```{r plotly_ac_y_urb_lines_hi}
#single nlcd_class
sc_nlcd_ac_y_cnty |>
  filter(aoi == "rp100", nlcd_class == "urbhi") |>
  plotly::plot_ly(
    type = 'scatter', mode = 'markers+lines',
      name = ~cnty, x = ~nlcd_year, y = ~ac,
      color = ~nlcd_class, colors = pal_nlcd[grep("urb", names(pal_nlcd))]
  ) |>
  plotly::layout(
    title = list(text = "Urbhi")
  )

```
```{r plotly_ac_y_urb_lines_md}
sc_nlcd_ac_y_cnty |>
  filter(aoi == "rp100", nlcd_class == "urbmd") |>
  plotly::plot_ly(
    type = 'scatter', mode = 'markers+lines',
      name = ~cnty, x = ~nlcd_year, y = ~ac,
      color = ~nlcd_class, colors = pal_nlcd[grep("urb", names(pal_nlcd))]
  ) |>
  plotly::layout(
    title = list(text = "Urbmd")
  )

```
```{r plotly_ac_y_urb_lines_lo}
#single nlcd_class
sc_nlcd_ac_y_cnty |>
  filter(aoi == "rp100", nlcd_class == "urblo") |>
  plotly::plot_ly(
    type = 'scatter', mode = 'markers+lines',
      name = ~cnty, x = ~nlcd_year, y = ~ac,
      color = ~nlcd_class, colors = pal_nlcd[grep("urb", names(pal_nlcd))]
  ) |>
  plotly::layout(
    title = list(text = "Urblo")
  )

```
```{r plotly_ac_y_urb_lines_op}
#single nlcd_class
sc_nlcd_ac_y_cnty |>
  filter(aoi == "rp100", nlcd_class == "urbop") |>
  plotly::plot_ly(
    type = 'scatter', mode = 'markers+lines',
      name = ~cnty, x = ~nlcd_year, y = ~ac,
      color = ~nlcd_class, colors = pal_nlcd[grep("urb", names(pal_nlcd))]
  ) |>
  plotly::layout(
    title = list(text = "Urbop")
  )

```

Viewed as the linear regression estimate of per-year change, the medium and high classes show consistent increases (i.e., positive slope estimates) across counties, while the low and open classes show variation with some counties decreasing in these classes.
(fig boxplot of rp100 lm-est by nlcd-class)

```{r ggcnty_ac_y_urb_box}
## if not html
# lm_nlcd_ac_y_cnty |> 
#   ggplot(aes(lm_ac_y_est_rp100, nlcd_class, color = nlcd_class)) +
#   geom_vline(xintercept = 0, linewidth = 0.3) +
#   geom_jitter(aes(size = ac_2001_rp100), position = position_jitter(height = 0.2), alpha = 0.5, show.legend = F) +
#   geom_boxplot(outliers = F, show.legend = F) +
#   scale_size_area(max_size = 4) +
#   scale_color_manual(values = pal_nlcd[grep("urb", names(pal_nlcd))]) +
#   labs(
#     title = "Annual changes by county in NLCD urban classes within riparian corridor",
#     subtitle = "Sample distributions of linear estimate of rp100 acres ~ NLCD year",
#     x = "est. acres/year", y = NULL
#   )

lm_nlcd_ac_y_cnty |> 
  mutate(nlcd_class = factor(nlcd_class)) |> 
  plotly::plot_ly(
        color = ~nlcd_class, colors = pal_nlcd[grep("urb", names(pal_nlcd))]
  ) |> 
  plotly::add_trace(
    x = ~lm_ac_y_est_rp100, 
    y = ~nlcd_class, 
    type = "box", hoverinfo = 'name+x', showlegend = F
  ) |> 
  plotly::add_markers(
    x = ~lm_ac_y_est_rp100,
    y = ~nlcd_class, 
    marker = list(size = 6),
    hoverinfo = 'text', text = ~paste(cnty, round(lm_ac_y_est_rp100,3)),
    showlegend = F
  )

```

These shifts within the riparian corridor are informed by the trajectory of urban cover in the area of each local catchment outside of the `rp100` extent. Comparing the medium and high classes this way, the within-corridor increases show clear inflections at roughly 30ac/y and 100ac/y for medium and high respectively, as well as saturation with increasing outside-corridor increases. Notably, the considerable scatter in within-corridor values at a given outside-corridor indicates clear differences between counties in where urban cover increases may have been concentrated.

(fig scatter of rp100 lm-est ~ d_cat_rp100 lm_est)

```{r ggcnty_ac_y_urb_scatter}
g <- lm_nlcd_ac_y_cnty |> 
  filter(str_detect(nlcd_class, "hi|md")) |> 
  ggplot(aes(label = cnty, color = nlcd_class)) +
  geom_point(aes(lm_ac_y_est_d_cat_rp100, lm_ac_y_est_rp100,
                 size = ac_2001_rp100), 
             show.legend = F) +
  geom_smooth(aes(lm_ac_y_est_d_cat_rp100, lm_ac_y_est_rp100)) +
  scale_color_manual(values = pal_nlcd[grep("urb", names(pal_nlcd))]) +
  scale_size_area() +
  facet_wrap(~nlcd_class, ncol = 1, scales = "free") +
  labs(
    title = "Estimated annual change in urban cover within vs outside rp100 corridor",
    subtitle = "Point size scaled to 2001 acres of cover in rp100",
    x = "Est. ac/year outside rp100",
    y = "Est. ac/year within rp100"
  )

plotly::ggplotly(g)
```

As an example, focusing on the `urbhi` class, Thurston (~77ac/y) and Yakima (~72ac/y) counties exhibit similar increases in the area outside `rp100`, but the ~14ac/yr within the riparian corridor of the latter was roughly 7 times the ~2ac/y of the former. Within Yakima county, most of the riparian corridor 'urban high' increase appears to have occurred in the same local catchments that experienced appreciable non-`rp100` increase. In contrast, the Thurston county local catchment with the most urban increase outside of `rp100` had relatively little change within the corridor. However, at the aggregated county scale, the larger total `rp100` increase in Yakima county appears due to the more widespread occurrence of reaches with both larger and smaller increases. It is possible that some of these smaller increases may be related to data artifacts, perhaps related to the more arid conditions.

But...compare Snohom and Spokane, which are reversed E/W-dry/wet and below/above avg for rp100~d_cat_rp100

```{r ggcnty_ac_y_urb_sf_focal_cnty}
d <- sc_nlcd |> 
  filter(
    str_detect(cnty, "hurst|akima")
    ,
    nlcd_year %in% c(2001, 2019)
    ) |> 
  #select(cnty, comid, nlcd_year, urbhicatrp100_ac) |> 
  #pivot_wider(names_from = nlcd_year, values_from = urbhicatrp100_ac) |> 
  #mutate(d = `2019`-`2001`) |> 

  select(cnty, comid, nlcd_year, contains("urbhi") & contains("_ac")) |> 
  mutate(
    #trace cover class percentages can generate negative d_cat_rp100 at single comid scale (e.g., 23105084)
    #so coerce rp100 down to cat value if greater
    urbhicatrp100_ac = if_else(urbhicatrp100_ac > urbhicat_ac, urbhicat_ac, urbhicatrp100_ac),
    urbhi_d_cat_rp100 = urbhicat_ac - urbhicatrp100_ac
    , urbhicat_ac = NULL
    ) |>  
  #filter(urbhi_d_cat_rp100 < 0) |> arrange(desc(abs(urbhi_d_cat_rp100)))
  pivot_wider(names_from = nlcd_year, values_from = contains("urbhi")) |> 
  mutate(
    d_rp100 = urbhicatrp100_ac_2019 - urbhicatrp100_ac_2001,
    d_out = urbhi_d_cat_rp100_2019 - urbhi_d_cat_rp100_2001
    ) |> 
  filter(urbhi_d_cat_rp100_2019 > 0 | urbhicatrp100_ac_2019 > 0) |> 
  arrange(d_out) |> 
  #12 cases of very small negative diffs in d_out for 19-01, all with d_rp100 < 1
  #could coerce to 0 but simpler to exclude
  filter(d_out >= 0)

d_sf_cat <- sf_cat |> 
  select(-cnty) |> 
  inner_join(d, by = "comid")

d_sf_flw <- sf_flw |> 
  select(-cnty) |> 
  inner_join(d, by = "comid")

{
ggplot() +
  geom_sf(data = d_sf_cat, aes(fill = d_out), color = "lightgrey", linewidth = 0.1) +
  geom_sf(data = d_sf_flw, color = "lightblue", linewidth = 0.3) +
  wacolors::scale_fill_wa_c("forest_fire", limits = c(0, max(d$d_out)*1.05), aesthetics = c("fill","color"), reverse = T) +
  ggspatial::annotation_scale() +
    labs(subtitle = "Outside rp100 corridor")
}/{
ggplot() +
  geom_sf(data = d_sf_cat, color = "lightgrey", fill = "white", linewidth = 0.1) +
  geom_sf(data = d_sf_flw, aes(fill = d_rp100, color = d_rp100)) +
  wacolors::scale_fill_wa_c("forest_fire", limits = c(0, max(d$d_rp100)*1.05), aesthetics = c("fill","color"), reverse = T) +
  ggspatial::annotation_scale() +
    labs(subtitle = "Within rp100 corridor")
}+
  plot_layout(ncol = 1) |> 
  plot_annotation(
    title = "Estimated increase in acres NLCD urban high cover class", subtitle = "Thurston and Yakima counties"
  )
```

these need work, among other problems xscales are deceptive, even when filtering >0 some values <<1 look like zeros

```{r fig.height=6}
{
d |> 
  filter(d_out > 0) |> 
  ggplot() +
  geom_histogram(aes(d_out, fill = cnty), position = position_dodge(width = 0.3))
}+{
d |> 
  #filter(d_rp100 > 0) |> 
  ggplot() +
  geom_histogram(aes(d_rp100, fill = cnty), position = position_dodge(width = 0.3))
}
```


# Citations

Hill, Ryan A., Marc H. Weber, Scott G. Leibowitz, Anthony R. Olsen, and Darren J. Thornbrugh, 2016. The Stream-Catchment (StreamCat) Dataset: A Database of Watershed Metrics for the Conterminous United States. Journal of the American Water Resources Association (JAWRA) 52:120-128. DOI: 10.1111/1752-1688.12372.

Weber M (2025). _StreamCatTools: Tools to Work with the StreamCat API Within R and Access the Full Suite of StreamCat and LakeCat Metrics_. R package version 0.6.0, commit d8a8cce142e7cb9e3666a2660a8315a1766e5981, <https://github.com/USEPA/StreamCatTools>.


::: {.content-hidden when-format="html"}

```{r sf_ugas}
#??
sf::read_sf(file.path(dir_data_common, "wa_dor_uga.gdb")) 
```

*other/more*
  - (eastern US, comparison against 1m^2 urban cover showed very good agreement overall, somewhat worse for riparian exclusively)
    - https://www.usgs.gov/publications/accuracy-assessment-nlcd-2011-impervious-cover-data-chesapeake-bay-region-usa
  - bring back sc_imperv?
```{r pctimp_back, include=FALSE, eval=F}
"~/T/DFW-Team WDFW Watershed Synthesis - data_common/streamcat/ImperviousSurfacesRipBuf100_WA.csv"
StreamCatTools::sc_get_data(
  comid = "23989097", metric = "pctimp2001",
  # state = "WA", year = .x,
  aoi = 'cat,catrp100,ws,wsrp100',
  showAreaSqKm = T
  ) |>
  rename_with(tolower) |> as_tibble()
sc_nlcd_2001 |> filter(comid =="23989097")

```
  - add in sc_bfw?
```{r sc_wa_bfw, eval=FALSE}
sc_wa_bfw <- StreamCatTools::sc_get_data(
  state = "WA",
  metric = 'bankfullwidth', aoi = 'other'
) |> 
  mutate(comid = as.character(comid))

#append to sf multilinestring of WA flowlines
sf_flw <- sf_flw |> 
  left_join(sc_wa_bfw, by = "comid")

sf_flw |> 
  drop_na(bankfullwidth) |> 
  ggplot() + geom_sf(aes(linewidth = bankfullwidth), color = "blue")

```


```{r qaqc, include=F, eval=FALSE}
#trace cover class percentages can generate negative d_cat_rp100 at single comid scale
x<-filter(sf_flw, comid=="23105084"); y<-filter(sf_cat, comid=="23105084"); mapview::mapview(x)+mapview::mapview(y)
x<-filter(sf_flw, comid=="24422847"); y<-filter(sf_cat, comid=="24422847"); mapview::mapview(x)+mapview::mapview(y)

#wria 12 is basically just the cities between JBLM and Tacoma, small mostly built or already protected
x<-filter(sf_flw, wria=="12"); y<-filter(sf_cat, wria=="12"); mapview::mapview(x)+mapview::mapview(y)

#digging into a high ratio of rp100/d_cat_rp100
#illustrates sensitivity to small d_cat_rp100 as well as potential processing artifacts
g <- sf_cat |> 
  filter(wria=="16") |> 
  left_join(
    sc_nlcd |> 
      filter(wria=="16") |> #to speed up following operations
      select(comid, nlcd_year, contains("rp100_ac") & contains("urbhi")) |> 
      pivot_longer(cols = -c(comid, nlcd_year), values_to = "ac") |> 
      mutate(
        aoi = if_else(str_detect(name, "rp100"), "rp100", "cat"),
        nlcd_class = str_remove(name, "cat") |> str_remove("rp100") |> str_remove("_ac"),
        name = NULL
        , nlcd_year = factor(nlcd_year)
      )
    ,
    by = "comid"
  ) |> 
  ggplot() +
  geom_sf(aes(fill = ac), color = "grey90", linewidth = 0.1) +
  #scale_fill_gradient(low = "white", high = "grey10") +
  wacolors::scale_fill_wa_c("vantage") +
  #facet_wrap(~nlcd_year, nrow = 2) +
  labs(subtitle = "High intensity urban cover in rp100") 

gganimate::animate(
  g + 
    #gganimate::transition_time(nlcd_year) +
    gganimate::transition_states(nlcd_year) +
    gganimate::ease_aes() +
    gganimate::enter_fade() +
    #labs(title = 'year: {frame_time}')
    labs(title = 'year: {closest_state}')
  , nframes = 2*8, fps = 1, 
  renderer = gifski_renderer()
)

x<-filter(sf_flw, wria=="16"); y <- filter(sf_cat, wria=="16"); mapview::mapview(x)+mapview::mapview(y)
sc_nlcd |> 
  # #the large ONF poly "24287056" looks artifactual; hard to see even 1.8ac of 'mostly impervious' cover other than river gravel
  # filter(comid == "24287056") |> 
  # whereas the Brinnon comid going from 2.7 to 4.5 ac mostly imperv within 100m is quite plausible
  filter(comid == "24286928") |> 
  select(nlcd_year, contains("urb") & contains("hi"))



```

```{r starting_refactor_arrowswarm, eval=FALSE}

#steeper/more vertical indicates greater riparian increase than encompassing
#versus flatter for surrounding increases without riparian

#define comids with non-zero urban cover in final NLCD year; could threshold to larger %
#drop second filter condition if not focusing the tree change on only those comids with +urban
#first look showed qualitatively similar and just including many more 'rural' cats
#further below created vector of 'urban in rp100' comids to limit even more

comids_2019_urb <- sc_nlcd |> 
  filter(nlcd_year == 2019, (urbmdcat + urbhicat > 0)) |> 
  distinct(comid)

d <- sc_nlcd |> 
    filter(nlcd_year %in% c(2001, 2019)
           #, comid %in% comid_2019_urb
           ) |> 
    select(comid, nlcd_year, wria, wria_nr_nm,
           starts_with("urb_")) |> 
    pivot_wider(names_from = nlcd_year, values_from = contains("cat")) |>
    mutate(
      d_cat = urb_cat_2019 - urb_cat_2001,
      d_catrp100 = urb_catrp100_2019 - urb_catrp100_2001
      ,
      d_cat_ac = urb_cat_ac_2019 - urb_cat_ac_2001,
      d_catrp100_ac = urb_catrp100_ac_2019 - urb_catrp100_ac_2001
    ) |> 
    filter(wria %in% wrias)

#in pct units
d |> 
    ggplot() + 
    geom_segment(aes(
      x = urb_cat_2001, y = urb_catrp100_2001,
      xend = urb_cat_2019, yend = urb_catrp100_2019,
      color = d_cat - d_catrp100 
    ),
    arrow = arrow(length = unit(0.05,"npc")),
    show.legend = T) +
    geom_abline(slope = 1, intercept = 0, linetype = 3) +
    wacolors::scale_color_wa_c("lopez", midpoint = 0) +
    scale_x_continuous(labels = scales::percent) +
    scale_y_continuous(labels = scales::percent) +
    facet_wrap(~wria_nr_nm, ncol = 1, strip.position = "right") +
    theme(strip.text = element_text(size = 5), legend.position = "top") +
    labs(
      title = "2001 to 2019 urban cover change",
      subtitle = "StreamCat NLCD %urban high+medium",
      x = "whole local catchment",
      y = "100m riparian corridor %urban"
    )

#in acres...order of mag diffs make not very helpful other than for seeing extremes?
d |> 
    ggplot() + 
    geom_segment(aes(
      x = urb_cat_ac_2001, y = urb_catrp100_ac_2001,
      xend = urb_cat_ac_2019, yend = urb_catrp100_ac_2019,
      color = d_cat_ac - d_catrp100_ac 
    ),
    arrow = arrow(length = unit(0.05,"npc")),
    show.legend = T) +
    geom_abline(slope = 1, intercept = 0, linetype = 3) +
    wacolors::scale_color_wa_c("lopez", midpoint = 0) +
    scale_x_continuous(labels = scales::comma) +
    scale_y_continuous(labels = scales::comma) +
    facet_wrap(~wria_nr_nm, ncol = 1, scales = "free", strip.position = "right") +
    theme(strip.text = element_text(size = 5), legend.position = "top") +
    labs(
      title = "2001 to 2019 urban cover change",
      subtitle = "StreamCat NLCD approx acres urban high+medium",
      x = "whole local catchment",
      y = "100m riparian corridor"
    )


## NOT YET REFACTORED FROM HERE DOWN
## "tree"
  sc_nlcd_cat_ac |> 
    filter(nlcd_year %in% c(2001, 2019), comid %in% comid_2019_urb) |> 
    select(comid, nlcd_year, wria, wria_nr_nm,
           starts_with("tree_")) |> 
    pivot_wider(names_from = nlcd_year, values_from = contains("cat")) |>
    mutate(
      d_cat = tree_cat_2019 - tree_cat_2001,
      d_catrp100 = tree_catrp100_2019 - tree_catrp100_2001
      , 
      d_catrp100f = case_when(
        d_catrp100 < 0 & d_cat < 0 ~ "both dec",
        d_catrp100 >= 0 & d_cat >= 0 ~ "both inc",
        d_catrp100 < 0 & d_cat >= 0 ~ "rp100 dec",
        d_catrp100 >= 0 & d_cat < 0 ~ "cat dec"
      )
    ) |>
    filter(wria %in% wrias) |> 
    #filter(d_catrp100f=="rp100 dec") |> summarise(across(contains("ac_"), sum), .by = wria_nr_nm)
    summarise(across(contains("ac_"), sum), .by = c(d_catrp100f, wria_nr_nm)) |> 
    mutate(
      d_cat_ac = tree_cat_ac_2019 - tree_cat_ac_2001,
      d_catrp100_ac = tree_catrp100_ac_2019 - tree_catrp100_ac_2001
    ) |> 
    select(wria_nr_nm, d_catrp100f, contains("cat_"), contains("catrp100_")) |> 
    arrange(wria_nr_nm, d_catrp100f) |> 
    gt(groupname_col = "wria_nr_nm", rowname_col = "d_catrp100f") |> fmt_number(decimals = 0) |> 
    tab_style_body(fn = \(x){x<0}, style = cell_text(color = "red"))
  ggplot() + 
    geom_segment(aes(
      x = tree_cat_2001, y = tree_catrp100_2001,
      xend = tree_cat_2019, yend = tree_catrp100_2019,
      color = d_catrp100
    ),
    arrow = arrow(length = unit(0.05,"npc")),
    show.legend = T) +
    geom_abline(slope = 1, intercept = 0, linetype = 3) +
    wacolors::scale_color_wa_c("stuart", midpoint = 0) +
    scale_x_continuous(labels = scales::percent) +
    scale_y_continuous(labels = scales::percent) +
    facet_wrap(~wria_nr_nm+d_catrp100f, ncol = 4, 
               labeller = label_wrap_gen(multi_line = F),
               strip.position = "right") +
    theme(strip.text = element_text(size = 5), legend.position = "top") +
    labs(
      title = "2001 to 2019 tree cover change",
      subtitle = "StreamCat NLCD %confi+decid+mxfst; comids with urban > 0 in 2019",
      x = "whole local catchment",
      y = "100m riparian corridor %tree"
    )

```

not usable as is, and likely not helpful due to summing over per-comid different +/- change within wria AND even with free scale hard to see smaller wria vs larger wria diffs
```{r perwria_sum_d1901_col_by_nlcd_class, eval=FALSE}
sc_nlcd |> 
  filter(nlcd_year %in% c(2001, 2019)) |> 
  select(wria, wria_nr_nm, nlcd_year, comid, contains("_ac"), -contains("urb_")) |> 
  summarise(across(contains("_ac"), sum), .by = c(nlcd_year, wria, wria_nr_nm)) |> 
  pivot_longer(contains("_ac")) |> 
  mutate(
    aoi = if_else(str_detect(name, "rp100"), "rp100", "cat"),
    nlcd_class = str_remove(name, "cat") |> str_remove("rp100") |> str_remove("_ac"),
    name = NULL
    ) |> 
  pivot_wider(names_from = nlcd_year, values_from = value) |> 
  mutate(
    d1901 = `2019`-`2001`,
    d1901pct = d1901/`2001`
    ) |> 
  ggplot() +
  geom_col(aes(d1901, wria, fill = nlcd_class, alpha = d1901 > 0), show.legend = F) +
  scale_fill_manual(values = pal_nlcd) +
  scale_alpha_manual(values = c(0.3,0.8)) +
  geom_vline(xintercept = 0) +
  facet_wrap(~nlcd_class, nrow = 1, scales = "free")
```


delete soon...
```{r streamcat_nlcd_overall_LUclass_EDA, eval=FALSE}
## overall spatial patterns of streamcat NLCD classes
## parsing to determine whether/how to drop and/or aggregate classes

sc_nlcd_cat <- readRDS(file.path(dir_data_common, "streamcat", "sc_wa_nlcd.rds")) |> 
  map(
    ~.x |> 
      rename_with(~str_remove(.,paste(c(2001, 2004, 2006, 2008, 2011, 2013, 2016, 2019),collapse = "|")) |> 
                    str_remove("pct")) |> 
      select(comid, nlcd_year, catareasqkm, ends_with("cat"))
      ) |> 
  list_rbind() |> 
# distinct(comid, .keep_all = T) |>  #57313
#   anti_join(as_tibble(sf_cat), by ="comid")
  inner_join(
    as_tibble(sf_cat) |> select(comid, wria, wria_nr_nm), by = "comid"
  )

#all classes all years by wria
sc_nlcd_cat_ac_year_wria <- sc_nlcd_cat |> 
  mutate(
    across(ends_with("cat"), ~./100*catareasqkm*247.11)
  ) |> 
  summarise(
    across(ends_with("cat"), sum),
    .by = c(nlcd_year, wria, wria_nr_nm)
  ) |> 
  pivot_longer(-c(nlcd_year,wria,wria_nr_nm), names_to = "nlcd_class", values_to = "ac") |> 
  mutate(nlcd_class = str_remove(nlcd_class, "cat"))

##statewide totals by nlcd_year
# #as statewide pct; think this may be more misleading than helpful
# sc_nlcd_cat_ac_year_wria |> 
#   summarise(ac = sum(ac), .by = c(nlcd_year, nlcd_class)) |> 
#   mutate(pct = ac/sum(ac), .by = nlcd_year) |> 
#   ggplot() + 
#   geom_col(aes(nlcd_year, pct, fill = nlcd_class, color = nlcd_class), show.legend = F) +
#   facet_wrap(~nlcd_class)
#as abs acres
sc_nlcd_cat_ac_year_wria |> 
  summarise(ac = sum(ac), .by = c(nlcd_year, nlcd_class)) |> 
  ggplot() + geom_col(aes(nlcd_year, ac, fill = nlcd_class, color = nlcd_class), show.legend = F) +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~nlcd_class, scales = "free")
#acres, urban only; did not expect to see decline in urbop
#but major potential conflation with other class switches
sc_nlcd_cat_ac_year_wria |> 
  filter(str_detect(nlcd_class, "urb")) |> 
  summarise(ac = sum(ac), .by = c(nlcd_year, nlcd_class)) |> 
  ggplot() + 
  geom_col(aes(nlcd_year, ac, fill = nlcd_class, color = nlcd_class), show.legend = F) +
  scale_color_grey(aesthetics = c("fill","color")) +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~nlcd_class)

#overall changes across nlcd classes and wrias
#could calc running diff() but start with 2019-2001
#this is 'too much' but also useful for narrowing
#statewide drop in urbop mostly wria 62, 49, 41, 43 --> looks mostly switched into urbmd
#multiwria 22-28 increases in wdwet seem likely timber regrowth given accompanying decreases in bl+mxfst+shrb
#decrease in wria4 ow points towards misclass artifact, unless baker and ross lakes have really shrunk a lot
sc_nlcd_cat_ac_year_wria |> 
  filter(nlcd_year %in% c(2001, 2019)) |> 
  pivot_wider(names_from = nlcd_year, values_from = ac) |> 
  mutate(
    d1901 = `2019`-`2001`,
    d1901pct = d1901/`2001`
    ) |> 
  ggplot() +
  geom_col(aes(d1901, wria, fill = nlcd_class, alpha = d1901 > 0), show.legend = F) +
  scale_alpha_manual(values = c(0.3,0.8)) +
  geom_vline(xintercept = 0) +
  facet_wrap(~nlcd_class, nrow = 1, scales = "free")
#another version, harvest and/or fire dominate when the unit is untransformed acres
#commented lines confirm that all urbhi and urbmd changes are increases
sc_nlcd_cat_ac_year_wria |> 
  filter(    
    str_detect(nlcd_class, "ice|ow", negate = T),
    nlcd_year %in% c(2001, 2019)
    ) |> 
  pivot_wider(names_from = nlcd_year, values_from = ac) |> 
  mutate(d1901 = `2019`-`2001`) |>
  select(-c(`2001`,`2019`)) |> 
  arrange(nlcd_class) |> 
  #pivot_wider(names_from = nlcd_class, values_from = d1901) |> 
  ## GGally::ggpairs(columns = 3:16, mapping = aes(size = 0.5, alpha = 0.5))
  #count(urbhi > 0, urbmd > 0)
  ggplot() + geom_point(aes(nlcd_class, wria_nr_nm, size = abs(d1901), color = d1901)) + wacolors::scale_color_wa_c("lopez", midpoint = 0)

#per-wria class changes between 2001 and 2019
#focusing on wria subset
#these 4 westside all have increased conif & decreased shrb
sc_nlcd_cat_ac_year_wria |> 
  filter(    
    str_detect(nlcd_class, "ice", negate = T),
    nlcd_year %in% c(2001, 2019)
    ) |> 
  pivot_wider(names_from = nlcd_year, values_from = ac) |> 
  mutate(d1901 = `2019`-`2001`) |> 
  #filter(wria=="57") |> arrange(d1901) |> 
  filter(wria %in% c("28","37","49","57", 
                     "8","9","10","15")) |> 
  ggplot() +
  geom_col(aes(nlcd_class, d1901, fill = nlcd_class), show.legend = F) +
  facet_wrap(~wria_nr_nm, nrow = 2, scales = "free", strip.position = "right")

#can ignore ice and open water and could combine urbhi+urbmd
#such that prelim cat-vs-rp100 was probably not wildly off for the urban part
#BUT combining 'tree' types looks much less clean/clear, as shrb/bl etc. vary by wria/region
#SO due to contrasting directions of change between classes across wrias, 
#and heterogeneity/conflation of different within-wria locations in wria-total change, 
#rather than initial approach of aggregating classes and summarizing by wria
#appears preferable to spatially-focus on comids with a change of interest
#then examine change in other classes

#orig questions: what's the deficit and how's it changing?
#"how well is washington's land use regulatory regime working to direct loss of natural cover away from a riparian corridor?"



### pct-based viz
#ignoring years, per-wria distrib pct-tree
sc_nlcd_cat_ac |> 
  ggplot() + geom_boxplot(aes(tree_cat, fct_reorder(wria, tree_cat)), varwidth = T)
#ignoring years, contrasting rp100 vs wria-wide
sc_nlcd_cat_ac |> 
  select(comid, nlcd_year, wria, tree_cat, tree_catrp100) |> 
  pivot_longer(cols = contains("tree"), values_to = "pct") |> 
  ggplot() + geom_boxplot(aes(pct, fct_reorder(wria, pct), color = name), varwidth = T)
#ignoring years, per-wria distrib of per-local spatial diff riparian-vs-whole
#positive: %treed in riparian corr greater than local catch as whole
#but these distributions of differences ignore 'starting point' of higher/lower pcts
sc_nlcd_cat_ac |> 
  select(comid, nlcd_year, wria, tree_cat, tree_catrp100) |> 
  mutate(d_tree = tree_catrp100 - tree_cat) |> 
  ggplot() + geom_boxplot(aes(d_tree, fct_reorder(wria, d_tree)), varwidth = T)
#so ordinate diffs by riparian treed
#within each nlcd_year, d_tree>0 indicates locally 'relatively-more-treed-than-overall' riparian for a given level of %treed
#larger d_tree at larger tree_catrp suggests more 'green ribbon'-like conditions with untreed upland
sc_nlcd_cat_ac_dtree <- sc_nlcd_cat_ac |> 
  filter(nlcd_year %in% c(2001, 2019)) |> 
  select(comid, nlcd_year, wria, tree_cat, tree_catrp100) |> 
  mutate(d_tree = tree_catrp100 - tree_cat) 
sc_nlcd_cat_ac_dtree |> 
  ggplot() + geom_point(aes(tree_catrp100, d_tree, color = factor(nlcd_year)), alpha = 0.1, size = 0.2) +
  annotate("segment", x = 0.05, y = -1.05, xend = 0.95, yend = -1.05, arrow = arrow()) +
  annotate("text", x = 0.15, y = -1, label = "higher riparian %tree cover", hjust = 0) +
  annotate("segment", x = -0.05, y = -1.05, xend = -0.05, yend = 1.05, arrow = arrow()) +
  annotate("text", x = -0.01, y = 0.5, label = "greater difference \nriparian vs whole-cat %tree cover", hjust = 0) +
  wacolors::scale_color_wa_d() +
  facet_wrap(~nlcd_year)
#following is difficult to intuit...
#calc'd as temporal diff in spatial diff: (rip19-cat19) - (rip01-cat01)
# best-case? positive d19 is more positive than a negative or positive d01?
sc_nlcd_cat_ac_dtree |> 
  pivot_wider(names_from = nlcd_year, values_from = contains("tree")) |> 
  mutate(`d_tree_2019-2001` = d_tree_2019 - d_tree_2001) |> 
  ggplot() +
  geom_point(aes(d_tree_2019, `d_tree_2019-2001`, size = tree_catrp100_2019, color = wria), alpha = 0.1, show.legend = F) +
  scale_size_area()
#spatial-diff ordinated t2 vs t1
sc_nlcd_cat_ac_dtree |> 
  pivot_wider(names_from = nlcd_year, values_from = contains("tree")) |> 
  ggplot() +
  geom_point(aes(d_tree_2001, d_tree_2019, size = tree_catrp100_2019, color = wria), alpha = 0.2, show.legend = F)
#best of a dubious bunch? calc then ordinate each temporal diff per spatial-extent
sc_nlcd_cat_ac_dtree |> 
  pivot_wider(names_from = nlcd_year, values_from = contains("tree")) |> 
  mutate(
    d_cat_1901 = tree_cat_2019 - tree_cat_2001,
    d_catrp100_1901 = tree_catrp100_2019 - tree_catrp100_2001
  ) |> 
  ggplot() +
  geom_point(aes(d_cat_1901, d_catrp100_1901, size = tree_catrp100_2019, color = wria), alpha = 0.2, show.legend = F) +
    annotate("segment", x = -1, y = -1.05, xend = 1, yend = -1.05, arrow = arrow()) +
  annotate("text", x = 0, y = -.95, label = "greater whole local catchment\n %tree in 2019 vs 2001", hjust = 0) +
  annotate("segment", x = -1.05, y = -1, xend = -1.05, yend = 1, arrow = arrow()) +
  annotate("text", x = -1, y = 0.85, label = "greater riparian %tree cover in 2019 vs 2001", hjust = 0)

#urban flipside, sort of interesting to see in the same 'unit space'?
#but still visually compromised by not having 'starting point' in the picture
#such that +5% between years means very different things from 75% vs 0%
sc_nlcd_cat_ac |> 
  filter(nlcd_year %in% c(2001, 2019)) |> 
  select(comid, nlcd_year, wria, urb_cat, urb_catrp100) |> 
  pivot_wider(names_from = nlcd_year, values_from = contains("urb")) |> 
  mutate(
    d_cat_1901 = urb_cat_2019 - urb_cat_2001,
    d_catrp100_1901 = urb_catrp100_2019 - urb_catrp100_2001
  ) |> 
  ggplot() +
  geom_point(aes(d_cat_1901, d_catrp100_1901, size = urb_catrp100_2019, color = wria), alpha = 0.2, show.legend = F) +
    annotate("segment", x = -1, y = -1.05, xend = 1, yend = -1.05, arrow = arrow()) +
  annotate("text", x = 0, y = -.95, label = "greater whole local catchment\n %urban in 2019 vs 2001", hjust = 0) +
  annotate("segment", x = -1.05, y = -1, xend = -1.05, yend = 1, arrow = arrow()) +
  annotate("text", x = -1, y = 0.85, label = "greater riparian %urban cover in 2019 vs 2001", hjust = 0)

#segments better than points
#steeper/more vertical indicates greater riparian increase than encompassing
#versus flatter for surrounding increases without riparian
wrias <- as.character(c(1,7,8,10,15, 28,32,37,45,57))
#define comids with non-zero urban cover in final NLCD year; could threshold to larger %
#drop second filter condition if not focusing the tree change on only those comids with +urban
#first look showed qualitatively similar and just including many more 'rural' cats
#further below created vector of 'urban in rp100' comids to limit even more
comid_2019_urb <- sc_nlcd_cat_ac |> 
  #ggplot() + stat_ecdf(aes(urbmdcat + urbhicat, color = factor(nlcd_year)))
  #summarise(q = quantile(urbmdcat + urbhicat, p = 0.75), .by = nlcd_year)
  filter(nlcd_year == 2019, (urbmdcat + urbhicat > 0)) |> 
  pull(comid)

{
  sc_nlcd_cat_ac |> 
    filter(nlcd_year %in% c(2001, 2019), comid %in% comid_2019_urb) |> 
    select(comid, nlcd_year, wria, wria_nr_nm,
           starts_with("urb_")) |> 
    pivot_wider(names_from = nlcd_year, values_from = contains("cat")) |>
    mutate(
      d_cat = urb_cat_2019 - urb_cat_2001,
      d_catrp100 = urb_catrp100_2019 - urb_catrp100_2001
    ) |> 
    filter(wria %in% wrias) |> 
    ggplot() + 
    geom_segment(aes(
      x = urb_cat_2001, y = urb_catrp100_2001,
      xend = urb_cat_2019, yend = urb_catrp100_2019,
      color = d_cat - d_catrp100 
    ),
    arrow = arrow(length = unit(0.05,"npc")),
    show.legend = T) +
    geom_abline(slope = 1, intercept = 0, linetype = 3) +
    wacolors::scale_color_wa_c("lopez", midpoint = 0) +
    scale_x_continuous(labels = scales::percent) +
    scale_y_continuous(labels = scales::percent) +
    facet_wrap(~wria_nr_nm, ncol = 1, strip.position = "right") +
    theme(strip.text = element_text(size = 5), legend.position = "top") +
    labs(
      title = "2001 to 2019 urban cover change",
      subtitle = "StreamCat NLCD %urban high+medium",
      x = "whole local catchment",
      y = "100m riparian corridor %urban"
    )
}+{
  sc_nlcd_cat_ac |> 
    filter(nlcd_year %in% c(2001, 2019), comid %in% comid_2019_urb) |> 
    select(comid, nlcd_year, wria, wria_nr_nm,
           starts_with("tree_")) |> 
    pivot_wider(names_from = nlcd_year, values_from = contains("cat")) |>
    mutate(
      d_cat = tree_cat_2019 - tree_cat_2001,
      d_catrp100 = tree_catrp100_2019 - tree_catrp100_2001
      , 
      d_catrp100f = case_when(
        d_catrp100 < 0 & d_cat < 0 ~ "both dec",
        d_catrp100 >= 0 & d_cat >= 0 ~ "both inc",
        d_catrp100 < 0 & d_cat >= 0 ~ "rp100 dec",
        d_catrp100 >= 0 & d_cat < 0 ~ "cat dec"
      )
    ) |>
    filter(wria %in% wrias) |> 
    #filter(d_catrp100f=="rp100 dec") |> summarise(across(contains("ac_"), sum), .by = wria_nr_nm)
    summarise(across(contains("ac_"), sum), .by = c(d_catrp100f, wria_nr_nm)) |> 
    mutate(
      d_cat_ac = tree_cat_ac_2019 - tree_cat_ac_2001,
      d_catrp100_ac = tree_catrp100_ac_2019 - tree_catrp100_ac_2001
    ) |> 
    select(wria_nr_nm, d_catrp100f, contains("cat_"), contains("catrp100_")) |> 
    arrange(wria_nr_nm, d_catrp100f) |> 
    gt(groupname_col = "wria_nr_nm", rowname_col = "d_catrp100f") |> fmt_number(decimals = 0) |> 
    tab_style_body(fn = \(x){x<0}, style = cell_text(color = "red"))
  ggplot() + 
    geom_segment(aes(
      x = tree_cat_2001, y = tree_catrp100_2001,
      xend = tree_cat_2019, yend = tree_catrp100_2019,
      color = d_catrp100
    ),
    arrow = arrow(length = unit(0.05,"npc")),
    show.legend = T) +
    geom_abline(slope = 1, intercept = 0, linetype = 3) +
    wacolors::scale_color_wa_c("stuart", midpoint = 0) +
    scale_x_continuous(labels = scales::percent) +
    scale_y_continuous(labels = scales::percent) +
    facet_wrap(~wria_nr_nm+d_catrp100f, ncol = 4, 
               labeller = label_wrap_gen(multi_line = F),
               strip.position = "right") +
    theme(strip.text = element_text(size = 5), legend.position = "top") +
    labs(
      title = "2001 to 2019 tree cover change",
      subtitle = "StreamCat NLCD %confi+decid+mxfst; comids with urban > 0 in 2019",
      x = "whole local catchment",
      y = "100m riparian corridor %tree"
    )
} + 
  plot_layout(widths = c(1,4)/5,guides = "keep")

#increased riparian urban cover is not exclusively correlated with decreased tree cover
sc_nlcd_cat_ac |> 
  filter(nlcd_year %in% c(2001, 2019), comid %in% comid_2019_urb) |> 
  select(comid, nlcd_year, wria, wria_nr_nm,
         starts_with("urb_") & ends_with("ac"),
         starts_with("tree_") & ends_with("ac")
         ) |> 
  pivot_wider(names_from = nlcd_year, values_from = contains("cat")) |>
  mutate(
    d_cat_ac_urb = urb_cat_ac_2019 - urb_cat_ac_2001,
    d_cat_ac_tree = tree_cat_ac_2019 - tree_cat_ac_2001,

    d_catrp100_ac_urb = urb_catrp100_ac_2019 - urb_catrp100_ac_2001,
    d_catrp100_ac_tree = tree_catrp100_ac_2019 - tree_catrp100_ac_2001
  ) |> 
  filter(wria %in% wrias) |> 
  ggplot() +
  geom_point(aes(d_catrp100_ac_urb, d_catrp100_ac_tree, color = wria), alpha = 0.5, size = 0.5, show.legend = F) +
  geom_smooth(aes(d_catrp100_ac_urb, d_catrp100_ac_tree, color = wria), show.legend = F) +
  geom_hline(yintercept = 0) +
  facet_wrap(~wria, nrow = 2, scales = "free") +
  labs(
    title = "Increased riparian urban cover is not exclusively correlated with decreased tree cover",
    subtitle = "StreamCat NLCD 2019-2001, comids with non-zero urban in 2019")

#what changes where urban increases?
#focus first on locations with nonzero RP100 urban in 2019
comid_2019_urb_rp100 <- sc_nlcd_cat_ac |> 
  filter(nlcd_year == 2019, (urbmdcatrp100 + urbhicatrp100 > 0)) |> 
  pull(comid)


sc_nlcd_cat_ac |> 
  filter(nlcd_year %in% c(2001, 2019), comid %in% comid_2019_urb_rp100) |> 
  select(wria, wria_nr_nm, comid, nlcd_year, contains("rp100") & ends_with("_ac")) |> 
  #filter(nlcd_year==2019) |> summary()
  pivot_longer(-c(wria, wria_nr_nm, comid, nlcd_year), names_to = "nlcd_class") |> 
  pivot_wider(names_from = nlcd_year,
              #names_prefix = "nlcd_", 
              values_from = value) |> 
  mutate(d = `2019` - `2001`) |> #mutate(d = nlcd_2019 - nlcd_2001) |> 
  # pivot_wider(names_from = name, values_from = c(d, `2019`, `2001`)) |> 
  filter(
    str_detect(nlcd_class, "urb_|tree_", negate = T),
    `2001`+`2019` > 0 #drop classes with zero cover both year
    ) |> 
  #ignore classes with no change in comid
  filter(abs(d) > 0) |> 
  filter(wria == "15") |> 
  # #big change comids
  filter(abs(d) < 50) |> 
  # #focal comids with larger urb gains
  # filter(nlcd_class == "urbmdcatrp100_ac", d > 10) |> pull(comid) -> urbmdgain
  ggplot() +
  # # #quasi heatmap
  # # geom_point(aes(fct_reorder(comid, d, min), nlcd_class, color = d)) +
  # # scale_color_gradient2(midpoint = 0) +
  # # scale_size_area(max_size = 4) +
  # #rotated parallel coord
  # geom_point(aes(nlcd_class, d, group = comid, color = nlcd_class), size = 0.6, show.legend = F) +
  # geom_line(aes(nlcd_class, d, group = comid), linewidth = 0.1, alpha = 0.3) +
  # coord_flip() +
  #problem with 'avg' change per class is that it blends different comid-specific shifts?
  geom_vline(xintercept = 0) +
  geom_jitter(aes(d, nlcd_class, color = nlcd_class), size = 0.5, alpha = 0.5, show.legend = F) +
  geom_boxplot(aes(d, nlcd_class, color = nlcd_class), fill = NA, varwidth = T, outliers = F, show.legend = F) +
  scale_color_manual(values = pal_nlcd) +
  facet_wrap(~wria, scales = "free_x") +
  theme(panel.grid = element_blank()) 

#closer look at 2 big rp100 changes, gain conif lose shrb
x <- sf_cat |> filter(comid %in% c("23990429", "24288108"))
y <- sf_flw |> filter(comid %in% c("23990429", "24288108")) |> st_buffer(dist = 300)
mapview(x) + mapview(y) 
#just E of Tahuya SF and E of Union R outlet, rp100 looks more S in cat, E of 'carney lake'
#plainly some regrowth of cut patches between 2001 and 2019 for 24288108
#and for 23990429, appears to be 
#https://earthengine.google.com/timelapse#v=47.46993,-122.80657,11.104,latLng&t=3.53&ps=50&bt=19840101&et=20221231

d <- sc_nlcd_cat_ac |> 
  filter(comid %in% urbmdgain) |> 
  select(wria, wria_nr_nm, comid, nlcd_year, contains("rp100") & ends_with("_ac")) |> 
  pivot_longer(-c(wria, wria_nr_nm, comid, nlcd_year), names_to = "nlcd_class") |> 
  filter(str_detect(nlcd_class, "ice|urb_|tree_", negate = T)) |> 
  arrange(comid, nlcd_year, desc(nlcd_class))
{d |> 
  ggplot(aes(nlcd_year, value, color=nlcd_class, fill=nlcd_class, group = comid)) +
  geom_col() +
  scale_color_manual(values = pal_nlcd, aesthetics = c("color","fill")) +
  facet_wrap(~comid, ncol = 1, scales = "free") + labs(y = "acres")
}+{
  d |> 
  ggplot(aes(nlcd_year, value, color=nlcd_class, fill=nlcd_class, group = nlcd_class)) +
  geom_line(show.legend = F) +
  scale_color_manual(values = pal_nlcd, aesthetics = c("color","fill")) +
  facet_wrap(~comid, ncol = 1, scales = "free") + labs(y = "acres")
} + plot_layout(guides = "keep")

#turns out to be N Bremerton, making the 'densification' plausible
x <- sf_cat |> filter(comid %in% c("23989097"))
y <- sf_flw |> filter(comid %in% c("23989097")) |> st_buffer(dist = 300)
mapview(x) + mapview(y) 

d |> 
  filter(
    nlcd_year %in% c(2001, 2019),
    comid %in% c("23989097")
    ) |> 
  pivot_wider(names_from = nlcd_year, values_from = value) |> 
  mutate(d = `2019` - `2001`) |> 
  arrange(desc(d))

#function to plot all-nlcd_class series, passed comid(s) as arg

```

```{r SUPERSEDED_BUT_WITH_USEFUL_RP100_cat_d_urb_then_tree, eval=FALSE}
#wrangle saved list by year to single tibble
#strip year from colnames, and condensing categories: 
#focus on urban 'high'+'medium', 4 tree categories 
#recognize that rp100 is nested rather than spatial difference/set complement when contrasted with encompassing catchment NLCD LU
sc_urb_tree <- readRDS(file.path(dir_data_common, "streamcat", "sc_wa_nlcd.rds")) |> 
  map(
    ~.x |> 
      rename_with(~str_remove(.,paste(c(2001, 2004, 2006, 2008, 2011, 2013, 2016, 2019),collapse = "|")) |> 
                    str_remove("pct")) |> 
      select(comid, nlcd_year, contains("areasqkm"),
             contains("urbmd"), contains("urbhi"), 
             contains("wdwet"), contains("mxfst"), contains("decid"), contains("conif")
      ) |> 
      mutate(
        urb_cat = urbmdcat + urbhicat,
        urb_ws = urbmdws + urbhiws,
        tree_cat = wdwetcat + mxfstcat + decidcat + conifcat,
        tree_ws = wdwetws + mxfstws + decidws + conifws
        ,
        urb_catrp100 = urbmdcatrp100 + urbhicatrp100,
        urb_wsrp100 = urbmdwsrp100 + urbhiwsrp100,
        tree_catrp100 = wdwetcatrp100 + mxfstcatrp100 + decidcatrp100 + conifcatrp100,
        tree_wsrp100 = wdwetwsrp100 + mxfstwsrp100 + decidwsrp100 + conifwsrp100
      ) |> 
      select(comid, nlcd_year, 
             contains("areasqkm"), 
             areasqkm_cat = catareasqkm, areasqkm_ws = wsareasqkm,
             areasqkm_catrp100 = catareasqkmrp100, areasqkm_wsrp100 = wsareasqkmrp100,
             ends_with("_cat"), ends_with("_catrp100"),
             ends_with("_ws"), ends_with("_wsrp100"))
  ) |> 
  list_rbind()

#break apart then rejoin to get areas by AOI, duplicated by LC
sc_urb_tree <- left_join(
  sc_urb_tree |> 
    select(comid, nlcd_year, contains("areasqkm")) |> 
    pivot_longer(cols = -c(comid, nlcd_year), values_to = "areasqkm") |> 
    mutate(aoi = str_remove(name, "areasqkm_"), name = NULL)
  ,
  sc_urb_tree |> 
    select(comid, nlcd_year, contains("urb"),contains("tree")) |> 
    pivot_longer(cols = -c(comid, nlcd_year), values_to = "pct") |> 
    separate(name, c("lc", "aoi")) |> 
    mutate(pct = round(pct/100, 4))
  ,
  by = c("comid", "nlcd_year", "aoi")
)

#per-nlcd-year 'spatial diff' of whole-cat-pct vs/minus riparian-pct
#positive indicating higher proportion of riparian 'urban' or treed
#random testing shows 'urban' can be roads...often near water
cat_d <- sc_urb_tree |> 
  mutate(acres = 247.11 * areasqkm * pct) |>
  filter(str_detect(aoi,"cat")) |> 
  pivot_wider(names_from = aoi, values_from = c(areasqkm, pct, acres)) |> 
  arrange(comid, nlcd_year)

#### urban ---------

# cat_d |> 
#   filter(str_detect(lc,"urb")) |> 
#   mutate(
#     # d_pct = pct_cat - pct_catrp100,
#     # d_acres = acres_cat - acres_catrp100
#     prop_rp100 = acres_catrp100 / acres_cat
#   )

#first look statewide, indicating that at least in some coarse sense,
#regulations have been steering 'urban' away from the riparian corridor 
cat_d |> 
  filter(str_detect(lc,"urb")) |> 
  summarise(
    across(starts_with("acres"), ~sum(., na.rm = T)),
    .by = c(lc, nlcd_year)
  ) |> 
  pivot_longer(cols = starts_with("acres"), names_to = "aoi", values_to = "acres") |> 
  mutate(
    aoi = if_else(str_detect(aoi, "rp100"), "Riparian 100m", "Local catchment")
  ) |> 
  ggplot() + 
  geom_col(aes(nlcd_year, acres, fill = aoi)) + 
  scale_fill_grey("Extent") +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Urban land cover, total vs riparian corridor",
    subtitle = "Sum of NLCD urban 'medium' and 'high' classes in StreamCat NHDplus 1:100K"
    )

cat_d_urb_wria <- sf_flw |> 
  as_tibble() |> 
  select(-fcode, -geometry) |> 
  distinct(comid, .keep_all = T) |> #enforce a single wria per comid
  inner_join(filter(cat_d, str_detect(lc,"urb")), by = "comid") |> 
  # #summary()
  # ##comids with NA wria are border edges
  # filter(is.na(wria)) |> distinct(comid) -> no_wria
  # semi_join(sf_flw, no_wria, by = "comid") |> ggplot() + geom_sf(aes(fill = fcode))
  drop_na(wria) |> 
  summarise(
    across(c(lengthkm, starts_with("acres")), ~sum(., na.rm = T)),
    .by = c(lc, nlcd_year, wria, wria_nr_nm)
  )

#geom_col by WRIA, abs area per cat/catrp100
cat_d_urb_wria |> 
  pivot_longer(cols = starts_with("acres"), names_to = "aoi", values_to = "acres") |> 
  mutate(
    aoi = if_else(str_detect(aoi, "rp100"), "Riparian 100m", "Local catchment")
  ) |> 
  ggplot() +
  geom_col(aes(nlcd_year, acres, fill = aoi)) + 
  scale_fill_grey("Extent") +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~wria, scales = "free_y")

#geom_line by WRIA: total urban, riparian corridor urban, and riparian as proportion of total
d <- cat_d_urb_wria |>
  mutate(riparian_proportion_of_total = acres_catrp100 / acres_cat)
d |> arrange(desc(riparian_proportion_of_total))

{
  ggplot(d) +
    geom_line(aes(nlcd_year, acres_cat, group = wria), color = "grey20", linewidth = 0.2) + 
    geom_smooth(aes(nlcd_year, acres_cat), color = "grey20", linewidth = 1.5, linetype = 2) + 
    scale_y_continuous(labels = scales::comma) +
    #facet_wrap(~wria, ncol = 1, strip.position = "right") +
    labs(subtitle = "Total urban extent has increased...")
  }+{
    ggplot() +
      geom_line(data = d, aes(nlcd_year, acres_catrp100, group = wria), color = "grey70", linewidth = 0.3) + 
      geom_smooth(data = d, aes(nlcd_year, acres_catrp100), color = "grey70", linewidth = 1.5, linetype = 2) + 
      geom_text(data = filter(d, nlcd_year == 2019),
                x = 2019.5, aes(y = acres_catrp100, label = wria), color = "grey70", size = 2) + 
      scale_y_continuous(labels = scales::comma) +
      #facet_wrap(~wria, ncol = 1, strip.position = "right") +
      labs(subtitle = "and so has urban cover in a 100m riparian corridor\n around major streams and rivers...")
  }+{
    ggplot() +
      geom_line(data = d, aes(nlcd_year, riparian_proportion_of_total, group = wria), color = "orange") + 
      geom_smooth(data = d, aes(nlcd_year, riparian_proportion_of_total), color = "orange", linewidth = 1.5, linetype = 2) + 
      geom_text(data = filter(d, nlcd_year == 2019),
                x = 2019.5, aes(y = riparian_proportion_of_total, label = wria), color = "orange", size = 2) +
      scale_y_continuous(labels = scales::percent) +
      #facet_wrap(~wria, ncol = 1, strip.position = "right") +
      labs(subtitle = "\nbut mostly at a flat or slower rate")
  } + plot_layout(nrow = 1, guides = "collect")

#geom_sf single wria catchments in time
sf_cat |> 
  filter(wria=="16") |>
  distinct(comid, .keep_all = T) |> #enforce a single wria per comid
  inner_join(
    cat_d |> 
      filter(str_detect(lc,"urb")) 
    , by = "comid") |>
  select(comid, contains("wria"), nlcd_year, contains("cat")) |> 
  pivot_longer(cols = starts_with("acres"), values_to = "ac") |> 
  ggplot() +
  geom_sf(aes(fill = ac), color = NA) +
  scale_fill_gradient(low = "tan",high = "grey30") +
  facet_wrap(~name+nlcd_year, nrow = 2)

#### tree ---------
cat_d |> 
  filter(str_detect(lc,"tree")) |> 
  summarise(
    across(starts_with("acres"), ~sum(., na.rm = T)),
    .by = c(lc, nlcd_year)
  ) |> 
  pivot_longer(cols = starts_with("acres"), names_to = "aoi", values_to = "acres") |> 
  mutate(
    aoi = if_else(str_detect(aoi, "rp100"), "Riparian 100m", "Local catchment")
  ) |> 
  ggplot() + 
  geom_col(aes(nlcd_year, acres, fill = aoi)) + 
  scale_fill_manual(name = "Extent", values = c("palegreen","darkgreen")) +
  scale_y_continuous(labels = scales::comma) +
  #scale_y_log10() +
  labs(
    title = "Tree cover, total vs riparian corridor",
    subtitle = "Sum of NLCD tree/forest classes in StreamCat NHDplus 1:100K"
    )

#statewide boxplot of per-comid pct-tree-riparian by nlcd year
#jitter renders useless
cat_d |> 
  filter(str_detect(lc,"tree")) |> 
  mutate(nlcd_year = factor(nlcd_year)) |> 
  ggplot(aes(nlcd_year, pct_catrp100)) +
  geom_boxplot(color = "darkgreen") +
  geom_jitter(color = "darkgreen", alpha = 0.3, size = 0.2)
#coarse regional stratification is perhaps more interesting
#east-of-cascades relatively consistent decline vs rebound west-side
sf_flw |> 
  as_tibble() |> 
  select(-fcode, -geometry) |> 
  distinct(comid, .keep_all = T) |> #enforce a single wria per comid
  inner_join(filter(cat_d, str_detect(lc,"tree")), by = "comid") |> 
  drop_na(wria) |> 
  mutate(
    nlcd_year = factor(nlcd_year),
    ew = if_else(as.integer(as.character(wria)) > 25, "east", "west")
    ) |> 
  ggplot(aes(nlcd_year, pct_catrp100)) +
  geom_jitter(color = "darkgreen", alpha = 0.2, size = 0.1) +
  geom_boxplot(fill = NA, color = "black") +
  facet_wrap(~ew, nrow = 1)

#going brightening fishing: did any catchments that gained urban cover also increase riparian tree cover?
cat_d |> 
  drop_na(pct_catrp100) |> 
  filter(
    nlcd_year %in% c(2001, 2019)
    ) |>
  select(-contains("areasqkm")) |> 
  pivot_wider(names_from = c(nlcd_year, lc), values_from = contains("cat")) |> 
  mutate(
    d_cat_urb = pct_cat_2019_urb - pct_cat_2001_urb,
    d_catrp100_tree = pct_catrp100_2019_tree - pct_catrp100_2001_tree
  ) |> 
  filter(
    d_cat_urb > 0
  ) |> 
  ggplot(aes(d_cat_urb, d_catrp100_tree)) +
  geom_point(aes(color = d_catrp100_tree > 0), size = 0.1, alpha = 0.3, show.legend = F) +
  scale_color_manual(values = c("grey30","darkgreen")) +
  labs(
    x = "Difference in local catchment %urban cover, 2019-2001",
    y = "Difference in %tree cover of 100m riparian corridor, 2019-2001",
    title = "Some urban land cover increases were concurrent with increased riparian tree cover"
  )

focal <- cat_d |> 
  drop_na(pct_catrp100) |> 
  filter(
    nlcd_year %in% c(2001, 2019)
    ) |>
  select(-contains("areasqkm")) |> 
  pivot_wider(names_from = c(nlcd_year, lc), values_from = contains("cat")) |> 
  mutate(
    d_cat_urb = pct_cat_2019_urb - pct_cat_2001_urb,
    d_catrp100_tree = pct_catrp100_2019_tree - pct_catrp100_2001_tree
  ) |> 
  filter(
    d_cat_urb > 0,
    d_catrp100_tree > 0
    )

#moving fast
ggplot() + 
  geom_sf(
    data = inner_join(sf_cat, focal, by = "comid"),
    aes(fill = d_cat_urb), color = NA
    ) +
  wacolors::scale_fill_wa_c("volcano", reverse = T) +
  geom_sf(
    data = inner_join(sf_flw, focal, by = "comid"),
    aes(color = d_catrp100_tree)
    ) +
  wacolors::scale_color_wa_c("foothills", reverse = T)

```


:::
